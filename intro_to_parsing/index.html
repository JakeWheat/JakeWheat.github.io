<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<title>Intro to Parsing with Parsec in Haskell</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove the comments around the @import statement below when using this as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
#map_canvas img,#map_canvas embed,#map_canvas object,.map_canvas img,.map_canvas embed,.map_canvas object{max-width:none!important}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
.antialiased,body{-webkit-font-smoothing:antialiased}
img{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{display:inline-block;color:rgba(0,0,0,.8);font-size:.75em;line-height:1.4;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:-.15em .15em 0 .15em;padding:.2em .6em .2em .5em;vertical-align:middle;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.05em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.spread{width:100%}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1{padding-right:.75em;font-weight:bold}
td.hdlist1,td.hdlist2{vertical-align:top}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none}
span.footnote,span.footnoteref{vertical-align:super;font-size:.875em}
span.footnote a,span.footnoteref a{text-decoration:none}
span.footnote a:active,span.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em;line-height:1.3;font-size:.875em;margin-left:1.2em;text-indent:-1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
h1,h2{letter-spacing:-.01em}
dt,th.tableblock,td.content{text-rendering:optimizeLegibility}
p,td.content{letter-spacing:-.01em}
p strong,td.content strong{letter-spacing:-.005em}
p,blockquote,dt,td.content{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img{page-break-inside:avoid}
thead{display:table-header-group}
img{max-width:100%!important}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<style>
.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments  { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="book toc2 toc-right">
<div id="header">
<h1>Intro to Parsing with Parsec in Haskell</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_overview">1. Overview</a>
<ul class="sectlevel2">
<li><a href="#_summary_of_sections">1.1. Summary of sections</a></li>
<li><a href="#_going_further">1.2. Going further</a></li>
<li><a href="#_extras">1.3. Extras</a></li>
</ul>
</li>
<li><a href="#getting-started">2. Getting started</a>
<ul class="sectlevel2">
<li><a href="#_first_parser">2.1. First parser</a></li>
<li><a href="#_type_signatures">2.2. Type signatures</a></li>
<li><a href="#_text_parsec_char">2.3. Text.Parsec.Char</a></li>
<li><a href="#_a_couple_of_helper_executables">2.4. A couple of helper executables</a></li>
</ul>
</li>
<li><a href="#very-simple-expression-parsing">3. Very simple expression parsing</a>
<ul class="sectlevel2">
<li><a href="#_num">3.1. num</a></li>
<li><a href="#_var">3.2. var</a></li>
<li><a href="#_parens">3.3. parens</a></li>
<li><a href="#_add">3.4. add</a></li>
<li><a href="#_whitespace">3.5. whitespace</a></li>
<li><a href="#_simple_expr">3.6. simple expr</a>
<ul class="sectlevel3">
<li><a href="#_choice">3.6.1. choice</a></li>
</ul>
</li>
<li><a href="#_testing_with_the_examples">3.7. Testing with the examples</a></li>
<li><a href="#_testing_with_quickcheck">3.8. Testing with quickcheck</a>
<ul class="sectlevel3">
<li><a href="#_a_pretty_printer">3.8.1. a pretty printer</a></li>
<li><a href="#_the_quick_check_code">3.8.2. the quick check code</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#applicative-style-parsing-code">4. Applicative style parsing code</a>
<ul class="sectlevel2">
<li><a href="#_lexeme">4.1. lexeme</a></li>
<li><a href="#_num_2">4.2. num</a></li>
<li><a href="#_var_2">4.3. var</a></li>
<li><a href="#_parens_2">4.4. parens</a></li>
<li><a href="#_simple_expr_2">4.5. simple expr</a></li>
<li><a href="#_summary">4.6. summary</a></li>
</ul>
</li>
<li><a href="#combinator-review">5. Combinator review</a>
<ul class="sectlevel2">
<li><a href="#_text_parsec_combinator">5.1. Text.Parsec.Combinator</a>
<ul class="sectlevel3">
<li><a href="#_choice_2">5.1.1. choice</a>
<ul class="sectlevel4">
<li><a href="#_using_with_try">using with try</a></li>
</ul>
</li>
<li><a href="#_count">5.1.2. count</a></li>
<li><a href="#_between">5.1.3. between</a></li>
<li><a href="#_option">5.1.4. option</a></li>
<li><a href="#_optionmaybe">5.1.5. optionMaybe</a></li>
<li><a href="#_optional">5.1.6. optional</a></li>
<li><a href="#_skipmany1">5.1.7. skipMany1</a></li>
<li><a href="#_many1">5.1.8. many1</a></li>
<li><a href="#_sepby">5.1.9. sepBy</a></li>
<li><a href="#_sepby1">5.1.10. sepBy1</a></li>
<li><a href="#_endby">5.1.11. endBy</a></li>
<li><a href="#_endby1">5.1.12. endBy1</a></li>
<li><a href="#_sependby">5.1.13. sepEndBy</a></li>
<li><a href="#_sependby1">5.1.14. sepEndBy1</a></li>
<li><a href="#_chainl">5.1.15. chainl</a></li>
<li><a href="#_chainl1">5.1.16. chainl1</a></li>
<li><a href="#_chainr">5.1.17. chainr</a></li>
<li><a href="#_chainr1">5.1.18. chainr1</a></li>
<li><a href="#_eof">5.1.19. eof</a></li>
<li><a href="#_notfollowedby">5.1.20. notFollowedBy</a></li>
<li><a href="#_manytill">5.1.21. manyTill</a></li>
<li><a href="#_lookahead">5.1.22. lookAhead</a></li>
<li><a href="#_anytoken">5.1.23. anyToken</a></li>
</ul>
</li>
<li><a href="#_control_applicative">5.2. Control.Applicative</a></li>
<li><a href="#_control_monad">5.3. Control.Monad</a>
<ul class="sectlevel3">
<li><a href="#_return">5.3.1. return</a></li>
<li><a href="#_mzero">5.3.2. mzero</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#functions-and-types-for-parsing">6. Functions and types for parsing</a>
<ul class="sectlevel2">
<li><a href="#_functions_for_parsing">6.1. Functions for parsing</a></li>
<li><a href="#_type_signatures_revisited">6.2. type signatures revisited</a></li>
<li><a href="#_parser">6.3. Parser</a></li>
<li><a href="#_other_information">6.4. Other information</a></li>
</ul>
</li>
<li><a href="#parsing-expressions-with-fixity">7. Parsing expressions with fixity</a>
<ul class="sectlevel2">
<li><a href="#_expressions_with_plus_and_times">7.1. expressions with plus and times</a></li>
<li><a href="#_a_full_featured_expression_type">7.2. a full featured expression type</a>
<ul class="sectlevel3">
<li><a href="#_unary">7.2.1. unary + -</a></li>
<li><a href="#_exponentiation">7.2.2. exponentiation</a></li>
<li><a href="#_multiplication_division_modulo">7.2.3. multiplication, division, modulo</a></li>
<li><a href="#_addition_subtraction">7.2.4. addition, subtraction</a></li>
<li><a href="#_less_than_greater_than">7.2.5. less than, greater than</a></li>
<li><a href="#_equals">7.2.6. equals</a></li>
<li><a href="#_not">7.2.7. not</a></li>
<li><a href="#_and">7.2.8. and</a></li>
<li><a href="#_or">7.2.9. or</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#an-issue-with-token-parsers">8. An issue with token parsers</a></li>
<li><a href="#permutation-parsing">9. Permutation parsing</a></li>
<li><a href="#token-parsing">10. Token parsing</a></li>
<li><a href="#value-expressions">11. Value expressions</a>
<ul class="sectlevel2">
<li><a href="#_lineup">11.1. Lineup</a>
<ul class="sectlevel3">
<li><a href="#_comments">11.1.1. comments</a></li>
<li><a href="#_literals">11.1.2. literals</a></li>
<li><a href="#_identifiers">11.1.3. identifiers</a></li>
<li><a href="#__dotted_identifiers">11.1.4. 'dotted identifiers'</a></li>
<li><a href="#_star">11.1.5. star</a></li>
<li><a href="#_function_application">11.1.6. function application</a></li>
<li><a href="#_operators">11.1.7. operators</a></li>
<li><a href="#_case_expression">11.1.8. case expression</a></li>
<li><a href="#_parentheses">11.1.9. parentheses</a></li>
</ul>
</li>
<li><a href="#_abstract_syntax_for_value_expressions">11.2. abstract syntax for value expressions</a></li>
<li><a href="#_automated_testing_framework">11.3. automated testing framework</a></li>
<li><a href="#_the_parsing_we_already_have">11.4. the parsing we already have</a>
<ul class="sectlevel3">
<li><a href="#_tokens">11.4.1. tokens</a></li>
<li><a href="#_helper_functions">11.4.2. helper functions</a></li>
<li><a href="#_terms">11.4.3. terms</a></li>
<li><a href="#_operator_table_and_the_first_value_expression_parser">11.4.4. operator table and the first value expression parser</a></li>
</ul>
</li>
<li><a href="#_new_parsers">11.5. new parsers</a>
<ul class="sectlevel3">
<li><a href="#_whitespace_and_comments">11.5.1. whitespace and comments</a></li>
<li><a href="#_string_literal">11.5.2. string literal</a></li>
<li><a href="#_dotted_identifier">11.5.3. dotted identifier</a></li>
<li><a href="#_star_2">11.5.4. star</a></li>
<li><a href="#_dotted_star">11.5.5. dotted star</a></li>
<li><a href="#_app">11.5.6. app</a></li>
<li><a href="#_case">11.5.7. case</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#query-expressions">12. Query expressions</a>
<ul class="sectlevel2">
<li><a href="#_select_lists">12.1. select lists</a>
<ul class="sectlevel3">
<li><a href="#_aliases">12.1.1. aliases</a></li>
</ul>
</li>
<li><a href="#_from_clause">12.2. from clause</a></li>
<li><a href="#_where">12.3. where</a></li>
<li><a href="#_group_by">12.4. group by</a></li>
<li><a href="#_having">12.5. having</a></li>
<li><a href="#_order_by">12.6. order by</a></li>
</ul>
</li>
<li><a href="#from-clause">13. From clause</a>
<ul class="sectlevel2">
<li><a href="#_abstract_syntax">13.1. Abstract syntax</a></li>
<li><a href="#_simple_table_name">13.2. simple table name</a></li>
<li><a href="#_subquery">13.3. subquery</a></li>
<li><a href="#_parens_3">13.4. parens</a></li>
<li><a href="#_alias">13.5. alias</a></li>
<li><a href="#_joins">13.6. joins</a>
<ul class="sectlevel3">
<li><a href="#_join_type">13.6.1. join type</a></li>
<li><a href="#_join_condition">13.6.2. join condition</a></li>
<li><a href="#_simple_binary_join">13.6.3. simple binary join</a></li>
</ul>
</li>
<li><a href="#_query_expressions">13.7. query expressions</a></li>
</ul>
</li>
<li><a href="#simple-sql-query-parser">14. Simple SQL query parser</a>
<ul class="sectlevel2">
<li><a href="#_supported_sql">14.1. Supported SQL</a>
<ul class="sectlevel3">
<li><a href="#_comments_2">14.1.1. comments</a></li>
<li><a href="#_value_expressions">14.1.2. value expressions</a>
<ul class="sectlevel4">
<li><a href="#_literals_2">literals</a></li>
<li><a href="#_identifiers_2">identifiers</a></li>
<li><a href="#_dotted_identifiers">dotted identifiers</a></li>
<li><a href="#_star_3">star</a></li>
<li><a href="#_function_application_2">function application</a></li>
<li><a href="#_operators_2">operators</a></li>
<li><a href="#_case_expression_2">case expression</a></li>
<li><a href="#_parentheses_2">parentheses</a></li>
</ul>
</li>
<li><a href="#_query_expressions_2">14.1.3. query expressions</a></li>
</ul>
</li>
<li><a href="#_abstract_syntax_2">14.2. Abstract syntax</a></li>
<li><a href="#_value_expression_parsing">14.3. Value expression parsing</a>
<ul class="sectlevel3">
<li><a href="#_term_components">14.3.1. term components</a></li>
<li><a href="#_case_2">14.3.2. case</a></li>
<li><a href="#_term">14.3.3. term</a></li>
<li><a href="#_operators_3">14.3.4. operators</a></li>
<li><a href="#_valueexpr">14.3.5. valueExpr</a></li>
</ul>
</li>
<li><a href="#_query_expression_parsing">14.4. Query expression parsing</a>
<ul class="sectlevel3">
<li><a href="#_from_clause_2">14.4.1. from clause</a></li>
<li><a href="#_queryexpr">14.4.2. queryExpr</a></li>
</ul>
</li>
<li><a href="#_tokens_2">14.5. tokens</a></li>
<li><a href="#_helper_functions_2">14.6. helper functions</a></li>
<li><a href="#_the_parser_api">14.7. the parser api</a></li>
<li><a href="#_tests">14.8. tests</a></li>
</ul>
</li>
<li><a href="#pretty-printing">15. Pretty printing</a>
<ul class="sectlevel2">
<li><a href="#_api">15.1. api</a></li>
<li><a href="#_value_expressions_2">15.2. value expressions</a></li>
<li><a href="#_query_expressions_3">15.3. query expressions</a></li>
<li><a href="#_helpers">15.4. helpers</a></li>
<li><a href="#_tests_2">15.5. tests</a></li>
</ul>
</li>
<li><a href="#error-messages">16. Error messages</a>
<ul class="sectlevel2">
<li><a href="#_ways_of_generating_errors_in_parsec">16.1. ways of generating errors in parsec</a></li>
<li><a href="#_how_parsec_combines_errors_or_drops_them_into_the_void">16.2. how parsec combines errors or drops them into the void</a></li>
<li><a href="#_parsing_tpch">16.3. Parsing tpch</a></li>
<li><a href="#_value_expressions_in_isolation">16.4. value expressions in isolation</a></li>
<li><a href="#_query_expressions_4">16.5. query expressions</a></li>
<li><a href="#_summarizing">16.6. summarizing?</a></li>
<li><a href="#_updated_parsing_code_with_improved_error_message_behaviour">16.7. updated parsing code with improved error message behaviour</a></li>
</ul>
</li>
</ul><hr />
<ul class="sectlevel1">
<li><a href="http://jakewheat.github.io/intro_to_parsing" class="bare">Homepage</a></li>
<li><a href="https://github.com/JakeWheat/intro_to_parsing" class="bare">Repository</a></li>
<li><a href="https://github.com/JakeWheat/intro_to_parsing/issues" class="bare">Bug tracker</a></li>
<li><a href="http://jakewheat.github.io/" class="bare">Parent project</a>
</li><li>jakewheatmail@gmail.com</li>
</ul>

</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_overview">1. Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>WIP, a tutorial which demonstrates the basics of Parsec and goes on to
build a SQL query parser.</p>
</div>
<div class="paragraph">
<p>You can view this tutorial as HTML online here:</p>
</div>
<div class="paragraph">
<p><a href="http://jakewheat.github.io/intro_to_parsing/" class="bare">http://jakewheat.github.io/intro_to_parsing/</a></p>
</div>
<div class="paragraph">
<p>and you can view the files directly in the github repository here:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/JakeWheat/intro_to_parsing" class="bare">https://github.com/JakeWheat/intro_to_parsing</a></p>
</div>
<div class="sect2">
<h3 id="_summary_of_sections">1.1. Summary of sections</h3>
<div class="paragraph">
<p><a href="#getting-started">Getting Started</a></p>
</div>
<div class="paragraph">
<p>Introduction to parsing with Parsec, including a review of
Text.Parsec.Char functions.</p>
</div>
<div class="paragraph">
<p><a href="#very-simple-expression-parsing">Very simple expression parsing</a></p>
</div>
<div class="paragraph">
<p>Creating a very simple expression language parser, and introducing
some functions from Text.Parsec.Combinator.</p>
</div>
<div class="paragraph">
<p><a href="#applicative-style-parsing-code">Applicative style parsing code</a></p>
</div>
<div class="paragraph">
<p>Rewriting the simple expression parser code in a more succinct style.</p>
</div>
<div class="paragraph">
<p><a href="#combinator-review">Combinator review</a></p>
</div>
<div class="paragraph">
<p>Review and examples of all functions from Text.Parsec.Combinator, and
some from Control.Applicative and Control.Monad.</p>
</div>
<div class="paragraph">
<p><a href="#functions-and-types-for-parsing">Functions and types for parsing</a></p>
</div>
<div class="paragraph">
<p>The utility functions used in the previous tutorials, plus some notes
on types in Parsec.</p>
</div>
<div class="paragraph">
<p><a href="#parsing-expressions-with-fixity">Parsing expressions with fixity</a></p>
</div>
<div class="paragraph">
<p>This covers using the Text.Parsec.Expr for expression parsing with
prefix, postfix and infix operators with fixity.</p>
</div>
<div class="paragraph">
<p><a href="#an-issue-with-token-parsers">An issue with token parsers</a></p>
</div>
<div class="paragraph">
<p>Looks at an issue we have with the way the symbol parser in the
Text.Parsec.Expr tutorial was used, and some possible fixes.</p>
</div>
<div class="paragraph">
<p><a href="#permutation-parsing">Permutation parsing</a></p>
</div>
<div class="paragraph">
<p>This covers the Text.Parsec.Perm module which is used for parsing
different things in flexible order.</p>
</div>
<div class="paragraph">
<p><a href="#token-parsing">Token parsing</a></p>
</div>
<div class="paragraph">
<p>This covers Text.Parsec.Token which can be used to create token
parsers easily.</p>
</div>
<div class="paragraph">
<p><a href="#value-expressions">Value expressions</a></p>
</div>
<div class="paragraph">
<p>This covers building a parser a subset of value expressions from SQL,
which are an extension of the simple expression types and parsers
covered in previous tutorials.</p>
</div>
<div class="paragraph">
<p><a href="#query-expressions">Query expressions</a></p>
</div>
<div class="paragraph">
<p>This covers building a parser to parse query expressions with select
lists, simple from, where, group by, having and order by.</p>
</div>
<div class="paragraph">
<p><a href="#from-clause">From clause</a></p>
</div>
<div class="paragraph">
<p>This extend the parser for query expressions to support a from clause
with much more features including joins.</p>
</div>
<div class="paragraph">
<p><a href="#simple-sql-query-parser">Simple SQL query parser</a></p>
</div>
<div class="paragraph">
<p>Here is the code from ValueExpressions, QueryExpressions and
FromClause plus tests put together and rearranged as a coherent
standalone module.</p>
</div>
<div class="paragraph">
<p><a href="#pretty-printing">Pretty printing</a></p>
</div>
<div class="paragraph">
<p>This quick module covers a simple pretty printer for our SQL ast.</p>
</div>
<div class="paragraph">
<p><a href="#error-messages">Error messages</a></p>
</div>
<div class="paragraph">
<p>In this document, we will explore error messages with parsec and how
restructuring parser code can lead to better or worse error messages.</p>
</div>
</div>
<div class="sect2">
<h3 id="_going_further">1.2. Going further</h3>
<div class="paragraph">
<p>If you are interesting in SQL parsing, check out the project to build
a complete SQL parser here:
<a href="http://jakewheat.github.io/simple-sql-parser/latest" class="bare">http://jakewheat.github.io/simple-sql-parser/latest</a>. The parsing code in the
simple-sql-parser project is based on this tutorial code.</p>
</div>
</div>
<div class="sect2">
<h3 id="_extras">1.3. Extras</h3>
<div class="ulist">
<ul>
<li>
<p><a href="ParseString.lhs" class="bare">ParseString.lhs</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>an executable which contains the boilerplate to run a parsec parser on
a string passed as an argument</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="ParseFile.lhs" class="bare">ParseFile.lhs</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>an executable which contains the boilerplate to run a parsec parser on
a file passed as an argument</p>
</div>
<div class="paragraph">
<p>Contact: jakewheatmail@gmail.com</p>
</div>
<div class="paragraph">
<p>License: BSD3</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started">2. Getting started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is an introduction to parsing with Haskell and Parsec.</p>
</div>
<div class="paragraph">
<p>Prerequisites: you should know some basic Haskell and have GHC and
cabal-install installed (installing the Haskell Platform will give you
this).</p>
</div>
<div class="paragraph">
<p>This tutorial was originally written using GHC 7.6.3 and Parsec 3.1.3,
which are the versions which come with the Haskell Platform
2013.2.0.0. It should also work fine with GHC 7.8.4 and GHC 7.10.2 and
through to at least the latest release of Parsec 3.1.x.</p>
</div>
<div class="paragraph">
<p>This tutorial was written using Literate Haskell files available here:
<a href="https://github.com/JakeWheat/intro_to_parsing" class="bare">https://github.com/JakeWheat/intro_to_parsing</a>.</p>
</div>
<div class="paragraph">
<p>I recommend you download them all, and follow along in your favourite
editor, and use GHCi to experiment. To download the intro_to_parsing
files, use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>git clone https://github.com/JakeWheat/intro_to_parsing.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the imports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String</span> <span class="tok-p">(</span><span class="tok-kt">Parser</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Char</span> <span class="tok-p">(</span><span class="tok-nf">anyChar</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Char</span>
<span class="tok-kr">import</span> <span class="tok-nn">FunctionsAndTypesForParsing</span> <span class="tok-p">(</span><span class="tok-nf">regularParse</span><span class="tok-p">,</span> <span class="tok-nf">parseWithEof</span><span class="tok-p">,</span> <span class="tok-nf">parseWithLeftOver</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Data.Char</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Combinator</span> <span class="tok-p">(</span><span class="tok-nf">many1</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_first_parser">2.1. First parser</h3>
<div class="paragraph">
<p>The first parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>anyChar :: Parser Char</code></pre>
</div>
</div>
<div class="paragraph">
<p>This parser is in the module <code>Text.Parsec.Char</code>. There is a wrapper in
this tutorial&#8217;s project, <code>Text.Parsec.String.Char</code>, which gives this
function a simplified type.</p>
</div>
<div class="paragraph">
<p>Whenever we write a parser which parses to a value of type <code>a</code>, we give
it the return type of <code>Parser a</code>. In this case, we parse a character
so the return type is <code>Parser Char</code>. The <code>Parser</code> type itself is in
the module <code>Text.Parsec.String</code>. We will cover this in more detail
later.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s use this parser. I will assume you have GHC and cabal-install
installed (which provides the 'cabal' executable) and both are in your
PATH. The Haskell Platform is one way that provides this.</p>
</div>
<div class="paragraph">
<p>Change to the directory where you downloaded the intro_to_parsing
source files (which will contain the GettingStarted.lhs file). Then
you can set up a cabal sandbox and be ready to work with the code by
running the following commands in that directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>cabal update
cabal sandbox init
cabal install parsec
cabal repl</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you will get the ghci prompt. Type in ':l GettingStarted.lhs'. You
can run the parser using a wrapper, enter the following at the ghci
prompt: <code>regularParse anyChar "a"</code>.</p>
</div>
<div class="paragraph">
<p>Here is a transcript of running ghci via 'cabal repl':</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>$ cabal repl
GHCi, version 7.6.3: http://www.haskell.org/ghc/  :? for help
Loading package ghc-prim ... linking ... done.
Loading package integer-gmp ... linking ... done.
Loading package base ... linking ... done.
Prelude&gt; :l GettingStarted.lhs
[1 of 5] Compiling Text.Parsec.String.Parsec ( Text/Parsec/String/Parsec.hs, interpreted )
[2 of 5] Compiling Text.Parsec.String.Combinator ( Text/Parsec/String/Combinator.hs, interpreted )
[3 of 5] Compiling Text.Parsec.String.Char ( Text/Parsec/String/Char.hs, interpreted )
[4 of 5] Compiling FunctionsAndTypesForParsing ( FunctionsAndTypesForParsing.lhs, interpreted )
[5 of 5] Compiling Main             ( GettingStarted.lhs, interpreted )
Ok, modules loaded: FunctionsAndTypesForParsing, Text.Parsec.String.Char, Text.Parsec.String.Combinator, Main, Text.Parsec.String.Parsec.
*Main&gt; regularParse anyChar "a"
Loading package array-0.4.0.1 ... linking ... done.
Loading package deepseq-1.3.0.1 ... linking ... done.
Loading package bytestring-0.10.0.2 ... linking ... done.
Loading package containers-0.5.0.0 ... linking ... done.
Loading package binary-0.5.1.1 ... linking ... done.
Loading package transformers-0.4.3.0 ... linking ... done.
Loading package mtl-2.2.1 ... linking ... done.
Loading package text-1.2.1.3 ... linking ... done.
Loading package parsec-3.1.9 ... linking ... done.
Right 'a'
*Main&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can exit ghci by entering ':quit' or using Ctrl-d. From now on, to
start ghci again, you can just change to the directory with
GettingStarted.lhs and run 'cabal repl'. ghci should have readline
support so you can browse through your command history using up and
down arrow, etc.</p>
</div>
<div class="paragraph">
<p>This is the type of <code>regularParse</code>. It is wrapper which takes a parser
function such as anyChar, and wraps it so you can parse a string to
either a parse error, or the return value from your parser function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>regularParse :: Parser a -&gt; String -&gt; Either ParseError a</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are some examples of running this parser on various input:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse anyChar "a"
Right 'a'

*Main&gt; regularParse anyChar "b"
Right 'b'

*Main&gt; regularParse anyChar "0"
Right '0'

*Main&gt; regularParse anyChar " "
Right ' '

*Main&gt; regularParse anyChar "\n"
Right '\n'

*Main&gt; regularParse anyChar "aa"
Right 'a'

*Main&gt; regularParse anyChar ""
Left (line 1, column 1):
unexpected end of input

*Main&gt; regularParse anyChar " a"
Right ' '</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that if there are no characters, we get an error.
Otherwise, it takes the first character and returns it, and throws
away any trailing characters. The details of the helper function
<code>regularParse</code> will come later.</p>
</div>
<div class="paragraph">
<p>Here are two alternatives to <code>regularParse</code> you can also use for
experimenting for the time being:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>parseWithEof :: Parser a -&gt; String -&gt; Either ParseError a</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>parseWithLeftOver :: Parser a -&gt; String -&gt; Either ParseError (a,String)</code></pre>
</div>
</div>
<div class="paragraph">
<p>These can be useful when you are not sure if your parser is consuming
all your input string or not. The eof parser will error if you haven&#8217;t
consumed all the input, and the leftover parser can instead tell you
what was not consumed from the input.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse anyChar "a"
Right 'a'

*Main&gt; parseWithEof anyChar "a"
Right 'a'

*Main&gt; parseWithLeftOver anyChar "a"
Right ('a',"")

*Main&gt; *Main&gt; regularParse anyChar ""
Left (line 1, column 1):
unexpected end of input

*Main&gt; parseWithEof anyChar ""
Left (line 1, column 1):
unexpected end of input

*Main&gt; parseWithLeftOver anyChar ""
Left (line 1, column 1):
unexpected end of input

*Main&gt; regularParse anyChar "aa"
Right 'a'

*Main&gt; parseWithEof anyChar "aa"
Left (line 1, column 2):
unexpected 'a'
expecting end of input

*Main&gt; parseWithLeftOver anyChar "aa"
Right ('a',"a")

*Main&gt; parseWithLeftOver anyChar "abc"
Right ('a',"bc")</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use these functions and ghci to experiment. Try running all
the parsers in ghci on various input strings as you work through the
document to get a good feel for all the different features. Tip: you
can also write the parsers inline in the function call, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse (many1 digit) "1"
Right "1"

*Main&gt; regularParse (many1 digit) "122"
Right "122"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This can be used to quickly try out new ad hoc parsing code.</p>
</div>
</div>
<div class="sect2">
<h3 id="_type_signatures">2.2. Type signatures</h3>
<div class="paragraph">
<p>The real Parsec functions have quite complex type signatures. This
makes a lot of things very tricky before you understand them, and can
make some of the error messages you&#8217;ll see really difficult to
understand. I&#8217;ve created some wrapper modules, which set the types of
all the functions from Parsec we use to be much more restricted. This
will make the types easy to understand, and reduce the amount of
tricky to understand compiler errors you get. You can use this
approach when writing your own parser code with Parsec. These wrapper
modules are created with the following name pattern:
<code>Text.Parsec.Char</code> &#8594; <code>Text.Parsec.String.Char</code>.</p>
</div>
<div class="paragraph">
<p>Later on, we will look at the general types in more detail.</p>
</div>
</div>
<div class="sect2">
<h3 id="_text_parsec_char">2.3. Text.Parsec.Char</h3>
<div class="paragraph">
<p>Let&#8217;s go through some of the functions in <code>Text.Parsec.Char</code> module from
the Parsec package. The haddock is available here:
<a href="http://hackage.haskell.org/package/parsec-3.1.3/docs/Text-Parsec-Char.html" class="bare">http://hackage.haskell.org/package/parsec-3.1.3/docs/Text-Parsec-Char.html</a>.</p>
</div>
<div class="paragraph">
<p>Here is the <code>satisfy</code> function, with its full type signature.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>satisfy :: Stream s m Char =&gt; (Char -&gt; Bool) -&gt; ParsecT s u m Char</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is one of the main primitive functions in Parsec. This looks at
the next character from the current input, and if the function (<code>Char
&#8594; Bool</code>) returns true for this character, it 'pops' it from the input
and returns it. In this way, the current position in the input string
is tracked behind the scenes.</p>
</div>
<div class="paragraph">
<p>In the simplified type wrappers, the <code>satisfy</code> function&#8217;s type is this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>satisfy :: (Char -&gt; Bool) -&gt; Parser Char</code></pre>
</div>
</div>
<div class="paragraph">
<p>This makes it a bit clearer what it is doing. All the functions in
<code>Text.Parsec.Char</code> are reproduced in the local <code>Text.Parsec.String.Char</code>
module with simplified types
(&lt;<a href="https://github.com/JakeWheat/intro_to_parsing/blob/master/Text/Parsec/String/Char.hs&gt;" class="bare">https://github.com/JakeWheat/intro_to_parsing/blob/master/Text/Parsec/String/Char.hs&gt;</a>).</p>
</div>
<div class="paragraph">
<p>Here are some examples of satisfy in action.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithEof (satisfy (=='a')) "a"
Right 'a'

*Main&gt; parseWithEof (satisfy (=='b')) "a"
Left (line 1, column 1):
unexpected "a"

*Main&gt; parseWithEof (satisfy (`elem` "abc")) "a"
Right 'a'

*Main&gt; parseWithEof (satisfy (`elem` "abc")) "d"
Left (line 1, column 1):
unexpected "d"

*Main&gt; parseWithEof (satisfy isDigit) "d"
Left (line 1, column 1):
unexpected "d"

*Main&gt; parseWithEof (satisfy isDigit) "1"
Right '1'</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that it is easy to use <code>==</code>, or <code>elem</code> or one of the
functions from the Data.Char module.</p>
</div>
<div class="paragraph">
<p>If you look at the docs on hackage
<a href="http://hackage.haskell.org/package/parsec-3.1.3/docs/Text-Parsec-Char.html" class="bare">http://hackage.haskell.org/package/parsec-3.1.3/docs/Text-Parsec-Char.html</a>,
you can view the source. The implementations of most of the functions
in <code>Text.Parsec.Char</code> are straightforward. I recommend you look at the
source for all of these functions.</p>
</div>
<div class="paragraph">
<p>You can see in the source that the <code>satisfy</code> function is a little more
primitive than the other functions.</p>
</div>
<div class="paragraph">
<p>Here is the parser we used above in the <code>anyChar</code> parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>anyChar :: Parser Char</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you look at the source via the haddock link above, you can see it
uses <code>satisfy</code>.</p>
</div>
<div class="paragraph">
<p>Here are some other simple wrappers of <code>satisfy</code> from
<code>Text.Parsec.Char</code> which use different validation functions.</p>
</div>
<div class="paragraph">
<p>The <code>char</code> parser parses a specific character which you supply:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>char :: Char -&gt; Parser Char</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse (char 'a') "a"
Right 'a'

*Main&gt; regularParse (char 'a') "b"
Left (line 1, column 1):
unexpected "b"
expecting "a"</code></pre>
</div>
</div>
<div class="paragraph">
<p>These parsers all parse single hardcoded characters</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>space :: Parser Char
newline :: Parser Char
tab :: Parser Char</code></pre>
</div>
</div>
<div class="paragraph">
<p>They all return a <code>Char</code>. You might be able to guess what <code>Char</code> each
of them returns, you can double check your intuition using ghci.</p>
</div>
<div class="paragraph">
<p>These parser all parse one character from a hardcoded set of
characters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>upper :: Parser Char
lower :: Parser Char
alphaNum :: Parser Char
letter :: Parser Char
digit :: Parser Char
hexDigit :: Parser Char
octDigit :: Parser Char</code></pre>
</div>
</div>
<div class="paragraph">
<p>In these cases, the return value is less redundant.</p>
</div>
<div class="paragraph">
<p><code>oneOf</code> and <code>noneOf</code> parse any of the characters in the given list</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>oneOf :: [Char] -&gt; Parser Char
noneOf :: [Char] -&gt; Parser Char</code></pre>
</div>
</div>
<div class="paragraph">
<p>These are just simple wrappers of satisfy using <code>elem</code>.</p>
</div>
<div class="paragraph">
<p>You should try all these parsers out in ghci, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>regularParse space " "

regularParse upper "A"

regularParse (char 'b') "B"

regularParse (oneOf "abc") "c"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the final functions in <code>Text.Parsec.Char</code>:</p>
</div>
<div class="paragraph">
<p><code>string</code> matches a complete string, one character at a time. I think
the implementation of this function is like it is for efficiency when
parsing from, e.g., <code>Data.Text.Text</code>, instead of <code>String</code>, but I&#8217;m not
sure. We will skip the detailed explanation of the implementation for
now.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>string :: String -&gt; Parser String</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse (string "one") "one"
Right "one"

*Main&gt; regularParse (string "one") "two"
Left (line 1, column 1):
unexpected "t"
expecting "one"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the <code>spaces</code> parser, which, if you look at the source, you can
see uses a combinator (<code>skipMany</code>). We will cover this combinator
shortly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>spaces :: Parser ()</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse spaces ""
Right ()

*Main&gt; regularParse spaces " "
Right ()

*Main&gt; regularParse spaces "   "
Right ()

*Main&gt; regularParse spaces " a  "
Right ()

*Main&gt; regularParse spaces "a a  "
Right ()</code></pre>
</div>
</div>
<div class="paragraph">
<p>It always succeeds.</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_couple_of_helper_executables">2.4. A couple of helper executables</h3>
<div class="paragraph">
<p>Here are two exes which you can use to parse either a string or a file
to help you experiment. This will save you having to figure out how to
write this boilerplate until later.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/JakeWheat/intro_to_parsing/blob/master/ParseFile.lhs" class="bare">https://github.com/JakeWheat/intro_to_parsing/blob/master/ParseFile.lhs</a></p>
</div>
<div class="paragraph">
<p><a href="https://github.com/JakeWheat/intro_to_parsing/blob/master/ParseString.lhs" class="bare">https://github.com/JakeWheat/intro_to_parsing/blob/master/ParseString.lhs</a></p>
</div>
<div class="paragraph">
<p>Now you can easily experiment using ghci, or with a string on the
command line, or by putting the text to parse into a file and parsing
that.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="very-simple-expression-parsing">3. Very simple expression parsing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this tutorial we will develop a parser for a very simple expression
language, and start learning about the set of combinators which comes
with Parsec.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec</span> <span class="tok-p">(</span><span class="tok-kt">ParseError</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String</span> <span class="tok-p">(</span><span class="tok-kt">Parser</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Parsec</span> <span class="tok-p">(</span><span class="tok-nf">try</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Char</span> <span class="tok-p">(</span><span class="tok-nf">oneOf</span><span class="tok-p">,</span> <span class="tok-nf">char</span><span class="tok-p">,</span> <span class="tok-nf">digit</span><span class="tok-p">,</span> <span class="tok-nf">satisfy</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Combinator</span> <span class="tok-p">(</span><span class="tok-nf">many1</span><span class="tok-p">,</span> <span class="tok-nf">choice</span><span class="tok-p">,</span> <span class="tok-nf">chainl1</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Control.Applicative</span> <span class="tok-p">((</span><span class="tok-o">&lt;|&gt;</span><span class="tok-p">),</span> <span class="tok-nf">many</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Control.Monad</span> <span class="tok-p">(</span><span class="tok-nf">void</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Data.Char</span> <span class="tok-p">(</span><span class="tok-nf">isLetter</span><span class="tok-p">,</span> <span class="tok-nf">isDigit</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">FunctionsAndTypesForParsing</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_num">3.1. num</h3>
<div class="paragraph">
<p>The first element we will have in this expression language is positive
integral numbers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">numberExamples</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">Integer</span><span class="tok-p">)]</span>
<span class="tok-nf">numberExamples</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-s">&quot;1&quot;</span><span class="tok-p">,</span> <span class="tok-mi">1</span><span class="tok-p">)</span>
                 <span class="tok-p">,(</span><span class="tok-s">&quot;23&quot;</span><span class="tok-p">,</span> <span class="tok-mi">23</span><span class="tok-p">)]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: make examples with parsing failures for all of the example
scripts below?</p>
</div>
<div class="paragraph">
<p>To parse a number, we need to parse one or more digits, and then read
the resulting string. We can use the combinator <code>many1</code> to help with
this. We will also use do notation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">num</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Integer</span>
<span class="tok-nf">num</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">n</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">many1</span> <span class="tok-n">digit</span>
    <span class="tok-n">return</span> <span class="tok-p">(</span><span class="tok-n">read</span> <span class="tok-n">n</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try it out.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse num "1"
Right 1

*Main&gt; regularParse num "123456"
Right 123456

*Main&gt; regularParse num "aa"
Left (line 1, column 1):
unexpected "a"
expecting digit</code></pre>
</div>
</div>
<div class="paragraph">
<p>How does it work? First, we parse one or more (<code>many1</code>) digits (<code>digit</code>),
and give the result the name 'n'. Then we convert the string to an
integer using <code>read</code>.</p>
</div>
<div class="paragraph">
<p>The <code>many1</code> function&#8217;s type looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>many1 :: Parser a -&gt; Parser [a]</code></pre>
</div>
</div>
<div class="paragraph">
<p>It applies the parser given one or more times, returning the result.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s see what happens when we use the <code>many</code> combinator which parses
zero or more items instead of one or more.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">num1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Integer</span>
<span class="tok-nf">num1</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">n</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">many</span> <span class="tok-n">digit</span>
    <span class="tok-n">return</span> <span class="tok-p">(</span><span class="tok-n">read</span> <span class="tok-n">n</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse num1 "1"
Right 1

*Main&gt; regularParse num1 "123456"
Right 123456

*Main&gt; regularParse num1 "aa"
Right *** Exception: Prelude.read: no parse</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_var">3.2. var</h3>
<div class="paragraph">
<p>For var, we have to decide on a syntax for the identifiers. Let&#8217;s go
for a common choice: identifiers must start with a letter or
underscore, and then they can be followed by zero or more letters,
underscores or digits in any combination.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">varExamples</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">String</span><span class="tok-p">)]</span>
<span class="tok-nf">varExamples</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-s">&quot;test&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;test&quot;</span><span class="tok-p">)</span>
              <span class="tok-p">,(</span><span class="tok-s">&quot;_stuff&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;_stuff&quot;</span><span class="tok-p">)</span>
              <span class="tok-p">,(</span><span class="tok-s">&quot;_1234&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;_1234&quot;</span><span class="tok-p">)]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">var</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">var</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">fc</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">firstChar</span>
    <span class="tok-n">rest</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">many</span> <span class="tok-n">nonFirstChar</span>
    <span class="tok-n">return</span> <span class="tok-p">(</span><span class="tok-n">fc</span><span class="tok-kt">:</span><span class="tok-n">rest</span><span class="tok-p">)</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">firstChar</span> <span class="tok-ow">=</span> <span class="tok-n">satisfy</span> <span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">isLetter</span> <span class="tok-n">a</span> <span class="tok-o">||</span> <span class="tok-n">a</span> <span class="tok-o">==</span> <span class="tok-sc">&#39;_&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">nonFirstChar</span> <span class="tok-ow">=</span> <span class="tok-n">satisfy</span> <span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">isDigit</span> <span class="tok-n">a</span> <span class="tok-o">||</span> <span class="tok-n">isLetter</span> <span class="tok-n">a</span> <span class="tok-o">||</span> <span class="tok-n">a</span> <span class="tok-o">==</span> <span class="tok-sc">&#39;_&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This time, we create two helper parsers: <code>firstChar</code>, which parses a
letter or underscore, and <code>nonFirstChar</code> which parses a digit, letter
or underscore. This time, we use the <code>many</code> function instead of
<code>many1</code>.</p>
</div>
<div class="paragraph">
<p>Try it out in ghci. I like to try things which you expect to work, and
also to try things which you expect to not work and make sure you get
an error.</p>
</div>
</div>
<div class="sect2">
<h3 id="_parens">3.3. parens</h3>
<div class="paragraph">
<p>The parens parser will eventually parse any expression inside
parentheses. First it will just parse integers inside parentheses.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">data</span> <span class="tok-kt">Parentheses</span> <span class="tok-ow">=</span> <span class="tok-kt">Parentheses</span> <span class="tok-kt">Integer</span>
                   <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span><span class="tok-p">,</span><span class="tok-kt">Show</span><span class="tok-p">)</span>

<span class="tok-nf">parensExamples</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span> <span class="tok-kt">Parentheses</span><span class="tok-p">)]</span>
<span class="tok-nf">parensExamples</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-s">&quot;(1)&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Parentheses</span> <span class="tok-mi">1</span><span class="tok-p">)</span>
                 <span class="tok-p">,(</span><span class="tok-s">&quot;(17)&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Parentheses</span> <span class="tok-mi">17</span><span class="tok-p">)]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parens</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Parentheses</span>
<span class="tok-nf">parens</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;(&#39;</span>
    <span class="tok-n">e</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">many1</span> <span class="tok-n">digit</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;)&#39;</span>
    <span class="tok-n">return</span> <span class="tok-p">(</span><span class="tok-kt">Parentheses</span> <span class="tok-p">(</span><span class="tok-n">read</span> <span class="tok-n">e</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There is a new function: <code>void</code>. This might be familiar to you
already. This is used to ignore the result of the <code>char</code> parser, since
we are not interested in this value. You can also write the function
without <code>void</code>, but ghc will give you a warning if you have warnings
turned on.</p>
</div>
<div class="paragraph">
<p>One way of turning warnings on in ghci is to enter <code>:set -Wall</code> at the
ghci prompt.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parens&#39;</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Parentheses</span>
<span class="tok-nf">parens&#39;</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">char</span> <span class="tok-sc">&#39;(&#39;</span>
    <span class="tok-n">e</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">many1</span> <span class="tok-n">digit</span>
    <span class="tok-n">char</span> <span class="tok-sc">&#39;)&#39;</span>
    <span class="tok-n">return</span> <span class="tok-p">(</span><span class="tok-kt">Parentheses</span> <span class="tok-p">(</span><span class="tok-n">read</span> <span class="tok-n">e</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; :set -Wall
*Main&gt; :l "VerySimpleExpressions.lhs"

...

FirstRealParsing.lhs:140:7: Warning:
    A do-notation statement discarded a result of type Char.
    Suppress this warning by saying "_ &lt;- char '('",
    or by using the flag -fno-warn-unused-do-bind

FirstRealParsing.lhs:142:7: Warning:
    A do-notation statement discarded a result of type Char.
    Suppress this warning by saying "_ &lt;- char ')'",
    or by using the flag -fno-warn-unused-do-bind

...</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, another way to suppress the warning is to use
<code>_ &#8592; char '('</code>.</p>
</div>
<div class="paragraph">
<p>One issue with this parser is that it doesn&#8217;t handle whitespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse parens "(1)"
Right (Parentheses 1)

*Main&gt; regularParse parens "( 1)"
Left (line 1, column 2):
unexpected " "
expecting digit

*Main&gt; regularParse parens "(1 )"
Left (line 1, column 3):
unexpected " "
expecting digit or ")"</code></pre>
</div>
</div>
<div class="paragraph">
<p>We will look at this issue below.</p>
</div>
</div>
<div class="sect2">
<h3 id="_add">3.4. add</h3>
<div class="paragraph">
<p>Now we will write a little parser to parse strings like 'a+b' where a
and b are numbers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">data</span> <span class="tok-kt">SingleAdd</span> <span class="tok-ow">=</span> <span class="tok-kt">SingleAdd</span> <span class="tok-kt">Integer</span> <span class="tok-kt">Integer</span>
                 <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span><span class="tok-p">,</span><span class="tok-kt">Show</span><span class="tok-p">)</span>

<span class="tok-nf">singleAddExamples</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span> <span class="tok-kt">SingleAdd</span><span class="tok-p">)]</span>
<span class="tok-nf">singleAddExamples</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-s">&quot;1+2&quot;</span><span class="tok-p">,</span> <span class="tok-kt">SingleAdd</span> <span class="tok-mi">1</span> <span class="tok-mi">2</span><span class="tok-p">)</span>
                    <span class="tok-p">,(</span><span class="tok-s">&quot;101+202&quot;</span><span class="tok-p">,</span> <span class="tok-kt">SingleAdd</span> <span class="tok-mi">101</span> <span class="tok-mi">202</span><span class="tok-p">)]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">add</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SingleAdd</span>
<span class="tok-nf">add</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">e0</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">many1</span> <span class="tok-n">digit</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;+&#39;</span>
    <span class="tok-n">e1</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">many1</span> <span class="tok-n">digit</span>
    <span class="tok-n">return</span> <span class="tok-p">(</span><span class="tok-kt">SingleAdd</span> <span class="tok-p">(</span><span class="tok-n">read</span> <span class="tok-n">e0</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-n">read</span> <span class="tok-n">e1</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It has the same whitespace issues as the parens parser.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse add "1+2"
Right (SingleAdd 1 2)

*Main&gt; regularParse add "1 +2"
Left (line 1, column 2):
unexpected " "
expecting digit or "+"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_whitespace">3.5. whitespace</h3>
<div class="paragraph">
<p>Here is a parser which will skip zero or more whitespace characters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">whitespace</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span>
<span class="tok-nf">whitespace</span> <span class="tok-ow">=</span> <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">many</span> <span class="tok-o">$</span> <span class="tok-n">oneOf</span> <span class="tok-s">&quot; </span><span class="tok-se">\n\t</span><span class="tok-s">&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use this to make our parsers handle whitespace better.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse whitespace " "
Right ()
*Main&gt; regularParse whitespace "  "
Right ()
*Main&gt; regularParse whitespace "\t"
Right ()
*Main&gt; regularParse whitespace " \n "
Right ()
*Main&gt; regularParse whitespace ""
Right ()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that it always succeeds.</p>
</div>
<div class="paragraph">
<p>Here is the parens parser rewritten with a common approach to
whitespace handling:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parensW</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Parentheses</span>
<span class="tok-nf">parensW</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">whitespace</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;(&#39;</span>
    <span class="tok-n">whitespace</span>
    <span class="tok-n">e</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">many1</span> <span class="tok-n">digit</span>
    <span class="tok-n">whitespace</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;)&#39;</span>
    <span class="tok-n">whitespace</span>
    <span class="tok-n">return</span> <span class="tok-p">(</span><span class="tok-kt">Parentheses</span> <span class="tok-p">(</span><span class="tok-n">read</span> <span class="tok-n">e</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse parensW "(1)"
Right (Parentheses 1)

*Main&gt; regularParse parensW " (1)"
Right (Parentheses 1)

*Main&gt; regularParse parensW " (1 )"
Right (Parentheses 1)

*Main&gt; regularParse parensW " ( 1 ) "
Right (Parentheses 1)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Looks good.</p>
</div>
<div class="paragraph">
<p>In the original parsec documentation, one of the concepts mentioned is
the idea of 'lexeme' parsing. This is a style in which every token
parser should also consume and ignore any trailing whitespace.</p>
</div>
<div class="paragraph">
<p>This is a simple convention which with a bit of care allows skipping
whitespace exactly once wherever it needs to be skipped. To complete
the lexeme style, we should also always skip leading whitespace at the
top level only. This feels more elegant than spamming all the parsing
code with many calls to <code>whitespace</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">lexeme</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span>
<span class="tok-nf">lexeme</span> <span class="tok-n">p</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
           <span class="tok-n">x</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">p</span>
           <span class="tok-n">whitespace</span>
           <span class="tok-n">return</span> <span class="tok-n">x</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parseWithWhitespace</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Either</span> <span class="tok-kt">ParseError</span> <span class="tok-n">a</span>
<span class="tok-nf">parseWithWhitespace</span> <span class="tok-n">p</span> <span class="tok-ow">=</span> <span class="tok-n">parseWithEof</span> <span class="tok-n">wrapper</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">wrapper</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
        <span class="tok-n">whitespace</span>
        <span class="tok-n">p</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the parens parser rewritten to use lexeme:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parensL</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Parentheses</span>
<span class="tok-nf">parensL</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;(&#39;</span>
    <span class="tok-n">e</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">many1</span> <span class="tok-n">digit</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;)&#39;</span>
    <span class="tok-n">return</span> <span class="tok-p">(</span><span class="tok-kt">Parentheses</span> <span class="tok-p">(</span><span class="tok-n">read</span> <span class="tok-n">e</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithWhitespace parensL "(1)"
Right (Parentheses 1)

*Main&gt; parseWithWhitespace parensL " (1)"
Right (Parentheses 1)

*Main&gt; parseWithWhitespace parensL " ( 1)"
Right (Parentheses 1)

*Main&gt; parseWithWhitespace parensL " ( 1 ) "
Right (Parentheses 1)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>parseWithWhitespace</code> function can also use <code>(&gt;&gt;)</code> to make it a
bit shorter, <code>wrapper = whiteSpace &gt;&gt; p</code>.</p>
</div>
<div class="paragraph">
<p>Here is the shorter version of this function using <code>(&gt;&gt;)</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parseWithWhitespace&#39;</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Either</span> <span class="tok-kt">ParseError</span> <span class="tok-n">a</span>
<span class="tok-nf">parseWithWhitespace&#39;</span> <span class="tok-n">p</span> <span class="tok-ow">=</span> <span class="tok-n">parseWithEof</span> <span class="tok-p">(</span><span class="tok-n">whitespace</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-n">p</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Try rewriting the SingleAdd parser to use <code>lexeme</code>, and test it out to
convince yourself that it skips whitespace correctly.</p>
</div>
</div>
<div class="sect2">
<h3 id="_simple_expr">3.6. simple expr</h3>
<div class="paragraph">
<p>Now we are ready to write a parser which parses simple expressions
made from these components. Here is the data type for these
expressions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">data</span> <span class="tok-kt">SimpleExpr</span> <span class="tok-ow">=</span> <span class="tok-kt">Num</span> <span class="tok-kt">Integer</span>
                <span class="tok-o">|</span> <span class="tok-kt">Var</span> <span class="tok-kt">String</span>
                <span class="tok-o">|</span> <span class="tok-kt">Add</span> <span class="tok-kt">SimpleExpr</span> <span class="tok-kt">SimpleExpr</span>
                <span class="tok-o">|</span> <span class="tok-kt">Parens</span> <span class="tok-kt">SimpleExpr</span>
                  <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span><span class="tok-p">,</span><span class="tok-kt">Show</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s so simple that it is almost useless at the moment.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">simpleExprExamples</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">SimpleExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">simpleExprExamples</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Var</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;1&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Num</span> <span class="tok-mi">1</span><span class="tok-p">)</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;2 + 3&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Add</span> <span class="tok-p">(</span><span class="tok-kt">Num</span> <span class="tok-mi">2</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-kt">Num</span> <span class="tok-mi">3</span><span class="tok-p">))</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;(42)&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Parens</span> <span class="tok-p">(</span><span class="tok-kt">Num</span> <span class="tok-mi">42</span><span class="tok-p">))]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: some more complex examples</p>
</div>
<div class="paragraph">
<p>Here are all our component parsers with <code>lexeme</code>, and with the
<code>SimpleExpr</code> constructors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">numE</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">numE</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">n</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">many1</span> <span class="tok-n">digit</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Num</span> <span class="tok-o">$</span> <span class="tok-n">read</span> <span class="tok-n">n</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There doesn&#8217;t seem to be a unique obviously correct place to put the
lexeme call in the var parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">varE</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">varE</span> <span class="tok-ow">=</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-kr">do</span>
    <span class="tok-n">fc</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">firstChar</span>
    <span class="tok-n">rest</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">many</span> <span class="tok-n">nonFirstChar</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Var</span> <span class="tok-p">(</span><span class="tok-n">fc</span><span class="tok-kt">:</span><span class="tok-n">rest</span><span class="tok-p">)</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">firstChar</span> <span class="tok-ow">=</span> <span class="tok-n">satisfy</span> <span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">isLetter</span> <span class="tok-n">a</span> <span class="tok-o">||</span> <span class="tok-n">a</span> <span class="tok-o">==</span> <span class="tok-sc">&#39;_&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">nonFirstChar</span> <span class="tok-ow">=</span> <span class="tok-n">satisfy</span> <span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">isDigit</span> <span class="tok-n">a</span> <span class="tok-o">||</span> <span class="tok-n">isLetter</span> <span class="tok-n">a</span> <span class="tok-o">||</span> <span class="tok-n">a</span> <span class="tok-o">==</span> <span class="tok-sc">&#39;_&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an alternative, with the call to lexeme in a different place,
but gives effectively the same function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">varE&#39;</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">varE&#39;</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">fc</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">firstChar</span>
    <span class="tok-n">rest</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">many</span> <span class="tok-n">nonFirstChar</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Var</span> <span class="tok-p">(</span><span class="tok-n">fc</span><span class="tok-kt">:</span><span class="tok-n">rest</span><span class="tok-p">)</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">firstChar</span> <span class="tok-ow">=</span> <span class="tok-n">satisfy</span> <span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">isLetter</span> <span class="tok-n">a</span> <span class="tok-o">||</span> <span class="tok-n">a</span> <span class="tok-o">==</span> <span class="tok-sc">&#39;_&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">nonFirstChar</span> <span class="tok-ow">=</span> <span class="tok-n">satisfy</span> <span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">isDigit</span> <span class="tok-n">a</span> <span class="tok-o">||</span> <span class="tok-n">isLetter</span> <span class="tok-n">a</span> <span class="tok-o">||</span> <span class="tok-n">a</span> <span class="tok-o">==</span> <span class="tok-sc">&#39;_&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parensE</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">parensE</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;(&#39;</span>
    <span class="tok-n">e</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">many1</span> <span class="tok-n">digit</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;)&#39;</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Parens</span> <span class="tok-o">$</span> <span class="tok-kt">Num</span> <span class="tok-o">$</span> <span class="tok-n">read</span> <span class="tok-n">e</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the parens parser, we can reuse the <code>numE</code> parser like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parensE&#39;</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">parensE&#39;</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;(&#39;</span>
    <span class="tok-n">e</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">numE</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;)&#39;</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Parens</span> <span class="tok-n">e</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the add parser using <code>numE</code> also.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">addE</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">addE</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">e0</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">numE</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;+&#39;</span>
    <span class="tok-n">e1</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">numE</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Add</span> <span class="tok-n">e0</span> <span class="tok-n">e1</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_choice">3.6.1. choice</h4>
<div class="paragraph">
<p>To combine these, we can use an operator called <code>(&lt;|&gt;)</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">numOrVar</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">numOrVar</span> <span class="tok-ow">=</span> <span class="tok-n">numE</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">varE</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It tries the first parser, and it if fails (without consuming any
input), it tries the second parser. More about the 'consuming input'
concept later.</p>
</div>
<div class="paragraph">
<p>Here is another way to write the numOrVar parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">numOrVar&#39;</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">numOrVar&#39;</span> <span class="tok-ow">=</span> <span class="tok-n">choice</span> <span class="tok-p">[</span><span class="tok-n">numE</span><span class="tok-p">,</span><span class="tok-n">varE</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>choice</code> is just wrapper around <code>(&lt;|&gt;)</code>. You can choose which one to
use based on which is more readable in each particular case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithWhitespace numOrVar "a"
Right (Var "a")

*Main&gt; parseWithWhitespace numOrVar "1"
Right (Num 1)

*Main&gt; parseWithWhitespace numOrVar "!"
Left (line 1, column 1):
unexpected "!"
expecting digit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the first version of the simpleExpr parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">simpleExpr</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">simpleExpr</span> <span class="tok-ow">=</span> <span class="tok-n">numE</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">varE</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">addE</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">parensE</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithWhitespace simpleExpr "12"
Right (Num 12)

*Main&gt; parseWithWhitespace simpleExpr "aa"
Right (Var "aa")

*Main&gt; parseWithWhitespace simpleExpr "1+2"
Left (line 1, column 2):
unexpected '+'
expecting digit or end of input

*Main&gt; parseWithWhitespace simpleExpr "(1)"
Right (Parens (Num 1))

*Main&gt; parseWithWhitespace simpleExpr "(aa)"
Left (line 1, column 2):
unexpected "a"
expecting digit</code></pre>
</div>
</div>
<div class="paragraph">
<p>It works well for some of the parsers. One problem is that the <code>addE</code>
and <code>parensE</code> parsers don&#8217;t parse general expressions as the
components, but just <code>numE</code>. Another problem is that the <code>addE</code>
doesn&#8217;t work at all: the <code>numE</code> parser parses the first number, and
the <code>addE</code> parser is never tried. This is an example of <code>(&lt;|&gt;)</code> not
trying the second parser if the first parser succeeds, even if a later
alternative would consume more input or successfully parse the whole
input.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s try and rearrange the order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">simpleExpr1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">simpleExpr1</span> <span class="tok-ow">=</span> <span class="tok-n">addE</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">numE</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">varE</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">parensE</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithWhitespace simpleExpr1 "12"
Left (line 1, column 3):
unexpected end of input
expecting digit or "+"

*Main&gt; parseWithWhitespace simpleExpr1 "aa"
Right (Var "aa")

*Main&gt; parseWithWhitespace simpleExpr1 "1+2"
Right (Add (Num 1) (Num 2))

*Main&gt; parseWithWhitespace simpleExpr1 "(1)"
Right (Parens (Num 1))</code></pre>
</div>
</div>
<div class="paragraph">
<p>We swapped one problem for another. Let&#8217;s fix this using the <code>try</code>
function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">simpleExpr2</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">simpleExpr2</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-n">addE</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">numE</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">varE</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">parensE</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithWhitespace simpleExpr2 "12"
Right (Num 12)

*Main&gt; parseWithWhitespace simpleExpr2 "aa"
Right (Var "aa")

*Main&gt; parseWithWhitespace simpleExpr2 "1+2"
Right (Add (Num 1) (Num 2))

*Main&gt; parseWithWhitespace simpleExpr2 "(1)"
Right (Parens (Num 1))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now everything seems to work fine. The <code>try</code> function is very powerful
and easy to use, and can be used where in a more traditional parsing
approach you would have to use left factoring or something else.</p>
</div>
<div class="paragraph">
<p>The <code>try</code> function implements backtracking. When this is used with
<code>(&lt;|&gt;)</code>, it means that if the first parser fails, it will undo the
consumed input and carry on with the next option, instead of failing
completely. This works even if the <code>try</code> is nested deeply within the
first parser given to <code>(&lt;|&gt;)</code>.</p>
</div>
<div class="paragraph">
<p><code>try</code> has its downsides (some of which we will see later), and I
usually try to minimise its use or eliminate it completely. I found I
often got into a complete mess when I used <code>try</code> too much when writing
parsers for something a little tricky like SQL, and that although
doing some left-factoring appeared at first to be tedious and appeared
to make the code less readable, I eventually decided that for me it
made the code more readable since what was happening was more
transparent.</p>
</div>
<div class="paragraph">
<p>Now we are going to fix this parser to parse arbitrarily nested
expressions. In a way, the method used will roughly mean we are left
factoring the <code>numE</code> and <code>addE</code> common prefix.</p>
</div>
<div class="paragraph">
<p>Here is the naive implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parensE3</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">parensE3</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;(&#39;</span>
    <span class="tok-n">e</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">simpleExpr3</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;)&#39;</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Parens</span> <span class="tok-n">e</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">addE3</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">addE3</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">e0</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">simpleExpr3</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;+&#39;</span>
    <span class="tok-n">e1</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">simpleExpr3</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Add</span> <span class="tok-n">e0</span> <span class="tok-n">e1</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">simpleExpr3</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">simpleExpr3</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-n">addE3</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">numE</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">varE</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">parensE3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run this parser, it will enter an infinite loop, since
<code>simpleExpr3</code> and <code>addE3</code> will keep calling each other recursively
without making any progress.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithWhitespace simpleExpr3 "a+b"
  C-c Interrupted.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try without <code>add</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parensE4</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">parensE4</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;(&#39;</span>
    <span class="tok-n">e</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">simpleExpr4</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;)&#39;</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Parens</span> <span class="tok-n">e</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">simpleExpr4</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">simpleExpr4</span> <span class="tok-ow">=</span> <span class="tok-n">numE</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">varE</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">parensE4</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithWhitespace simpleExpr4 "a"
Right (Var "a")

*Main&gt; parseWithWhitespace simpleExpr4 "1"
Right (Num 1)

*Main&gt; parseWithWhitespace simpleExpr4 "(1)"
Right (Parens (Num 1))

*Main&gt; parseWithWhitespace simpleExpr4 "((a))"
Right (Parens (Parens (Var "a")))</code></pre>
</div>
</div>
<div class="paragraph">
<p>At least this part seems to work OK.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s try to stop the add parser from calling itself indirectly:</p>
</div>
<div class="paragraph">
<p>Here is a parameterized parens parser where we supply the nested
expression parser as an argument. This is used here to try to make the
code easier to follow and avoid rewriting this parser out again and
again in full.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parensEN</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">parensEN</span> <span class="tok-n">simpleExprImpl</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;(&#39;</span>
    <span class="tok-n">e</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">simpleExprImpl</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;)&#39;</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Parens</span> <span class="tok-n">e</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is a new parser, which parses expressions except add.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">term</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">term</span> <span class="tok-n">simpleExprImpl</span> <span class="tok-ow">=</span> <span class="tok-n">numE</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">varE</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">parensEN</span> <span class="tok-n">simpleExprImpl</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">term5</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">term5</span> <span class="tok-ow">=</span> <span class="tok-n">term</span> <span class="tok-n">term5</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">addE5</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">addE5</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">e0</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">term5</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;+&#39;</span>
    <span class="tok-n">e1</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">term5</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Add</span> <span class="tok-n">e0</span> <span class="tok-n">e1</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">simpleExpr5</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">simpleExpr5</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-n">addE5</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">term5</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithWhitespace simpleExpr5 "1"
Right (Num 1)

*Main&gt; parseWithWhitespace simpleExpr5 "a"
Right (Var "a")

*Main&gt; parseWithWhitespace simpleExpr5 "(a)"
Right (Parens (Var "a"))

*Main&gt; parseWithWhitespace simpleExpr5 "1+2"
Right (Add (Num 1) (Num 2))

*Main&gt; parseWithWhitespace simpleExpr5 "1+a"
Right (Add (Num 1) (Var "a"))

*Main&gt; parseWithWhitespace simpleExpr5 "(1+a)"
Right (Parens (Add (Num 1) (Var "a")))

*Main&gt; parseWithWhitespace simpleExpr5 "1+a+b"
Left (line 1, column 4):
unexpected '+'
expecting end of input</code></pre>
</div>
</div>
<div class="paragraph">
<p>Almost. Let&#8217;s see what happens when the second <code>term</code> in <code>add</code> is
changed to the general expression parser.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">term6</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">term6</span> <span class="tok-ow">=</span> <span class="tok-n">term</span> <span class="tok-n">simpleExpr6</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">addE6</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">addE6</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">e0</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">term6</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;+&#39;</span>
    <span class="tok-n">e1</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">simpleExpr6</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Add</span> <span class="tok-n">e0</span> <span class="tok-n">e1</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">simpleExpr6</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">simpleExpr6</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-n">addE6</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">term6</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithWhitespace simpleExpr6 "a + b + c"
Right (Add (Var "a") (Add (Var "b") (Var "c")))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Maybe it looks like we&#8217;ve made it. But there is a problem. We&#8217;ve
parsed the + operator as if it has right associativity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>a + b + c -&gt; a + (b + c)</code></pre>
</div>
</div>
<div class="paragraph">
<p>But it should be left associative:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>a + b + c -&gt; (a + b) + c</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s left factor the parsing and fix this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">term7</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">term7</span> <span class="tok-ow">=</span> <span class="tok-n">term</span> <span class="tok-n">simpleExpr7</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">simpleExpr7</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">simpleExpr7</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-c1">-- first parse a term</span>
    <span class="tok-n">e</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">term7</span>
    <span class="tok-c1">-- then see if it is followed by an &#39;+ expr&#39; suffix</span>
    <span class="tok-n">maybeAddSuffix</span> <span class="tok-n">e</span>
  <span class="tok-kr">where</span>
    <span class="tok-c1">-- this function takes an expression, and parses a</span>
    <span class="tok-c1">-- &#39;+ expr&#39; suffix, returning an Add expression</span>
    <span class="tok-c1">-- it recursively calls itself via the maybeAddSuffix function</span>
    <span class="tok-n">addSuffix</span> <span class="tok-n">e0</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
        <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;+&#39;</span>
        <span class="tok-n">e1</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">term7</span>
        <span class="tok-n">maybeAddSuffix</span> <span class="tok-p">(</span><span class="tok-kt">Add</span> <span class="tok-n">e0</span> <span class="tok-n">e1</span><span class="tok-p">)</span>
    <span class="tok-c1">-- this is the wrapper for addSuffix, which adapts it so that if</span>
    <span class="tok-c1">-- addSuffix fails, it returns just the original expression</span>
    <span class="tok-n">maybeAddSuffix</span> <span class="tok-n">e</span> <span class="tok-ow">=</span> <span class="tok-n">addSuffix</span> <span class="tok-n">e</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">return</span> <span class="tok-n">e</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithWhitespace simpleExpr7 "a + b + c"
Right (Add (Add (Var "a") (Var "b")) (Var "c"))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the parser seems to work for everything it should.</p>
</div>
<div class="paragraph">
<p>There is a combinator function in Parsec we can use which abstracts
this sort of pattern, <code>chainl1</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">simpleExpr8</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">simpleExpr8</span> <span class="tok-ow">=</span> <span class="tok-n">chainl1</span> <span class="tok-n">term8</span> <span class="tok-n">op</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">op</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
        <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;+&#39;</span>
        <span class="tok-n">return</span> <span class="tok-kt">Add</span>
    <span class="tok-n">term8</span> <span class="tok-ow">=</span> <span class="tok-n">term</span> <span class="tok-n">simpleExpr8</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>How does this work? Here is the type of <code>chainl1</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">chainl1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span>
<span class="tok-nf">chainl1</span> <span class="tok-n">term</span> <span class="tok-n">op</span> <span class="tok-ow">=</span> <span class="tok-o">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The type of the Add constructor in pseudocode is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kt">Add</span> <span class="tok-ow">::</span> <span class="tok-kt">SimpleExpr</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">SimpleExpr</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">SimpleExpr</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>op</code> parser here now just parses the operator itself, i.e. '+'
(and not the second expression like our simpleExpr7 parser). The
return from the <code>op</code> function is a function which accepts two elements
and combines them using the appropriate operator representation. In
this case, the represenation is the <code>Add</code> constructor.</p>
</div>
<div class="paragraph">
<p>You can look at the source
<a href="http://hackage.haskell.org/package/parsec-3.1.3/docs/src/Text-Parsec-Combinator.html#chainl1" class="bare">http://hackage.haskell.org/package/parsec-3.1.3/docs/src/Text-Parsec-Combinator.html#chainl1</a>
and see if you can understand how it works. If you can&#8217;t work it out,
you could come back to it later when you have more experience writing
parsing code.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_testing_with_the_examples">3.7. Testing with the examples</h3>
<div class="paragraph">
<p>TODO: write a little manual tester that accepts a parser and a list of
examples, and checks they all parse correctly.</p>
</div>
</div>
<div class="sect2">
<h3 id="_testing_with_quickcheck">3.8. Testing with quickcheck</h3>
<div class="paragraph">
<p>Let&#8217;s see if we can check with quickcheck. It&#8217;s a bit tricky testing
parsers in this way, but one way to do something useful is to generate
random asts, convert them to concrete syntax, parse them, and check
the result. We can write a simple 'pretty printer' to convert an ast
to concrete syntax.</p>
</div>
<div class="sect3">
<h4 id="_a_pretty_printer">3.8.1. a pretty printer</h4>
<div class="paragraph">
<p>TODO: a really simple pretty printer just pasting strings together, no
layout.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_quick_check_code">3.8.2. the quick check code</h4>
<div class="paragraph">
<p>TODO: write a quickcheck property and arbitary instance and show
running it at the ghci prompt</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="applicative-style-parsing-code">4. Applicative style parsing code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we can go back over the expression parsing code written in the
last tutorial, and make it much more concise, and also make it more
readable. We are going to do this mainly by using functions from the
typeclass Applicative.</p>
</div>
<div class="paragraph">
<p>Remember you can (and should) use the functions <code>regularParse</code> and its
variations (TODO list them here) to try out the all these parsers in
ghci, and you can write your own variations to experiment with if you
are unsure about anything.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String</span> <span class="tok-p">(</span><span class="tok-kt">Parser</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Char</span> <span class="tok-p">(</span><span class="tok-nf">oneOf</span><span class="tok-p">,</span> <span class="tok-nf">char</span><span class="tok-p">,</span> <span class="tok-nf">digit</span><span class="tok-p">,</span> <span class="tok-nf">letter</span><span class="tok-p">,</span> <span class="tok-nf">satisfy</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Combinator</span> <span class="tok-p">(</span><span class="tok-nf">many1</span><span class="tok-p">,</span> <span class="tok-nf">chainl1</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Control.Applicative</span> <span class="tok-p">((</span><span class="tok-o">&lt;$&gt;</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;*&gt;</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;*</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">*&gt;</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;|&gt;</span><span class="tok-p">),</span> <span class="tok-nf">many</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-o">&lt;$</span><span class="tok-p">))</span>
<span class="tok-kr">import</span> <span class="tok-nn">Control.Monad</span> <span class="tok-p">(</span><span class="tok-nf">void</span><span class="tok-p">,</span> <span class="tok-nf">ap</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Data.Char</span> <span class="tok-p">(</span><span class="tok-nf">isLetter</span><span class="tok-p">,</span> <span class="tok-nf">isDigit</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">FunctionsAndTypesForParsing</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the SimpleExpr type again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">data</span> <span class="tok-kt">SimpleExpr</span> <span class="tok-ow">=</span> <span class="tok-kt">Num</span> <span class="tok-kt">Integer</span>
                <span class="tok-o">|</span> <span class="tok-kt">Var</span> <span class="tok-kt">String</span>
                <span class="tok-o">|</span> <span class="tok-kt">Add</span> <span class="tok-kt">SimpleExpr</span> <span class="tok-kt">SimpleExpr</span>
                <span class="tok-o">|</span> <span class="tok-kt">Parens</span> <span class="tok-kt">SimpleExpr</span>
                  <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span><span class="tok-p">,</span><span class="tok-kt">Show</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the basic pattern behind most of the rewrites we are going to
cover. Here is a function which takes a constructor and two parsers
for the two arguments for the constructor. It parses the two
arguments, then applies the constructor to the results:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">myParser1</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">c</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">c</span>
<span class="tok-nf">myParser1</span> <span class="tok-n">ctor</span> <span class="tok-n">pa</span> <span class="tok-n">pb</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">a</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">pa</span>
    <span class="tok-n">b</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">pb</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-n">ctor</span> <span class="tok-n">a</span> <span class="tok-n">b</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: concrete example, plus examples at the bottom of this section
(for ctor &lt;$&gt; a, ctor &lt;$&gt; a &lt;*&gt; b, ctor &lt;$&gt; a &lt;*&gt; b &lt;*&gt; c).</p>
</div>
<div class="paragraph">
<p>This can be rewritten without the do syntactic sugar like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">myParser2</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">c</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">c</span>
<span class="tok-nf">myParser2</span> <span class="tok-n">ctor</span> <span class="tok-n">pa</span> <span class="tok-n">pb</span> <span class="tok-ow">=</span>
    <span class="tok-n">pa</span> <span class="tok-o">&gt;&gt;=</span> <span class="tok-nf">\</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">pb</span> <span class="tok-o">&gt;&gt;=</span> <span class="tok-nf">\</span><span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-n">ctor</span> <span class="tok-n">a</span> <span class="tok-n">b</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And can also be rewritten like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">myParser3</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">c</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">c</span>
<span class="tok-nf">myParser3</span> <span class="tok-n">ctor</span> <span class="tok-n">pa</span> <span class="tok-n">pb</span> <span class="tok-ow">=</span> <span class="tok-n">ctor</span> <span class="tok-p">`</span><span class="tok-n">fmap</span><span class="tok-p">`</span> <span class="tok-n">pa</span> <span class="tok-p">`</span><span class="tok-n">ap</span><span class="tok-p">`</span> <span class="tok-n">pb</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(This uses functions from Applicative instead of Monad.) We replace
the use of <code>&gt;&gt;=</code> with <code>fmap</code> and <code>ap</code>. This isn&#8217;t always possible, but
it often is.</p>
</div>
<div class="paragraph">
<p>Here is the version using the operators for <code>fmap</code> and <code>ap</code> (<code>fmap</code>
changed to <code>&lt;$&gt;</code>, and <code>ap</code> changed to <code>&lt;*&gt;</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">myParser4</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">c</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">c</span>
<span class="tok-nf">myParser4</span> <span class="tok-n">ctor</span> <span class="tok-n">pa</span> <span class="tok-n">pb</span> <span class="tok-ow">=</span> <span class="tok-n">ctor</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">pa</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">pb</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This style takes less typing, and is often much simpler to write and
read.</p>
</div>
<div class="paragraph">
<p>This pattern 'scales', you can use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>Ctor &lt;$&gt; pa</code></pre>
</div>
</div>
<div class="paragraph">
<p>for a single argument constructor. This might also be familiar to you
as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>fmap Ctor pa</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>Ctor `fmap` pa</code></pre>
</div>
</div>
<div class="paragraph">
<p>All of which mean the same thing, just slightly different spellings.</p>
</div>
<div class="paragraph">
<p>This can also be written using Monad operators:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>pa &gt;&gt;= liftM ctor</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>liftM ctor =&lt;&lt; pa</code></pre>
</div>
</div>
<div class="paragraph">
<p>(<code>liftM</code> is in the module <code>Control.Monad</code>)</p>
</div>
<div class="paragraph">
<p>These <code>liftM</code> versions effectively mean the same thing as the previous
versions with <code>fmap</code> and <code>&lt;$&gt;</code>.</p>
</div>
<div class="paragraph">
<p>You can use</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>Ctor &lt;$&gt; pa &lt;*&gt; pb &lt;*&gt; pc</code></pre>
</div>
</div>
<div class="paragraph">
<p>for three args, and so on. So you use <code>&lt;$&gt;</code> between the pure
constructor and the first arg, then <code>&lt;*&gt;</code> between each subsequent arg.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s go over the simple expression parsers and try to rewrite them
using this style. We will see a few other new functions. I will break
things down into a lot of steps.</p>
</div>
<div class="sect2">
<h3 id="_lexeme">4.1. lexeme</h3>
<div class="paragraph">
<p>Here is the old lexeme parser, 'D' suffix for 'do notation'.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">lexemeD</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span>
<span class="tok-nf">lexemeD</span> <span class="tok-n">p</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
           <span class="tok-n">x</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">p</span>
           <span class="tok-n">whitespace</span>
           <span class="tok-n">return</span> <span class="tok-n">x</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">whitespace</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span>
<span class="tok-nf">whitespace</span> <span class="tok-ow">=</span> <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">many</span> <span class="tok-o">$</span> <span class="tok-n">oneOf</span> <span class="tok-s">&quot; </span><span class="tok-se">\n\t</span><span class="tok-s">&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>First, we can move the <code>whitespace</code> from its own separate line.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">lexemeA0</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span>
<span class="tok-nf">lexemeA0</span> <span class="tok-n">p</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
           <span class="tok-n">x</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">p</span> <span class="tok-o">&lt;*</span> <span class="tok-n">whitespace</span>
           <span class="tok-n">return</span> <span class="tok-n">x</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The expression <code>pa &lt;* pb</code> means run <code>pa</code>, then run <code>pb</code>, and return
the result of <code>pa</code>. It is sort of equivalent to this code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-p">(</span><span class="tok-o">&lt;*</span><span class="tok-p">)</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">b</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span>
<span class="tok-p">(</span><span class="tok-o">&lt;*</span><span class="tok-p">)</span> <span class="tok-n">pa</span> <span class="tok-n">pb</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">a</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">pa</span>
    <span class="tok-n">void</span> <span class="tok-n">pb</span>
    <span class="tok-n">return</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(It isn&#8217;t implemented this way, since <code>(&lt;*)</code> only needs Applicative
and not Monad.)</p>
</div>
<div class="paragraph">
<p>Now we can use the usual monad syntax rewrites, first eliminate the
name <code>x</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">lexemeA1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span>
<span class="tok-nf">lexemeA1</span> <span class="tok-n">p</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
             <span class="tok-n">p</span> <span class="tok-o">&lt;*</span> <span class="tok-n">whitespace</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now remove the redundant do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">lexemeA</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span>
<span class="tok-nf">lexemeA</span> <span class="tok-n">p</span> <span class="tok-ow">=</span> <span class="tok-n">p</span> <span class="tok-o">&lt;*</span> <span class="tok-n">whitespace</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_num_2">4.2. num</h3>
<div class="paragraph">
<p>Now let&#8217;s tackle the <code>num</code> parser.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">numD</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">numD</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">n</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">lexemeD</span> <span class="tok-o">$</span> <span class="tok-n">many1</span> <span class="tok-n">digit</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Num</span> <span class="tok-o">$</span> <span class="tok-n">read</span> <span class="tok-n">n</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s move 'read' to the first line.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">numA0</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">numA0</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">n</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">read</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">lexemeA</span> <span class="tok-p">(</span><span class="tok-n">many1</span> <span class="tok-n">digit</span><span class="tok-p">)</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Num</span> <span class="tok-n">n</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This uses <code>(&lt;$&gt;)</code> which we saw above. You may have done code rewrites
like this using <code>fmap</code> with IO in other Haskell code.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s move the <code>Num</code> ctor as well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">numA1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">numA1</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">n</span> <span class="tok-ow">&lt;-</span> <span class="tok-p">(</span><span class="tok-kt">Num</span> <span class="tok-o">.</span> <span class="tok-n">read</span><span class="tok-p">)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">lexemeA</span> <span class="tok-p">(</span><span class="tok-n">many1</span> <span class="tok-n">digit</span><span class="tok-p">)</span>
    <span class="tok-n">return</span> <span class="tok-n">n</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also write it in this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">numA2</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">numA2</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">n</span> <span class="tok-ow">&lt;-</span> <span class="tok-kt">Num</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">read</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">lexemeA</span> <span class="tok-p">(</span><span class="tok-n">many1</span> <span class="tok-n">digit</span><span class="tok-p">)</span>
    <span class="tok-n">return</span> <span class="tok-n">n</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Why does this work? It it equivalent to the previous version partly
because of the applicative laws.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s break it down:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">numA2&#39;&#39;</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">numA2&#39;&#39;</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">n</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">numb</span>
    <span class="tok-n">return</span> <span class="tok-n">n</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">numb</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
    <span class="tok-n">numb</span> <span class="tok-ow">=</span> <span class="tok-kt">Num</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">int</span>
    <span class="tok-n">int</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Integer</span>
    <span class="tok-n">int</span> <span class="tok-ow">=</span> <span class="tok-n">read</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">lexemeA</span> <span class="tok-p">(</span><span class="tok-n">many1</span> <span class="tok-n">digit</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In terms of style, which do you think looks better:
<code>(a . b) &lt;$&gt; p</code> or <code>a &lt;$&gt; b &lt;$&gt; p</code>.</p>
</div>
<div class="paragraph">
<p>The next step for num, we can eliminate the temporary name <code>n</code> and the
<code>do</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">numA3</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">numA3</span> <span class="tok-ow">=</span> <span class="tok-p">(</span><span class="tok-kt">Num</span> <span class="tok-o">.</span> <span class="tok-n">read</span><span class="tok-p">)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">lexemeA</span> <span class="tok-p">(</span><span class="tok-n">many1</span> <span class="tok-n">digit</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In more 'industrial' parser code, I would usually write some
tokenization parsers separately like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">integerA4</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Integer</span>
<span class="tok-nf">integerA4</span> <span class="tok-ow">=</span> <span class="tok-n">read</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">lexemeA</span> <span class="tok-p">(</span><span class="tok-n">many1</span> <span class="tok-n">digit</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then the num expression parser looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">numA4</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">numA4</span> <span class="tok-ow">=</span> <span class="tok-kt">Num</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">integerA4</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and we also get a integer parser which we can reuse if we need to
parse an integer in another context.</p>
</div>
</div>
<div class="sect2">
<h3 id="_var_2">4.3. var</h3>
<div class="paragraph">
<p>Here is the previous var parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">varD</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">varD</span> <span class="tok-ow">=</span> <span class="tok-n">lexemeA</span> <span class="tok-o">$</span> <span class="tok-kr">do</span>
    <span class="tok-n">fc</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">firstChar</span>
    <span class="tok-n">rest</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">many</span> <span class="tok-n">nonFirstChar</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Var</span> <span class="tok-p">(</span><span class="tok-n">fc</span><span class="tok-kt">:</span><span class="tok-n">rest</span><span class="tok-p">)</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">firstChar</span> <span class="tok-ow">=</span> <span class="tok-n">satisfy</span> <span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">isLetter</span> <span class="tok-n">a</span> <span class="tok-o">||</span> <span class="tok-n">a</span> <span class="tok-o">==</span> <span class="tok-sc">&#39;_&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">nonFirstChar</span> <span class="tok-ow">=</span> <span class="tok-n">satisfy</span> <span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">isDigit</span> <span class="tok-n">a</span> <span class="tok-o">||</span> <span class="tok-n">isLetter</span> <span class="tok-n">a</span> <span class="tok-o">||</span> <span class="tok-n">a</span> <span class="tok-o">==</span> <span class="tok-sc">&#39;_&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first thing we can do is to make the <code>firstChar</code> and
<code>nonFirstChar</code> a little easier to read, using <code>(&lt;|&gt;)</code>, <code>char</code>,
<code>letter</code> and <code>digit</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">varA0</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">varA0</span> <span class="tok-ow">=</span> <span class="tok-n">lexemeA</span> <span class="tok-o">$</span> <span class="tok-kr">do</span>
    <span class="tok-n">fl</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">firstChar</span>
    <span class="tok-n">rest</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">many</span> <span class="tok-n">nonFirstChar</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Var</span> <span class="tok-p">(</span><span class="tok-n">fl</span><span class="tok-kt">:</span><span class="tok-n">rest</span><span class="tok-p">)</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">firstChar</span> <span class="tok-ow">=</span> <span class="tok-n">letter</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;_&#39;</span>
    <span class="tok-n">nonFirstChar</span> <span class="tok-ow">=</span> <span class="tok-n">digit</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">firstChar</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is another way of making the function a little better:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">varA0&#39;</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">varA0&#39;</span> <span class="tok-ow">=</span> <span class="tok-n">lexemeA</span> <span class="tok-o">$</span> <span class="tok-kr">do</span>
    <span class="tok-n">fl</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">satisfy</span> <span class="tok-n">validFirstChar</span>
    <span class="tok-n">rest</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">many</span> <span class="tok-p">(</span><span class="tok-n">satisfy</span> <span class="tok-n">validNonFirstChar</span><span class="tok-p">)</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Var</span> <span class="tok-p">(</span><span class="tok-n">fl</span><span class="tok-kt">:</span><span class="tok-n">rest</span><span class="tok-p">)</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">validFirstChar</span> <span class="tok-n">a</span> <span class="tok-ow">=</span> <span class="tok-n">isLetter</span> <span class="tok-n">a</span> <span class="tok-o">||</span> <span class="tok-n">a</span> <span class="tok-o">==</span> <span class="tok-sc">&#39;_&#39;</span>
    <span class="tok-n">validNonFirstChar</span> <span class="tok-n">a</span> <span class="tok-ow">=</span> <span class="tok-n">validFirstChar</span> <span class="tok-n">a</span> <span class="tok-o">||</span> <span class="tok-n">isDigit</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can lift the <code>(:)</code> using the Applicative operators.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">varA1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">varA1</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">i</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">iden</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Var</span> <span class="tok-n">i</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">iden</span> <span class="tok-ow">=</span> <span class="tok-n">lexemeA</span> <span class="tok-p">((</span><span class="tok-kt">:</span><span class="tok-p">)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">firstChar</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">many</span> <span class="tok-n">nonFirstChar</span><span class="tok-p">)</span>
    <span class="tok-n">firstChar</span> <span class="tok-ow">=</span> <span class="tok-n">letter</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;_&#39;</span>
    <span class="tok-n">nonFirstChar</span> <span class="tok-ow">=</span> <span class="tok-n">digit</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">firstChar</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We used the prefix version of <code>(:)</code> to use it with <code>(&lt;$&gt;)</code> and
<code>(&lt;*&gt;)</code>. The lexemeA call was moved to the <code>iden</code> helper function.</p>
</div>
<div class="paragraph">
<p>Now tidy it up using <code>(&lt;$&gt;)</code> with the <code>Var</code> constructor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">varA2</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">varA2</span> <span class="tok-ow">=</span> <span class="tok-kt">Var</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">iden</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">iden</span> <span class="tok-ow">=</span> <span class="tok-n">lexemeA</span> <span class="tok-p">((</span><span class="tok-kt">:</span><span class="tok-p">)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">firstChar</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">many</span> <span class="tok-n">nonFirstChar</span><span class="tok-p">)</span>
    <span class="tok-n">firstChar</span> <span class="tok-ow">=</span> <span class="tok-n">letter</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;_&#39;</span>
    <span class="tok-n">nonFirstChar</span> <span class="tok-ow">=</span> <span class="tok-n">digit</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">firstChar</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We could also split the <code>iden</code> into a separate top level function,
with the same idea as with splitting the <code>integer</code> parser.</p>
</div>
</div>
<div class="sect2">
<h3 id="_parens_2">4.4. parens</h3>
<div class="paragraph">
<p>Here is the starting point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parensD</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">parensD</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexemeA</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;(&#39;</span>
    <span class="tok-n">e</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">simpleExprD</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexemeA</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;)&#39;</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Parens</span> <span class="tok-n">e</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the rewrite in one step:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parensA0</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">parensA0</span> <span class="tok-ow">=</span>
    <span class="tok-kt">Parens</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-p">(</span><span class="tok-n">lexemeA</span> <span class="tok-p">(</span><span class="tok-n">char</span> <span class="tok-sc">&#39;(&#39;</span><span class="tok-p">)</span>
                <span class="tok-o">*&gt;</span> <span class="tok-n">simpleExprD</span>
                <span class="tok-o">&lt;*</span> <span class="tok-n">lexemeA</span> <span class="tok-p">(</span><span class="tok-n">char</span> <span class="tok-sc">&#39;)&#39;</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here you can see that there is a <code>(*&gt;)</code> which works in the opposite
direction to <code>(&lt;*)</code>. The precendence of these operators means that we
have to use some extra parentheses (!) here.</p>
</div>
<div class="paragraph">
<p>TODO: lost the chained &lt;*. Put something below about this so there is
a concrete example.</p>
</div>
</div>
<div class="sect2">
<h3 id="_simple_expr_2">4.5. simple expr</h3>
<div class="paragraph">
<p>Here is the old version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">termD</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">termD</span> <span class="tok-ow">=</span> <span class="tok-n">numD</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">varD</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">parensD</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">simpleExprD</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">simpleExprD</span> <span class="tok-ow">=</span> <span class="tok-n">chainl1</span> <span class="tok-n">termD</span> <span class="tok-n">op</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">op</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
         <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexemeA</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;+&#39;</span>
         <span class="tok-n">return</span> <span class="tok-kt">Add</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can simplify the <code>op</code> function using the techniques we&#8217;ve already
seen:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">simpleExprA0</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">simpleExprA0</span> <span class="tok-ow">=</span> <span class="tok-n">chainl1</span> <span class="tok-n">termD</span> <span class="tok-n">op</span>
  <span class="tok-kr">where</span> <span class="tok-n">op</span> <span class="tok-ow">=</span> <span class="tok-n">lexemeA</span> <span class="tok-p">(</span><span class="tok-n">char</span> <span class="tok-sc">&#39;+&#39;</span><span class="tok-p">)</span> <span class="tok-o">*&gt;</span> <span class="tok-n">return</span> <span class="tok-kt">Add</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The pattern <code>p *&gt; return f</code> can use a different operator like this:
<code>f &lt;$ p</code>. Here it is in the expression parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">simpleExprA1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">simpleExprA1</span> <span class="tok-ow">=</span> <span class="tok-n">chainl1</span> <span class="tok-n">termD</span> <span class="tok-n">op</span>
  <span class="tok-kr">where</span> <span class="tok-n">op</span> <span class="tok-ow">=</span> <span class="tok-kt">Add</span> <span class="tok-o">&lt;$</span> <span class="tok-n">lexemeA</span> <span class="tok-p">(</span><span class="tok-n">char</span> <span class="tok-sc">&#39;+&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You could also write the <code>op</code> parser inline:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">simpleExprA2</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">simpleExprA2</span> <span class="tok-ow">=</span> <span class="tok-n">chainl1</span> <span class="tok-n">termD</span> <span class="tok-p">(</span><span class="tok-kt">Add</span> <span class="tok-o">&lt;$</span> <span class="tok-n">lexemeA</span> <span class="tok-p">(</span><span class="tok-n">char</span> <span class="tok-sc">&#39;+&#39;</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maybe this last step makes it less readable?</p>
</div>
</div>
<div class="sect2">
<h3 id="_summary">4.6. summary</h3>
<div class="paragraph">
<p>Here is the finished job for all the simple expression code without
separate token parsers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">num&#39;</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">num&#39;</span> <span class="tok-ow">=</span> <span class="tok-p">(</span><span class="tok-kt">Num</span> <span class="tok-o">.</span> <span class="tok-n">read</span><span class="tok-p">)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">lexemeA</span> <span class="tok-p">(</span><span class="tok-n">many1</span> <span class="tok-n">digit</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">var&#39;</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">var&#39;</span> <span class="tok-ow">=</span> <span class="tok-kt">Var</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">iden</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">iden</span> <span class="tok-ow">=</span> <span class="tok-n">lexemeA</span> <span class="tok-p">((</span><span class="tok-kt">:</span><span class="tok-p">)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">firstChar</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">many</span> <span class="tok-n">nonFirstChar</span><span class="tok-p">)</span>
    <span class="tok-n">firstChar</span> <span class="tok-ow">=</span> <span class="tok-n">letter</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;_&#39;</span>
    <span class="tok-n">nonFirstChar</span> <span class="tok-ow">=</span> <span class="tok-n">digit</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">firstChar</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parens&#39;</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">parens&#39;</span> <span class="tok-ow">=</span>
    <span class="tok-kt">Parens</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-p">(</span><span class="tok-n">lexemeA</span> <span class="tok-p">(</span><span class="tok-n">char</span> <span class="tok-sc">&#39;(&#39;</span><span class="tok-p">)</span>
                <span class="tok-o">*&gt;</span> <span class="tok-n">simpleExpr&#39;</span>
                <span class="tok-o">&lt;*</span> <span class="tok-n">lexemeA</span> <span class="tok-p">(</span><span class="tok-n">char</span> <span class="tok-sc">&#39;)&#39;</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">term&#39;</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">term&#39;</span> <span class="tok-ow">=</span> <span class="tok-n">num&#39;</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">var&#39;</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">parens&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">simpleExpr&#39;</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">simpleExpr&#39;</span> <span class="tok-ow">=</span> <span class="tok-n">chainl1</span> <span class="tok-n">term&#39;</span> <span class="tok-n">op</span>
  <span class="tok-kr">where</span> <span class="tok-n">op</span> <span class="tok-ow">=</span> <span class="tok-kt">Add</span> <span class="tok-o">&lt;$</span> <span class="tok-n">lexemeA</span> <span class="tok-p">(</span><span class="tok-n">char</span> <span class="tok-sc">&#39;+&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here they are with separate token parsers and a helper function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">lexeme</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span>
<span class="tok-nf">lexeme</span> <span class="tok-n">p</span> <span class="tok-ow">=</span> <span class="tok-n">p</span> <span class="tok-o">&lt;*</span> <span class="tok-n">whitespace</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">identifier</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">identifier</span> <span class="tok-ow">=</span> <span class="tok-n">lexeme</span> <span class="tok-p">((</span><span class="tok-kt">:</span><span class="tok-p">)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">firstChar</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">many</span> <span class="tok-n">nonFirstChar</span><span class="tok-p">)</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">firstChar</span> <span class="tok-ow">=</span> <span class="tok-n">letter</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;_&#39;</span>
    <span class="tok-n">nonFirstChar</span> <span class="tok-ow">=</span> <span class="tok-n">digit</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">firstChar</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">integer</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Integer</span>
<span class="tok-nf">integer</span> <span class="tok-ow">=</span> <span class="tok-n">read</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">lexeme</span> <span class="tok-p">(</span><span class="tok-n">many1</span> <span class="tok-n">digit</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is a lexeme wrapper for parsing single character symbols.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">symbol</span> <span class="tok-ow">::</span> <span class="tok-kt">Char</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span>
<span class="tok-nf">symbol</span> <span class="tok-n">c</span> <span class="tok-ow">=</span> <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-n">c</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is another little helper function. It barely pays its way in this
short example, but even though it is only used once, I think it is
worth it to make the code clearer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">betweenParens</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span>
<span class="tok-nf">betweenParens</span> <span class="tok-n">p</span> <span class="tok-ow">=</span> <span class="tok-n">symbol</span> <span class="tok-sc">&#39;(&#39;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">p</span> <span class="tok-o">&lt;*</span> <span class="tok-n">symbol</span> <span class="tok-sc">&#39;)&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the expression parsers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">num</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">num</span> <span class="tok-ow">=</span> <span class="tok-kt">Num</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">integer</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">var</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">var</span> <span class="tok-ow">=</span> <span class="tok-kt">Var</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">identifier</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parens</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">parens</span> <span class="tok-ow">=</span> <span class="tok-kt">Parens</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">betweenParens</span> <span class="tok-n">simpleExpr</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">term</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">term</span> <span class="tok-ow">=</span> <span class="tok-n">num</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">var</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">parens</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">simpleExpr</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">simpleExpr</span> <span class="tok-ow">=</span> <span class="tok-n">chainl1</span> <span class="tok-n">term&#39;</span> <span class="tok-n">op</span>
  <span class="tok-kr">where</span> <span class="tok-n">op</span> <span class="tok-ow">=</span> <span class="tok-kt">Add</span> <span class="tok-o">&lt;$</span> <span class="tok-n">lexemeA</span> <span class="tok-p">(</span><span class="tok-n">char</span> <span class="tok-sc">&#39;+&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Splitting the lexer parser layer out means that we have one place
where we have to remember to add <code>lexeme</code> wrappers, and also I think
makes the code easier to follow.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="combinator-review">5. Combinator review</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this tutorial we will go through all the functions in
Text.Parsec.Combinator, and some useful ones in Control.Applicative
and Control.Monad as well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec</span> <span class="tok-p">(</span><span class="tok-kt">ParseError</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String</span> <span class="tok-p">(</span><span class="tok-kt">Parser</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Parsec</span> <span class="tok-p">(</span><span class="tok-nf">try</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Char</span> <span class="tok-p">(</span><span class="tok-nf">oneOf</span><span class="tok-p">,</span> <span class="tok-nf">char</span><span class="tok-p">,</span> <span class="tok-nf">digit</span>
                               <span class="tok-p">,</span><span class="tok-nf">string</span><span class="tok-p">,</span> <span class="tok-nf">letter</span><span class="tok-p">,</span> <span class="tok-nf">satisfy</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Combinator</span> <span class="tok-p">(</span><span class="tok-nf">many1</span><span class="tok-p">,</span> <span class="tok-nf">choice</span><span class="tok-p">,</span> <span class="tok-nf">chainl1</span><span class="tok-p">,</span> <span class="tok-nf">between</span>
                                     <span class="tok-p">,</span><span class="tok-nf">count</span><span class="tok-p">,</span> <span class="tok-nf">option</span><span class="tok-p">,</span> <span class="tok-nf">optionMaybe</span><span class="tok-p">,</span> <span class="tok-nf">optional</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Control.Applicative</span> <span class="tok-p">((</span><span class="tok-o">&lt;$&gt;</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;*&gt;</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;$</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;*</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">*&gt;</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;|&gt;</span><span class="tok-p">),</span> <span class="tok-nf">many</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Control.Monad</span> <span class="tok-p">(</span><span class="tok-nf">void</span><span class="tok-p">,</span> <span class="tok-nf">ap</span><span class="tok-p">,</span> <span class="tok-nf">mzero</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Data.Char</span> <span class="tok-p">(</span><span class="tok-nf">isLetter</span><span class="tok-p">,</span> <span class="tok-nf">isDigit</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">FunctionsAndTypesForParsing</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_text_parsec_combinator">5.1. Text.Parsec.Combinator</h3>
<div class="paragraph">
<p>You should look at the source for these functions and try to
understand how they are implemented.</p>
</div>
<div class="paragraph">
<p><a href="http://hackage.haskell.org/package/parsec-3.1.3/docs/src/Text-Parsec-Combinator.html" class="bare">http://hackage.haskell.org/package/parsec-3.1.3/docs/src/Text-Parsec-Combinator.html</a></p>
</div>
<div class="paragraph">
<p>The style of the source code in the Parsec library sources is a little
different to what we used at the end of the last tutorial. You can try
reimplementing each of the Text.Parsec.Combinator module functions
using the Applicative style. See if you can find a way to reassure
yourself that the rewritten versions you make are correct, perhaps via
writing automated tests, or perhaps some other method.</p>
</div>
<div class="paragraph">
<p>You should be able to easily understand the implementation of all the
functions in Text.Parsec.Combinator except possibly <code>anyToken</code> and
<code>notFollowedBy</code>.</p>
</div>
<div class="sect3">
<h4 id="_choice_2">5.1.1. choice</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">choice</span> <span class="tok-ow">::</span> <span class="tok-p">[</span><span class="tok-kt">Parser</span> <span class="tok-n">a</span><span class="tok-p">]</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>choice ps</code> tries to apply the parsers in the list <code>ps</code> in order,
until one of them succeeds. It returns the value of the succeeding
parser.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">a</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Char</span>
<span class="tok-nf">a</span> <span class="tok-ow">=</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;a&#39;</span>

<span class="tok-nf">b</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Char</span>
<span class="tok-nf">b</span> <span class="tok-ow">=</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;b&#39;</span>

<span class="tok-nf">aOrB</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Char</span>
<span class="tok-nf">aOrB</span> <span class="tok-ow">=</span> <span class="tok-n">choice</span> <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">,</span><span class="tok-n">b</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse aOrB "a"
Right 'a'

*Main&gt; regularParse aOrB "b"
Right 'b'

*Main&gt; regularParse aOrB "c"
Left (line 1, column 1):
unexpected "c"
expecting "a" or "b"</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_using_with_try">using with try</h5>
<div class="paragraph">
<p>If a parser fails with <code>(&lt;|&gt;)</code> or <code>choice</code>, then it will only try the
next parser if the last parser consumed no input.</p>
</div>
<div class="paragraph">
<p>TODO: make the parsers return the keyword and update the examples</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">byKeyword</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span>
<span class="tok-nf">byKeyword</span> <span class="tok-ow">=</span> <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">string</span> <span class="tok-s">&quot;by&quot;</span>

<span class="tok-nf">betweenKeyword</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span>
<span class="tok-nf">betweenKeyword</span> <span class="tok-ow">=</span> <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">string</span> <span class="tok-s">&quot;between&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since both of these have the same prefix - b - if we combine them
using <code>choice</code> then it doesn&#8217;t work correctly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse byKeyword "by"
Right ()

*Main&gt; regularParse byKeyword "between"
Left (line 1, column 1):
unexpected "e"
expecting "by"

*Main&gt; regularParse betweenKeyword "between"
Right ()

*Main&gt; regularParse betweenKeyword "by"
Left (line 1, column 1):
unexpected "y"
expecting "between"

*Main&gt; regularParse (choice [betweenKeyword,byKeyword]) "between"
Right ()

*Main&gt; regularParse (choice [betweenKeyword,byKeyword]) "by"
Left (line 1, column 1):
unexpected "y"
expecting "between"

*Main&gt; regularParse (choice [byKeyword,betweenKeyword]) "between"
Left (line 1, column 1):
unexpected "e"
expecting "by"

*Main&gt; regularParse (choice [byKeyword,betweenKeyword]) "by"
Right ()</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we use <code>try</code> on the first option, then it all works fine.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse (choice [try byKeyword,betweenKeyword]) "by"
Right ()

*Main&gt; regularParse (choice [try byKeyword,betweenKeyword]) "between"
Right ()</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_count">5.1.2. count</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">count</span> <span class="tok-ow">::</span> <span class="tok-kt">Int</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>count n p</code> parses <code>n</code> occurrences of <code>p</code>. If <code>n</code> is smaller or equal
to zero, the parser is equivalent to <code>return []</code>. It returns a list of
the n values returned by <code>p</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse (count 5 a) "aaaaa"
Right "aaaaa"

*Main&gt; regularParse (count 5 a) "aaaa"
Left (line 1, column 5):
unexpected end of input
expecting "a"

*Main&gt; regularParse (count 5 a) "aaaab"
Left (line 1, column 5):
unexpected "b"
expecting "a"

*Main&gt; regularParse (count 5 aOrB) "aabaa"
Right "aabaa"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_between">5.1.3. between</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">between</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">open</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">close</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>between open close p</code> parses <code>open</code>, followed by <code>p</code> and
<code>close</code>. It returns the value returned by <code>p</code>.</p>
</div>
<div class="paragraph">
<p>We can replace the betweenParens from the previous tutorial using
this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">betweenParens</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span>
<span class="tok-nf">betweenParens</span> <span class="tok-n">p</span> <span class="tok-ow">=</span> <span class="tok-n">between</span> <span class="tok-p">(</span><span class="tok-n">symbol</span> <span class="tok-sc">&#39;(&#39;</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-n">symbol</span> <span class="tok-sc">&#39;)&#39;</span><span class="tok-p">)</span> <span class="tok-n">p</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It hardly seems worth it to make this change, but it might be slightly
quicker to read and understand if you aren&#8217;t already familiar with
some code or haven&#8217;t viewed it for a while. This is good for 'code
maintenance', where we need to fix bugs or add new features quickly to
code we haven&#8217;t looked at for two years or something.</p>
</div>
<div class="paragraph">
<p>Here are the support functions for this parser.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">symbol</span> <span class="tok-ow">::</span> <span class="tok-kt">Char</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Char</span>
<span class="tok-nf">symbol</span> <span class="tok-n">c</span> <span class="tok-ow">=</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-n">c</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">lexeme</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span>
<span class="tok-nf">lexeme</span> <span class="tok-n">p</span> <span class="tok-ow">=</span> <span class="tok-n">p</span> <span class="tok-o">&lt;*</span> <span class="tok-n">whitespace</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">whitespace</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span>
<span class="tok-nf">whitespace</span> <span class="tok-ow">=</span> <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">oneOf</span> <span class="tok-s">&quot; </span><span class="tok-se">\n\t</span><span class="tok-s">&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_option">5.1.4. option</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">option</span> <span class="tok-ow">::</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>option x p</code> tries to apply parser <code>p</code>. If <code>p</code> fails without
consuming input, it returns the value <code>x</code>, otherwise the value returned
by <code>p</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse (option "" (count 5 aOrB)) "aaaaa"
Right "aaaaa"

*Main&gt; regularParse (option "" (count 5 aOrB)) "caaaa"
Right ""

*Main&gt; regularParse (option "" (count 5 aOrB)) "aaaa"
Left (line 1, column 5):
unexpected end of input
expecting "a" or "b"

*Main&gt; regularParse (option "" (count 5 aOrB)) "aaaac"
Left (line 1, column 5):
unexpected "c"
expecting "a" or "b"

*Main&gt; regularParse (option "" (try (count 5 aOrB))) "aaaa"
Right ""</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_optionmaybe">5.1.5. optionMaybe</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">optionMaybe</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-p">(</span><span class="tok-kt">Maybe</span> <span class="tok-n">a</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>optionMaybe p</code> tries to apply parser <code>p</code>. If <code>p</code> fails without consuming
input, it returns <code>Nothing</code>, otherwise it returns <code>Just</code> the value returned
by <code>p</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse (optionMaybe (count 5 aOrB)) "aaaaa"
Right (Just "aaaaa")

*Main&gt; regularParse (optionMaybe (count 5 aOrB)) "caaaa"
Right Nothing

*Main&gt; regularParse (optionMaybe (count 5 aOrB)) "caaa"
Right Nothing

*Main&gt; regularParse (optionMaybe (count 5 aOrB)) "aaaa"
Left (line 1, column 5):
unexpected end of input
expecting "a" or "b"

*Main&gt; regularParse (optionMaybe (count 5 aOrB)) "aaaac"
Left (line 1, column 5):
unexpected "c"
expecting "a" or "b"

*Main&gt; regularParse (optionMaybe (try $ count 5 aOrB)) "aaaac"
Right Nothing</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_optional">5.1.6. optional</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">optional</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>optional p</code> tries to apply parser <code>p</code>. It will parse <code>p</code> or
nothing. It only fails if <code>p</code> fails after consuming input. It discards
the result of <code>p</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithLeftOver (optional (count 5 aOrB)) "aaaaa"
Right ((),"")

*Main&gt; parseWithLeftOver (optional (count 5 aOrB)) "caaaa"
Right ((),"caaaa")

*Main&gt; parseWithLeftOver (optional (count 5 aOrB)) "caaa"
Right ((),"caaa")

*Main&gt; parseWithLeftOver (optional (count 5 aOrB)) "aaaa"
Left (line 1, column 5):
unexpected end of input
expecting "a" or "b"

*Main&gt; parseWithLeftOver (optional (count 5 aOrB)) "aaaac"
Left (line 1, column 5):
unexpected "c"
expecting "a" or "b"

*Main&gt; parseWithLeftOver (optional (try $ count 5 aOrB)) "aaaac"
Right ((),"aaaac")</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_skipmany1">5.1.7. skipMany1</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">skipMany1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>skipMany1 p</code> applies the parser <code>p</code> one or more times, skipping its result.</p>
</div>
</div>
<div class="sect3">
<h4 id="_many1">5.1.8. many1</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">many1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>many1 p applies the parser p one or more times. Returns a list of the
returned values of p.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell">  <span class="tok-n">word</span>  <span class="tok-ow">=</span> <span class="tok-n">many1</span> <span class="tok-n">letter</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sepby">5.1.9. sepBy</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">sepBy</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">sep</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>sepBy p sep parses zero or more occurrences of p, separated by
sep. Returns a list of values returned by p.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell">  <span class="tok-n">commaSep</span> <span class="tok-n">p</span>  <span class="tok-ow">=</span> <span class="tok-n">p</span> <span class="tok-p">`</span><span class="tok-n">sepBy</span><span class="tok-p">`</span> <span class="tok-p">(</span><span class="tok-n">symbol</span> <span class="tok-s">&quot;,&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sepby1">5.1.10. sepBy1</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">sepBy1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">sep</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>sepBy1 p sep parses one or more occurrences of p, separated by
sep. Returns a list of values returned by p.</p>
</div>
</div>
<div class="sect3">
<h4 id="_endby">5.1.11. endBy</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">endBy</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">sep</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>endBy p sep parses zero or more occurrences of p, seperated and ended
by sep. Returns a list of values returned by p.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell">   <span class="tok-n">cStatements</span>  <span class="tok-ow">=</span> <span class="tok-n">cStatement</span> <span class="tok-p">`</span><span class="tok-n">endBy</span><span class="tok-p">`</span> <span class="tok-n">semi</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_endby1">5.1.12. endBy1</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">endBy1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">sep</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>endBy1 p sep parses one or more occurrences of p, seperated and ended
by sep. Returns a list of values returned by p.</p>
</div>
</div>
<div class="sect3">
<h4 id="_sependby">5.1.13. sepEndBy</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">sepEndBy</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">sep</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>sepEndBy p sep parses zero or more occurrences of p, separated and
optionally ended by sep, ie. haskell style statements. Returns a list
of values returned by p.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell">  <span class="tok-n">haskellStatements</span>  <span class="tok-ow">=</span> <span class="tok-n">haskellStatement</span> <span class="tok-p">`</span><span class="tok-n">sepEndBy</span><span class="tok-p">`</span> <span class="tok-n">semi</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sependby1">5.1.14. sepEndBy1</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">sepEndBy1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">sep</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>sepEndBy1 p sep parses one or more occurrences of p, separated and
optionally ended by sep. Returns a list of values returned by p.</p>
</div>
</div>
<div class="sect3">
<h4 id="_chainl">5.1.15. chainl</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">chainl</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>chainl p op x parser zero or more occurrences of p, separated by
op. Returns a value obtained by a left associative application of all
functions returned by op to the values returned by p. If there are
zero occurrences of p, the value x is returned.</p>
</div>
</div>
<div class="sect3">
<h4 id="_chainl1">5.1.16. chainl1</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">chainl1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>chainl1 p op x parser one or more occurrences of p, separated by op
Returns a value obtained by a left associative application of all
functions returned by op to the values returned by p. . This parser
can for example be used to eliminate left recursion which typically
occurs in expression grammars.</p>
</div>
</div>
<div class="sect3">
<h4 id="_chainr">5.1.17. chainr</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">chainr</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>chainr p op x parser zero or more occurrences of p, separated by op
Returns a value obtained by a right associative application of all
functions returned by op to the values returned by p. If there are no
occurrences of p, the value x is returned.</p>
</div>
</div>
<div class="sect3">
<h4 id="_chainr1">5.1.18. chainr1</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">chainr1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>chainr1 p op x parser one or more occurrences of <code>p</code>, separated by op
Returns a value obtained by a right associative application of all
functions returned by op to the values returned by p.</p>
</div>
</div>
<div class="sect3">
<h4 id="_eof">5.1.19. eof</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">eof</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This parser only succeeds at the end of the input. This is not a
primitive parser but it is defined using notFollowedBy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell">  <span class="tok-n">eof</span>  <span class="tok-ow">=</span> <span class="tok-n">notFollowedBy</span> <span class="tok-n">anyToken</span> <span class="tok-o">&lt;?&gt;</span> <span class="tok-s">&quot;end of input&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The (&lt;?&gt;) operator is used for error messages. We will come back to
error messages after writing the basic SQL parser.</p>
</div>
</div>
<div class="sect3">
<h4 id="_notfollowedby">5.1.20. notFollowedBy</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">notFollowedBy</span> <span class="tok-ow">::</span> <span class="tok-kt">Show</span> <span class="tok-n">a</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>notFollowedBy p only succeeds when parser p fails. This parser does
not consume any input. This parser can be used to implement the
'longest match' rule. For example, when recognizing keywords (for
example let), we want to make sure that a keyword is not followed by a
legal identifier character, in which case the keyword is actually an
identifier (for example lets). We can program this behaviour as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell">  <span class="tok-n">keywordLet</span>  <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-kr">do</span><span class="tok-p">{</span> <span class="tok-n">string</span> <span class="tok-s">&quot;let&quot;</span>
                       <span class="tok-p">;</span> <span class="tok-n">notFollowedBy</span> <span class="tok-n">alphaNum</span>
                       <span class="tok-p">})</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_manytill">5.1.21. manyTill</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">manyTill</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">end</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>manyTill p end applies parser p zero or more times until parser end
succeeds. Returns the list of values returned by p. This parser can be
used to scan comments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell">  <span class="tok-n">simpleComment</span>   <span class="tok-ow">=</span> <span class="tok-kr">do</span><span class="tok-p">{</span> <span class="tok-n">string</span> <span class="tok-s">&quot;&lt;!--&quot;</span>
                      <span class="tok-p">;</span> <span class="tok-n">manyTill</span> <span class="tok-n">anyChar</span> <span class="tok-p">(</span><span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-n">string</span> <span class="tok-s">&quot;--&gt;&quot;</span><span class="tok-p">))</span>
                      <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the overlapping parsers anyChar and string "--&gt;", and therefore
the use of the try combinator.</p>
</div>
</div>
<div class="sect3">
<h4 id="_lookahead">5.1.22. lookAhead</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">lookAhead</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>lookAhead p parses p without consuming any input.</p>
</div>
<div class="paragraph">
<p>If p fails and consumes some input, so does lookAhead. Combine with
try if this is undesirable.</p>
</div>
</div>
<div class="sect3">
<h4 id="_anytoken">5.1.23. anyToken</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">anyToken</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Char</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The parser anyToken accepts any kind of token. It is for example used
to implement eof. Returns the accepted token.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_control_applicative">5.2. Control.Applicative</h3>
<div class="paragraph">
<p>Here are the functions from Applicative that are used:</p>
</div>
<div class="paragraph">
<p><code>(&lt;$&gt;)</code>, <code>(&lt;*&gt;)</code>, <code>(&lt;$)</code>, <code>(&lt;*)</code>, <code>(*&gt;)</code>, <code>(&lt;|&gt;)</code>, <code>many</code></p>
</div>
<div class="paragraph">
<p>TODO: examples for all of these</p>
</div>
<div class="paragraph">
<p>We&#8217;ve already seen all of these, except <code>(&lt;$)</code>. This is often used to
parse a keyword and return a no argument constructor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">data</span> <span class="tok-kt">Something</span> <span class="tok-ow">=</span> <span class="tok-kt">Type1</span> <span class="tok-o">|</span> <span class="tok-kt">Type2</span> <span class="tok-o">|</span> <span class="tok-kt">Type3</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">something</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Something</span>
<span class="tok-nf">something</span> <span class="tok-ow">=</span> <span class="tok-n">choice</span> <span class="tok-p">[</span><span class="tok-kt">Type1</span> <span class="tok-o">&lt;$</span> <span class="tok-n">string</span> <span class="tok-s">&quot;type1&quot;</span>
                   <span class="tok-p">,</span><span class="tok-kt">Type2</span> <span class="tok-o">&lt;$</span> <span class="tok-n">string</span> <span class="tok-s">&quot;type2&quot;</span>
                   <span class="tok-p">,</span><span class="tok-kt">Type3</span> <span class="tok-o">&lt;$</span> <span class="tok-n">string</span> <span class="tok-s">&quot;type3&quot;</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There is also <code>(&lt;**&gt;)</code> which is <code>(&lt;*&gt;)</code> with the arguments flipped.</p>
</div>
<div class="paragraph">
<p>TODO: double check using these from Parsec instead of
Control.Applicative: possible performance implictions?</p>
</div>
</div>
<div class="sect2">
<h3 id="_control_monad">5.3. Control.Monad</h3>
<div class="sect3">
<h4 id="_return">5.3.1. return</h4>
<div class="paragraph">
<p>One use of return is to always succeed, and return a value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">alwaysX</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Char</span>
<span class="tok-nf">alwaysX</span> <span class="tok-ow">=</span> <span class="tok-n">return</span> <span class="tok-sc">&#39;x&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithLeftOver (a &lt;|&gt; alwaysX) "a"
Right ('a',"")

*Main&gt; parseWithLeftOver (a &lt;|&gt; alwaysX) "b"
Right ('x',"b")</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mzero">5.3.2. mzero</h4>
<div class="paragraph">
<p>This function is used in the implementation of <code>choice</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">choice&#39;</span> <span class="tok-ow">::</span> <span class="tok-p">[</span><span class="tok-kt">Parser</span> <span class="tok-n">a</span><span class="tok-p">]</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span>
<span class="tok-nf">choice&#39;</span> <span class="tok-n">ps</span> <span class="tok-ow">=</span> <span class="tok-n">foldr</span> <span class="tok-p">(</span><span class="tok-o">&lt;|&gt;</span><span class="tok-p">)</span> <span class="tok-n">mzero</span> <span class="tok-n">ps</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: go through a bunch of functions + do notation examples</p>
</div>
<div class="literalblock">
<div class="content">
<pre> &gt;&gt;=
 =&lt;&lt;
 &gt;&gt;
 void
 mapM, mapM_
 sequence,sequence_
 guard
 return
mzero
mplus
when, unless
liftMN
ap
quick note about fail, will return to this in the error messages stage</pre>
</div>
</div>
<div class="paragraph">
<p>TODO: using trace</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="functions-and-types-for-parsing">6. Functions and types for parsing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this file is the source and explanation for the parsing functions
which we&#8217;ve been using, and some limited notes about the wrappers and
full types in Parsec.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">module</span> <span class="tok-nn">FunctionsAndTypesForParsing</span> <span class="tok-kr">where</span>

<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec</span> <span class="tok-p">(</span><span class="tok-kt">ParseError</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String</span> <span class="tok-p">(</span><span class="tok-kt">Parser</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Parsec</span> <span class="tok-p">(</span><span class="tok-nf">parse</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Char</span> <span class="tok-p">(</span><span class="tok-nf">oneOf</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Combinator</span> <span class="tok-p">(</span><span class="tok-nf">eof</span><span class="tok-p">,</span><span class="tok-nf">manyTill</span><span class="tok-p">,</span><span class="tok-nf">anyToken</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Control.Applicative</span> <span class="tok-p">((</span><span class="tok-o">&lt;$&gt;</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;*&gt;</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;*</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">*&gt;</span><span class="tok-p">),</span> <span class="tok-nf">many</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Control.Monad</span> <span class="tok-p">(</span><span class="tok-nf">void</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_functions_for_parsing">6.1. Functions for parsing</h3>
<div class="paragraph">
<p>Here are the testing functions which were used earlier:</p>
</div>
<div class="paragraph">
<p>The basic parse function: this is a pretty simple wrapper. The parse
function from parsec just adds a filename to use in parse errors,
which is set as the empty string here.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">regularParse</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Either</span> <span class="tok-kt">ParseError</span> <span class="tok-n">a</span>
<span class="tok-nf">regularParse</span> <span class="tok-n">p</span> <span class="tok-ow">=</span> <span class="tok-n">parse</span> <span class="tok-n">p</span> <span class="tok-s">&quot;&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>'parse' is a basic function in the family of functions for running
parsers in Parsec. You can compose the parser functions in the Parser
monad, then run the top level function using 'parse' and get back an
'Either ParserError a' as the result. There are a few alternatives to
'parse' in Parsec, mostly when you are using a more general parser
type instead of 'Parser a' (which is an alias for 'ParsecT String ()
Identity a'). Have a look in the Text.Parsec.Prim module for these
<a href="http://hackage.haskell.org/package/parsec-3.1.3/docs/Text-Parsec-Prim.html" class="bare">http://hackage.haskell.org/package/parsec-3.1.3/docs/Text-Parsec-Prim.html</a>.</p>
</div>
<div class="paragraph">
<p>This function will run the parser, but additionally fail if it doesn&#8217;t
consume all the input.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parseWithEof</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Either</span> <span class="tok-kt">ParseError</span> <span class="tok-n">a</span>
<span class="tok-nf">parseWithEof</span> <span class="tok-n">p</span> <span class="tok-ow">=</span> <span class="tok-n">parse</span> <span class="tok-p">(</span><span class="tok-n">p</span> <span class="tok-o">&lt;*</span> <span class="tok-n">eof</span><span class="tok-p">)</span> <span class="tok-s">&quot;&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This function will apply the parser, then also return any left over
input which wasn&#8217;t parsed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parseWithLeftOver</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Either</span> <span class="tok-kt">ParseError</span> <span class="tok-p">(</span><span class="tok-n">a</span><span class="tok-p">,</span><span class="tok-kt">String</span><span class="tok-p">)</span>
<span class="tok-nf">parseWithLeftOver</span> <span class="tok-n">p</span> <span class="tok-ow">=</span> <span class="tok-n">parse</span> <span class="tok-p">((,)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">p</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">leftOver</span><span class="tok-p">)</span> <span class="tok-s">&quot;&quot;</span>
  <span class="tok-kr">where</span> <span class="tok-n">leftOver</span> <span class="tok-ow">=</span> <span class="tok-n">manyTill</span> <span class="tok-n">anyToken</span> <span class="tok-n">eof</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: what happens when you use 'many anyToken &lt;* eof' variations
instead? Maybe should talk about greediness? Or talk about it in a
better place in the tutorial.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parseWithWSEof</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Either</span> <span class="tok-kt">ParseError</span> <span class="tok-n">a</span>
<span class="tok-nf">parseWithWSEof</span> <span class="tok-n">p</span> <span class="tok-ow">=</span> <span class="tok-n">parseWithEof</span> <span class="tok-p">(</span><span class="tok-n">whiteSpace</span> <span class="tok-o">*&gt;</span> <span class="tok-n">p</span><span class="tok-p">)</span>
  <span class="tok-kr">where</span> <span class="tok-n">whiteSpace</span> <span class="tok-ow">=</span> <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">many</span> <span class="tok-o">$</span> <span class="tok-n">oneOf</span> <span class="tok-s">&quot; </span><span class="tok-se">\n\t</span><span class="tok-s">&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You should have a look at the two helper executables, and see if you
can understand the code now. You can see them online here:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/JakeWheat/intro_to_parsing/blob/master/ParseFile.lhs" class="bare">https://github.com/JakeWheat/intro_to_parsing/blob/master/ParseFile.lhs</a></p>
</div>
<div class="paragraph">
<p><a href="https://github.com/JakeWheat/intro_to_parsing/blob/master/ParseString.lhs" class="bare">https://github.com/JakeWheat/intro_to_parsing/blob/master/ParseString.lhs</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_type_signatures_revisited">6.2. type signatures revisited</h3>
<div class="paragraph">
<p>todo: update this to refer to real parsec instead of the string
wrappers here.</p>
</div>
<div class="paragraph">
<p>I think you should always use type signatures with Parsec. Because the
Parsec code is really generalized, without the type GHC will refuse to
compile this code. Try commenting out the type signature above and
loading into ghci to see the error message.</p>
</div>
<div class="paragraph">
<p>There is an alternative: you can get this code to compile without a
type signature by using the NoMonomorphismRestriction language
pragma. You can also see the type signature that GHC will choose for
this function by commenting the type signature and using -Wall and
-XNoMonomorphismRestriction together. Using NoMonomorphismRestriction
is a popular solution to these sorts of problems in haskell.</p>
</div>
<div class="paragraph">
<p>It&#8217;s up to you whether you prefer to always write type signatures when
you are developing parsing code, or use the NoMonomorphismRestriction
pragma. Even if you can use NoMonomorphismRestriction, when using
explicit type signatures you usually get much simpler compiler error
messages.</p>
</div>
</div>
<div class="sect2">
<h3 id="_parser">6.3. Parser</h3>
<div class="paragraph">
<p>The definition of Parser and a partial explanation of the full type
signature.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>type Parser = Parsec String ()</code></pre>
</div>
</div>
<div class="paragraph">
<p>This means that a function returning Parser a parses from a String
with () as the initial state.</p>
</div>
<div class="paragraph">
<p>The Parsec type is defined like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>type Parsec s u = ParsecT s u Identity</code></pre>
</div>
</div>
<div class="paragraph">
<p>ParsecT is a monad transformer, I think it is the primitive one in the
Parsec library, and the 'Parsec' type is a type alias which sets the
base monad to be Identity.</p>
</div>
<div class="paragraph">
<p>Here is the haddock for the ParsecT type:</p>
</div>
<div class="paragraph">
<p><code>ParsecT s u m a</code> is a parser with stream type <code>s</code>, user state type <code>u</code>,
underlying monad <code>m</code> and return type <code>a</code>.</p>
</div>
<div class="paragraph">
<p>The full types that you see like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>satisfy :: Stream s m Char =&gt; (Char -&gt; Bool) -&gt; ParsecT s u m Char</code></pre>
</div>
</div>
<div class="paragraph">
<p>refer to the same things (stream type s, user state type u, underlying
monad m).</p>
</div>
<div class="paragraph">
<p>We are using String as the stream type (i.e. the input type), () as
the user state type (this effectively means no user state, since ()
only has one value), and the underlying monad is Identity: we are
using no other underlying monad, so <code>Parser a</code> expands to <code>ParsecT
String () Identity a</code>.</p>
</div>
<div class="paragraph">
<p>I.e. the source is String, the user state is (), and the underlying monad
is Identity.</p>
</div>
</div>
<div class="sect2">
<h3 id="_other_information">6.4. Other information</h3>
<div class="paragraph">
<p>TODO: Here is some other information on Parsec and Haskell:
links, tutorials on fp, section in rwh, lyah?, old parsec docs,
parsec docs on hackage, other parser combinator libs (uu, polyparse,
trifecta?)</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="parsing-expressions-with-fixity">7. Parsing expressions with fixity</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Text.Parsec.Expr allows building expression parsers with a range of
operators with different precedences and associativities
easily. Fixity is the (not completely standard) term for precendence
and associativity together.</p>
</div>
<div class="paragraph">
<p><code>Text.Parsec.Expr</code> can be great to quickly get a parser for simple
expressions or a simple programming language with simple expressions
up and running.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String</span> <span class="tok-p">(</span><span class="tok-kt">Parser</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Combinator</span> <span class="tok-p">(</span><span class="tok-nf">many1</span><span class="tok-p">,</span> <span class="tok-nf">between</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Char</span> <span class="tok-p">(</span><span class="tok-nf">letter</span><span class="tok-p">,</span> <span class="tok-nf">char</span><span class="tok-p">,</span> <span class="tok-nf">digit</span><span class="tok-p">,</span> <span class="tok-nf">string</span><span class="tok-p">,</span> <span class="tok-nf">oneOf</span><span class="tok-p">)</span>

<span class="tok-kr">import</span> <span class="tok-nn">Control.Applicative</span> <span class="tok-p">((</span><span class="tok-o">&lt;$&gt;</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;*&gt;</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;*</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;|&gt;</span><span class="tok-p">),</span> <span class="tok-nf">many</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-o">&lt;$</span><span class="tok-p">))</span>
<span class="tok-kr">import</span> <span class="tok-nn">Control.Monad</span> <span class="tok-p">(</span><span class="tok-nf">void</span><span class="tok-p">)</span>

<span class="tok-kr">import</span> <span class="tok-k">qualified</span> <span class="tok-nn">Text.Parsec.String.Expr</span> <span class="tok-k">as</span> <span class="tok-n">E</span>
<span class="tok-kr">import</span> <span class="tok-nn">FunctionsAndTypesForParsing</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s extend the SimpleExpression type and parsers to cover a range of
operators with different precedences and associativity.</p>
</div>
<div class="sect2">
<h3 id="_expressions_with_plus_and_times">7.1. expressions with plus and times</h3>
<div class="paragraph">
<p>Let&#8217;s start with a simple case: + and * with the usual fixity. Here is
the abstract syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">data</span> <span class="tok-kt">PlusTimesExpr</span> <span class="tok-ow">=</span> <span class="tok-kt">PteVar</span> <span class="tok-kt">String</span>
                   <span class="tok-o">|</span> <span class="tok-kt">PteNum</span> <span class="tok-kt">Integer</span>
                   <span class="tok-o">|</span> <span class="tok-kt">PteParens</span> <span class="tok-kt">PlusTimesExpr</span>
                   <span class="tok-o">|</span> <span class="tok-kt">Plus</span> <span class="tok-kt">PlusTimesExpr</span> <span class="tok-kt">PlusTimesExpr</span>
                   <span class="tok-o">|</span> <span class="tok-kt">Times</span> <span class="tok-kt">PlusTimesExpr</span> <span class="tok-kt">PlusTimesExpr</span>
                         <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span><span class="tok-p">,</span><span class="tok-kt">Show</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">plusTimesExpr</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">PlusTimesExpr</span>
<span class="tok-nf">plusTimesExpr</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-n">buildExpressionParser</span> <span class="tok-n">pteTable</span> <span class="tok-n">pteTerm</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">pteTable</span> <span class="tok-ow">::</span> <span class="tok-p">[[</span><span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Operator</span> <span class="tok-kt">PlusTimesExpr</span><span class="tok-p">]]</span>
<span class="tok-nf">pteTable</span> <span class="tok-ow">=</span> <span class="tok-p">[[</span><span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Infix</span> <span class="tok-p">(</span><span class="tok-kt">Times</span> <span class="tok-o">&lt;$</span> <span class="tok-n">symbol</span> <span class="tok-s">&quot;*&quot;</span><span class="tok-p">)</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span><span class="tok-p">]</span>
           <span class="tok-p">,[</span><span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Infix</span> <span class="tok-p">(</span><span class="tok-kt">Plus</span> <span class="tok-o">&lt;$</span> <span class="tok-n">symbol</span> <span class="tok-s">&quot;+&quot;</span><span class="tok-p">)</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span><span class="tok-p">]</span>
           <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here you can see the operator parsers are the same as the previous
<code>SimpleExpr</code> parser which used <code>chainl1</code>: <code>Times &lt;$ symbol "*"</code> and
<code>Plus &lt;$ symbol "+"</code>. We just wrapped these up in the <code>E.Infix</code>
constructor with the associativity, and put them in a list of lists
which represents the precendence classes.</p>
</div>
<div class="paragraph">
<p>Here is the term parser and components. All this is just the same as
the <code>SimpleExpr</code> parser a previous tutorial.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">pteTerm</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">PlusTimesExpr</span>
<span class="tok-nf">pteTerm</span> <span class="tok-ow">=</span> <span class="tok-n">pteVar</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">pteNum</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">pteParens</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">pteNum</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">PlusTimesExpr</span>
<span class="tok-nf">pteNum</span> <span class="tok-ow">=</span> <span class="tok-kt">PteNum</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">integer</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">pteVar</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">PlusTimesExpr</span>
<span class="tok-nf">pteVar</span> <span class="tok-ow">=</span> <span class="tok-kt">PteVar</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">identifier</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">pteParens</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">PlusTimesExpr</span>
<span class="tok-nf">pteParens</span> <span class="tok-ow">=</span> <span class="tok-kt">PteParens</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">between</span> <span class="tok-p">(</span><span class="tok-n">symbol</span> <span class="tok-s">&quot;(&quot;</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-n">symbol</span> <span class="tok-s">&quot;)&quot;</span><span class="tok-p">)</span> <span class="tok-n">plusTimesExpr</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>support functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">whitespace</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span>
<span class="tok-nf">whitespace</span> <span class="tok-ow">=</span> <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">many</span> <span class="tok-o">$</span> <span class="tok-n">oneOf</span> <span class="tok-s">&quot; </span><span class="tok-se">\n\t</span><span class="tok-s">&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">lexeme</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span>
<span class="tok-nf">lexeme</span> <span class="tok-n">p</span> <span class="tok-ow">=</span> <span class="tok-n">p</span> <span class="tok-o">&lt;*</span> <span class="tok-n">whitespace</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">integer</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Integer</span>
<span class="tok-nf">integer</span> <span class="tok-ow">=</span> <span class="tok-n">read</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">lexeme</span> <span class="tok-p">(</span><span class="tok-n">many1</span> <span class="tok-n">digit</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">identifier</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">identifier</span> <span class="tok-ow">=</span> <span class="tok-n">lexeme</span> <span class="tok-p">((</span><span class="tok-kt">:</span><span class="tok-p">)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">firstChar</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">many</span> <span class="tok-n">nonFirstChar</span><span class="tok-p">)</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">firstChar</span> <span class="tok-ow">=</span> <span class="tok-n">letter</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;_&#39;</span>
    <span class="tok-n">nonFirstChar</span> <span class="tok-ow">=</span> <span class="tok-n">digit</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">firstChar</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">symbol</span> <span class="tok-ow">::</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">symbol</span> <span class="tok-n">s</span> <span class="tok-ow">=</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">string</span> <span class="tok-n">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here you can see the precendence in action:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse plusTimesExpr "a + b * c"
Right (Plus (PteVar "a") (Times (PteVar "b") (PteVar "c")))

*Main&gt; regularParse plusTimesExpr "a * b + c"
Right (Plus (Times (PteVar "a") (PteVar "b")) (PteVar "c"))</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_a_full_featured_expression_type">7.2. a full featured expression type</h3>
<div class="paragraph">
<p>Now let&#8217;s try a much bigger example with lots more operators. Now we
are thinking ahead to the first version of the SQL query parser, and
preparing for this.</p>
</div>
<div class="paragraph">
<p>Here are our new operators in precedence order:</p>
</div>
<div class="sect3">
<h4 id="_unary">7.2.1. unary + -</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>+a
-3</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exponentiation">7.2.2. exponentiation</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>a ^ 3</code></pre>
</div>
</div>
<div class="paragraph">
<p>associativity: left</p>
</div>
</div>
<div class="sect3">
<h4 id="_multiplication_division_modulo">7.2.3. multiplication, division, modulo</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>a * 3
3 / b
a % 5</code></pre>
</div>
</div>
<div class="paragraph">
<p>associativity: left</p>
</div>
</div>
<div class="sect3">
<h4 id="_addition_subtraction">7.2.4. addition, subtraction</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>a + b
a - b</code></pre>
</div>
</div>
<div class="paragraph">
<p>associativity: left</p>
</div>
</div>
<div class="sect3">
<h4 id="_less_than_greater_than">7.2.5. less than, greater than</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>a &lt; b
a &gt; b</code></pre>
</div>
</div>
<div class="paragraph">
<p>associativity: none</p>
</div>
</div>
<div class="sect3">
<h4 id="_equals">7.2.6. equals</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>a = 3</code></pre>
</div>
</div>
<div class="paragraph">
<p>associativity: right</p>
</div>
</div>
<div class="sect3">
<h4 id="_not">7.2.7. not</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>not a</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_and">7.2.8. and</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>a and b</code></pre>
</div>
</div>
<div class="paragraph">
<p>associativity: left</p>
</div>
</div>
<div class="sect3">
<h4 id="_or">7.2.9. or</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>a or b</code></pre>
</div>
</div>
<div class="paragraph">
<p>associativity: left</p>
</div>
<div class="paragraph">
<p>Here is the abstract syntax type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">data</span> <span class="tok-kt">SimpleExpr</span> <span class="tok-ow">=</span> <span class="tok-kt">Num</span> <span class="tok-kt">Integer</span>
                <span class="tok-o">|</span> <span class="tok-kt">Var</span> <span class="tok-kt">String</span>
                <span class="tok-o">|</span> <span class="tok-kt">Parens</span> <span class="tok-kt">SimpleExpr</span>
                <span class="tok-o">|</span> <span class="tok-kt">PrefixOp</span> <span class="tok-kt">String</span> <span class="tok-kt">SimpleExpr</span>
                <span class="tok-o">|</span> <span class="tok-kt">BinaryOp</span> <span class="tok-kt">SimpleExpr</span> <span class="tok-kt">String</span> <span class="tok-kt">SimpleExpr</span>
                   <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span><span class="tok-p">,</span><span class="tok-kt">Show</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the new expression parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">simpleExpr</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">simpleExpr</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-n">buildExpressionParser</span> <span class="tok-n">table</span> <span class="tok-n">term</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">table</span> <span class="tok-ow">::</span> <span class="tok-p">[[</span><span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Operator</span> <span class="tok-kt">SimpleExpr</span><span class="tok-p">]]</span>
<span class="tok-nf">table</span> <span class="tok-ow">=</span> <span class="tok-p">[[</span><span class="tok-n">prefix</span> <span class="tok-s">&quot;-&quot;</span><span class="tok-p">,</span> <span class="tok-n">prefix</span> <span class="tok-s">&quot;+&quot;</span><span class="tok-p">]</span>
        <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;^&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span><span class="tok-p">]</span>
        <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;*&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span>
         <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;/&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span>
         <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;%&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span><span class="tok-p">]</span>
        <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;+&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span>
         <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;-&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span><span class="tok-p">]</span>
        <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&lt;&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocNone</span>
         <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&gt;&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocNone</span><span class="tok-p">]</span>
        <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;=&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocRight</span><span class="tok-p">]</span>
        <span class="tok-p">,[</span><span class="tok-n">prefix</span> <span class="tok-s">&quot;not&quot;</span><span class="tok-p">]</span>
        <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;and&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span><span class="tok-p">]</span>
        <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;or&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span><span class="tok-p">]</span>
        <span class="tok-p">]</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">binary</span> <span class="tok-n">name</span> <span class="tok-n">assoc</span> <span class="tok-ow">=</span>
        <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Infix</span> <span class="tok-p">(</span><span class="tok-n">mkBinOp</span> <span class="tok-n">name</span> <span class="tok-o">&lt;$</span> <span class="tok-n">symbol</span> <span class="tok-n">name</span><span class="tok-p">)</span> <span class="tok-n">assoc</span>
    <span class="tok-n">mkBinOp</span> <span class="tok-n">nm</span> <span class="tok-n">a</span> <span class="tok-n">b</span> <span class="tok-ow">=</span> <span class="tok-kt">BinaryOp</span> <span class="tok-n">a</span> <span class="tok-n">nm</span> <span class="tok-n">b</span>
    <span class="tok-n">prefix</span> <span class="tok-n">name</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Prefix</span> <span class="tok-p">(</span><span class="tok-kt">PrefixOp</span> <span class="tok-n">name</span> <span class="tok-o">&lt;$</span> <span class="tok-n">symbol</span> <span class="tok-n">name</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: expand and explain the bits.</p>
</div>
<div class="paragraph">
<p>Here is the term parser.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">term</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">term</span> <span class="tok-ow">=</span> <span class="tok-n">var</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">num</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">parens</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">num</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">num</span> <span class="tok-ow">=</span> <span class="tok-kt">Num</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">integer</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">var</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">var</span> <span class="tok-ow">=</span> <span class="tok-kt">Var</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">identifier</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parens</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">parens</span> <span class="tok-ow">=</span> <span class="tok-n">between</span> <span class="tok-p">(</span><span class="tok-n">symbol</span> <span class="tok-s">&quot;(&quot;</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-n">symbol</span> <span class="tok-s">&quot;)&quot;</span><span class="tok-p">)</span> <span class="tok-n">simpleExpr</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: write lots of parsing examples, including parse failures with
ambiguity.</p>
</div>
<div class="paragraph">
<p>issue: double prefix op, link to bug on parsec bug tracker.</p>
</div>
<div class="paragraph">
<p>The source in Text.Parsec.Expr is not too big. You can have a look and
try to understand it. There are several standard approaches in parsing
theory to parse expressions with data driven precendences and
associativity. I don&#8217;t know which one Text.Parsec.Expr uses, but if
you find these and read about them, then the source of
Text.Parsec.Expr might be a bit more understandable.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="an-issue-with-token-parsers">8. An issue with token parsers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is a tutorial about an issue with the token parsing we have so
far.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String</span> <span class="tok-p">(</span><span class="tok-kt">Parser</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Parsec</span> <span class="tok-p">(</span><span class="tok-nf">try</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Combinator</span> <span class="tok-p">(</span><span class="tok-nf">many1</span><span class="tok-p">,</span> <span class="tok-nf">notFollowedBy</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Char</span> <span class="tok-p">(</span><span class="tok-nf">digit</span><span class="tok-p">,</span> <span class="tok-nf">string</span><span class="tok-p">,</span> <span class="tok-nf">oneOf</span><span class="tok-p">,</span> <span class="tok-nf">satisfy</span><span class="tok-p">,</span> <span class="tok-nf">char</span><span class="tok-p">,</span> <span class="tok-nf">letter</span><span class="tok-p">)</span>

<span class="tok-kr">import</span> <span class="tok-nn">Control.Applicative</span> <span class="tok-p">((</span><span class="tok-o">&lt;$&gt;</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;*&gt;</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;*</span><span class="tok-p">),</span> <span class="tok-nf">many</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-o">&lt;$</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;|&gt;</span><span class="tok-p">))</span>
<span class="tok-kr">import</span> <span class="tok-nn">Control.Monad</span> <span class="tok-p">(</span><span class="tok-nf">void</span><span class="tok-p">,</span> <span class="tok-nf">guard</span><span class="tok-p">)</span>

<span class="tok-kr">import</span> <span class="tok-k">qualified</span> <span class="tok-nn">Text.Parsec.String.Expr</span> <span class="tok-k">as</span> <span class="tok-n">E</span>
<span class="tok-kr">import</span> <span class="tok-nn">FunctionsAndTypesForParsing</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is a simplified expression type and parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">data</span> <span class="tok-kt">SimpleExpr</span> <span class="tok-ow">=</span> <span class="tok-kt">Num</span> <span class="tok-kt">Integer</span>
                <span class="tok-o">|</span> <span class="tok-kt">BinaryOp</span> <span class="tok-kt">SimpleExpr</span> <span class="tok-kt">String</span> <span class="tok-kt">SimpleExpr</span>
                   <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span><span class="tok-p">,</span><span class="tok-kt">Show</span><span class="tok-p">)</span>

<span class="tok-nf">simpleExpr</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">simpleExpr</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-n">buildExpressionParser</span> <span class="tok-n">table</span> <span class="tok-n">num</span>

<span class="tok-nf">table</span> <span class="tok-ow">::</span> <span class="tok-p">[[</span><span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Operator</span> <span class="tok-kt">SimpleExpr</span><span class="tok-p">]]</span>
<span class="tok-nf">table</span> <span class="tok-ow">=</span> <span class="tok-p">[[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&lt;=&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocNone</span>
         <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&gt;=&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocNone</span><span class="tok-p">]</span>
        <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&lt;&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocNone</span>
         <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&gt;&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocNone</span><span class="tok-p">]</span>
        <span class="tok-p">]</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">binary</span> <span class="tok-n">name</span> <span class="tok-n">assoc</span> <span class="tok-ow">=</span>
        <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Infix</span> <span class="tok-p">(</span><span class="tok-n">mkBinOp</span> <span class="tok-n">name</span> <span class="tok-o">&lt;$</span> <span class="tok-n">symbol</span> <span class="tok-n">name</span><span class="tok-p">)</span> <span class="tok-n">assoc</span>
    <span class="tok-n">mkBinOp</span> <span class="tok-n">nm</span> <span class="tok-n">a</span> <span class="tok-n">b</span> <span class="tok-ow">=</span> <span class="tok-kt">BinaryOp</span> <span class="tok-n">a</span> <span class="tok-n">nm</span> <span class="tok-n">b</span>

<span class="tok-nf">num</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">num</span> <span class="tok-ow">=</span> <span class="tok-kt">Num</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">integer</span>

<span class="tok-nf">whitespace</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span>
<span class="tok-nf">whitespace</span> <span class="tok-ow">=</span> <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">many</span> <span class="tok-o">$</span> <span class="tok-n">oneOf</span> <span class="tok-s">&quot; </span><span class="tok-se">\n\t</span><span class="tok-s">&quot;</span>

<span class="tok-nf">lexeme</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span>
<span class="tok-nf">lexeme</span> <span class="tok-n">p</span> <span class="tok-ow">=</span> <span class="tok-n">p</span> <span class="tok-o">&lt;*</span> <span class="tok-n">whitespace</span>

<span class="tok-nf">integer</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Integer</span>
<span class="tok-nf">integer</span> <span class="tok-ow">=</span> <span class="tok-n">read</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">lexeme</span> <span class="tok-p">(</span><span class="tok-n">many1</span> <span class="tok-n">digit</span><span class="tok-p">)</span>

<span class="tok-nf">symbol</span> <span class="tok-ow">::</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">symbol</span> <span class="tok-n">s</span> <span class="tok-ow">=</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">string</span> <span class="tok-n">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try it out:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse simpleExpr "1=2"
Right (Num 1)

*Main&gt; regularParse simpleExpr "1&gt;=2"
Right (BinaryOp (Num 1) "&gt;=" (Num 2))

*Main&gt; regularParse simpleExpr "1&gt;2"
Left (line 1, column 2):
unexpected "2"
expecting "&gt;="</code></pre>
</div>
</div>
<div class="paragraph">
<p>What happened? The parser tried to parse &gt; as &gt;=, failed, and since
the failure consumed some input (the first &gt;), it failed completely.</p>
</div>
<div class="paragraph">
<p>We are going to change the symbol parser to fix this. Here is a
parameterized version of the simpleExpr parser so we can try a few
variations out.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">simpleExprP</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">simpleExprP</span> <span class="tok-n">sym</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-n">buildExpressionParser</span> <span class="tok-p">(</span><span class="tok-n">tableP</span> <span class="tok-n">sym</span><span class="tok-p">)</span> <span class="tok-n">num</span>

<span class="tok-nf">tableP</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-p">[[</span><span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Operator</span> <span class="tok-kt">SimpleExpr</span><span class="tok-p">]]</span>
<span class="tok-nf">tableP</span> <span class="tok-n">sym</span> <span class="tok-ow">=</span> <span class="tok-p">[[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&lt;=&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocNone</span>
              <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&gt;=&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocNone</span><span class="tok-p">]</span>
             <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&lt;&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocNone</span>
              <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&gt;&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocNone</span><span class="tok-p">]]</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">binary</span> <span class="tok-n">name</span> <span class="tok-n">assoc</span> <span class="tok-ow">=</span>
        <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Infix</span> <span class="tok-p">(</span><span class="tok-n">mkBinOp</span> <span class="tok-n">name</span> <span class="tok-o">&lt;$</span> <span class="tok-n">sym</span> <span class="tok-n">name</span><span class="tok-p">)</span> <span class="tok-n">assoc</span>
    <span class="tok-n">mkBinOp</span> <span class="tok-n">nm</span> <span class="tok-n">a</span> <span class="tok-n">b</span> <span class="tok-ow">=</span> <span class="tok-kt">BinaryOp</span> <span class="tok-n">a</span> <span class="tok-n">nm</span> <span class="tok-n">b</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s reproduce the failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse (simpleExprP symbol) "1&gt;=2"
Right (BinaryOp (Num 1) "&gt;=" (Num 2))

*Main&gt; regularParse (simpleExprP symbol) "1&gt;2"
Left (line 1, column 2):
unexpected "2"
expecting "&gt;="</code></pre>
</div>
</div>
<div class="paragraph">
<p>We are going to look at two possible solutions.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Let&#8217;s use <code>try</code>:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse (simpleExprP (try . symbol)) "1&gt;=2"
Right (BinaryOp (Num 1) "&gt;=" (Num 2))

*Main&gt; regularParse (simpleExprP (try . symbol)) "1&gt;2"
Right (BinaryOp (Num 1) "&gt;" (Num 2))</code></pre>
</div>
</div>
<div class="paragraph">
<p>This seems to have done the job. There is still a problem
though. Consider a case when the precedence is the other way round -
the <code>&lt;</code> and <code>&gt;</code> are higher precedence than <code>&#8656;</code> and <code>&gt;=</code>,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">simpleExprP1</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">SimpleExpr</span>
<span class="tok-nf">simpleExprP1</span> <span class="tok-n">sym</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-n">buildExpressionParser</span> <span class="tok-p">(</span><span class="tok-n">tableP1</span> <span class="tok-n">sym</span><span class="tok-p">)</span> <span class="tok-n">num</span>

<span class="tok-nf">tableP1</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-p">[[</span><span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Operator</span> <span class="tok-kt">SimpleExpr</span><span class="tok-p">]]</span>
<span class="tok-nf">tableP1</span> <span class="tok-n">sym</span> <span class="tok-ow">=</span> <span class="tok-p">[[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&lt;&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocNone</span>
              <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&gt;&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocNone</span><span class="tok-p">]</span>
             <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&lt;=&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocNone</span>
              <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&gt;=&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocNone</span><span class="tok-p">]]</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">binary</span> <span class="tok-n">name</span> <span class="tok-n">assoc</span> <span class="tok-ow">=</span>
        <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Infix</span> <span class="tok-p">(</span><span class="tok-n">mkBinOp</span> <span class="tok-n">name</span> <span class="tok-o">&lt;$</span> <span class="tok-n">sym</span> <span class="tok-n">name</span><span class="tok-p">)</span> <span class="tok-n">assoc</span>
    <span class="tok-n">mkBinOp</span> <span class="tok-n">nm</span> <span class="tok-n">a</span> <span class="tok-n">b</span> <span class="tok-ow">=</span> <span class="tok-kt">BinaryOp</span> <span class="tok-n">a</span> <span class="tok-n">nm</span> <span class="tok-n">b</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse (simpleExprP1 (try . symbol)) "1&gt;2"
Right (BinaryOp (Num 1) "&gt;" (Num 2))

*Main&gt; regularParse (simpleExprP1 (try . symbol)) "1&gt;=2"
Left (line 1, column 3):
unexpected "="
expecting digit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Although the precendence order is a little contrived in this case,
this issue could easily crop up for real when we start adding more
operators. Let&#8217;s fix it now.</p>
</div>
<div class="paragraph">
<p>This could be solved by adding a <code>try</code> at a earlier place in the
parsing. Because of how the <code>buildExpressionParser</code> function works,
it&#8217;s not obvious where the <code>try</code> could go.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s try tackling the problem in a different way. One way of looking
at this is to consider that the symbol parser stops parsing too soon:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithLeftOver (symbol "&gt;") "&gt;="
Right ("&gt;","=")</code></pre>
</div>
</div>
<div class="paragraph">
<p>What it should do is keep parsing symbol characters until it gets a
result string which can&#8217;t be a symbol, and stop one character before
this..</p>
</div>
<div class="paragraph">
<p>Here is a slightly naive way of doing it, which will be good enough
for quite a while:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">symbol1</span> <span class="tok-ow">::</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">symbol1</span> <span class="tok-n">s</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-kr">do</span>
    <span class="tok-n">u</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">many1</span> <span class="tok-p">(</span><span class="tok-n">oneOf</span> <span class="tok-s">&quot;&lt;&gt;=+-^%/*&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">guard</span> <span class="tok-p">(</span><span class="tok-n">s</span> <span class="tok-o">==</span> <span class="tok-n">u</span><span class="tok-p">)</span>
    <span class="tok-n">return</span> <span class="tok-n">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is a similar alternative:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">symbol2</span> <span class="tok-ow">::</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">symbol2</span> <span class="tok-n">s</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-kr">do</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">string</span> <span class="tok-n">s</span>
    <span class="tok-n">notFollowedBy</span> <span class="tok-p">(</span><span class="tok-n">oneOf</span> <span class="tok-s">&quot;&lt;&gt;=+-^%/*&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">return</span> <span class="tok-n">s</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try them out:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithLeftOver (symbol1 "&gt;") "&gt;="
Left (line 1, column 3):
unexpected end of input

*Main&gt; parseWithLeftOver (symbol1 "&gt;") "&gt;"
Right ("&gt;","")

*Main&gt; parseWithLeftOver (symbol1 "&gt;") "&gt;= 3"
Left (line 1, column 3):
unexpected " "

*Main&gt; parseWithLeftOver (symbol1 "&gt;=") "&gt;= 3"
Right ("&gt;="," 3")</code></pre>
</div>
</div>
<div class="paragraph">
<p>The error messages don&#8217;t seem very good, but it parses and fails to
parse correctly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithLeftOver (symbol2 "&gt;") "&gt;="
Left (line 1, column 3):
unexpected '='

*Main&gt; parseWithLeftOver (symbol2 "&gt;") "&gt;"
Right ("&gt;","")

*Main&gt; parseWithLeftOver (symbol2 "&gt;") "&gt;= 3"
Left (line 1, column 3):
unexpected '='

*Main&gt; parseWithLeftOver (symbol2 "&gt;=") "&gt;= 3"
Right ("&gt;="," 3")</code></pre>
</div>
</div>
<div class="paragraph">
<p>This one appears to give better error messages in this limited
scenario, apart from that they both work the same.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s try them out in the full expression parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; regularParse (simpleExprP symbol1) "1&gt;=2"
Right (BinaryOp (Num 1) "&gt;=" (Num 2))

*Main&gt; regularParse (simpleExprP symbol1) "1&gt;2"
Right (BinaryOp (Num 1) "&gt;" (Num 2))

*Main&gt; regularParse (simpleExprP symbol2) "1&gt;=2"
Right (BinaryOp (Num 1) "&gt;=" (Num 2))

*Main&gt; regularParse (simpleExprP symbol2) "1&gt;2"
Right (BinaryOp (Num 1) "&gt;" (Num 2))</code></pre>
</div>
</div>
<div class="paragraph">
<p>They both work fine here. Let&#8217;s see some error messages in this
context.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithEof (simpleExprP symbol1) "1&gt;*2"
Left (line 1, column 4):
unexpected "2"
expecting operator

*Main&gt; parseWithEof (simpleExprP symbol2) "1&gt;*2"
Left (line 1, column 4):
unexpected '*'
expecting operator</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both error messages are a bit crap. So much for the second variation
producing better error messages.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at the equivalent issue with respect to keyword parsing. We
can get a similar problem here.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">keyword</span> <span class="tok-ow">::</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">keyword</span> <span class="tok-n">s</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-o">$</span> <span class="tok-n">string</span> <span class="tok-n">s</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithEof (keyword "not") "not"
Right "not"

*Main&gt; parseWithEof (keyword "not") "nothing"
Left (line 1, column 4):
unexpected 'h'
expecting end of input

*Main&gt; parseWithEof (keyword "not" &lt;|&gt; keyword "nothing") "nothing"
Left (line 1, column 4):
unexpected 'h'
expecting end of input

*Main&gt; parseWithEof (keyword "nothing" &lt;|&gt; keyword "not") "nothing"
Right "nothing"</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can fix this overlapping prefix issue by reordering the
choices. But let&#8217;s fix the <code>keyword</code> parser in a similar way to the
symbol parser.</p>
</div>
<div class="paragraph">
<p>TODO: I don&#8217;t know if symbol is the right name, I don&#8217;t think Parsec
usually uses symbol in this way. Maybe it should be called operator.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">identifier</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">identifier</span> <span class="tok-ow">=</span> <span class="tok-n">lexeme</span> <span class="tok-p">((</span><span class="tok-kt">:</span><span class="tok-p">)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">firstChar</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">many</span> <span class="tok-n">nonFirstChar</span><span class="tok-p">)</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">firstChar</span> <span class="tok-ow">=</span> <span class="tok-n">letter</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;_&#39;</span>
    <span class="tok-n">nonFirstChar</span> <span class="tok-ow">=</span> <span class="tok-n">digit</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">firstChar</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">keyword1</span> <span class="tok-ow">::</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">keyword1</span> <span class="tok-n">k</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-o">$</span> <span class="tok-kr">do</span>
    <span class="tok-n">i</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">identifier</span>
    <span class="tok-n">guard</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">==</span> <span class="tok-n">k</span><span class="tok-p">)</span>
    <span class="tok-n">return</span> <span class="tok-n">k</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: later note in error messages about choosing identifier here
instead of e.g. many1 letter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithEof (keyword1 "not") "not"
Right "not"

*Main&gt; parseWithEof (keyword1 "not") "nothing"
Left (line 1, column 8):
unexpected end of input
expecting digit, letter or "_"

*Main&gt; parseWithEof (keyword1 "not" &lt;|&gt; keyword1 "nothing") "nothing"
Right "nothing"

*Main&gt; parseWithEof (keyword1 "nothing" &lt;|&gt; keyword1 "not") "nothing"
Right "nothing"

*Main&gt; parseWithEof (keyword1 "not" &lt;|&gt; keyword1 "nothing") "not"
Right "not"

*Main&gt; parseWithEof (keyword1 "nothing" &lt;|&gt; keyword1 "not") "not"
Right "not"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Try implementing the <code>keyword2</code> parser which uses <code>notFollowedBy</code>
instead of <code>guard</code>, using something analogous to the change from
<code>symbol1</code> to <code>symbol2</code> above.</p>
</div>
<div class="paragraph">
<p>After this, you can try reimplementing the expression parser from the
Text.Parsec.Expr tutorial using the new symbol and keyword parsers.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="permutation-parsing">9. Permutation parsing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This can parse a bunch of different things in any order. TODO:
examples.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="token-parsing">10. Token parsing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This can be used quickly create a set of token parsers handling lots
of little issues which you otherwise have to deal with manually.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="value-expressions">11. Value expressions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this tutorial, we will build a parser for a subset of SQL value
expressions. These are roughly the same as the expressions used in
languages like Haskell or C. This will follow on from the work on
expressions in previous tutorials.</p>
</div>
<div class="paragraph">
<p>Our value expressions will support literals, identifiers, asterisk,
some simple operators, case expression and parentheses.</p>
</div>
<div class="paragraph">
<p>The phrase 'value expression' is from the ANSI SQL standards. What we
will develop here isn&#8217;t exactly ANSI SQL value expressions, and we
won&#8217;t use them exactly how the standards do, but the differences
really aren&#8217;t important right now. I will come back to this in a later
tutorial.</p>
</div>
<div class="paragraph">
<p>TODO: not so sure anymore what is a 'value expression' in the
standard, and what is a 'scalar expression'. Find out and document it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-cm">{-# LANGUAGE TupleSections #-}</span>
<span class="tok-kr">module</span> <span class="tok-nn">ValueExpressions</span> <span class="tok-p">(</span><span class="tok-kt">ValueExpr</span><span class="tok-p">(</span><span class="tok-o">..</span><span class="tok-p">)</span>
                        <span class="tok-p">,</span><span class="tok-nf">valueExpr</span>
                        <span class="tok-p">,</span><span class="tok-nf">keyword</span>
                        <span class="tok-p">,</span><span class="tok-nf">symbol</span>
                        <span class="tok-p">,</span><span class="tok-nf">identifier</span>
                        <span class="tok-p">,</span><span class="tok-nf">makeTest</span>
                        <span class="tok-p">,</span><span class="tok-nf">blackListValueExpr</span>
                        <span class="tok-p">,</span><span class="tok-nf">comma</span>
                        <span class="tok-p">,</span><span class="tok-nf">parens</span>
                        <span class="tok-p">)</span> <span class="tok-kr">where</span>

<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String</span> <span class="tok-p">(</span><span class="tok-kt">Parser</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Char</span> <span class="tok-p">(</span><span class="tok-nf">oneOf</span><span class="tok-p">,</span> <span class="tok-nf">digit</span><span class="tok-p">,</span> <span class="tok-nf">string</span><span class="tok-p">,</span> <span class="tok-nf">anyChar</span><span class="tok-p">,</span> <span class="tok-nf">char</span><span class="tok-p">,</span> <span class="tok-nf">letter</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Combinator</span> <span class="tok-p">(</span><span class="tok-nf">many1</span><span class="tok-p">,</span> <span class="tok-nf">manyTill</span><span class="tok-p">,</span> <span class="tok-nf">eof</span><span class="tok-p">,</span> <span class="tok-nf">choice</span><span class="tok-p">,</span> <span class="tok-nf">between</span>
                                     <span class="tok-p">,</span><span class="tok-nf">sepBy</span><span class="tok-p">,</span> <span class="tok-nf">optionMaybe</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Parsec</span> <span class="tok-p">(</span><span class="tok-nf">try</span><span class="tok-p">,</span><span class="tok-nf">parse</span><span class="tok-p">)</span>

<span class="tok-kr">import</span> <span class="tok-nn">Control.Applicative</span> <span class="tok-p">(</span><span class="tok-nf">many</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-o">&lt;*</span><span class="tok-p">),(</span><span class="tok-o">&lt;$&gt;</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">*&gt;</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;|&gt;</span><span class="tok-p">),(</span><span class="tok-o">&lt;$</span><span class="tok-p">),(</span><span class="tok-o">&lt;*&gt;</span><span class="tok-p">))</span>
<span class="tok-kr">import</span> <span class="tok-nn">Control.Monad</span> <span class="tok-p">(</span><span class="tok-nf">void</span><span class="tok-p">,</span><span class="tok-nf">guard</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-k">qualified</span> <span class="tok-nn">Text.Parsec.String.Expr</span> <span class="tok-k">as</span> <span class="tok-n">E</span>
<span class="tok-kr">import</span> <span class="tok-k">qualified</span> <span class="tok-nn">Test.HUnit</span> <span class="tok-k">as</span> <span class="tok-n">H</span>
<span class="tok-kr">import</span> <span class="tok-nn">FunctionsAndTypesForParsing</span>

<span class="tok-kr">import</span> <span class="tok-nn">Debug.Trace</span> <span class="tok-p">(</span><span class="tok-nf">trace</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_lineup">11.1. Lineup</h3>
<div class="sect3">
<h4 id="_comments">11.1.1. comments</h4>
<div class="paragraph">
<p>We will start supporting comments. It will support the two standard
comment syntaxes from the standard:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-c1">-- single line comment</span>
<span class="tok-cm">/*</span>
<span class="tok-cm">multiline</span>
<span class="tok-cm">comment</span>
<span class="tok-cm">*/</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>/* */</code> comments do not nest.</p>
</div>
</div>
<div class="sect3">
<h4 id="_literals">11.1.2. literals</h4>
<div class="paragraph">
<p>It will just support positive integral and string literals at this
time. Proper SQL supports more literal types including some quite
weird syntax which we will skip for now.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-mi">1</span>
<span class="tok-mi">500</span>
<span class="tok-s1">&#39;string literal&#39;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_identifiers">11.1.3. identifiers</h4>
<div class="paragraph">
<p>We will use simple identifiers: an identifier may start with a letter
or underscore, and contain letters, underscores and numbers. Full SQL
identifiers are more complicated to support so we will skip this for
now also.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-n">a</span>
<span class="tok-n">something</span>
<span class="tok-n">_test_</span>
<span class="tok-n">a123</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="__dotted_identifiers">11.1.4. 'dotted identifiers'</h4>
<div class="paragraph">
<p>We will do some limited support for identifiers with two parts
separated by a dot. I don&#8217;t want to get into the exact meaning or the
various names used to describe these since it is a bit confusing,
especially in SQL. We can just stick to the syntax. Both parts must
parse according to the identifier rules above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-n">t</span><span class="tok-p">.</span><span class="tok-n">a</span>
<span class="tok-n">something</span><span class="tok-p">.</span><span class="tok-n">something_else</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_star">11.1.5. star</h4>
<div class="paragraph">
<p>We will support the star as special expression which can be used at
the top level of select lists (and a few other places in SQL). We will
also support a 'dotted star'.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-o">*</span>
<span class="tok-n">t</span><span class="tok-p">.</span><span class="tok-o">*</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_function_application">11.1.6. function application</h4>
<div class="paragraph">
<p>This represents any syntax which looks like the normal function
application used in languages like C. The function name must parse as
a valid identifier according to the rules above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-n">f</span><span class="tok-p">()</span>
<span class="tok-k">g</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span>
<span class="tok-n">h</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">,</span><span class="tok-s1">&#39;something&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_operators">11.1.7. operators</h4>
<div class="paragraph">
<p>We will only support a small range of binary operators for now plus a
single prefix unary operator (<code>not</code>). We will attempt to support
correct precedence and associativity for these via the
Text.Parsec.Expr module. Here is a complete list of all the supported
operators.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-n">b</span>
<span class="tok-n">a</span> <span class="tok-o">&gt;</span> <span class="tok-n">b</span>
<span class="tok-n">a</span> <span class="tok-o">&lt;</span> <span class="tok-n">b</span>
<span class="tok-n">a</span> <span class="tok-o">&gt;=</span> <span class="tok-n">b</span>
<span class="tok-n">a</span> <span class="tok-o">&lt;=</span> <span class="tok-n">b</span>
<span class="tok-n">a</span> <span class="tok-o">!=</span> <span class="tok-n">b</span>
<span class="tok-n">a</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-n">b</span> <span class="tok-p">(</span><span class="tok-n">two</span> <span class="tok-n">spellings</span> <span class="tok-k">of</span> <span class="tok-n">the</span> <span class="tok-n">same</span> <span class="tok-n">thing</span><span class="tok-p">,</span> <span class="tok-n">we</span> <span class="tok-n">will</span> <span class="tok-n">parse</span> <span class="tok-n">them</span> <span class="tok-k">as</span>
        <span class="tok-n">separate</span> <span class="tok-n">operators</span> <span class="tok-n">though</span><span class="tok-p">)</span>
<span class="tok-n">a</span> <span class="tok-k">and</span> <span class="tok-n">b</span>
<span class="tok-n">a</span> <span class="tok-k">or</span> <span class="tok-n">b</span>
<span class="tok-mi">1</span> <span class="tok-o">+</span> <span class="tok-mi">2</span>
<span class="tok-mi">1</span> <span class="tok-o">-</span> <span class="tok-mi">2</span>
<span class="tok-mi">1</span> <span class="tok-o">*</span> <span class="tok-mi">2</span>
<span class="tok-mi">1</span> <span class="tok-o">/</span> <span class="tok-mi">2</span>
<span class="tok-s1">&#39;some&#39;</span> <span class="tok-o">||</span> <span class="tok-s1">&#39;thing&#39;</span>
<span class="tok-n">a</span> <span class="tok-k">like</span> <span class="tok-n">b</span>
<span class="tok-k">not</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_case_expression">11.1.8. case expression</h4>
<div class="paragraph">
<p>There are two standard variations of case expressions in SQL. One is
more like a switch statement in C (but is an expression, not a
statement):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">case</span> <span class="tok-n">a</span>
<span class="tok-k">when</span> <span class="tok-mi">3</span> <span class="tok-k">then</span> <span class="tok-s1">&#39;got three&#39;</span>
<span class="tok-k">when</span> <span class="tok-mi">5</span> <span class="tok-k">then</span> <span class="tok-s1">&#39;got five&#39;</span>
<span class="tok-k">else</span> <span class="tok-s1">&#39;neither&#39;</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The other has a boolean expression in each branch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">case</span>
<span class="tok-k">when</span> <span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-mi">3</span> <span class="tok-k">then</span> <span class="tok-s1">&#39;a is three&#39;</span>
<span class="tok-k">when</span> <span class="tok-n">b</span> <span class="tok-o">=</span> <span class="tok-mi">4</span> <span class="tok-k">then</span> <span class="tok-s1">&#39;b is four&#39;</span>
<span class="tok-k">else</span> <span class="tok-s1">&#39;neither&#39;</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The else branch is optional (if it is missing, it implicitly means
'else null').</p>
</div>
</div>
<div class="sect3">
<h4 id="_parentheses">11.1.9. parentheses</h4>
<div class="paragraph">
<p>It will parse and represent parentheses explicitly in the abstract
syntax, like we did with the previous expression parsers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-p">(</span><span class="tok-mi">1</span> <span class="tok-o">+</span> <span class="tok-mi">2</span><span class="tok-p">)</span> <span class="tok-o">*</span> <span class="tok-mi">3</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_abstract_syntax_for_value_expressions">11.2. abstract syntax for value expressions</h3>
<div class="paragraph">
<p>Here is a type to represent value expressions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">data</span> <span class="tok-kt">ValueExpr</span> <span class="tok-ow">=</span> <span class="tok-kt">StringLit</span> <span class="tok-kt">String</span>
               <span class="tok-o">|</span> <span class="tok-kt">NumLit</span> <span class="tok-kt">Integer</span>
               <span class="tok-o">|</span> <span class="tok-kt">Iden</span> <span class="tok-kt">String</span>
               <span class="tok-o">|</span> <span class="tok-kt">DIden</span> <span class="tok-kt">String</span> <span class="tok-kt">String</span> <span class="tok-c1">-- a.b</span>
               <span class="tok-o">|</span> <span class="tok-kt">Star</span>
               <span class="tok-o">|</span> <span class="tok-kt">DStar</span> <span class="tok-kt">String</span> <span class="tok-c1">-- t.*</span>
               <span class="tok-o">|</span> <span class="tok-kt">App</span> <span class="tok-kt">String</span> <span class="tok-p">[</span><span class="tok-kt">ValueExpr</span><span class="tok-p">]</span>
               <span class="tok-o">|</span> <span class="tok-kt">PrefOp</span> <span class="tok-kt">String</span> <span class="tok-kt">ValueExpr</span>
               <span class="tok-o">|</span> <span class="tok-kt">BinOp</span> <span class="tok-kt">ValueExpr</span> <span class="tok-kt">String</span> <span class="tok-kt">ValueExpr</span>
               <span class="tok-o">|</span> <span class="tok-kt">Case</span> <span class="tok-p">(</span><span class="tok-kt">Maybe</span> <span class="tok-kt">ValueExpr</span><span class="tok-p">)</span> <span class="tok-c1">-- test value</span>
                      <span class="tok-p">[(</span><span class="tok-kt">ValueExpr</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span> <span class="tok-c1">-- when branches</span>
                      <span class="tok-p">(</span><span class="tok-kt">Maybe</span> <span class="tok-kt">ValueExpr</span><span class="tok-p">)</span> <span class="tok-c1">-- else value</span>
               <span class="tok-o">|</span> <span class="tok-kt">Parens</span> <span class="tok-kt">ValueExpr</span>
                 <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span><span class="tok-p">,</span><span class="tok-kt">Show</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the plan for tackling this:</p>
</div>
<div class="paragraph">
<p>Let&#8217;s write some simple automated tests to check our progress and
check for regressions.</p>
</div>
<div class="paragraph">
<p>We can start by using the code already written to produce a partial
expression parser, then add parsing for each new constructor one at a
time.</p>
</div>
</div>
<div class="sect2">
<h3 id="_automated_testing_framework">11.3. automated testing framework</h3>
<div class="paragraph">
<p>Let&#8217;s start with some examples we can turn into automated tests. Here
are the constructors above which I think we&#8217;ve already more or less
implemented the parsers for in previous tutorials: <code>NumLit</code>, <code>Iden</code>,
<code>PrefixOp</code>, <code>BinaryOp</code> and <code>Parens</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">numLitTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">numLitTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;1&quot;</span><span class="tok-p">,</span> <span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">)</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;54321&quot;</span><span class="tok-p">,</span> <span class="tok-kt">NumLit</span> <span class="tok-mi">54321</span><span class="tok-p">)]</span>

<span class="tok-nf">idenTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">idenTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;test&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;test&quot;</span><span class="tok-p">)</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;_something3&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;_something3&quot;</span><span class="tok-p">)]</span>

<span class="tok-nf">operatorTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">operatorTests</span> <span class="tok-ow">=</span>
   <span class="tok-n">map</span> <span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">o</span> <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-n">o</span> <span class="tok-o">++</span> <span class="tok-s">&quot; a&quot;</span><span class="tok-p">,</span> <span class="tok-kt">PrefOp</span> <span class="tok-n">o</span> <span class="tok-p">(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)))</span> <span class="tok-p">[</span><span class="tok-s">&quot;not&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;+&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;-&quot;</span><span class="tok-p">]</span>
   <span class="tok-o">++</span> <span class="tok-n">map</span> <span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">o</span> <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-s">&quot;a &quot;</span> <span class="tok-o">++</span> <span class="tok-n">o</span> <span class="tok-o">++</span> <span class="tok-s">&quot; b&quot;</span><span class="tok-p">,</span> <span class="tok-kt">BinOp</span> <span class="tok-p">(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-n">o</span> <span class="tok-p">(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">)))</span>
          <span class="tok-p">[</span><span class="tok-s">&quot;=&quot;</span><span class="tok-p">,</span><span class="tok-s">&quot;&gt;&quot;</span><span class="tok-p">,</span><span class="tok-s">&quot;&lt;&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;&gt;=&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;&lt;=&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;!=&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;&lt;&gt;&quot;</span>
          <span class="tok-p">,</span><span class="tok-s">&quot;and&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;or&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;+&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;-&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;*&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;/&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;||&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;like&quot;</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*ValueExpressions&gt; import Data.List
*ValueExpressions Data.List&gt; putStrLn $ intercalate "\n" $ map show operatorTests
("not a",PrefOp "not" (Iden "a"))
("+ a",PrefOp "+" (Iden "a"))
("- a",PrefOp "-" (Iden "a"))
("a = b",BinOp (Iden "a") "=" (Iden "b"))
("a &gt; b",BinOp (Iden "a") "&gt;" (Iden "b"))
("a &lt; b",BinOp (Iden "a") "&lt;" (Iden "b"))
("a &gt;= b",BinOp (Iden "a") "&gt;=" (Iden "b"))
("a &lt;= b",BinOp (Iden "a") "&lt;=" (Iden "b"))
("a != b",BinOp (Iden "a") "!=" (Iden "b"))
("a &lt;&gt; b",BinOp (Iden "a") "&lt;&gt;" (Iden "b"))
("a and b",BinOp (Iden "a") "and" (Iden "b"))
("a or b",BinOp (Iden "a") "or" (Iden "b"))
("a + b",BinOp (Iden "a") "+" (Iden "b"))
("a - b",BinOp (Iden "a") "-" (Iden "b"))
("a * b",BinOp (Iden "a") "*" (Iden "b"))
("a / b",BinOp (Iden "a") "/" (Iden "b"))
("a || b",BinOp (Iden "a") "||" (Iden "b"))
("a like b",BinOp (Iden "a") "like" (Iden "b"))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parensTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">parensTests</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-s">&quot;(1)&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Parens</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">))]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">basicTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">basicTests</span> <span class="tok-ow">=</span> <span class="tok-n">numLitTests</span> <span class="tok-o">++</span> <span class="tok-n">idenTests</span> <span class="tok-o">++</span> <span class="tok-n">operatorTests</span> <span class="tok-o">++</span> <span class="tok-n">parensTests</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is a test runner which uses HUnit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">makeTest</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-kt">Show</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">H</span><span class="tok-o">.</span><span class="tok-kt">Test</span>
<span class="tok-nf">makeTest</span> <span class="tok-n">parser</span> <span class="tok-p">(</span><span class="tok-n">src</span><span class="tok-p">,</span><span class="tok-n">expected</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-kt">H</span><span class="tok-o">.</span><span class="tok-kt">TestLabel</span> <span class="tok-n">src</span> <span class="tok-o">$</span> <span class="tok-kt">H</span><span class="tok-o">.</span><span class="tok-kt">TestCase</span> <span class="tok-o">$</span> <span class="tok-kr">do</span>
    <span class="tok-kr">let</span> <span class="tok-n">gote</span> <span class="tok-ow">=</span> <span class="tok-n">parse</span> <span class="tok-p">(</span><span class="tok-n">whitespace</span> <span class="tok-o">*&gt;</span> <span class="tok-n">parser</span> <span class="tok-o">&lt;*</span> <span class="tok-n">eof</span><span class="tok-p">)</span> <span class="tok-s">&quot;&quot;</span> <span class="tok-n">src</span>
    <span class="tok-kr">case</span> <span class="tok-n">gote</span> <span class="tok-kr">of</span>
      <span class="tok-kt">Left</span> <span class="tok-n">e</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">H</span><span class="tok-o">.</span><span class="tok-n">assertFailure</span> <span class="tok-o">$</span> <span class="tok-n">show</span> <span class="tok-n">e</span>
      <span class="tok-kt">Right</span> <span class="tok-n">got</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">H</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span> <span class="tok-n">src</span> <span class="tok-n">expected</span> <span class="tok-n">got</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_parsing_we_already_have">11.4. the parsing we already have</h3>
<div class="sect3">
<h4 id="_tokens">11.4.1. tokens</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">lexeme</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span>
<span class="tok-nf">lexeme</span> <span class="tok-n">p</span> <span class="tok-ow">=</span> <span class="tok-n">p</span> <span class="tok-o">&lt;*</span> <span class="tok-n">whitespace</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">integer</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Integer</span>
<span class="tok-nf">integer</span> <span class="tok-ow">=</span> <span class="tok-n">read</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">lexeme</span> <span class="tok-p">(</span><span class="tok-n">many1</span> <span class="tok-n">digit</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">identifier</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">identifier</span> <span class="tok-ow">=</span> <span class="tok-n">lexeme</span> <span class="tok-p">((</span><span class="tok-kt">:</span><span class="tok-p">)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">firstChar</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">many</span> <span class="tok-n">nonFirstChar</span><span class="tok-p">)</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">firstChar</span> <span class="tok-ow">=</span> <span class="tok-n">letter</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;_&#39;</span>
    <span class="tok-n">nonFirstChar</span> <span class="tok-ow">=</span> <span class="tok-n">digit</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">firstChar</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">symbol</span> <span class="tok-ow">::</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">symbol</span> <span class="tok-n">s</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-kr">do</span>
    <span class="tok-n">u</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">many1</span> <span class="tok-p">(</span><span class="tok-n">oneOf</span> <span class="tok-s">&quot;&lt;&gt;=+-^%/*!|&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">guard</span> <span class="tok-p">(</span><span class="tok-n">s</span> <span class="tok-o">==</span> <span class="tok-n">u</span><span class="tok-p">)</span>
    <span class="tok-n">return</span> <span class="tok-n">s</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">openParen</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Char</span>
<span class="tok-nf">openParen</span> <span class="tok-ow">=</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;(&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">closeParen</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Char</span>
<span class="tok-nf">closeParen</span> <span class="tok-ow">=</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;)&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The whitespace parser is below, since it includes some new code to
deal with comments.</p>
</div>
</div>
<div class="sect3">
<h4 id="_helper_functions">11.4.2. helper functions</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">keyword</span> <span class="tok-ow">::</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">keyword</span> <span class="tok-n">k</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-o">$</span> <span class="tok-kr">do</span>
    <span class="tok-n">i</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">identifier</span>
    <span class="tok-n">guard</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">==</span> <span class="tok-n">k</span><span class="tok-p">)</span>
    <span class="tok-n">return</span> <span class="tok-n">k</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: find a place to discuss putting try in the keyword and symbol
parsers. I think maybe this should come in the error message tutorial?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parens</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span>
<span class="tok-nf">parens</span> <span class="tok-ow">=</span> <span class="tok-n">between</span> <span class="tok-n">openParen</span> <span class="tok-n">closeParen</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_terms">11.4.3. terms</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">num</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">num</span> <span class="tok-ow">=</span> <span class="tok-kt">NumLit</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">integer</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">iden</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">iden</span> <span class="tok-ow">=</span> <span class="tok-kt">Iden</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">identifier</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I&#8217;m going to parameterize the parens parser again to avoid rewriting
lots of very similar code in this tutorial.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parensValue</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">parensValue</span> <span class="tok-n">val</span> <span class="tok-ow">=</span> <span class="tok-kt">Parens</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-n">val</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">term0</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">term0</span> <span class="tok-ow">=</span> <span class="tok-n">iden</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">num</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">parensValue</span> <span class="tok-n">valueExpr0</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_operator_table_and_the_first_value_expression_parser">11.4.4. operator table and the first value expression parser</h4>
<div class="paragraph">
<p>I&#8217;ve added all the new operators in this table.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">table</span> <span class="tok-ow">::</span> <span class="tok-p">[[</span><span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Operator</span> <span class="tok-kt">ValueExpr</span><span class="tok-p">]]</span>
<span class="tok-nf">table</span> <span class="tok-ow">=</span> <span class="tok-p">[[</span><span class="tok-n">prefix</span> <span class="tok-s">&quot;-&quot;</span><span class="tok-p">,</span> <span class="tok-n">prefix</span> <span class="tok-s">&quot;+&quot;</span><span class="tok-p">]</span>
         <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;^&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span><span class="tok-p">]</span>
         <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;*&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span>
          <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;/&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span>
          <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;%&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span><span class="tok-p">]</span>
         <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;+&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span>
          <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;-&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span><span class="tok-p">]</span>
         <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&lt;=&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocRight</span>
          <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&gt;=&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocRight</span>
          <span class="tok-p">,</span><span class="tok-n">binaryK</span> <span class="tok-s">&quot;like&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocNone</span>
          <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;!=&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocRight</span>
          <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&lt;&gt;&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocRight</span>
          <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;||&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocRight</span><span class="tok-p">]</span>
         <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&lt;&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocNone</span>
          <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&gt;&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocNone</span><span class="tok-p">]</span>
         <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;=&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocRight</span><span class="tok-p">]</span>
         <span class="tok-p">,[</span><span class="tok-n">prefixK</span> <span class="tok-s">&quot;not&quot;</span><span class="tok-p">]</span>
         <span class="tok-p">,[</span><span class="tok-n">binaryK</span> <span class="tok-s">&quot;and&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span><span class="tok-p">]</span>
         <span class="tok-p">,[</span><span class="tok-n">binaryK</span> <span class="tok-s">&quot;or&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span><span class="tok-p">]]</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">binary</span> <span class="tok-n">name</span> <span class="tok-n">assoc</span> <span class="tok-ow">=</span>
        <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Infix</span> <span class="tok-p">(</span><span class="tok-n">mkBinOp</span> <span class="tok-n">name</span> <span class="tok-o">&lt;$</span> <span class="tok-n">symbol</span> <span class="tok-n">name</span><span class="tok-p">)</span> <span class="tok-n">assoc</span>
    <span class="tok-n">mkBinOp</span> <span class="tok-n">nm</span> <span class="tok-n">a</span> <span class="tok-n">b</span> <span class="tok-ow">=</span> <span class="tok-kt">BinOp</span> <span class="tok-n">a</span> <span class="tok-n">nm</span> <span class="tok-n">b</span>
    <span class="tok-n">prefix</span> <span class="tok-n">name</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Prefix</span> <span class="tok-p">(</span><span class="tok-kt">PrefOp</span> <span class="tok-n">name</span> <span class="tok-o">&lt;$</span> <span class="tok-n">symbol</span> <span class="tok-n">name</span><span class="tok-p">)</span>
    <span class="tok-n">binaryK</span> <span class="tok-n">name</span> <span class="tok-n">assoc</span> <span class="tok-ow">=</span>
        <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Infix</span> <span class="tok-p">(</span><span class="tok-n">mkBinOp</span> <span class="tok-n">name</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword</span> <span class="tok-n">name</span><span class="tok-p">)</span> <span class="tok-n">assoc</span>
    <span class="tok-n">prefixK</span> <span class="tok-n">name</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Prefix</span> <span class="tok-p">(</span><span class="tok-kt">PrefOp</span> <span class="tok-n">name</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword</span> <span class="tok-n">name</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">valueExpr0</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">valueExpr0</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-n">buildExpressionParser</span> <span class="tok-n">table</span> <span class="tok-n">term0</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can run the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*ValueExpressions&gt; H.runTestTT $ H.TestList $ map (makeTest valueExpr0) basicTests
Cases: 23  Tried: 23  Errors: 0  Failures: 0
Counts {cases = 23, tried = 23, errors = 0, failures = 0}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_new_parsers">11.5. new parsers</h3>
<div class="paragraph">
<p>Let&#8217;s start extending things one constructor at a time, but first we
will do comments.</p>
</div>
<div class="sect3">
<h4 id="_whitespace_and_comments">11.5.1. whitespace and comments</h4>
<div class="paragraph">
<p>Here is our old whitespace parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">whitespace0</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span>
<span class="tok-nf">whitespace0</span> <span class="tok-ow">=</span> <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">many</span> <span class="tok-o">$</span> <span class="tok-n">oneOf</span> <span class="tok-s">&quot; </span><span class="tok-se">\n\t</span><span class="tok-s">&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We are going to change this to do comments as well.</p>
</div>
<div class="paragraph">
<p>TODO: build these two parsers up in stages, show why each bit is there</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">lineComment</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span>
<span class="tok-nf">lineComment</span> <span class="tok-ow">=</span> <span class="tok-n">void</span> <span class="tok-p">(</span><span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-n">string</span> <span class="tok-s">&quot;--&quot;</span><span class="tok-p">)</span> <span class="tok-o">*&gt;</span>
                    <span class="tok-n">manyTill</span> <span class="tok-n">anyChar</span> <span class="tok-p">(</span><span class="tok-n">void</span> <span class="tok-p">(</span><span class="tok-n">char</span> <span class="tok-sc">&#39;</span><span class="tok-se">\n</span><span class="tok-sc">&#39;</span><span class="tok-p">)</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">eof</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">blockComment</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span>
<span class="tok-nf">blockComment</span> <span class="tok-ow">=</span> <span class="tok-n">void</span> <span class="tok-p">(</span><span class="tok-c1">-- no nesting of block comments in SQL</span>
                     <span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-n">string</span> <span class="tok-s">&quot;/*&quot;</span><span class="tok-p">)</span>
                     <span class="tok-c1">-- TODO: why is try used here</span>
                     <span class="tok-o">*&gt;</span> <span class="tok-n">manyTill</span> <span class="tok-n">anyChar</span> <span class="tok-p">(</span><span class="tok-n">try</span> <span class="tok-o">$</span> <span class="tok-n">string</span> <span class="tok-s">&quot;*/&quot;</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>todo: discuss how to compose to create the whitespace parser
todo: create the whitespace parser without many1 and return () and
show the problem.</p>
</div>
<div class="paragraph">
<p>Here is the final parser for whitespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">whitespace</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span>
<span class="tok-nf">whitespace</span> <span class="tok-ow">=</span>
    <span class="tok-n">choice</span> <span class="tok-p">[</span><span class="tok-n">simpleWhitespace</span> <span class="tok-o">*&gt;</span> <span class="tok-n">whitespace</span>
           <span class="tok-p">,</span><span class="tok-n">lineComment</span> <span class="tok-o">*&gt;</span> <span class="tok-n">whitespace</span>
           <span class="tok-p">,</span><span class="tok-n">blockComment</span> <span class="tok-o">*&gt;</span> <span class="tok-n">whitespace</span>
           <span class="tok-p">,</span><span class="tok-n">return</span> <span class="tok-nb">()</span><span class="tok-p">]</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">lineComment</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-n">string</span> <span class="tok-s">&quot;--&quot;</span><span class="tok-p">)</span>
                  <span class="tok-o">*&gt;</span> <span class="tok-n">manyTill</span> <span class="tok-n">anyChar</span> <span class="tok-p">(</span><span class="tok-n">void</span> <span class="tok-p">(</span><span class="tok-n">char</span> <span class="tok-sc">&#39;</span><span class="tok-se">\n</span><span class="tok-sc">&#39;</span><span class="tok-p">)</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">eof</span><span class="tok-p">)</span>
    <span class="tok-n">blockComment</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-n">string</span> <span class="tok-s">&quot;/*&quot;</span><span class="tok-p">)</span>
                   <span class="tok-o">*&gt;</span> <span class="tok-n">manyTill</span> <span class="tok-n">anyChar</span> <span class="tok-p">(</span><span class="tok-n">try</span> <span class="tok-o">$</span> <span class="tok-n">string</span> <span class="tok-s">&quot;*/&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">simpleWhitespace</span> <span class="tok-ow">=</span> <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">many1</span> <span class="tok-p">(</span><span class="tok-n">oneOf</span> <span class="tok-s">&quot; </span><span class="tok-se">\t\n</span><span class="tok-s">&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_string_literal">11.5.2. string literal</h4>
<div class="paragraph">
<p>Our string literal is any characters except single quote enclosed in
single quotes. We aren&#8217;t going to support other string literal
syntaxes or escaping single quotes within a string right now.</p>
</div>
<div class="paragraph">
<p>Here are some examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">stringLiteralTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">stringLiteralTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;&#39;&#39;&quot;</span><span class="tok-p">,</span> <span class="tok-kt">StringLit</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">)</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;&#39;test&#39;&quot;</span><span class="tok-p">,</span> <span class="tok-kt">StringLit</span> <span class="tok-s">&quot;test&quot;</span><span class="tok-p">)]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We need a new token parser for string literals:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">stringToken</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">stringToken</span> <span class="tok-ow">=</span> <span class="tok-n">lexeme</span> <span class="tok-p">(</span><span class="tok-n">char</span> <span class="tok-sc">&#39;</span><span class="tok-se">\&#39;</span><span class="tok-sc">&#39;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">manyTill</span> <span class="tok-n">anyChar</span> <span class="tok-p">(</span><span class="tok-n">char</span> <span class="tok-sc">&#39;</span><span class="tok-se">\&#39;</span><span class="tok-sc">&#39;</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: more explanation</p>
</div>
<div class="paragraph">
<p>And the string literal expression parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">stringLit</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">stringLit</span> <span class="tok-ow">=</span> <span class="tok-kt">StringLit</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">stringToken</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the new value expression parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">term1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">term1</span> <span class="tok-ow">=</span> <span class="tok-n">iden</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">num</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">parensValue</span> <span class="tok-n">valueExpr1</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">stringLit</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">valueExpr1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">valueExpr1</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-n">buildExpressionParser</span> <span class="tok-n">table</span> <span class="tok-n">term1</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*ValueExpressions&gt; H.runTestTT $ H.TestList $ map (makeTest valueExpr1) (basicTests ++ stringLiteralTests)
Cases: 25  Tried: 25  Errors: 0  Failures: 0
Counts {cases = 25, tried = 25, errors = 0, failures = 0}</code></pre>
</div>
</div>
<div class="paragraph">
<p>So far, so good.</p>
</div>
</div>
<div class="sect3">
<h4 id="_dotted_identifier">11.5.3. dotted identifier</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">dIdenTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">dIdenTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;t.a&quot;</span><span class="tok-p">,</span> <span class="tok-kt">DIden</span> <span class="tok-s">&quot;t&quot;</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is a new token parser to use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">dot</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Char</span>
<span class="tok-nf">dot</span> <span class="tok-ow">=</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;.&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">dIden</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">dIden</span> <span class="tok-ow">=</span> <span class="tok-kt">DIden</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">identifier</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-p">(</span><span class="tok-n">dot</span> <span class="tok-o">*&gt;</span> <span class="tok-n">identifier</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">term2</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">term2</span> <span class="tok-ow">=</span> <span class="tok-n">iden</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">num</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">parensValue</span> <span class="tok-n">valueExpr2</span>
        <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">stringLit</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">dIden</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">valueExpr2</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">valueExpr2</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-n">buildExpressionParser</span> <span class="tok-n">table</span> <span class="tok-n">term2</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*ValueExpressions&gt; H.runTestTT $ H.TestList $ map (makeTest valueExpr2) (basicTests ++ stringLiteralTests ++ dIdenTests)
 ### Failure in: 25:t.a
(line 1, column 2):
unexpected '.'
expecting digit, letter, "_", "--", "/*", operator or end of input
Cases: 26  Tried: 26  Errors: 0  Failures: 1
Counts {cases = 26, tried = 26, errors = 0, failures = 1}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Do you know why this happened? Can you think of a way to solve this?</p>
</div>
<div class="paragraph">
<p>Here is the usual blunt hammer technique: reorder the choices to put
the longest choice first and use <code>try</code> when there is a common prefix.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">term3</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">term3</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-n">dIden</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">iden</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">num</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">parensValue</span> <span class="tok-n">valueExpr3</span>
        <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">stringLit</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">valueExpr3</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">valueExpr3</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-n">buildExpressionParser</span> <span class="tok-n">table</span> <span class="tok-n">term3</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*ValueExpressions&gt; H.runTestTT $ H.TestList $ map (makeTest valueExpr3) (basicTests ++ stringLiteralTests ++ dIdenTests)
Cases: 26  Tried: 26  Errors: 0  Failures: 0
Counts {cases = 26, tried = 26, errors = 0, failures = 0}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_star_2">11.5.4. star</h4>
<div class="paragraph">
<p>star - no surprises</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">starTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">starTests</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-s">&quot;*&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Star</span><span class="tok-p">)]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">star</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">star</span> <span class="tok-ow">=</span> <span class="tok-kt">Star</span> <span class="tok-o">&lt;$</span> <span class="tok-n">symbol</span> <span class="tok-s">&quot;*&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">term4</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">term4</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-n">dIden</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">iden</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">num</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">parensValue</span> <span class="tok-n">valueExpr4</span>
        <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">stringLit</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">star</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">valueExpr4</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">valueExpr4</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-n">buildExpressionParser</span> <span class="tok-n">table</span> <span class="tok-n">term4</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*ValueExpressions&gt; H.runTestTT $ H.TestList $ map (makeTest valueExpr4) (basicTests ++ stringLiteralTests ++ dIdenTests ++ starTests)
Cases: 27  Tried: 27  Errors: 0  Failures: 0
Counts {cases = 27, tried = 27, errors = 0, failures = 0}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dotted_star">11.5.5. dotted star</h4>
<div class="paragraph">
<p>Here is dotted star.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">dStarTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">dStarTests</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-s">&quot;t.*&quot;</span><span class="tok-p">,</span> <span class="tok-kt">DStar</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">dstar</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">dstar</span> <span class="tok-ow">=</span> <span class="tok-kt">DStar</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-p">(</span><span class="tok-n">identifier</span> <span class="tok-o">&lt;*</span> <span class="tok-n">dot</span> <span class="tok-o">&lt;*</span> <span class="tok-n">symbol</span> <span class="tok-s">&quot;*&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll have the same issue we&#8217;ve seen before, so let&#8217;s go straight to
the solution.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">term5</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">term5</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-n">dstar</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">try</span> <span class="tok-n">dIden</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">iden</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">num</span>
        <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">parensValue</span> <span class="tok-n">valueExpr5</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">stringLit</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">star</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">valueExpr5</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">valueExpr5</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-n">buildExpressionParser</span> <span class="tok-n">table</span> <span class="tok-n">term5</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*ValueExpressions&gt; H.runTestTT $ H.TestList $ map (makeTest valueExpr5) (basicTests ++ stringLiteralTests ++ dIdenTests ++ starTests ++ dStarTests)
Cases: 28  Tried: 28  Errors: 0  Failures: 0
Counts {cases = 28, tried = 28, errors = 0, failures = 0}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_app">11.5.6. app</h4>
<div class="paragraph">
<p>The App constructor is used for syntax which looks like regular
function application: f(), f(a), f(a,b), etc.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">appTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">appTests</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-s">&quot;f()&quot;</span><span class="tok-p">,</span> <span class="tok-kt">App</span> <span class="tok-s">&quot;f&quot;</span> <span class="tok-kt">[]</span><span class="tok-p">)</span>
           <span class="tok-p">,(</span><span class="tok-s">&quot;f(1)&quot;</span><span class="tok-p">,</span> <span class="tok-kt">App</span> <span class="tok-s">&quot;f&quot;</span> <span class="tok-p">[</span><span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">])</span>
           <span class="tok-p">,(</span><span class="tok-s">&quot;f(1,a)&quot;</span><span class="tok-p">,</span> <span class="tok-kt">App</span> <span class="tok-s">&quot;f&quot;</span> <span class="tok-p">[</span><span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">])]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the parser, parameterized like the <code>parensValue</code> parser for
the same reason, so we can reuse the code for different versions of
the value expression parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">app</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">app</span> <span class="tok-n">val</span> <span class="tok-ow">=</span> <span class="tok-kt">App</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">identifier</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">parens</span> <span class="tok-p">(</span><span class="tok-n">commaSep</span> <span class="tok-n">val</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And here is the <code>commaSep</code> helper:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">commaSep</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span>
<span class="tok-nf">commaSep</span> <span class="tok-ow">=</span> <span class="tok-p">(`</span><span class="tok-n">sepBy</span><span class="tok-p">`</span> <span class="tok-n">comma</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">comma</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Char</span>
<span class="tok-nf">comma</span> <span class="tok-ow">=</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;,&#39;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is another parser with the <code>identifier</code> prefix, so another <code>try</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">term6</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">term6</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-n">app</span> <span class="tok-n">valueExpr6</span><span class="tok-p">)</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">try</span> <span class="tok-n">dstar</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">try</span> <span class="tok-n">dIden</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">iden</span>
        <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">num</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">parensValue</span> <span class="tok-n">valueExpr6</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">stringLit</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">star</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">valueExpr6</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">valueExpr6</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-n">buildExpressionParser</span> <span class="tok-n">table</span> <span class="tok-n">term6</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*ValueExpressions&gt; H.runTestTT $ H.TestList $ map (makeTest valueExpr6) (basicTests ++ stringLiteralTests ++ dIdenTests ++ starTests ++ dStarTests ++ appTests)
Cases: 31  Tried: 31  Errors: 0  Failures: 0
Counts {cases = 31, tried = 31, errors = 0, failures = 0}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Everything looks good.</p>
</div>
</div>
<div class="sect3">
<h4 id="_case">11.5.7. case</h4>
<div class="paragraph">
<p>Here is something a little more interesting.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">caseTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">caseTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;case a when 1 then 2 end&quot;</span>
     <span class="tok-p">,</span><span class="tok-kt">Case</span> <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-p">[(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-kt">NumLit</span> <span class="tok-mi">2</span><span class="tok-p">)]</span> <span class="tok-kt">Nothing</span><span class="tok-p">)</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;case a when 1 then 2 when 3 then 4 end&quot;</span>
     <span class="tok-p">,</span><span class="tok-kt">Case</span> <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span>
           <span class="tok-p">[(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-kt">NumLit</span> <span class="tok-mi">2</span><span class="tok-p">)</span>
           <span class="tok-p">,(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">3</span><span class="tok-p">,</span> <span class="tok-kt">NumLit</span> <span class="tok-mi">4</span><span class="tok-p">)]</span>
           <span class="tok-kt">Nothing</span><span class="tok-p">)</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;case a when 1 then 2 when 3 then 4 else 5 end&quot;</span>
     <span class="tok-p">,</span><span class="tok-kt">Case</span> <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span>
           <span class="tok-p">[(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-kt">NumLit</span> <span class="tok-mi">2</span><span class="tok-p">)</span>
           <span class="tok-p">,(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">3</span><span class="tok-p">,</span> <span class="tok-kt">NumLit</span> <span class="tok-mi">4</span><span class="tok-p">)]</span>
           <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">NumLit</span> <span class="tok-mi">5</span><span class="tok-p">))</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;case when a=1 then 2 when a=3 then 4 else 5 end&quot;</span>
     <span class="tok-p">,</span><span class="tok-kt">Case</span> <span class="tok-kt">Nothing</span>
           <span class="tok-p">[(</span><span class="tok-kt">BinOp</span> <span class="tok-p">(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;=&quot;</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">),</span> <span class="tok-kt">NumLit</span> <span class="tok-mi">2</span><span class="tok-p">)</span>
           <span class="tok-p">,(</span><span class="tok-kt">BinOp</span> <span class="tok-p">(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;=&quot;</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">3</span><span class="tok-p">),</span> <span class="tok-kt">NumLit</span> <span class="tok-mi">4</span><span class="tok-p">)]</span>
           <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">NumLit</span> <span class="tok-mi">5</span><span class="tok-p">))</span>
    <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>How can we approach this? We know that there will always be a case
keyword at the start, and an end keyword at the end. Each when branch
seems to be self contained.</p>
</div>
<div class="paragraph">
<p>Here is a rough pseudo-code sketch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>keyword "case"
optional test_expression
many1 when_clause
optional else clause
keyword "end"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the case parser based simply on this pseudo-code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">caseValue0</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">caseValue0</span> <span class="tok-n">val</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;case&quot;</span>
    <span class="tok-n">testExp</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">val</span>
    <span class="tok-n">whens</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">many1</span> <span class="tok-n">whenClause</span>
    <span class="tok-n">els</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">elseClause</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;end&quot;</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Case</span> <span class="tok-n">testExp</span> <span class="tok-n">whens</span> <span class="tok-n">els</span>
 <span class="tok-kr">where</span>
   <span class="tok-n">whenClause</span> <span class="tok-ow">=</span> <span class="tok-p">(,)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-p">(</span><span class="tok-n">keyword</span> <span class="tok-s">&quot;when&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">val</span><span class="tok-p">)</span>
                    <span class="tok-o">&lt;*&gt;</span> <span class="tok-p">(</span><span class="tok-n">keyword</span> <span class="tok-s">&quot;then&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">val</span><span class="tok-p">)</span>
   <span class="tok-n">elseClause</span> <span class="tok-ow">=</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;else&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">val</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s try it on its own first and see if we have any problems:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*ValueExpressions&gt; H.runTestTT $ H.TestList $ map (makeTest (caseValue0 valueExpr6)) caseTests in: 3:case when a=1 then 2 when a=3 then 4 else 5 end
(line 1, column 12):
unexpected "="
expecting operator, digit, letter, "_", "--" or "/*"
Cases: 4  Tried: 4  Errors: 0  Failures: 1
Counts {cases = 4, tried = 4, errors = 0, failures = 1}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Three work, and one fails. What happened here? Try to run the parsing
code in your head to see if you can work out what the problem is.</p>
</div>
<div class="paragraph">
<p>Here is a method we can use when you can&#8217;t manage to locate a problem
in this way.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s single out the failure first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*ValueExpressions&gt; parseWithEof (caseValue0 valueExpr6) "case when a=1 then 2 when a=3 then 4 else 5 end"
Left (line 1, column 12):
unexpected "="
expecting operator, digit, letter, "_", "--" or "/*"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the <code>caseValue</code> parser rewritten with <code>trace</code> interleaved:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">caseValue1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">caseValue1</span> <span class="tok-n">val</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">trace</span> <span class="tok-s">&quot;start case&quot;</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;case&quot;</span>
    <span class="tok-n">trace</span> <span class="tok-s">&quot;read case keyword&quot;</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
    <span class="tok-n">testExp</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">val</span>
    <span class="tok-n">trace</span> <span class="tok-p">(</span><span class="tok-s">&quot;read testExpr: &quot;</span> <span class="tok-o">++</span> <span class="tok-n">show</span> <span class="tok-n">testExp</span><span class="tok-p">)</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
    <span class="tok-n">whens</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">many1</span> <span class="tok-n">whenClause</span>
    <span class="tok-n">trace</span> <span class="tok-p">(</span><span class="tok-s">&quot;read whens: &quot;</span> <span class="tok-o">++</span> <span class="tok-n">show</span> <span class="tok-p">(</span><span class="tok-n">length</span> <span class="tok-n">whens</span><span class="tok-p">))</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
    <span class="tok-n">els</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">elseClause</span>
    <span class="tok-n">trace</span> <span class="tok-p">(</span><span class="tok-s">&quot;read else: &quot;</span> <span class="tok-o">++</span> <span class="tok-n">show</span> <span class="tok-n">els</span><span class="tok-p">)</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;end&quot;</span>
    <span class="tok-n">trace</span> <span class="tok-s">&quot;read end keyword&quot;</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Case</span> <span class="tok-n">testExp</span> <span class="tok-n">whens</span> <span class="tok-n">els</span>
 <span class="tok-kr">where</span>
   <span class="tok-n">whenClause</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
       <span class="tok-n">trace</span> <span class="tok-s">&quot;start when clause&quot;</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
       <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;when&quot;</span>
       <span class="tok-n">trace</span> <span class="tok-s">&quot;read when keyword&quot;</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
       <span class="tok-n">w</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">val</span>
       <span class="tok-n">trace</span> <span class="tok-p">(</span><span class="tok-s">&quot;read when exp: &quot;</span> <span class="tok-o">++</span> <span class="tok-n">show</span> <span class="tok-n">w</span><span class="tok-p">)</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
       <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;then&quot;</span>
       <span class="tok-n">trace</span> <span class="tok-s">&quot;read then keyword&quot;</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
       <span class="tok-n">t</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">val</span>
       <span class="tok-n">trace</span> <span class="tok-p">(</span><span class="tok-s">&quot;read then exp: &quot;</span> <span class="tok-o">++</span> <span class="tok-n">show</span> <span class="tok-n">t</span><span class="tok-p">)</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
       <span class="tok-n">return</span> <span class="tok-p">(</span><span class="tok-n">w</span><span class="tok-p">,</span><span class="tok-n">t</span><span class="tok-p">)</span>
   <span class="tok-n">elseClause</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
       <span class="tok-n">trace</span> <span class="tok-s">&quot;start else clause&quot;</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
       <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;else&quot;</span>
       <span class="tok-n">trace</span> <span class="tok-s">&quot;read else keyword&quot;</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
       <span class="tok-n">v</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">val</span>
       <span class="tok-n">trace</span> <span class="tok-p">(</span><span class="tok-s">&quot;read else exp: &quot;</span> <span class="tok-o">++</span> <span class="tok-n">show</span> <span class="tok-n">v</span><span class="tok-p">)</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
       <span class="tok-n">return</span> <span class="tok-n">v</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now when we run the test, we can see a trace of what happens:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*ValueExpressions&gt; parseWithEof (caseValue1 valueExpr6) "case when a=1 then 2 when a=3 then 4 else 5 end"
start case
read case keyword
read testExpr: Just (Iden "when")
start when clause
Left (line 1, column 12):
unexpected "="
expecting operator, digit, letter, "_", "--" or "/*"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Look at the trace and see if you spot the problem.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve parsed the <code>when</code> keyword as an identifier for the optional
first expression. The way we deal with this is to use a new identifier
parser which has a blacklist of keywords which can&#8217;t be identifiers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">caseValue2</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">caseValue2</span> <span class="tok-n">val</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">trace</span> <span class="tok-s">&quot;start case&quot;</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;case&quot;</span>
    <span class="tok-n">trace</span> <span class="tok-s">&quot;read case keyword&quot;</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
    <span class="tok-n">testExp</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">caseVal</span>
    <span class="tok-n">trace</span> <span class="tok-p">(</span><span class="tok-s">&quot;read testExpr: &quot;</span> <span class="tok-o">++</span> <span class="tok-n">show</span> <span class="tok-n">testExp</span><span class="tok-p">)</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
    <span class="tok-n">whens</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">many1</span> <span class="tok-n">whenClause</span>
    <span class="tok-n">trace</span> <span class="tok-p">(</span><span class="tok-s">&quot;read whens: &quot;</span> <span class="tok-o">++</span> <span class="tok-n">show</span> <span class="tok-p">(</span><span class="tok-n">length</span> <span class="tok-n">whens</span><span class="tok-p">))</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
    <span class="tok-n">els</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">elseClause</span>
    <span class="tok-n">trace</span> <span class="tok-p">(</span><span class="tok-s">&quot;read else: &quot;</span> <span class="tok-o">++</span> <span class="tok-n">show</span> <span class="tok-n">els</span><span class="tok-p">)</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;end&quot;</span>
    <span class="tok-n">trace</span> <span class="tok-s">&quot;read end keyword&quot;</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Case</span> <span class="tok-n">testExp</span> <span class="tok-n">whens</span> <span class="tok-n">els</span>
 <span class="tok-kr">where</span>
   <span class="tok-n">whenClause</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
       <span class="tok-n">trace</span> <span class="tok-s">&quot;start when clause&quot;</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
       <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;when&quot;</span>
       <span class="tok-n">trace</span> <span class="tok-s">&quot;read when keyword&quot;</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
       <span class="tok-n">w</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">caseVal</span>
       <span class="tok-n">trace</span> <span class="tok-p">(</span><span class="tok-s">&quot;read when exp: &quot;</span> <span class="tok-o">++</span> <span class="tok-n">show</span> <span class="tok-n">w</span><span class="tok-p">)</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
       <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;then&quot;</span>
       <span class="tok-n">trace</span> <span class="tok-s">&quot;read then keyword&quot;</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
       <span class="tok-n">t</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">caseVal</span>
       <span class="tok-n">trace</span> <span class="tok-p">(</span><span class="tok-s">&quot;read then exp: &quot;</span> <span class="tok-o">++</span> <span class="tok-n">show</span> <span class="tok-n">t</span><span class="tok-p">)</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
       <span class="tok-n">return</span> <span class="tok-p">(</span><span class="tok-n">w</span><span class="tok-p">,</span><span class="tok-n">t</span><span class="tok-p">)</span>
   <span class="tok-n">elseClause</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
       <span class="tok-n">trace</span> <span class="tok-s">&quot;start else clause&quot;</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
       <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;else&quot;</span>
       <span class="tok-n">trace</span> <span class="tok-s">&quot;read else keyword&quot;</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
       <span class="tok-n">v</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">caseVal</span>
       <span class="tok-n">trace</span> <span class="tok-p">(</span><span class="tok-s">&quot;read else exp: &quot;</span> <span class="tok-o">++</span> <span class="tok-n">show</span> <span class="tok-n">v</span><span class="tok-p">)</span> <span class="tok-o">$</span> <span class="tok-n">return</span> <span class="tok-nb">()</span>
       <span class="tok-n">return</span> <span class="tok-n">v</span>
   <span class="tok-c1">-- here is the fix, we replace calls to `val` with calls to</span>
   <span class="tok-c1">-- this function which prevents any of the case keywords from</span>
   <span class="tok-c1">-- being parsed as identifiers</span>
   <span class="tok-n">caseVal</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-o">$</span> <span class="tok-kr">do</span>
       <span class="tok-n">v</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">val</span>
       <span class="tok-n">guard</span> <span class="tok-o">$</span> <span class="tok-kr">case</span> <span class="tok-n">v</span> <span class="tok-kr">of</span>
           <span class="tok-kt">Iden</span> <span class="tok-n">i</span> <span class="tok-o">|</span> <span class="tok-n">i</span> <span class="tok-p">`</span><span class="tok-n">elem</span><span class="tok-p">`</span> <span class="tok-p">[</span><span class="tok-s">&quot;case&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;when&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;then&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;else&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;end&quot;</span><span class="tok-p">]</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">False</span>
           <span class="tok-kr">_</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">True</span>
       <span class="tok-n">return</span> <span class="tok-n">v</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Maybe this blacklist used in this way isn&#8217;t permissive enough, or is
too permissive, but let&#8217;s not get lost in these details right now, and
come back to it later.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*ValueExpressions&gt; parseWithEof (caseValue2 valueExpr6) "case when a=1 then 2 when a=3 then 4 else 5 end"
start case
read case keyword
read testExpr: Nothing
start when clause
read when keyword
read when exp: BinOp (Iden "a") "=" (NumLit 1)
read then keyword
read then exp: NumLit 2
read when exp: BinOp (Iden "a") "=" (NumLit 3)
read then keyword
read then exp: NumLit 4
read whens: 2
start else clause
read else keyword
read else exp: NumLit 5
read else: Just (NumLit 5)
read end keyword
Right (Case Nothing [(BinOp (Iden "a") "=" (NumLit 1),NumLit 2),(BinOp (Iden "a") "=" (NumLit 3),NumLit 4)] (Just (NumLit 5)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Looks good. Have a close look through the trace to see if you can
follow it all and it makes sense. TODO: There appear to be some
messages missing - I think it is some sort of memoization effect.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s run all the tests with the tracing still in so if there are any
failures we can zero in on them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*ValueExpressions&gt; H.runTestTT $ H.TestList $ map (makeTest (caseValue2 valueExpr6)) caseTests
Cases: 4  Tried: 0  Errors: 0  Failures: 0start case
read case keyword
read testExpr: Just (Iden "a")
start when clause
read when keyword
read when exp: NumLit 1
read then keyword
read then exp: NumLit 2
read whens: 1
start else clause
read else: Nothing
read end keyword
Cases: 4  Tried: 1  Errors: 0  Failures: 0read testExpr: Just (Iden "a")
read when exp: NumLit 1
read then keyword
read then exp: NumLit 2
read when exp: NumLit 3
read then keyword
read then exp: NumLit 4
read whens: 2
read else: Nothing
read end keyword
Cases: 4  Tried: 2  Errors: 0  Failures: 0read testExpr: Just (Iden "a")
read when exp: NumLit 1
read then keyword
read then exp: NumLit 2
read when exp: NumLit 3
read then keyword
read then exp: NumLit 4
read whens: 2
read else keyword
read else exp: NumLit 5
read else: Just (NumLit 5)
read end keyword
Cases: 4  Tried: 3  Errors: 0  Failures: 0read testExpr: Nothing
read when exp: BinOp (Iden "a") "=" (NumLit 1)
read then keyword
read then exp: NumLit 2
read when exp: BinOp (Iden "a") "=" (NumLit 3)
read then keyword
read then exp: NumLit 4
read whens: 2
read else exp: NumLit 5
read else: Just (NumLit 5)
read end keyword
Cases: 4  Tried: 4  Errors: 0  Failures: 0
Counts {cases = 4, tried = 4, errors = 0, failures = 0}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the full expression parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">term7</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">term7</span> <span class="tok-ow">=</span> <span class="tok-n">caseValue2</span> <span class="tok-n">valueExpr7</span>
        <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-n">app</span> <span class="tok-n">valueExpr7</span><span class="tok-p">)</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">try</span> <span class="tok-n">dstar</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">try</span> <span class="tok-n">dIden</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">iden</span>
        <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">num</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">parensValue</span> <span class="tok-n">valueExpr7</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">stringLit</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">star</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">valueExpr7</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">valueExpr7</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-n">buildExpressionParser</span> <span class="tok-n">table</span> <span class="tok-n">term7</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*ValueExpressions&gt; H.runTestTT $ H.TestList $ map (makeTest valueExpr7) (basicTests ++ stringLiteralTests ++ dIdenTests ++ starTests ++ dStarTests ++ appTests ++ caseTests)
Cases: 35  Tried: 0  Errors: 0  Failures: 0start case
Cases: 35  Tried: 31  Errors: 0  Failures: 0read case keyword
read testExpr: Just (Iden "a")
start when clause
read when keyword
read when exp: NumLit 1
read then keyword
read then exp: NumLit 2
read whens: 1
start else clause
read else: Nothing
read end keyword
Cases: 35  Tried: 32  Errors: 0  Failures: 0read testExpr: Just (Iden "a")
read when exp: NumLit 1
read then keyword
read then exp: NumLit 2
read when exp: NumLit 3
read then keyword
read then exp: NumLit 4
read whens: 2
read else: Nothing
read end keyword
Cases: 35  Tried: 33  Errors: 0  Failures: 0read testExpr: Just (Iden "a")
read when exp: NumLit 1
read then keyword
read then exp: NumLit 2
read when exp: NumLit 3
read then keyword
read then exp: NumLit 4
read whens: 2
read else keyword
read else exp: NumLit 5
read else: Just (NumLit 5)
read end keyword
Cases: 35  Tried: 34  Errors: 0  Failures: 0read testExpr: Nothing
read when exp: BinOp (Iden "a") "=" (NumLit 1)
read then keyword
read then exp: NumLit 2
read when exp: BinOp (Iden "a") "=" (NumLit 3)
read then keyword
read then exp: NumLit 4
read whens: 2
read else exp: NumLit 5
read else: Just (NumLit 5)
read end keyword
Cases: 35  Tried: 35  Errors: 0  Failures: 0
Counts {cases = 35, tried = 35, errors = 0, failures = 0}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Everything looks good. Let&#8217;s refactor the case parser and tidy
everything up.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">blackListValueExpr</span> <span class="tok-ow">::</span> <span class="tok-p">[</span><span class="tok-kt">String</span><span class="tok-p">]</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">blackListValueExpr</span> <span class="tok-n">blackList</span> <span class="tok-n">val</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-o">$</span> <span class="tok-kr">do</span>
    <span class="tok-n">v</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">val</span>
    <span class="tok-n">guard</span> <span class="tok-o">$</span> <span class="tok-kr">case</span> <span class="tok-n">v</span> <span class="tok-kr">of</span>
        <span class="tok-kt">Iden</span> <span class="tok-n">i</span> <span class="tok-o">|</span> <span class="tok-n">i</span> <span class="tok-p">`</span><span class="tok-n">elem</span><span class="tok-p">`</span> <span class="tok-n">blackList</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">False</span>
        <span class="tok-kr">_</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">True</span>
    <span class="tok-n">return</span> <span class="tok-n">v</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the parser with the <code>trace`s removed, and using the new
`blackListValueExpr</code> parser.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">caseValue3</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">caseValue3</span> <span class="tok-n">val</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;case&quot;</span>
    <span class="tok-n">testExp</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">caseVal</span>
    <span class="tok-n">whens</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">many1</span> <span class="tok-n">whenClause</span>
    <span class="tok-n">els</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">elseClause</span>
    <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;end&quot;</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">Case</span> <span class="tok-n">testExp</span> <span class="tok-n">whens</span> <span class="tok-n">els</span>
 <span class="tok-kr">where</span>
   <span class="tok-n">whenClause</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
       <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;when&quot;</span>
       <span class="tok-n">w</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">caseVal</span>
       <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;then&quot;</span>
       <span class="tok-n">t</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">caseVal</span>
       <span class="tok-n">return</span> <span class="tok-p">(</span><span class="tok-n">w</span><span class="tok-p">,</span><span class="tok-n">t</span><span class="tok-p">)</span>
   <span class="tok-n">elseClause</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
       <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;else&quot;</span>
       <span class="tok-n">v</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">caseVal</span>
       <span class="tok-n">return</span> <span class="tok-n">v</span>
   <span class="tok-n">caseVal</span> <span class="tok-ow">=</span> <span class="tok-n">blackListValueExpr</span> <span class="tok-n">blackList</span> <span class="tok-n">val</span>
   <span class="tok-n">blackList</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-s">&quot;case&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;when&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;then&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;else&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;end&quot;</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And here it is after some shortening:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">caseValue4</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">caseValue4</span> <span class="tok-n">val</span> <span class="tok-ow">=</span>
    <span class="tok-kt">Case</span>
    <span class="tok-o">&lt;$&gt;</span> <span class="tok-p">(</span><span class="tok-n">keyword</span> <span class="tok-s">&quot;case&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">caseVal</span><span class="tok-p">)</span>
    <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">many1</span> <span class="tok-n">whenClause</span>
    <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">elseClause</span>
    <span class="tok-o">&lt;*</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;end&quot;</span>
 <span class="tok-kr">where</span>
   <span class="tok-n">whenClause</span> <span class="tok-ow">=</span> <span class="tok-p">(,)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-p">(</span><span class="tok-n">keyword</span> <span class="tok-s">&quot;when&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">caseVal</span><span class="tok-p">)</span>
                    <span class="tok-o">&lt;*&gt;</span> <span class="tok-p">(</span><span class="tok-n">keyword</span> <span class="tok-s">&quot;then&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">caseVal</span><span class="tok-p">)</span>
   <span class="tok-n">elseClause</span> <span class="tok-ow">=</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;else&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">caseVal</span>
   <span class="tok-n">caseVal</span> <span class="tok-ow">=</span> <span class="tok-n">blackListValueExpr</span> <span class="tok-n">blackList</span> <span class="tok-n">val</span>
   <span class="tok-n">blackList</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-s">&quot;case&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;when&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;then&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;else&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;end&quot;</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I think we passed the point where <code>(&lt;|&gt;)</code> is more readable than
<code>choice</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">term8</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">term8</span> <span class="tok-ow">=</span> <span class="tok-n">choice</span> <span class="tok-p">[</span><span class="tok-n">caseValue4</span> <span class="tok-n">valueExpr8</span>
               <span class="tok-p">,</span><span class="tok-n">try</span> <span class="tok-o">$</span> <span class="tok-n">app</span> <span class="tok-n">valueExpr8</span>
               <span class="tok-p">,</span><span class="tok-n">try</span> <span class="tok-n">dstar</span>
               <span class="tok-p">,</span><span class="tok-n">try</span> <span class="tok-n">dIden</span>
               <span class="tok-p">,</span><span class="tok-n">iden</span>
               <span class="tok-p">,</span><span class="tok-n">num</span>
               <span class="tok-p">,</span><span class="tok-n">parensValue</span> <span class="tok-n">valueExpr8</span>
               <span class="tok-p">,</span><span class="tok-n">stringLit</span>
               <span class="tok-p">,</span><span class="tok-n">star</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">valueExpr8</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">valueExpr8</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-n">buildExpressionParser</span> <span class="tok-n">table</span> <span class="tok-n">term8</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">allExpressionTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">allExpressionTests</span> <span class="tok-ow">=</span> <span class="tok-n">concat</span> <span class="tok-p">[</span><span class="tok-n">basicTests</span>
                            <span class="tok-p">,</span><span class="tok-n">stringLiteralTests</span>
                            <span class="tok-p">,</span><span class="tok-n">dIdenTests</span>
                            <span class="tok-p">,</span><span class="tok-n">starTests</span>
                            <span class="tok-p">,</span><span class="tok-n">dStarTests</span>
                            <span class="tok-p">,</span><span class="tok-n">appTests</span>
                            <span class="tok-p">,</span><span class="tok-n">caseTests</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s double check:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*ValueExpressions&gt; H.runTestTT $ H.TestList $ map (makeTest valueExpr8) allExpressionTests
Cases: 35  Tried: 35  Errors: 0  Failures: 0
Counts {cases = 35, tried = 35, errors = 0, failures = 0}</code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: review code above for new syntax patterns to talk about. Or
maybe don&#8217;t talk about them?</p>
</div>
<div class="paragraph">
<p>Let&#8217;s predict that we will need more blacklisting when we work on the
query expression parsing, and create a parser which can be used in
this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">term</span> <span class="tok-ow">::</span> <span class="tok-p">[</span><span class="tok-kt">String</span><span class="tok-p">]</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">term</span> <span class="tok-n">blackList</span> <span class="tok-ow">=</span> <span class="tok-n">choice</span> <span class="tok-p">[</span><span class="tok-n">caseValue4</span> <span class="tok-p">(</span><span class="tok-n">valueExpr</span> <span class="tok-n">blackList</span><span class="tok-p">)</span>
                        <span class="tok-p">,</span><span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-n">app</span> <span class="tok-p">(</span><span class="tok-n">valueExpr</span> <span class="tok-n">blackList</span><span class="tok-p">))</span>
                        <span class="tok-p">,</span><span class="tok-n">try</span> <span class="tok-n">dstar</span>
                        <span class="tok-p">,</span><span class="tok-n">try</span> <span class="tok-n">dIden</span>
                        <span class="tok-p">,</span><span class="tok-n">blackListValueExpr</span> <span class="tok-n">blackList</span> <span class="tok-n">iden</span>
                        <span class="tok-p">,</span><span class="tok-n">num</span>
                        <span class="tok-p">,</span><span class="tok-n">parensValue</span> <span class="tok-p">(</span><span class="tok-n">valueExpr</span> <span class="tok-n">blackList</span><span class="tok-p">)</span>
                        <span class="tok-p">,</span><span class="tok-n">stringLit</span>
                        <span class="tok-p">,</span><span class="tok-n">star</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: need to change app, dstar and diden for blacklisting?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">valueExpr</span> <span class="tok-ow">::</span> <span class="tok-p">[</span><span class="tok-kt">String</span><span class="tok-p">]</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">valueExpr</span> <span class="tok-n">blackList</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-n">buildExpressionParser</span> <span class="tok-n">table</span> <span class="tok-p">(</span><span class="tok-n">term</span> <span class="tok-n">blackList</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Final sanity check:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*ValueExpressions&gt; H.runTestTT $ H.TestList $ map (makeTest (valueExpr [])) allExpressionTests
Cases: 35  Tried: 35  Errors: 0  Failures: 0
Counts {cases = 35, tried = 35, errors = 0, failures = 0}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="query-expressions">12. Query expressions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We can now start on the 'select' parser. In the SQL standard, it
refers to these things as 'query expressions' to distinguish then from
'value expressions', so we will reuse this language here.</p>
</div>
<div class="paragraph">
<p>The subset of SQL we will support is this:</p>
</div>
<div class="paragraph">
<p>TODO: write lots of examples here</p>
</div>
<div class="paragraph">
<p>select queries only, no union, intersect or except. No common table
expressions.</p>
</div>
<div class="paragraph">
<p>we will support all the value expressions that the value expression
parser above supports</p>
</div>
<div class="paragraph">
<p>we will support select lists with optional aliases, with the 'as'
optional in the alias</p>
</div>
<div class="paragraph">
<p>we will support the * as in 'select * from t', and the variation
'select t.* from t', but not the alias version select * as (a,b,c)
from t.</p>
</div>
<div class="paragraph">
<p>we support two part dotted identifiers in value expressions, but no
other sort (such as 3-part dotted value expression identifiers, or
schema qualified table names or function names).</p>
</div>
<div class="paragraph">
<p>for the from clause, we will only support optional 'from table_name'.</p>
</div>
<div class="paragraph">
<p>supports where</p>
</div>
<div class="paragraph">
<p>we will support regular group by lists, but not the new group by
options in SQL2003 (group by (), grouping sets, cube, rollup).</p>
</div>
<div class="paragraph">
<p>we will support having</p>
</div>
<div class="paragraph">
<p>we support order by, with multiple columns, but not explicit asc or
desc , and no 'nulls first' or 'nulls last' syntax.</p>
</div>
<div class="paragraph">
<p>No support for offset and fetch first, or variations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-cm">{-# LANGUAGE TupleSections #-}</span>
<span class="tok-kr">module</span> <span class="tok-nn">QueryExpressions</span> <span class="tok-kr">where</span>

<span class="tok-c1">--import Text.Groom (groom)</span>
<span class="tok-c1">--import qualified Text.Parsec as P</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String</span> <span class="tok-p">(</span><span class="tok-kt">Parser</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec</span> <span class="tok-p">(</span><span class="tok-nf">try</span><span class="tok-p">,</span><span class="tok-nf">optionMaybe</span><span class="tok-p">,</span> <span class="tok-nf">optional</span><span class="tok-p">,</span> <span class="tok-nf">sepBy1</span><span class="tok-p">,</span><span class="tok-nf">option</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Control.Applicative</span> <span class="tok-p">((</span><span class="tok-o">&lt;$&gt;</span><span class="tok-p">),(</span><span class="tok-o">*&gt;</span><span class="tok-p">),(</span><span class="tok-o">&lt;*&gt;</span><span class="tok-p">))</span>
<span class="tok-kr">import</span> <span class="tok-nn">Control.Monad</span> <span class="tok-p">(</span><span class="tok-nf">void</span><span class="tok-p">,</span><span class="tok-nf">guard</span><span class="tok-p">)</span>
<span class="tok-c1">--import Debug.Trace</span>
<span class="tok-c1">--import Data.List (intercalate)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Data.Maybe</span> <span class="tok-p">()</span>
<span class="tok-kr">import</span> <span class="tok-k">qualified</span> <span class="tok-nn">Test.HUnit</span> <span class="tok-k">as</span> <span class="tok-n">H</span>
<span class="tok-kr">import</span> <span class="tok-nn">FunctionsAndTypesForParsing</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">import</span> <span class="tok-nn">ValueExpressions</span> <span class="tok-p">(</span><span class="tok-kt">ValueExpr</span><span class="tok-p">(</span><span class="tok-o">..</span><span class="tok-p">),</span> <span class="tok-nf">valueExpr</span><span class="tok-p">,</span> <span class="tok-nf">identifier</span><span class="tok-p">,</span> <span class="tok-nf">symbol</span><span class="tok-p">,</span> <span class="tok-nf">keyword</span><span class="tok-p">,</span> <span class="tok-nf">comma</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the datatype for query expressions to get started with. In
this tutorial, we will only support an optional single table in the
from clause, and this will be expanded in the next tutorial.</p>
</div>
<div class="paragraph">
<p>TODO: rearrange the from/where/groupby/having/orderby to a separate
datatype which is optional in a select, and the from part is mandatory
in this new type. This follows the standard and is more accurate
syntax.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">data</span> <span class="tok-kt">QueryExpr</span>
    <span class="tok-ow">=</span> <span class="tok-kt">Select</span>
      <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">ValueExpr</span><span class="tok-p">,</span><span class="tok-kt">Maybe</span> <span class="tok-kt">String</span><span class="tok-p">)]</span>
      <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">::</span> <span class="tok-kt">Maybe</span> <span class="tok-kt">String</span>
      <span class="tok-p">,</span><span class="tok-n">qeWhere</span> <span class="tok-ow">::</span> <span class="tok-kt">Maybe</span> <span class="tok-kt">ValueExpr</span>
      <span class="tok-p">,</span><span class="tok-n">qeGroupBy</span> <span class="tok-ow">::</span> <span class="tok-p">[</span><span class="tok-kt">ValueExpr</span><span class="tok-p">]</span>
      <span class="tok-p">,</span><span class="tok-n">qeHaving</span> <span class="tok-ow">::</span> <span class="tok-kt">Maybe</span> <span class="tok-kt">ValueExpr</span>
      <span class="tok-p">,</span><span class="tok-n">qeOrderBy</span> <span class="tok-ow">::</span> <span class="tok-p">[</span><span class="tok-kt">ValueExpr</span><span class="tok-p">]</span>
      <span class="tok-p">}</span> <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span><span class="tok-p">,</span><span class="tok-kt">Show</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is a default value which can be used to easily construct query
expression values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">makeSelect</span> <span class="tok-ow">::</span> <span class="tok-kt">QueryExpr</span>
<span class="tok-nf">makeSelect</span> <span class="tok-ow">=</span> <span class="tok-kt">Select</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-kt">[]</span>
                    <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-kt">Nothing</span>
                    <span class="tok-p">,</span><span class="tok-n">qeWhere</span> <span class="tok-ow">=</span> <span class="tok-kt">Nothing</span>
                    <span class="tok-p">,</span><span class="tok-n">qeGroupBy</span> <span class="tok-ow">=</span> <span class="tok-kt">[]</span>
                    <span class="tok-p">,</span><span class="tok-n">qeHaving</span> <span class="tok-ow">=</span> <span class="tok-kt">Nothing</span>
                    <span class="tok-p">,</span><span class="tok-n">qeOrderBy</span> <span class="tok-ow">=</span> <span class="tok-kt">[]</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_select_lists">12.1. select lists</h3>
<div class="paragraph">
<p>Let&#8217;s start with something simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>select [value expr]</code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: shorten the names of these examples</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">singleSelectItemTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">singleSelectItemTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select 1&quot;</span><span class="tok-p">,</span> <span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]})]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are a couple of wrappers for <code>symbol</code> and <code>keyword</code> which wrap
them with void.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">keyword_</span> <span class="tok-ow">::</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span>
<span class="tok-nf">keyword_</span> <span class="tok-ow">=</span> <span class="tok-n">void</span> <span class="tok-o">.</span> <span class="tok-n">keyword</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">symbol_</span> <span class="tok-ow">::</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span>
<span class="tok-nf">symbol_</span> <span class="tok-ow">=</span> <span class="tok-n">void</span> <span class="tok-o">.</span> <span class="tok-n">symbol</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">singleSelectItem</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">QueryExpr</span>
<span class="tok-nf">singleSelectItem</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">keyword_</span> <span class="tok-s">&quot;select&quot;</span>
    <span class="tok-n">e</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">valueExpr</span> <span class="tok-kt">[]</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-n">e</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use the old test runner to check these:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*QueryExpressions&gt; H.runTestTT $ H.TestList $ map (makeTest singleSelectItem) parseSingleSelectItemTestData
Cases: 1  Tried: 1  Errors: 0  Failures: 0
Counts {cases = 1, tried = 1, errors = 0, failures = 0}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s rewrite it in the Applicative and mostly point free style.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">singleSelectItemApplicative</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">QueryExpr</span>
<span class="tok-nf">singleSelectItemApplicative</span> <span class="tok-ow">=</span>
    <span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">sl</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-n">sl</span><span class="tok-p">})</span>
    <span class="tok-o">&lt;$&gt;</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;select&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-p">(((</span><span class="tok-kt">:[]</span><span class="tok-p">)</span> <span class="tok-o">.</span> <span class="tok-p">(,</span><span class="tok-kt">Nothing</span><span class="tok-p">))</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">valueExpr</span> <span class="tok-kt">[]</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That didn&#8217;t go so well. Using a wrapper:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">singleSelectItemApplicative&#39;</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">QueryExpr</span>
<span class="tok-nf">singleSelectItemApplicative&#39;</span> <span class="tok-ow">=</span>
    <span class="tok-n">ms</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;select&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">valueExpr</span> <span class="tok-kt">[]</span><span class="tok-p">)</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">ms</span> <span class="tok-n">e</span> <span class="tok-ow">=</span> <span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-n">e</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s write something that supports multiple value expressions,
e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>select 1+2, 3+4;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">multipleSelectItemsTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">multipleSelectItemsTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select a&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]})</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;select a,b&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]})</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;select 1+2,3+4&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span>
                     <span class="tok-p">[(</span><span class="tok-kt">BinOp</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-s">&quot;+&quot;</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">2</span><span class="tok-p">),</span><span class="tok-kt">Nothing</span><span class="tok-p">)</span>
                     <span class="tok-p">,(</span><span class="tok-kt">BinOp</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">3</span><span class="tok-p">)</span> <span class="tok-s">&quot;+&quot;</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">4</span><span class="tok-p">),</span><span class="tok-kt">Nothing</span><span class="tok-p">)]})</span>
    <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">selectMultipleItems</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">QueryExpr</span>
<span class="tok-nf">selectMultipleItems</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">keyword_</span> <span class="tok-s">&quot;select&quot;</span>
    <span class="tok-n">es</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">commaSep1</span> <span class="tok-p">(</span><span class="tok-n">valueExpr</span> <span class="tok-kt">[]</span><span class="tok-p">)</span>
    <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-n">map</span> <span class="tok-p">(,</span><span class="tok-kt">Nothing</span><span class="tok-p">)</span> <span class="tok-n">es</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">commaSep1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span>
<span class="tok-nf">commaSep1</span> <span class="tok-ow">=</span> <span class="tok-p">(`</span><span class="tok-n">sepBy1</span><span class="tok-p">`</span> <span class="tok-n">comma</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_aliases">12.1.1. aliases</h4>
<div class="paragraph">
<p>We can write names for the columns produced from a select list using
the keyword <code>as</code>, and we can miss out the <code>as</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">select</span> <span class="tok-n">a</span> <span class="tok-k">as</span> <span class="tok-n">a1</span><span class="tok-p">,</span> <span class="tok-n">b</span> <span class="tok-k">as</span> <span class="tok-n">b1</span><span class="tok-p">,</span> <span class="tok-n">f</span><span class="tok-p">(</span><span class="tok-k">c</span><span class="tok-p">)</span> <span class="tok-k">as</span> <span class="tok-n">c1</span><span class="tok-p">;</span>

<span class="tok-c1">-- no as</span>
<span class="tok-k">select</span> <span class="tok-n">a</span> <span class="tok-n">a1</span><span class="tok-p">,</span> <span class="tok-n">b</span> <span class="tok-n">b1</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">selectListTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">selectListTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select a as a1, b as b1&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Just</span> <span class="tok-s">&quot;a1&quot;</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Just</span> <span class="tok-s">&quot;b1&quot;</span><span class="tok-p">)]})</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;select a a1, b b1&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Just</span> <span class="tok-s">&quot;a1&quot;</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Just</span> <span class="tok-s">&quot;b1&quot;</span><span class="tok-p">)]})</span>
    <span class="tok-p">]</span> <span class="tok-o">++</span> <span class="tok-n">multipleSelectItemsTests</span>
      <span class="tok-o">++</span> <span class="tok-n">singleSelectItemTests</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, here is the select list parser and the helper for select
items:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">selectItem0</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">(</span><span class="tok-kt">ValueExpr</span><span class="tok-p">,</span> <span class="tok-kt">Maybe</span> <span class="tok-kt">String</span><span class="tok-p">)</span>
<span class="tok-nf">selectItem0</span> <span class="tok-ow">=</span> <span class="tok-p">(,)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">valueExpr</span> <span class="tok-kt">[]</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-p">(</span><span class="tok-n">try</span> <span class="tok-n">alias</span><span class="tok-p">)</span>
  <span class="tok-kr">where</span> <span class="tok-n">alias</span> <span class="tok-ow">=</span> <span class="tok-n">optional</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;as&quot;</span><span class="tok-p">)</span> <span class="tok-o">*&gt;</span> <span class="tok-n">identifier</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">selectList0</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">[(</span><span class="tok-kt">ValueExpr</span><span class="tok-p">,</span> <span class="tok-kt">Maybe</span> <span class="tok-kt">String</span><span class="tok-p">)]</span>
<span class="tok-nf">selectList0</span> <span class="tok-ow">=</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;select&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">commaSep1</span> <span class="tok-n">selectItem0</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">queryExpr0</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">QueryExpr</span>
<span class="tok-nf">queryExpr0</span> <span class="tok-ow">=</span> <span class="tok-n">mkSelect</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">selectList0</span>
  <span class="tok-kr">where</span> <span class="tok-n">mkSelect</span> <span class="tok-n">sl</span> <span class="tok-ow">=</span> <span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-n">sl</span><span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_from_clause">12.2. from clause</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">from</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">from</span> <span class="tok-ow">=</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;from&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">identifier</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">fromTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">fromTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select a from t&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)})]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">queryExpr1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">QueryExpr</span>
<span class="tok-nf">queryExpr1</span> <span class="tok-ow">=</span> <span class="tok-n">mkSelect</span>
             <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">selectList0</span>
             <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">from</span>
  <span class="tok-kr">where</span> <span class="tok-n">mkSelect</span> <span class="tok-n">sl</span> <span class="tok-n">fr</span> <span class="tok-ow">=</span> <span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-n">sl</span>
                                    <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-n">fr</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*QueryExpressions&gt; H.runTestTT $ H.TestList $ map (makeTest queryExpr1) (selectListTests ++ fromTests)
 ### Failure in: 6:select a from t
(line 1, column 16):
unexpected end of input
expecting digit, letter, "_", "--" or "/*"
Cases: 7  Tried: 7  Errors: 0  Failures: 1
Counts {cases = 7, tried = 7, errors = 0, failures = 1}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a keyword issue again. We are parsing the <code>from</code> as if it was
a column alias and then getting stuck.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">blackListIdentifier</span> <span class="tok-ow">::</span> <span class="tok-p">[</span><span class="tok-kt">String</span><span class="tok-p">]</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">blackListIdentifier</span> <span class="tok-n">bl</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">i</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">identifier</span>
    <span class="tok-n">guard</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-p">`</span><span class="tok-n">notElem</span><span class="tok-p">`</span> <span class="tok-n">bl</span><span class="tok-p">)</span>
    <span class="tok-n">return</span> <span class="tok-n">i</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">selectItem</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">(</span><span class="tok-kt">ValueExpr</span><span class="tok-p">,</span> <span class="tok-kt">Maybe</span> <span class="tok-kt">String</span><span class="tok-p">)</span>
<span class="tok-nf">selectItem</span> <span class="tok-ow">=</span> <span class="tok-p">(,)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">valueExpr</span> <span class="tok-kt">[]</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-p">(</span><span class="tok-n">try</span> <span class="tok-n">alias</span><span class="tok-p">)</span>
  <span class="tok-kr">where</span> <span class="tok-n">alias</span> <span class="tok-ow">=</span> <span class="tok-n">optional</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;as&quot;</span><span class="tok-p">)</span> <span class="tok-o">*&gt;</span> <span class="tok-n">blackListIdentifier</span> <span class="tok-p">[</span><span class="tok-s">&quot;from&quot;</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">selectList</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">[(</span><span class="tok-kt">ValueExpr</span><span class="tok-p">,</span> <span class="tok-kt">Maybe</span> <span class="tok-kt">String</span><span class="tok-p">)]</span>
<span class="tok-nf">selectList</span> <span class="tok-ow">=</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;select&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">commaSep1</span> <span class="tok-n">selectItem</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">queryExpr2</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">QueryExpr</span>
<span class="tok-nf">queryExpr2</span> <span class="tok-ow">=</span> <span class="tok-n">mkSelect</span>
             <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">selectList</span>
             <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">from</span>
  <span class="tok-kr">where</span> <span class="tok-n">mkSelect</span> <span class="tok-n">sl</span> <span class="tok-n">fr</span> <span class="tok-ow">=</span> <span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-n">sl</span>
                                    <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-n">fr</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That did the job for now.</p>
</div>
</div>
<div class="sect2">
<h3 id="_where">12.3. where</h3>
<div class="paragraph">
<p>The where, group by, having, and order by parsers are simple.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">whereTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">whereTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select a from t where a = 5&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-kt">Just</span> <span class="tok-s">&quot;t&quot;</span>
                 <span class="tok-p">,</span><span class="tok-n">qeWhere</span> <span class="tok-ow">=</span> <span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">BinOp</span> <span class="tok-p">(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;=&quot;</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">5</span><span class="tok-p">)})</span>
    <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">whereClause</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">whereClause</span> <span class="tok-ow">=</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;where&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">valueExpr</span> <span class="tok-kt">[]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">queryExpr3</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">QueryExpr</span>
<span class="tok-nf">queryExpr3</span> <span class="tok-ow">=</span> <span class="tok-n">mkSelect</span>
             <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">selectList</span>
             <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">from</span>
             <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">whereClause</span>
  <span class="tok-kr">where</span> <span class="tok-n">mkSelect</span> <span class="tok-n">sl</span> <span class="tok-n">fr</span> <span class="tok-n">wh</span> <span class="tok-ow">=</span>
            <span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-n">sl</span>
                       <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-n">fr</span>
                       <span class="tok-p">,</span><span class="tok-n">qeWhere</span> <span class="tok-ow">=</span> <span class="tok-n">wh</span><span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_group_by">12.4. group by</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">groupByTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">groupByTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select a,sum(b) from t group by a&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">App</span> <span class="tok-s">&quot;sum&quot;</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">],</span><span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-kt">Just</span> <span class="tok-s">&quot;t&quot;</span>
                 <span class="tok-p">,</span><span class="tok-n">qeGroupBy</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">]</span>
                 <span class="tok-p">})</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;select a,b,sum(c) from t group by a,b&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">App</span> <span class="tok-s">&quot;sum&quot;</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;c&quot;</span><span class="tok-p">],</span><span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-kt">Just</span> <span class="tok-s">&quot;t&quot;</span>
                 <span class="tok-p">,</span><span class="tok-n">qeGroupBy</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">]</span>
                 <span class="tok-p">})</span>
    <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">groupByClause</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-kt">ValueExpr</span><span class="tok-p">]</span>
<span class="tok-nf">groupByClause</span> <span class="tok-ow">=</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;group&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;by&quot;</span>
                <span class="tok-o">*&gt;</span> <span class="tok-n">commaSep1</span> <span class="tok-p">(</span><span class="tok-n">valueExpr</span> <span class="tok-kt">[]</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">queryExpr4</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">QueryExpr</span>
<span class="tok-nf">queryExpr4</span> <span class="tok-ow">=</span> <span class="tok-n">mkSelect</span>
             <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">selectList</span>
             <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">from</span>
             <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">whereClause</span>
             <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">option</span> <span class="tok-kt">[]</span> <span class="tok-n">groupByClause</span>
  <span class="tok-kr">where</span> <span class="tok-n">mkSelect</span> <span class="tok-n">sl</span> <span class="tok-n">fr</span> <span class="tok-n">wh</span> <span class="tok-n">gr</span> <span class="tok-ow">=</span>
            <span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-n">sl</span>
                       <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-n">fr</span>
                       <span class="tok-p">,</span><span class="tok-n">qeWhere</span> <span class="tok-ow">=</span> <span class="tok-n">wh</span>
                       <span class="tok-p">,</span><span class="tok-n">qeGroupBy</span> <span class="tok-ow">=</span> <span class="tok-n">gr</span><span class="tok-p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_having">12.5. having</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">havingTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">havingTests</span> <span class="tok-ow">=</span>
  <span class="tok-p">[(</span><span class="tok-s">&quot;select a,sum(b) from t group by a having sum(b) &gt; 5&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">App</span> <span class="tok-s">&quot;sum&quot;</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">],</span><span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span>
                 <span class="tok-p">,</span><span class="tok-n">qeGroupBy</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeHaving</span> <span class="tok-ow">=</span> <span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">BinOp</span> <span class="tok-p">(</span><span class="tok-kt">App</span> <span class="tok-s">&quot;sum&quot;</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">])</span> <span class="tok-s">&quot;&gt;&quot;</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">5</span><span class="tok-p">)</span>
                 <span class="tok-p">})</span>
  <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">having</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">having</span> <span class="tok-ow">=</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;having&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-p">(</span><span class="tok-n">valueExpr</span> <span class="tok-kt">[]</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">queryExpr5</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">QueryExpr</span>
<span class="tok-nf">queryExpr5</span> <span class="tok-ow">=</span> <span class="tok-n">mkSelect</span>
             <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">selectList</span>
             <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">from</span>
             <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">whereClause</span>
             <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">option</span> <span class="tok-kt">[]</span> <span class="tok-n">groupByClause</span>
             <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">having</span>
  <span class="tok-kr">where</span> <span class="tok-n">mkSelect</span> <span class="tok-n">sl</span> <span class="tok-n">fr</span> <span class="tok-n">wh</span> <span class="tok-n">gr</span> <span class="tok-n">hv</span> <span class="tok-ow">=</span>
            <span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-n">sl</span>
                       <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-n">fr</span>
                       <span class="tok-p">,</span><span class="tok-n">qeWhere</span> <span class="tok-ow">=</span> <span class="tok-n">wh</span>
                       <span class="tok-p">,</span><span class="tok-n">qeGroupBy</span> <span class="tok-ow">=</span> <span class="tok-n">gr</span>
                       <span class="tok-p">,</span><span class="tok-n">qeHaving</span> <span class="tok-ow">=</span> <span class="tok-n">hv</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Looking nice so far. Did you run the tests for each stage?</p>
</div>
</div>
<div class="sect2">
<h3 id="_order_by">12.6. order by</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">orderByTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">orderByTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select a from t order by a&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">])</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t order by a, b&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">])</span>
    <span class="tok-p">]</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">ms</span> <span class="tok-n">o</span> <span class="tok-ow">=</span> <span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                      <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span>
                      <span class="tok-p">,</span><span class="tok-n">qeOrderBy</span> <span class="tok-ow">=</span> <span class="tok-n">o</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">orderBy</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-kt">ValueExpr</span><span class="tok-p">]</span>
<span class="tok-nf">orderBy</span> <span class="tok-ow">=</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;order&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;by&quot;</span>
          <span class="tok-o">*&gt;</span> <span class="tok-n">commaSep1</span> <span class="tok-p">(</span><span class="tok-n">valueExpr</span> <span class="tok-kt">[]</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">queryExpr6</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">QueryExpr</span>
<span class="tok-nf">queryExpr6</span> <span class="tok-ow">=</span> <span class="tok-kt">Select</span>
             <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">selectList</span>
             <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">from</span>
             <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">whereClause</span>
             <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">option</span> <span class="tok-kt">[]</span> <span class="tok-n">groupByClause</span>
             <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">having</span>
             <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">option</span> <span class="tok-kt">[]</span> <span class="tok-n">orderBy</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*QueryExpressions&gt; H.runTestTT $ H.TestList $ map (makeTest queryExpr6) (selectListTests ++ fromTests ++ whereTests ++ groupByTests ++ havingTests ++ orderByTests)
Cases: 13  Tried: 13  Errors: 0  Failures: 0
Counts {cases = 13, tried = 13, errors = 0, failures = 0}</code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: talk about putting the maybes/default values inside from, where, etc??</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="from-clause">13. From clause</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this tutorial, we extend the from clause support to the following:
we will support implicit and explicit joins, including keywords
natural, inner, outer, left, right, full, cross, on and using, plus
parens and simple aliases (e.g. select a from t u, but not select a
from t(a,b)). We don&#8217;t support oracle outer join syntax (+) or the
other 'pre-ANSI' variations on this theme. No lateral keyword or apply
or pivot.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-cm">{-# LANGUAGE TupleSections #-}</span>

<span class="tok-c1">--import Text.Groom (groom)</span>
<span class="tok-c1">--import qualified Text.Parsec as P</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String</span> <span class="tok-p">(</span><span class="tok-kt">Parser</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Parsec</span> <span class="tok-p">(</span><span class="tok-nf">try</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Combinator</span>
<span class="tok-kr">import</span> <span class="tok-nn">Control.Applicative</span> <span class="tok-p">((</span><span class="tok-o">&lt;$&gt;</span><span class="tok-p">),(</span><span class="tok-o">&lt;*</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">*&gt;</span><span class="tok-p">),(</span><span class="tok-o">&lt;*&gt;</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;$</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;|&gt;</span><span class="tok-p">))</span>
<span class="tok-kr">import</span> <span class="tok-nn">Control.Monad</span>
<span class="tok-kr">import</span> <span class="tok-nn">Data.Maybe</span> <span class="tok-p">()</span>
<span class="tok-kr">import</span> <span class="tok-k">qualified</span> <span class="tok-nn">Test.HUnit</span> <span class="tok-k">as</span> <span class="tok-n">H</span>
<span class="tok-kr">import</span> <span class="tok-nn">FunctionsAndTypesForParsing</span>
<span class="tok-kr">import</span> <span class="tok-nn">Debug.Trace</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: should explicitly import from these two modules (and same in
QueryExpressions.lhs)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">import</span> <span class="tok-nn">ValueExpressions</span> <span class="tok-p">(</span><span class="tok-kt">ValueExpr</span><span class="tok-p">(</span><span class="tok-o">..</span><span class="tok-p">),</span> <span class="tok-nf">valueExpr</span><span class="tok-p">,</span> <span class="tok-nf">identifier</span><span class="tok-p">,</span> <span class="tok-nf">makeTest</span><span class="tok-p">,</span> <span class="tok-nf">parens</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">QueryExpressions</span> <span class="tok-p">(</span><span class="tok-nf">selectList</span><span class="tok-p">,</span><span class="tok-nf">whereClause</span><span class="tok-p">,</span><span class="tok-nf">groupByClause</span><span class="tok-p">,</span><span class="tok-nf">having</span><span class="tok-p">,</span><span class="tok-nf">orderBy</span>
                        <span class="tok-p">,</span><span class="tok-nf">commaSep1</span><span class="tok-p">,</span> <span class="tok-nf">keyword_</span><span class="tok-p">,</span><span class="tok-nf">blackListIdentifier</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_abstract_syntax">13.1. Abstract syntax</h3>
<div class="paragraph">
<p>Here are is the updated <code>QueryExpr</code> and the new <code>TableRef</code> abstract
syntax types.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">data</span> <span class="tok-kt">QueryExpr</span>
    <span class="tok-ow">=</span> <span class="tok-kt">Select</span>
      <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">ValueExpr</span><span class="tok-p">,</span><span class="tok-kt">Maybe</span> <span class="tok-kt">String</span><span class="tok-p">)]</span>
      <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">::</span> <span class="tok-p">[</span><span class="tok-kt">TableRef</span><span class="tok-p">]</span>
      <span class="tok-p">,</span><span class="tok-n">qeWhere</span> <span class="tok-ow">::</span> <span class="tok-kt">Maybe</span> <span class="tok-kt">ValueExpr</span>
      <span class="tok-p">,</span><span class="tok-n">qeGroupBy</span> <span class="tok-ow">::</span> <span class="tok-p">[</span><span class="tok-kt">ValueExpr</span><span class="tok-p">]</span>
      <span class="tok-p">,</span><span class="tok-n">qeHaving</span> <span class="tok-ow">::</span> <span class="tok-kt">Maybe</span> <span class="tok-kt">ValueExpr</span>
      <span class="tok-p">,</span><span class="tok-n">qeOrderBy</span> <span class="tok-ow">::</span> <span class="tok-p">[</span><span class="tok-kt">ValueExpr</span><span class="tok-p">]</span>
      <span class="tok-p">}</span> <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span><span class="tok-p">,</span><span class="tok-kt">Show</span><span class="tok-p">)</span>

<span class="tok-nf">makeSelect</span> <span class="tok-ow">::</span> <span class="tok-kt">QueryExpr</span>
<span class="tok-nf">makeSelect</span> <span class="tok-ow">=</span> <span class="tok-kt">Select</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-kt">[]</span>
                    <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-kt">[]</span>
                    <span class="tok-p">,</span><span class="tok-n">qeWhere</span> <span class="tok-ow">=</span> <span class="tok-kt">Nothing</span>
                    <span class="tok-p">,</span><span class="tok-n">qeGroupBy</span> <span class="tok-ow">=</span> <span class="tok-kt">[]</span>
                    <span class="tok-p">,</span><span class="tok-n">qeHaving</span> <span class="tok-ow">=</span> <span class="tok-kt">Nothing</span>
                    <span class="tok-p">,</span><span class="tok-n">qeOrderBy</span> <span class="tok-ow">=</span> <span class="tok-kt">[]</span><span class="tok-p">}</span>

<span class="tok-kr">data</span> <span class="tok-kt">TableRef</span> <span class="tok-ow">=</span> <span class="tok-kt">TRSimple</span> <span class="tok-kt">String</span>
              <span class="tok-o">|</span> <span class="tok-kt">TRJoin</span> <span class="tok-kt">TableRef</span> <span class="tok-kt">JoinType</span> <span class="tok-kt">TableRef</span> <span class="tok-p">(</span><span class="tok-kt">Maybe</span> <span class="tok-kt">JoinCondition</span><span class="tok-p">)</span>
              <span class="tok-o">|</span> <span class="tok-kt">TRParens</span> <span class="tok-kt">TableRef</span>
              <span class="tok-o">|</span> <span class="tok-kt">TRAlias</span> <span class="tok-kt">TableRef</span> <span class="tok-kt">String</span>
              <span class="tok-o">|</span> <span class="tok-kt">TRQueryExpr</span> <span class="tok-kt">QueryExpr</span>
                <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span><span class="tok-p">,</span><span class="tok-kt">Show</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This syntax for table references can represent invalid syntax, for
instance two nested aliases. The justification for this is that
sometimes trying to accurately represent only exactly what is valid
creates something much more complex. Maybe this is a good tradeoff in
this situation, and maybe not.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">data</span> <span class="tok-kt">JoinType</span> <span class="tok-ow">=</span> <span class="tok-kt">JoinInner</span> <span class="tok-o">|</span> <span class="tok-kt">JoinLeft</span> <span class="tok-o">|</span> <span class="tok-kt">JoinRight</span> <span class="tok-o">|</span> <span class="tok-kt">JoinFull</span> <span class="tok-o">|</span> <span class="tok-kt">JoinCross</span>
                <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span><span class="tok-p">,</span><span class="tok-kt">Show</span><span class="tok-p">)</span>

<span class="tok-kr">data</span> <span class="tok-kt">JoinCondition</span> <span class="tok-ow">=</span> <span class="tok-kt">JoinOn</span> <span class="tok-kt">ValueExpr</span>
                   <span class="tok-o">|</span> <span class="tok-kt">JoinUsing</span> <span class="tok-p">[</span><span class="tok-kt">String</span><span class="tok-p">]</span>
                   <span class="tok-o">|</span> <span class="tok-kt">JoinNatural</span>
                   <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span><span class="tok-p">,</span><span class="tok-kt">Show</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With the join condition, we&#8217;ve done the opposite to TableRef - we&#8217;ve
combined <code>natural</code> and <code>on</code>/<code>using</code>, since only one of these can be
present, even though this departs a little from the concrete
syntax.</p>
</div>
<div class="paragraph">
<p>First we will develop the standalone from clause parser, then we will
update the query expression syntax and parsing to incorporate our new
from clause parser.</p>
</div>
</div>
<div class="sect2">
<h3 id="_simple_table_name">13.2. simple table name</h3>
<div class="paragraph">
<p>Let&#8217;s start with something simple: a from clause can be multiple comma
separated tablerefs, aka an implicit join.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">multipleTRSimpleTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-kt">TableRef</span><span class="tok-p">])]</span>
<span class="tok-nf">multipleTRSimpleTests</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-s">&quot;from a,b&quot;</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span> <span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">])]</span>

<span class="tok-nf">from0</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-kt">TableRef</span><span class="tok-p">]</span>
<span class="tok-nf">from0</span> <span class="tok-ow">=</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;from&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">commaSep1</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">identifier</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; H.runTestTT $ H.TestList $ map (makeTest from0) multipleTRSimpleTests
Cases: 1  Tried: 1  Errors: 0  Failures: 0
Counts {cases = 1, tried = 1, errors = 0, failures = 0}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s do the query expression, parens and alias first, before tackling
joins.</p>
</div>
</div>
<div class="sect2">
<h3 id="_subquery">13.3. subquery</h3>
<div class="paragraph">
<p>Here is the example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">trQueryExprTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-kt">TableRef</span><span class="tok-p">])]</span>
<span class="tok-nf">trQueryExprTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;from (select a from t)&quot;</span>
    <span class="tok-p">,[</span><span class="tok-kt">TRQueryExpr</span> <span class="tok-o">$</span> <span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                               <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">]}])]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the query expression parser we can use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">queryExpr1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-kt">TableRef</span><span class="tok-p">]</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">QueryExpr</span>
<span class="tok-nf">queryExpr1</span> <span class="tok-n">from&#39;</span> <span class="tok-ow">=</span> <span class="tok-kt">Select</span>
                   <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">selectList</span>
                   <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">option</span> <span class="tok-kt">[]</span> <span class="tok-n">from&#39;</span>
                   <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">whereClause</span>
                   <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">option</span> <span class="tok-kt">[]</span> <span class="tok-n">groupByClause</span>
                   <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">having</span>
                   <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">option</span> <span class="tok-kt">[]</span> <span class="tok-n">orderBy</span>

<span class="tok-nf">from1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-kt">TableRef</span><span class="tok-p">]</span>
<span class="tok-nf">from1</span> <span class="tok-ow">=</span>
    <span class="tok-n">keyword_</span> <span class="tok-s">&quot;from&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">commaSep1</span> <span class="tok-n">trefTerm</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">trefTerm</span> <span class="tok-ow">=</span> <span class="tok-n">choice</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">identifier</span>
                      <span class="tok-p">,</span><span class="tok-kt">TRQueryExpr</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-p">(</span><span class="tok-n">queryExpr1</span> <span class="tok-n">from1</span><span class="tok-p">)]</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_parens_3">13.4. parens</h3>
<div class="paragraph">
<p>We can&#8217;t do a sensible example for these right now - we need explicit
joins and then the parens can be used to override the associativity of
a three way join, or to specify over what part of the expression to
apply an alias.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">trParensTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-kt">TableRef</span><span class="tok-p">])]</span>
<span class="tok-nf">trParensTests</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-s">&quot;from (a)&quot;</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-kt">TRParens</span> <span class="tok-o">$</span> <span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">])]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can write some more tests for parens after we&#8217;ve done the explicit
joins.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">from2</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-kt">TableRef</span><span class="tok-p">]</span>
<span class="tok-nf">from2</span> <span class="tok-ow">=</span>
    <span class="tok-n">keyword_</span> <span class="tok-s">&quot;from&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">commaSep1</span> <span class="tok-n">trefTerm</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">trefTerm</span> <span class="tok-ow">=</span> <span class="tok-n">choice</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">identifier</span>
                      <span class="tok-p">,</span><span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-kt">TRQueryExpr</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-p">(</span><span class="tok-n">queryExpr1</span> <span class="tok-n">from2</span><span class="tok-p">))</span>
                      <span class="tok-p">,</span><span class="tok-kt">TRParens</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-n">trefTerm</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_alias">13.5. alias</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">trAliasTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,[</span><span class="tok-kt">TableRef</span><span class="tok-p">])]</span>
<span class="tok-nf">trAliasTests</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-s">&quot;from a as b&quot;</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-kt">TRAlias</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">])</span>
               <span class="tok-p">,(</span><span class="tok-s">&quot;from a b&quot;</span><span class="tok-p">,</span> <span class="tok-p">[</span><span class="tok-kt">TRAlias</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">])]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The alias can be treated like a postfix operator.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">suffixWrapper</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span>
<span class="tok-nf">suffixWrapper</span> <span class="tok-n">p</span> <span class="tok-n">a</span> <span class="tok-ow">=</span> <span class="tok-n">p</span> <span class="tok-n">a</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">return</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: ?? not sure about this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">from3</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-kt">TableRef</span><span class="tok-p">]</span>
<span class="tok-nf">from3</span> <span class="tok-ow">=</span>
    <span class="tok-n">keyword_</span> <span class="tok-s">&quot;from&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">commaSep1</span> <span class="tok-n">trefTerm</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">trefTerm</span> <span class="tok-ow">=</span> <span class="tok-n">choice</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">identifier</span>
                      <span class="tok-p">,</span><span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-kt">TRQueryExpr</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-p">(</span><span class="tok-n">queryExpr1</span> <span class="tok-n">from3</span><span class="tok-p">))</span>
                      <span class="tok-p">,</span><span class="tok-kt">TRParens</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-n">trefTerm</span><span class="tok-p">]</span>
               <span class="tok-o">&gt;&gt;=</span> <span class="tok-n">suffixWrapper</span> <span class="tok-n">alias</span>
    <span class="tok-n">alias</span> <span class="tok-n">tr</span> <span class="tok-ow">=</span> <span class="tok-kt">TRAlias</span> <span class="tok-n">tr</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-p">(</span><span class="tok-n">optional</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;as&quot;</span><span class="tok-p">)</span> <span class="tok-o">*&gt;</span> <span class="tok-n">identifier</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>How to make it keep nesting?</p>
</div>
</div>
<div class="sect2">
<h3 id="_joins">13.6. joins</h3>
<div class="paragraph">
<p>Here is a casual sketch of the target grammar:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>tref
(cross | [natural]
         ([inner]
          | left [outer]
          | right [outer]
          | full [outer]
         )
join tref
[on expr | using (...)]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s start with parsers for the 'join operator' in the middle and for
the join condition:</p>
</div>
<div class="sect3">
<h4 id="_join_type">13.6.1. join type</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">joinType</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">JoinType</span>
<span class="tok-nf">joinType</span> <span class="tok-ow">=</span> <span class="tok-n">choice</span>
    <span class="tok-p">[</span><span class="tok-kt">JoinCross</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;cross&quot;</span> <span class="tok-o">&lt;*</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;join&quot;</span>
    <span class="tok-p">,</span><span class="tok-kt">JoinInner</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;inner&quot;</span> <span class="tok-o">&lt;*</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;join&quot;</span>
    <span class="tok-p">,</span><span class="tok-kt">JoinLeft</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;left&quot;</span>
           <span class="tok-o">&lt;*</span> <span class="tok-n">optional</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;outer&quot;</span><span class="tok-p">)</span>
           <span class="tok-o">&lt;*</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;join&quot;</span>
    <span class="tok-p">,</span><span class="tok-kt">JoinRight</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;right&quot;</span>
            <span class="tok-o">&lt;*</span> <span class="tok-n">optional</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;outer&quot;</span><span class="tok-p">)</span>
            <span class="tok-o">&lt;*</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;join&quot;</span>
    <span class="tok-p">,</span><span class="tok-kt">JoinFull</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;full&quot;</span>
           <span class="tok-o">&lt;*</span> <span class="tok-n">optional</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;outer&quot;</span><span class="tok-p">)</span>
           <span class="tok-o">&lt;*</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;join&quot;</span>
    <span class="tok-p">,</span><span class="tok-kt">JoinInner</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;join&quot;</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithEof joinType "cross join"
Right JoinCross

*Main&gt; parseWithEof joinType "inner join"
Right JoinInner

*Main&gt; parseWithEof joinType "left outer join"
Right JoinLeft

*Main&gt; parseWithEof joinType "left join"
Right JoinLeft

*Main&gt; parseWithEof joinType "right outer join"
Right JoinRight

*Main&gt; parseWithEof joinType "right join"
Right JoinRight

*Main&gt; parseWithEof joinType "full outer join"
Right JFull

*Main&gt; parseWithEof joinType "full join"
Right JoinFull

*Main&gt; parseWithEof joinType "join"
Right JoinInner</code></pre>
</div>
</div>
<div class="paragraph">
<p>I thought about factoring out the common bits with the joinType parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">joinType0</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">JoinType</span>
<span class="tok-nf">joinType0</span> <span class="tok-ow">=</span> <span class="tok-n">choice</span>
    <span class="tok-p">[</span><span class="tok-n">choice</span>
     <span class="tok-p">[</span><span class="tok-kt">JoinCross</span> <span class="tok-o">&lt;$</span> <span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;cross&quot;</span><span class="tok-p">)</span>
     <span class="tok-p">,</span><span class="tok-kt">JoinInner</span> <span class="tok-o">&lt;$</span> <span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;inner&quot;</span><span class="tok-p">)</span>
     <span class="tok-p">,</span><span class="tok-n">choice</span> <span class="tok-p">[</span><span class="tok-kt">JoinLeft</span> <span class="tok-o">&lt;$</span> <span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;left&quot;</span><span class="tok-p">)</span>
             <span class="tok-p">,</span><span class="tok-kt">JoinRight</span> <span class="tok-o">&lt;$</span> <span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;right&quot;</span><span class="tok-p">)</span>
             <span class="tok-p">,</span><span class="tok-kt">JoinFull</span> <span class="tok-o">&lt;$</span> <span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;full&quot;</span><span class="tok-p">)]</span>
      <span class="tok-o">&lt;*</span> <span class="tok-n">optional</span> <span class="tok-p">(</span><span class="tok-n">try</span> <span class="tok-o">$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;outer&quot;</span><span class="tok-p">)]</span>
     <span class="tok-o">&lt;*</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;join&quot;</span>
    <span class="tok-p">,</span><span class="tok-kt">JoinInner</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;join&quot;</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But I think the longer version is much easier to follow, even if it is
a little more boring.</p>
</div>
</div>
<div class="sect3">
<h4 id="_join_condition">13.6.2. join condition</h4>
<div class="paragraph">
<p>The idea with the join condition is that we pass a bool to say whether
we&#8217;ve already seen the 'natural' keyword. If so, then we don&#8217;t try to
parse 'on' or 'using'.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">joinCondition</span> <span class="tok-ow">::</span> <span class="tok-kt">Bool</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">JoinCondition</span>
<span class="tok-nf">joinCondition</span> <span class="tok-n">nat</span> <span class="tok-ow">=</span>
    <span class="tok-n">choice</span> <span class="tok-p">[</span><span class="tok-n">guard</span> <span class="tok-n">nat</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-n">return</span> <span class="tok-kt">JoinNatural</span>
           <span class="tok-p">,</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;on&quot;</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-kt">JoinOn</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">valueExpr</span> <span class="tok-kt">[]</span>
           <span class="tok-p">,</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;using&quot;</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-kt">JoinUsing</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-p">(</span><span class="tok-n">commaSep1</span> <span class="tok-n">identifier</span><span class="tok-p">)</span>
           <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; parseWithEof (joinCondition False) "on a"
Right (JoinOn (Iden "a"))

*Main&gt; parseWithEof (joinCondition False) "on a + b"
Right (JoinOn (BinOp (Iden "a") "+" (Iden "b")))

*Main&gt; parseWithEof (joinCondition False) "using (a,b)"
Right (JoinUsing ["a","b"])

*Main&gt; parseWithEof (joinCondition True) "using (a,b)"
Left (line 1, column 1):
unexpected 'u'
expecting end of input

*Main&gt; parseWithEof (joinCondition True) ""
Right JoinNatural</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_simple_binary_join">13.6.3. simple binary join</h4>
<div class="paragraph">
<p>Let&#8217;s try some simple binary joins:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">simpleBinaryJoinTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,[</span><span class="tok-kt">TableRef</span><span class="tok-p">])]</span>
<span class="tok-nf">simpleBinaryJoinTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;from a join b&quot;</span>
     <span class="tok-p">,[</span><span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinInner</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">)</span> <span class="tok-kt">Nothing</span><span class="tok-p">])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;from a natural join b&quot;</span>
     <span class="tok-p">,[</span><span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinInner</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">)</span> <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-kt">JoinNatural</span><span class="tok-p">)])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;from a join b on a.x = b.y&quot;</span>
     <span class="tok-p">,[</span><span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinInner</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">)</span>
       <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">JoinOn</span> <span class="tok-o">$</span> <span class="tok-kt">BinOp</span> <span class="tok-p">(</span><span class="tok-kt">DIden</span> <span class="tok-s">&quot;a&quot;</span> <span class="tok-s">&quot;x&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;=&quot;</span><span class="tok-p">(</span><span class="tok-kt">DIden</span> <span class="tok-s">&quot;b&quot;</span> <span class="tok-s">&quot;y&quot;</span><span class="tok-p">))])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;from a join b using(x,y)&quot;</span>
     <span class="tok-p">,[</span><span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinInner</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">)</span>
       <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">JoinUsing</span> <span class="tok-p">[</span><span class="tok-s">&quot;x&quot;</span><span class="tok-p">,</span><span class="tok-s">&quot;y&quot;</span><span class="tok-p">])])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;from a cross join b&quot;</span>
     <span class="tok-p">,[</span><span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinCross</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">)</span> <span class="tok-kt">Nothing</span><span class="tok-p">])</span>

    <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We want to parse the first table, then optionally parse the 'natural'
keyword, then the join type, then the second table, then optionally
parse the join condition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">from4</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-kt">TableRef</span><span class="tok-p">]</span>
<span class="tok-nf">from4</span> <span class="tok-ow">=</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;from&quot;</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-p">(</span><span class="tok-kt">:[]</span><span class="tok-p">)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-kr">do</span>
     <span class="tok-n">t0</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">simpleTref</span>
     <span class="tok-n">nat</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">option</span> <span class="tok-kt">False</span> <span class="tok-p">(</span><span class="tok-kt">True</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;natural&quot;</span><span class="tok-p">)</span>
     <span class="tok-n">jt</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">joinType</span>
     <span class="tok-n">t1</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">simpleTref</span>
     <span class="tok-n">jc</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">optionMaybe</span> <span class="tok-p">(</span><span class="tok-n">joinCondition</span> <span class="tok-n">nat</span><span class="tok-p">)</span>
     <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">TRJoin</span> <span class="tok-n">t0</span> <span class="tok-n">jt</span> <span class="tok-n">t1</span> <span class="tok-n">jc</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">simpleTref</span> <span class="tok-ow">=</span> <span class="tok-kt">TRSimple</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">identifier</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s start extending this into the full target parser. In this next
version, I&#8217;ve tried to combine all the versions we&#8217;ve seen so far.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">from5</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-kt">TableRef</span><span class="tok-p">]</span>
<span class="tok-nf">from5</span> <span class="tok-ow">=</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;from&quot;</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-n">commaSep1</span> <span class="tok-n">tref</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">tref</span> <span class="tok-ow">=</span> <span class="tok-n">nonJoinTref</span> <span class="tok-o">&gt;&gt;=</span> <span class="tok-n">suffixWrapper</span> <span class="tok-n">joinTrefSuffix</span>
    <span class="tok-n">joinTrefSuffix</span> <span class="tok-n">t0</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
        <span class="tok-n">nat</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">option</span> <span class="tok-kt">False</span> <span class="tok-p">(</span><span class="tok-kt">True</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;natural&quot;</span><span class="tok-p">)</span>
        <span class="tok-n">jt</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">joinType</span>
        <span class="tok-n">t1</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">nonJoinTref</span>
        <span class="tok-n">jc</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">optionMaybe</span> <span class="tok-p">(</span><span class="tok-n">joinCondition</span> <span class="tok-n">nat</span><span class="tok-p">)</span>
        <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">TRJoin</span> <span class="tok-n">t0</span> <span class="tok-n">jt</span> <span class="tok-n">t1</span> <span class="tok-n">jc</span>
    <span class="tok-n">nonJoinTref</span> <span class="tok-ow">=</span> <span class="tok-n">choice</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">identifier</span>
                         <span class="tok-p">,</span><span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-kt">TRQueryExpr</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-p">(</span><span class="tok-n">queryExpr1</span> <span class="tok-n">from5</span><span class="tok-p">))</span>
                         <span class="tok-p">,</span><span class="tok-kt">TRParens</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-n">tref</span><span class="tok-p">]</span>
                  <span class="tok-o">&gt;&gt;=</span> <span class="tok-n">suffixWrapper</span> <span class="tok-n">alias</span>
    <span class="tok-n">alias</span> <span class="tok-n">tr</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-kt">TRAlias</span> <span class="tok-n">tr</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-p">(</span><span class="tok-n">optional</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;as&quot;</span><span class="tok-p">)</span> <span class="tok-o">*&gt;</span> <span class="tok-n">identifier</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; H.runTestTT $ H.TestList $ map (makeTest from5) (multipleTRSimpleTests ++ trQueryExprTests ++ trParensTests ++ trAliasTests ++ simpleBinaryJoinTests)
 ### Failure in: 5:from a join b
(line 1, column 14):
unexpected end of input
expecting digit, letter, "_", "--" or "/*"
 ### Failure in: 6:from a natural join b
from a natural join b
expected: [TRJoin (TRSimple "a") JoinInner (TRSimple "b") (Just JoinNatural)]
 but got: [TRJoin (TRAlias (TRSimple "a") "natural") JoinInner (TRSimple "b") Nothing]
 ### Failure in: 7:from a join b on a.x = b.y
(line 1, column 15):
unexpected "o"
expecting "--" or "/*"
 ### Failure in: 8:from a join b using(x,y)
(line 1, column 15):
unexpected "u"
expecting "--" or "/*"
 ### Failure in: 9:from a cross join b
from a cross join b
expected: [TRJoin (TRSimple "a") JoinCross (TRSimple "b") Nothing]
 but got: [TRJoin (TRAlias (TRSimple "a") "cross") JoinInner (TRSimple "b") Nothing]
Cases: 10  Tried: 10  Errors: 0  Failures: 5
Counts {cases = 10, tried = 10, errors = 0, failures = 5}</code></pre>
</div>
</div>
<div class="paragraph">
<p>What&#8217;s going wrong? If you look at some of the issues, it looks like
we are getting keywords parsed as aliases. Let&#8217;s fix that first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">from6</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-kt">TableRef</span><span class="tok-p">]</span>
<span class="tok-nf">from6</span> <span class="tok-ow">=</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;from&quot;</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-n">commaSep1</span> <span class="tok-n">tref</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">tref</span> <span class="tok-ow">=</span> <span class="tok-n">nonJoinTref</span> <span class="tok-o">&gt;&gt;=</span> <span class="tok-n">suffixWrapper</span> <span class="tok-n">joinTrefSuffix</span>
    <span class="tok-n">joinTrefSuffix</span> <span class="tok-n">t0</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
        <span class="tok-n">nat</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">option</span> <span class="tok-kt">False</span> <span class="tok-p">(</span><span class="tok-kt">True</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;natural&quot;</span><span class="tok-p">)</span>
        <span class="tok-n">jt</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">joinType</span>
        <span class="tok-n">t1</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">nonJoinTref</span>
        <span class="tok-n">jc</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">optionMaybe</span> <span class="tok-p">(</span><span class="tok-n">joinCondition</span> <span class="tok-n">nat</span><span class="tok-p">)</span>
        <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">TRJoin</span> <span class="tok-n">t0</span> <span class="tok-n">jt</span> <span class="tok-n">t1</span> <span class="tok-n">jc</span>
    <span class="tok-n">nonJoinTref</span> <span class="tok-ow">=</span> <span class="tok-n">choice</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">identifier</span>
                         <span class="tok-p">,</span><span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-kt">TRQueryExpr</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-p">(</span><span class="tok-n">queryExpr1</span> <span class="tok-n">from6</span><span class="tok-p">))</span>
                         <span class="tok-p">,</span><span class="tok-kt">TRParens</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-n">tref</span><span class="tok-p">]</span>
                  <span class="tok-o">&gt;&gt;=</span> <span class="tok-n">suffixWrapper</span> <span class="tok-n">alias</span>
    <span class="tok-n">alias</span> <span class="tok-n">tr</span> <span class="tok-ow">=</span> <span class="tok-kt">TRAlias</span> <span class="tok-n">tr</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-p">(</span><span class="tok-n">optional</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;as&quot;</span><span class="tok-p">)</span> <span class="tok-o">*&gt;</span> <span class="tok-n">aliasIdentifier</span><span class="tok-p">)</span>
    <span class="tok-n">aliasIdentifier</span> <span class="tok-ow">=</span> <span class="tok-n">blackListIdentifier</span>
                      <span class="tok-p">[</span><span class="tok-s">&quot;natural&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;inner&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;outer&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;cross&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;left&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;right&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;full&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;join&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;on&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;using&quot;</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That didn&#8217;t solve the problem. I think we also have a problem since
the <code>alias</code> can now fail after consuming input, we need to use <code>try</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">from7</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-kt">TableRef</span><span class="tok-p">]</span>
<span class="tok-nf">from7</span> <span class="tok-ow">=</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;from&quot;</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-n">commaSep1</span> <span class="tok-n">tref</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">tref</span> <span class="tok-ow">=</span> <span class="tok-n">nonJoinTref</span> <span class="tok-o">&gt;&gt;=</span> <span class="tok-n">suffixWrapper</span> <span class="tok-n">joinTrefSuffix</span>
    <span class="tok-n">joinTrefSuffix</span> <span class="tok-n">t0</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
        <span class="tok-n">nat</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">option</span> <span class="tok-kt">False</span> <span class="tok-p">(</span><span class="tok-kt">True</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;natural&quot;</span><span class="tok-p">)</span>
        <span class="tok-n">jt</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">joinType</span>
        <span class="tok-n">t1</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">nonJoinTref</span>
        <span class="tok-n">jc</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">optionMaybe</span> <span class="tok-p">(</span><span class="tok-n">joinCondition</span> <span class="tok-n">nat</span><span class="tok-p">)</span>
        <span class="tok-n">return</span> <span class="tok-o">$</span> <span class="tok-kt">TRJoin</span> <span class="tok-n">t0</span> <span class="tok-n">jt</span> <span class="tok-n">t1</span> <span class="tok-n">jc</span>
    <span class="tok-n">nonJoinTref</span> <span class="tok-ow">=</span> <span class="tok-n">choice</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">identifier</span>
                         <span class="tok-p">,</span><span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-kt">TRQueryExpr</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-p">(</span><span class="tok-n">queryExpr1</span> <span class="tok-n">from7</span><span class="tok-p">))</span>
                         <span class="tok-p">,</span><span class="tok-kt">TRParens</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-n">tref</span><span class="tok-p">]</span>
                  <span class="tok-o">&gt;&gt;=</span> <span class="tok-n">suffixWrapper</span> <span class="tok-p">(</span><span class="tok-n">try</span> <span class="tok-o">.</span> <span class="tok-n">alias</span><span class="tok-p">)</span>
    <span class="tok-n">alias</span> <span class="tok-n">tr</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-kt">TRAlias</span> <span class="tok-n">tr</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-p">(</span><span class="tok-n">optional</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;as&quot;</span><span class="tok-p">)</span> <span class="tok-o">*&gt;</span> <span class="tok-n">aliasIdentifier</span><span class="tok-p">))</span>
    <span class="tok-n">aliasIdentifier</span> <span class="tok-ow">=</span> <span class="tok-n">blackListIdentifier</span>
                      <span class="tok-p">[</span><span class="tok-s">&quot;natural&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;inner&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;outer&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;cross&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;left&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;right&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;full&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;join&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;on&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;using&quot;</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The final step is to make it parse n-way explicit joins.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">threeWayJoinTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,[</span><span class="tok-kt">TableRef</span><span class="tok-p">])]</span>
<span class="tok-nf">threeWayJoinTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;from a join b join c&quot;</span>
     <span class="tok-p">,[</span><span class="tok-kt">TRJoin</span>
       <span class="tok-p">(</span><span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinInner</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">)</span> <span class="tok-kt">Nothing</span><span class="tok-p">)</span>
       <span class="tok-kt">JoinInner</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;c&quot;</span><span class="tok-p">)</span> <span class="tok-kt">Nothing</span><span class="tok-p">])]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">from8</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-kt">TableRef</span><span class="tok-p">]</span>
<span class="tok-nf">from8</span> <span class="tok-ow">=</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;from&quot;</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-n">commaSep1</span> <span class="tok-n">tref</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">tref</span> <span class="tok-ow">=</span> <span class="tok-n">nonJoinTref</span> <span class="tok-o">&gt;&gt;=</span> <span class="tok-n">suffixWrapper</span> <span class="tok-n">joinTrefSuffix</span>
    <span class="tok-n">joinTrefSuffix</span> <span class="tok-n">t0</span> <span class="tok-ow">=</span> <span class="tok-p">(</span><span class="tok-kr">do</span>
         <span class="tok-n">nat</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">option</span> <span class="tok-kt">False</span> <span class="tok-p">(</span><span class="tok-kt">True</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;natural&quot;</span><span class="tok-p">)</span>
         <span class="tok-kt">TRJoin</span> <span class="tok-n">t0</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">joinType</span>
                   <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">nonJoinTref</span>
                   <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-p">(</span><span class="tok-n">joinCondition</span> <span class="tok-n">nat</span><span class="tok-p">))</span>
        <span class="tok-o">&gt;&gt;=</span> <span class="tok-n">suffixWrapper</span> <span class="tok-n">joinTrefSuffix</span>
    <span class="tok-n">nonJoinTref</span> <span class="tok-ow">=</span> <span class="tok-n">choice</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">identifier</span>
                         <span class="tok-p">,</span><span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-kt">TRQueryExpr</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-p">(</span><span class="tok-n">queryExpr1</span> <span class="tok-n">from8</span><span class="tok-p">))</span>
                         <span class="tok-p">,</span><span class="tok-kt">TRParens</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-n">tref</span><span class="tok-p">]</span>
                  <span class="tok-o">&gt;&gt;=</span> <span class="tok-n">suffixWrapper</span> <span class="tok-p">(</span><span class="tok-n">try</span> <span class="tok-o">.</span> <span class="tok-n">alias</span><span class="tok-p">)</span>
    <span class="tok-n">alias</span> <span class="tok-n">tr</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-kt">TRAlias</span> <span class="tok-n">tr</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-p">(</span><span class="tok-n">optional</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;as&quot;</span><span class="tok-p">)</span> <span class="tok-o">*&gt;</span> <span class="tok-n">aliasIdentifier</span><span class="tok-p">))</span>
    <span class="tok-n">aliasIdentifier</span> <span class="tok-ow">=</span> <span class="tok-n">blackListIdentifier</span>
                      <span class="tok-p">[</span><span class="tok-s">&quot;natural&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;inner&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;outer&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;cross&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;left&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;right&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;full&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;join&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;on&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;using&quot;</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We get left associative with this code. I don&#8217;t know if this is correct.</p>
</div>
<div class="paragraph">
<p>We should do some more testing to make sure this code is good. TODO</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_query_expressions">13.7. query expressions</h3>
<div class="paragraph">
<p>Let&#8217;s create the full query expression parser now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">queryExprJoinTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">queryExprJoinTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select a from t&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t,u&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">,</span> <span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t inner join u on expr&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinInner</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">)</span>
          <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">JoinOn</span> <span class="tok-o">$</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;expr&quot;</span><span class="tok-p">)])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t left join u on expr&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinLeft</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">)</span>
          <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">JoinOn</span> <span class="tok-o">$</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;expr&quot;</span><span class="tok-p">)])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t right join u on expr&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinRight</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">)</span>
          <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">JoinOn</span> <span class="tok-o">$</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;expr&quot;</span><span class="tok-p">)])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t full join u on expr&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinFull</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">)</span>
          <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">JoinOn</span> <span class="tok-o">$</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;expr&quot;</span><span class="tok-p">)])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t cross join u&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinCross</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">)</span> <span class="tok-kt">Nothing</span><span class="tok-p">])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t natural inner join u&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinInner</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">)</span>
          <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-kt">JoinNatural</span><span class="tok-p">)])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t inner join u using(a,b)&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinInner</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">)</span>
          <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">JoinUsing</span> <span class="tok-p">[</span><span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">])])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from (select a from t)&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRQueryExpr</span> <span class="tok-o">$</span> <span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">]])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t as u&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRAlias</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t u&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRAlias</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from (t cross join u) as u&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRAlias</span> <span class="tok-p">(</span><span class="tok-kt">TRParens</span> <span class="tok-o">$</span> <span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinCross</span>
                                     <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">)</span> <span class="tok-kt">Nothing</span><span class="tok-p">)</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">])</span>
    <span class="tok-p">]</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">ms</span> <span class="tok-n">f</span> <span class="tok-ow">=</span> <span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                      <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-n">f</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are all the other query expression tests updated with the new
QueryExpr type.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">singleSelectItemTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">singleSelectItemTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select 1&quot;</span><span class="tok-p">,</span> <span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]})]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">multipleSelectItemsTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">multipleSelectItemsTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select a&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]})</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;select a,b&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]})</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;select 1+2,3+4&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span>
                     <span class="tok-p">[(</span><span class="tok-kt">BinOp</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-s">&quot;+&quot;</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">2</span><span class="tok-p">),</span><span class="tok-kt">Nothing</span><span class="tok-p">)</span>
                     <span class="tok-p">,(</span><span class="tok-kt">BinOp</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">3</span><span class="tok-p">)</span> <span class="tok-s">&quot;+&quot;</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">4</span><span class="tok-p">),</span><span class="tok-kt">Nothing</span><span class="tok-p">)]})</span>
    <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">selectListTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">selectListTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select a as a, b as b&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Just</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Just</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">)]})</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a a, b b&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Just</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Just</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">)]})</span>
    <span class="tok-p">]</span> <span class="tok-o">++</span> <span class="tok-n">multipleSelectItemsTests</span>
      <span class="tok-o">++</span> <span class="tok-n">singleSelectItemTests</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">fromTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">fromTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select a from t&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">]})]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">whereTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">whereTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select a from t where a = 5&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeWhere</span> <span class="tok-ow">=</span> <span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">BinOp</span> <span class="tok-p">(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;=&quot;</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">5</span><span class="tok-p">)})</span>
    <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">groupByTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">groupByTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select a,sum(b) from t group by a&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">App</span> <span class="tok-s">&quot;sum&quot;</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">],</span><span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeGroupBy</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">]</span>
                 <span class="tok-p">})</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a,b,sum(c) from t group by a,b&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">App</span> <span class="tok-s">&quot;sum&quot;</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;c&quot;</span><span class="tok-p">],</span><span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeGroupBy</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">]</span>
                 <span class="tok-p">})</span>
    <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">havingTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">havingTests</span> <span class="tok-ow">=</span>
  <span class="tok-p">[(</span><span class="tok-s">&quot;select a,sum(b) from t group by a having sum(b) &gt; 5&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">App</span> <span class="tok-s">&quot;sum&quot;</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">],</span><span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeGroupBy</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeHaving</span> <span class="tok-ow">=</span> <span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">BinOp</span> <span class="tok-p">(</span><span class="tok-kt">App</span> <span class="tok-s">&quot;sum&quot;</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">])</span> <span class="tok-s">&quot;&gt;&quot;</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">5</span><span class="tok-p">)</span>
                 <span class="tok-p">})</span>
  <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">orderByTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">orderByTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select a from t order by a&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t order by a, b&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">])</span>
    <span class="tok-p">]</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">ms</span> <span class="tok-n">o</span> <span class="tok-ow">=</span> <span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                      <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">]</span>
                      <span class="tok-p">,</span><span class="tok-n">qeOrderBy</span> <span class="tok-ow">=</span> <span class="tok-n">o</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*Main&gt; H.runTestTT $ H.TestList $ map (makeTest (queryExpr1 from8)) (selectListTests ++ fromTests ++ whereTests ++ groupByTests ++ havingTests ++ orderByTests ++ queryExprJoinTests)
 ### Failure in: 7:select a from t where a = 5
(line 1, column 25):
unexpected "="
expecting "--" or "/*"
 ### Failure in: 8:select a,sum(b) from t group by a
(line 1, column 33):
unexpected "a"
expecting "--" or "/*"
 ### Failure in: 9:select a,b,sum(c) from t group by a,b
(line 1, column 35):
unexpected "a"
expecting "--" or "/*"
 ### Failure in: 10:select a,sum(b) from t group by a having sum(b) &gt; 5
(line 1, column 33):
unexpected "a"
expecting "--" or "/*"
 ### Failure in: 11:select a from t order by a
(line 1, column 26):
unexpected "a"
expecting "--" or "/*"
 ### Failure in: 12:select a from t order by a, b
(line 1, column 26):
unexpected "a"
expecting "--" or "/*"
Cases: 26  Tried: 26  Errors: 0  Failures: 6
Counts {cases = 26, tried = 26, errors = 0, failures = 6}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The problem is the table alias parser is trying to parse keywords
again. Here is the <code>from</code> parser with the alias name blacklist
expanded.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">from</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-kt">TableRef</span><span class="tok-p">]</span>
<span class="tok-nf">from</span> <span class="tok-ow">=</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;from&quot;</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-n">commaSep1</span> <span class="tok-n">tref</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">tref</span> <span class="tok-ow">=</span> <span class="tok-n">nonJoinTref</span> <span class="tok-o">&gt;&gt;=</span> <span class="tok-n">suffixWrapper</span> <span class="tok-n">joinTrefSuffix</span>
    <span class="tok-n">joinTrefSuffix</span> <span class="tok-n">t0</span> <span class="tok-ow">=</span> <span class="tok-p">(</span><span class="tok-kr">do</span>
         <span class="tok-n">nat</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">option</span> <span class="tok-kt">False</span> <span class="tok-p">(</span><span class="tok-kt">True</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;natural&quot;</span><span class="tok-p">)</span>
         <span class="tok-kt">TRJoin</span> <span class="tok-n">t0</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">joinType</span>
                   <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">nonJoinTref</span>
                   <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-p">(</span><span class="tok-n">joinCondition</span> <span class="tok-n">nat</span><span class="tok-p">))</span>
        <span class="tok-o">&gt;&gt;=</span> <span class="tok-n">suffixWrapper</span> <span class="tok-n">joinTrefSuffix</span>
    <span class="tok-n">nonJoinTref</span> <span class="tok-ow">=</span> <span class="tok-n">choice</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">identifier</span>
                         <span class="tok-p">,</span><span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-kt">TRQueryExpr</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-n">queryExpr</span><span class="tok-p">)</span>
                         <span class="tok-p">,</span><span class="tok-kt">TRParens</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-n">tref</span><span class="tok-p">]</span>
                  <span class="tok-o">&gt;&gt;=</span> <span class="tok-n">suffixWrapper</span> <span class="tok-p">(</span><span class="tok-n">try</span> <span class="tok-o">.</span> <span class="tok-n">alias</span><span class="tok-p">)</span>
    <span class="tok-n">alias</span> <span class="tok-n">tr</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-kt">TRAlias</span> <span class="tok-n">tr</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-p">(</span><span class="tok-n">optional</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;as&quot;</span><span class="tok-p">)</span> <span class="tok-o">*&gt;</span> <span class="tok-n">aliasIdentifier</span><span class="tok-p">))</span>
    <span class="tok-n">aliasIdentifier</span> <span class="tok-ow">=</span> <span class="tok-n">blackListIdentifier</span>
                      <span class="tok-p">[</span><span class="tok-c1">-- join keywords</span>
                       <span class="tok-s">&quot;natural&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;inner&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;outer&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;cross&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;left&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;right&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;full&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;join&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;on&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;using&quot;</span>
                       <span class="tok-c1">-- subsequent clause keywords</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;where&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;group&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;having&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;order&quot;</span>
                      <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the final query expression parser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">queryExpr</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">QueryExpr</span>
<span class="tok-nf">queryExpr</span> <span class="tok-ow">=</span> <span class="tok-kt">Select</span>
            <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">selectList</span>
            <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">option</span> <span class="tok-kt">[]</span> <span class="tok-n">from</span>
            <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">whereClause</span>
            <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">option</span> <span class="tok-kt">[]</span> <span class="tok-n">groupByClause</span>
            <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">having</span>
            <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">option</span> <span class="tok-kt">[]</span> <span class="tok-n">orderBy</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="simple-sql-query-parser">14. Simple SQL query parser</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here is the complete syntax, parser and tests for the value and query
expressions so far as a self contained module</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">module</span> <span class="tok-nn">SimpleSQLQueryParser0</span> <span class="tok-kr">where</span>

<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String</span> <span class="tok-p">(</span><span class="tok-kt">Parser</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Parsec</span> <span class="tok-p">(</span><span class="tok-nf">try</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Char</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec.String.Combinator</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec</span> <span class="tok-p">(</span><span class="tok-nf">parse</span><span class="tok-p">,</span><span class="tok-kt">ParseError</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Control.Applicative</span> <span class="tok-p">((</span><span class="tok-o">&lt;$&gt;</span><span class="tok-p">),(</span><span class="tok-o">&lt;*</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">*&gt;</span><span class="tok-p">),(</span><span class="tok-o">&lt;*&gt;</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;$</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;|&gt;</span><span class="tok-p">),</span> <span class="tok-nf">many</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-k">qualified</span> <span class="tok-nn">Text.Parsec.String.Expr</span> <span class="tok-k">as</span> <span class="tok-n">E</span>
<span class="tok-kr">import</span> <span class="tok-nn">Control.Monad</span>
<span class="tok-c1">--import Data.List (intercalate)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Data.Maybe</span> <span class="tok-p">()</span>
<span class="tok-kr">import</span> <span class="tok-k">qualified</span> <span class="tok-nn">Test.HUnit</span> <span class="tok-k">as</span> <span class="tok-n">H</span>
<span class="tok-kr">import</span> <span class="tok-nn">FunctionsAndTypesForParsing</span>
<span class="tok-kr">import</span> <span class="tok-nn">Debug.Trace</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_supported_sql">14.1. Supported SQL</h3>
<div class="sect3">
<h4 id="_comments_2">14.1.1. comments</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-c1">-- single line comment</span>
<span class="tok-cm">/*</span>
<span class="tok-cm">multiline</span>
<span class="tok-cm">comment</span>
<span class="tok-cm">*/</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>/* */</code> comments do not nest.</p>
</div>
</div>
<div class="sect3">
<h4 id="_value_expressions">14.1.2. value expressions</h4>
<div class="sect4">
<h5 id="_literals_2">literals</h5>
<div class="paragraph">
<p>postive integral literals and string literals with single quote,
without escaping of single quote within string (so there is no way to
create a string literal with a single quote in it).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-mi">1</span>
<span class="tok-mi">500</span>
<span class="tok-s1">&#39;string literal&#39;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_identifiers_2">identifiers</h5>
<div class="paragraph">
<p>Unquoted identifiers only, an identifier may start with a letter or
underscore, and contain letters, underscores and digits.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-n">a</span>
<span class="tok-n">something</span>
<span class="tok-n">_test_</span>
<span class="tok-n">a123</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_dotted_identifiers">dotted identifiers</h5>
<div class="paragraph">
<p>Supports two part dotted identifiers only. Both parts must parse
according to the rules for regular identifiers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-n">t</span><span class="tok-p">.</span><span class="tok-n">a</span>
<span class="tok-n">something</span><span class="tok-p">.</span><span class="tok-n">something_else</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_star_3">star</h5>
<div class="paragraph">
<p>Star, plus dotted star using the identifier rules for the first part.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-o">*</span>
<span class="tok-n">t</span><span class="tok-p">.</span><span class="tok-o">*</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_function_application_2">function application</h5>
<div class="paragraph">
<p>The function name must parse as a valid identifier.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-n">f</span><span class="tok-p">()</span>
<span class="tok-k">g</span><span class="tok-p">(</span><span class="tok-mi">1</span><span class="tok-p">)</span>
<span class="tok-n">h</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">,</span><span class="tok-s1">&#39;something&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_operators_2">operators</h5>
<div class="paragraph">
<p>Here is the range of operators supported.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-n">b</span>
<span class="tok-n">a</span> <span class="tok-o">&gt;</span> <span class="tok-n">b</span>
<span class="tok-n">a</span> <span class="tok-o">&lt;</span> <span class="tok-n">b</span>
<span class="tok-n">a</span> <span class="tok-o">&gt;=</span> <span class="tok-n">b</span>
<span class="tok-n">a</span> <span class="tok-o">&lt;=</span> <span class="tok-n">b</span>
<span class="tok-n">a</span> <span class="tok-o">!=</span> <span class="tok-n">b</span>
<span class="tok-n">a</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-n">b</span>
<span class="tok-n">a</span> <span class="tok-k">and</span> <span class="tok-n">b</span>
<span class="tok-n">a</span> <span class="tok-k">or</span> <span class="tok-n">b</span>
<span class="tok-mi">1</span> <span class="tok-o">+</span> <span class="tok-mi">2</span>
<span class="tok-mi">1</span> <span class="tok-o">-</span> <span class="tok-mi">2</span>
<span class="tok-mi">1</span> <span class="tok-o">*</span> <span class="tok-mi">2</span>
<span class="tok-mi">1</span> <span class="tok-o">/</span> <span class="tok-mi">2</span>
<span class="tok-s1">&#39;some&#39;</span> <span class="tok-o">||</span> <span class="tok-s1">&#39;thing&#39;</span>
<span class="tok-n">a</span> <span class="tok-k">like</span> <span class="tok-n">b</span>
<span class="tok-k">not</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_case_expression_2">case expression</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">case</span> <span class="tok-n">a</span>
<span class="tok-k">when</span> <span class="tok-mi">3</span> <span class="tok-k">then</span> <span class="tok-s1">&#39;got three&#39;</span>
<span class="tok-k">when</span> <span class="tok-mi">5</span> <span class="tok-k">then</span> <span class="tok-s1">&#39;got five&#39;</span>
<span class="tok-k">else</span> <span class="tok-s1">&#39;neither&#39;</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">case</span>
<span class="tok-k">when</span> <span class="tok-n">a</span> <span class="tok-o">=</span> <span class="tok-mi">3</span> <span class="tok-k">then</span> <span class="tok-s1">&#39;a is three&#39;</span>
<span class="tok-k">when</span> <span class="tok-n">b</span> <span class="tok-o">=</span> <span class="tok-mi">4</span> <span class="tok-k">then</span> <span class="tok-s1">&#39;b is four&#39;</span>
<span class="tok-k">else</span> <span class="tok-s1">&#39;neither&#39;</span>
<span class="tok-k">end</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The else branch is optional in both cases.</p>
</div>
</div>
<div class="sect4">
<h5 id="_parentheses_2">parentheses</h5>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-p">(</span><span class="tok-mi">1</span> <span class="tok-o">+</span> <span class="tok-mi">2</span><span class="tok-p">)</span> <span class="tok-o">*</span> <span class="tok-mi">3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Parentheses are explicit in the abstract syntax.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_query_expressions_2">14.1.3. query expressions</h4>
<div class="paragraph">
<p>TODO: examples</p>
</div>
<div class="paragraph">
<p>select queries only, no union, intersect or except. No common table
expressions.</p>
</div>
<div class="paragraph">
<p>select list aliases, with the 'as' optional in the alias</p>
</div>
<div class="paragraph">
<p>'select * from t'
'select t.* from t'
but not the alias version 'select * as (a,b,c) from t'.</p>
</div>
<div class="paragraph">
<p>from clause</p>
</div>
<div class="paragraph">
<p>implicit and explicit joins, including keywords
natural, inner, outer, left, right, full, cross, on and using, plus
parens and simple aliases (e.g. select a from t u, but not select a
from t(a,b)).</p>
</div>
<div class="paragraph">
<p>where</p>
</div>
<div class="paragraph">
<p>group by lists
but not the new group by options in SQL2003 (group by (), grouping
sets, cube, rollup).</p>
</div>
<div class="paragraph">
<p>having</p>
</div>
<div class="paragraph">
<p>order by, with multiple columns, but not explicit asc or
desc , and no 'nulls first' or 'nulls last' syntax.</p>
</div>
<div class="paragraph">
<p>No support for offset and fetch first, or variations.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_abstract_syntax_2">14.2. Abstract syntax</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">data</span> <span class="tok-kt">ValueExpr</span> <span class="tok-ow">=</span> <span class="tok-kt">StringLit</span> <span class="tok-kt">String</span>
               <span class="tok-o">|</span> <span class="tok-kt">NumLit</span> <span class="tok-kt">Integer</span>
               <span class="tok-o">|</span> <span class="tok-kt">Iden</span> <span class="tok-kt">String</span>
               <span class="tok-o">|</span> <span class="tok-kt">DIden</span> <span class="tok-kt">String</span> <span class="tok-kt">String</span> <span class="tok-c1">-- a.b</span>
               <span class="tok-o">|</span> <span class="tok-kt">Star</span>
               <span class="tok-o">|</span> <span class="tok-kt">DStar</span> <span class="tok-kt">String</span> <span class="tok-c1">-- t.*</span>
               <span class="tok-o">|</span> <span class="tok-kt">App</span> <span class="tok-kt">String</span> <span class="tok-p">[</span><span class="tok-kt">ValueExpr</span><span class="tok-p">]</span>
               <span class="tok-o">|</span> <span class="tok-kt">PrefOp</span> <span class="tok-kt">String</span> <span class="tok-kt">ValueExpr</span>
               <span class="tok-o">|</span> <span class="tok-kt">BinOp</span> <span class="tok-kt">ValueExpr</span> <span class="tok-kt">String</span> <span class="tok-kt">ValueExpr</span>
               <span class="tok-o">|</span> <span class="tok-kt">Case</span> <span class="tok-p">(</span><span class="tok-kt">Maybe</span> <span class="tok-kt">ValueExpr</span><span class="tok-p">)</span> <span class="tok-c1">-- test value</span>
                      <span class="tok-p">[(</span><span class="tok-kt">ValueExpr</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span> <span class="tok-c1">-- when branches</span>
                      <span class="tok-p">(</span><span class="tok-kt">Maybe</span> <span class="tok-kt">ValueExpr</span><span class="tok-p">)</span> <span class="tok-c1">-- else value</span>
               <span class="tok-o">|</span> <span class="tok-kt">Parens</span> <span class="tok-kt">ValueExpr</span>
                 <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span><span class="tok-p">,</span><span class="tok-kt">Show</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">data</span> <span class="tok-kt">QueryExpr</span>
    <span class="tok-ow">=</span> <span class="tok-kt">Select</span>
      <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">ValueExpr</span><span class="tok-p">,</span><span class="tok-kt">Maybe</span> <span class="tok-kt">String</span><span class="tok-p">)]</span>
      <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">::</span> <span class="tok-p">[</span><span class="tok-kt">TableRef</span><span class="tok-p">]</span>
      <span class="tok-p">,</span><span class="tok-n">qeWhere</span> <span class="tok-ow">::</span> <span class="tok-kt">Maybe</span> <span class="tok-kt">ValueExpr</span>
      <span class="tok-p">,</span><span class="tok-n">qeGroupBy</span> <span class="tok-ow">::</span> <span class="tok-p">[</span><span class="tok-kt">ValueExpr</span><span class="tok-p">]</span>
      <span class="tok-p">,</span><span class="tok-n">qeHaving</span> <span class="tok-ow">::</span> <span class="tok-kt">Maybe</span> <span class="tok-kt">ValueExpr</span>
      <span class="tok-p">,</span><span class="tok-n">qeOrderBy</span> <span class="tok-ow">::</span> <span class="tok-p">[</span><span class="tok-kt">ValueExpr</span><span class="tok-p">]</span>
      <span class="tok-p">}</span> <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span><span class="tok-p">,</span><span class="tok-kt">Show</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">makeSelect</span> <span class="tok-ow">::</span> <span class="tok-kt">QueryExpr</span>
<span class="tok-nf">makeSelect</span> <span class="tok-ow">=</span> <span class="tok-kt">Select</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-kt">[]</span>
                    <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-kt">[]</span>
                    <span class="tok-p">,</span><span class="tok-n">qeWhere</span> <span class="tok-ow">=</span> <span class="tok-kt">Nothing</span>
                    <span class="tok-p">,</span><span class="tok-n">qeGroupBy</span> <span class="tok-ow">=</span> <span class="tok-kt">[]</span>
                    <span class="tok-p">,</span><span class="tok-n">qeHaving</span> <span class="tok-ow">=</span> <span class="tok-kt">Nothing</span>
                    <span class="tok-p">,</span><span class="tok-n">qeOrderBy</span> <span class="tok-ow">=</span> <span class="tok-kt">[]</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">data</span> <span class="tok-kt">TableRef</span> <span class="tok-ow">=</span> <span class="tok-kt">TRSimple</span> <span class="tok-kt">String</span>
              <span class="tok-o">|</span> <span class="tok-kt">TRJoin</span> <span class="tok-kt">TableRef</span> <span class="tok-kt">JoinType</span> <span class="tok-kt">TableRef</span> <span class="tok-p">(</span><span class="tok-kt">Maybe</span> <span class="tok-kt">JoinCondition</span><span class="tok-p">)</span>
              <span class="tok-o">|</span> <span class="tok-kt">TRParens</span> <span class="tok-kt">TableRef</span>
              <span class="tok-o">|</span> <span class="tok-kt">TRAlias</span> <span class="tok-kt">TableRef</span> <span class="tok-kt">String</span>
              <span class="tok-o">|</span> <span class="tok-kt">TRQueryExpr</span> <span class="tok-kt">QueryExpr</span>
                <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span><span class="tok-p">,</span><span class="tok-kt">Show</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">data</span> <span class="tok-kt">JoinType</span> <span class="tok-ow">=</span> <span class="tok-kt">JoinInner</span> <span class="tok-o">|</span> <span class="tok-kt">JoinLeft</span> <span class="tok-o">|</span> <span class="tok-kt">JoinRight</span> <span class="tok-o">|</span> <span class="tok-kt">JoinFull</span> <span class="tok-o">|</span> <span class="tok-kt">JoinCross</span>
                <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span><span class="tok-p">,</span><span class="tok-kt">Show</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">data</span> <span class="tok-kt">JoinCondition</span> <span class="tok-ow">=</span> <span class="tok-kt">JoinOn</span> <span class="tok-kt">ValueExpr</span>
                   <span class="tok-o">|</span> <span class="tok-kt">JoinUsing</span> <span class="tok-p">[</span><span class="tok-kt">String</span><span class="tok-p">]</span>
                   <span class="tok-o">|</span> <span class="tok-kt">JoinNatural</span>
                   <span class="tok-kr">deriving</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span><span class="tok-p">,</span><span class="tok-kt">Show</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_value_expression_parsing">14.3. Value expression parsing</h3>
<div class="sect3">
<h4 id="_term_components">14.3.1. term components</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">num</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">num</span> <span class="tok-ow">=</span> <span class="tok-kt">NumLit</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">integer</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">iden</span> <span class="tok-ow">::</span> <span class="tok-p">[</span><span class="tok-kt">String</span><span class="tok-p">]</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">iden</span> <span class="tok-n">blacklist</span> <span class="tok-ow">=</span> <span class="tok-kt">Iden</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">identifierBlacklist</span> <span class="tok-n">blacklist</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parensValue</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">parensValue</span> <span class="tok-ow">=</span> <span class="tok-kt">Parens</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-p">(</span><span class="tok-n">valueExpr</span> <span class="tok-kt">[]</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">stringLit</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">stringLit</span> <span class="tok-ow">=</span> <span class="tok-kt">StringLit</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">stringToken</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">dIden</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">dIden</span> <span class="tok-ow">=</span> <span class="tok-kt">DIden</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">identifier</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-p">(</span><span class="tok-n">dot</span> <span class="tok-o">*&gt;</span> <span class="tok-n">identifier</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">star</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">star</span> <span class="tok-ow">=</span> <span class="tok-kt">Star</span> <span class="tok-o">&lt;$</span> <span class="tok-n">symbol</span> <span class="tok-s">&quot;*&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">dstar</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">dstar</span> <span class="tok-ow">=</span> <span class="tok-kt">DStar</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-p">(</span><span class="tok-n">identifier</span> <span class="tok-o">&lt;*</span> <span class="tok-n">dot</span> <span class="tok-o">&lt;*</span> <span class="tok-n">symbol</span> <span class="tok-s">&quot;*&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">app</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">app</span> <span class="tok-ow">=</span> <span class="tok-kt">App</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">identifier</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">parens</span> <span class="tok-p">(</span><span class="tok-n">commaSep</span> <span class="tok-o">$</span> <span class="tok-n">valueExpr</span> <span class="tok-kt">[]</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_case_2">14.3.2. case</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">caseValue</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">caseValue</span> <span class="tok-ow">=</span>
    <span class="tok-kt">Case</span>
    <span class="tok-o">&lt;$&gt;</span> <span class="tok-p">(</span><span class="tok-n">keyword</span> <span class="tok-s">&quot;case&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">caseVal</span><span class="tok-p">)</span>
    <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">many1</span> <span class="tok-n">whenClause</span>
    <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">elseClause</span>
    <span class="tok-o">&lt;*</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;end&quot;</span>
 <span class="tok-kr">where</span>
   <span class="tok-n">whenClause</span> <span class="tok-ow">=</span> <span class="tok-p">(,)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-p">(</span><span class="tok-n">keyword</span> <span class="tok-s">&quot;when&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">caseVal</span><span class="tok-p">)</span>
                    <span class="tok-o">&lt;*&gt;</span> <span class="tok-p">(</span><span class="tok-n">keyword</span> <span class="tok-s">&quot;then&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">caseVal</span><span class="tok-p">)</span>
   <span class="tok-n">elseClause</span> <span class="tok-ow">=</span> <span class="tok-n">keyword</span> <span class="tok-s">&quot;else&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">caseVal</span>
   <span class="tok-n">caseVal</span> <span class="tok-ow">=</span> <span class="tok-n">valueExpr</span> <span class="tok-n">blackList</span>
   <span class="tok-n">blackList</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-s">&quot;case&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;when&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;then&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;else&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;end&quot;</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_term">14.3.3. term</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">term</span> <span class="tok-ow">::</span> <span class="tok-p">[</span><span class="tok-kt">String</span><span class="tok-p">]</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">term</span> <span class="tok-n">blackList</span> <span class="tok-ow">=</span> <span class="tok-n">choice</span> <span class="tok-p">[</span><span class="tok-n">caseValue</span>
                        <span class="tok-p">,</span><span class="tok-n">try</span> <span class="tok-n">app</span>
                        <span class="tok-p">,</span><span class="tok-n">try</span> <span class="tok-n">dstar</span>
                        <span class="tok-p">,</span><span class="tok-n">try</span> <span class="tok-n">dIden</span>
                        <span class="tok-p">,</span><span class="tok-n">iden</span> <span class="tok-n">blackList</span>
                        <span class="tok-p">,</span><span class="tok-n">num</span>
                        <span class="tok-p">,</span><span class="tok-n">parensValue</span>
                        <span class="tok-p">,</span><span class="tok-n">stringLit</span>
                        <span class="tok-p">,</span><span class="tok-n">star</span><span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_operators_3">14.3.4. operators</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">table</span> <span class="tok-ow">::</span> <span class="tok-p">[[</span><span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Operator</span> <span class="tok-kt">ValueExpr</span><span class="tok-p">]]</span>
<span class="tok-nf">table</span> <span class="tok-ow">=</span> <span class="tok-p">[[</span><span class="tok-n">prefix</span> <span class="tok-s">&quot;-&quot;</span><span class="tok-p">,</span> <span class="tok-n">prefix</span> <span class="tok-s">&quot;+&quot;</span><span class="tok-p">]</span>
         <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;^&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span><span class="tok-p">]</span>
         <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;*&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span>
          <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;/&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span>
          <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;%&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span><span class="tok-p">]</span>
         <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;+&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span>
          <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;-&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span><span class="tok-p">]</span>
         <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&lt;=&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocRight</span>
          <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&gt;=&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocRight</span>
          <span class="tok-p">,</span><span class="tok-n">binaryK</span> <span class="tok-s">&quot;like&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocNone</span>
          <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;!=&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocRight</span>
          <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&lt;&gt;&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocRight</span>
          <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;||&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocRight</span><span class="tok-p">]</span>
         <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&lt;&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocNone</span>
          <span class="tok-p">,</span><span class="tok-n">binary</span> <span class="tok-s">&quot;&gt;&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocNone</span><span class="tok-p">]</span>
         <span class="tok-p">,[</span><span class="tok-n">binary</span> <span class="tok-s">&quot;=&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocRight</span><span class="tok-p">]</span>
         <span class="tok-p">,[</span><span class="tok-n">prefixK</span> <span class="tok-s">&quot;not&quot;</span><span class="tok-p">]</span>
         <span class="tok-p">,[</span><span class="tok-n">binaryK</span> <span class="tok-s">&quot;and&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span><span class="tok-p">]</span>
         <span class="tok-p">,[</span><span class="tok-n">binaryK</span> <span class="tok-s">&quot;or&quot;</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">AssocLeft</span><span class="tok-p">]]</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">binary</span> <span class="tok-n">name</span> <span class="tok-n">assoc</span> <span class="tok-ow">=</span>
        <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Infix</span> <span class="tok-p">(</span><span class="tok-n">mkBinOp</span> <span class="tok-n">name</span> <span class="tok-o">&lt;$</span> <span class="tok-n">symbol</span> <span class="tok-n">name</span><span class="tok-p">)</span> <span class="tok-n">assoc</span>
    <span class="tok-n">mkBinOp</span> <span class="tok-n">nm</span> <span class="tok-n">a</span> <span class="tok-n">b</span> <span class="tok-ow">=</span> <span class="tok-kt">BinOp</span> <span class="tok-n">a</span> <span class="tok-n">nm</span> <span class="tok-n">b</span>
    <span class="tok-n">prefix</span> <span class="tok-n">name</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Prefix</span> <span class="tok-p">(</span><span class="tok-kt">PrefOp</span> <span class="tok-n">name</span> <span class="tok-o">&lt;$</span> <span class="tok-n">symbol</span> <span class="tok-n">name</span><span class="tok-p">)</span>
    <span class="tok-n">binaryK</span> <span class="tok-n">name</span> <span class="tok-n">assoc</span> <span class="tok-ow">=</span>
        <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Infix</span> <span class="tok-p">(</span><span class="tok-n">mkBinOp</span> <span class="tok-n">name</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword</span> <span class="tok-n">name</span><span class="tok-p">)</span> <span class="tok-n">assoc</span>
    <span class="tok-n">prefixK</span> <span class="tok-n">name</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-kt">Prefix</span> <span class="tok-p">(</span><span class="tok-kt">PrefOp</span> <span class="tok-n">name</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword</span> <span class="tok-n">name</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_valueexpr">14.3.5. valueExpr</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">valueExpr</span> <span class="tok-ow">::</span> <span class="tok-p">[</span><span class="tok-kt">String</span><span class="tok-p">]</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">valueExpr</span> <span class="tok-n">blackList</span> <span class="tok-ow">=</span> <span class="tok-kt">E</span><span class="tok-o">.</span><span class="tok-n">buildExpressionParser</span> <span class="tok-n">table</span> <span class="tok-p">(</span><span class="tok-n">term</span> <span class="tok-n">blackList</span><span class="tok-p">)</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_query_expression_parsing">14.4. Query expression parsing</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">selectList</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">[(</span><span class="tok-kt">ValueExpr</span><span class="tok-p">,</span> <span class="tok-kt">Maybe</span> <span class="tok-kt">String</span><span class="tok-p">)]</span>
<span class="tok-nf">selectList</span> <span class="tok-ow">=</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;select&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">commaSep1</span> <span class="tok-n">selectItem</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">selectItem</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">(</span><span class="tok-kt">ValueExpr</span><span class="tok-p">,</span> <span class="tok-kt">Maybe</span> <span class="tok-kt">String</span><span class="tok-p">)</span>
<span class="tok-nf">selectItem</span> <span class="tok-ow">=</span> <span class="tok-p">(,)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">valueExpr</span> <span class="tok-kt">[]</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-p">(</span><span class="tok-n">try</span> <span class="tok-n">alias</span><span class="tok-p">)</span>
  <span class="tok-kr">where</span> <span class="tok-n">alias</span> <span class="tok-ow">=</span> <span class="tok-n">optional</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;as&quot;</span><span class="tok-p">)</span> <span class="tok-o">*&gt;</span> <span class="tok-n">identifierBlacklist</span> <span class="tok-p">[</span><span class="tok-s">&quot;from&quot;</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">whereClause</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">whereClause</span> <span class="tok-ow">=</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;where&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">valueExpr</span> <span class="tok-kt">[]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">groupByClause</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-kt">ValueExpr</span><span class="tok-p">]</span>
<span class="tok-nf">groupByClause</span> <span class="tok-ow">=</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;group&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;by&quot;</span>
                <span class="tok-o">*&gt;</span> <span class="tok-n">commaSep1</span> <span class="tok-p">(</span><span class="tok-n">valueExpr</span> <span class="tok-kt">[]</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">having</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">having</span> <span class="tok-ow">=</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;having&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-p">(</span><span class="tok-n">valueExpr</span> <span class="tok-kt">[]</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">orderBy</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-kt">ValueExpr</span><span class="tok-p">]</span>
<span class="tok-nf">orderBy</span> <span class="tok-ow">=</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;order&quot;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;by&quot;</span>
          <span class="tok-o">*&gt;</span> <span class="tok-n">commaSep1</span> <span class="tok-p">(</span><span class="tok-n">valueExpr</span> <span class="tok-kt">[]</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_from_clause_2">14.4.1. from clause</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">from</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-kt">TableRef</span><span class="tok-p">]</span>
<span class="tok-nf">from</span> <span class="tok-ow">=</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;from&quot;</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-n">commaSep1</span> <span class="tok-n">tref</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">tref</span> <span class="tok-ow">=</span> <span class="tok-n">nonJoinTref</span> <span class="tok-o">&gt;&gt;=</span> <span class="tok-n">suffixWrapper</span> <span class="tok-n">joinTrefSuffix</span>
    <span class="tok-n">joinTrefSuffix</span> <span class="tok-n">t0</span> <span class="tok-ow">=</span> <span class="tok-p">(</span><span class="tok-kr">do</span>
         <span class="tok-n">nat</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">option</span> <span class="tok-kt">False</span> <span class="tok-p">(</span><span class="tok-kt">True</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;natural&quot;</span><span class="tok-p">)</span>
         <span class="tok-kt">TRJoin</span> <span class="tok-n">t0</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">joinType</span>
                   <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">nonJoinTref</span>
                   <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-p">(</span><span class="tok-n">joinCondition</span> <span class="tok-n">nat</span><span class="tok-p">))</span>
        <span class="tok-o">&gt;&gt;=</span> <span class="tok-n">suffixWrapper</span> <span class="tok-n">joinTrefSuffix</span>
    <span class="tok-n">nonJoinTref</span> <span class="tok-ow">=</span> <span class="tok-n">choice</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">identifier</span>
                         <span class="tok-p">,</span><span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-kt">TRQueryExpr</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-n">queryExpr</span><span class="tok-p">)</span>
                         <span class="tok-p">,</span><span class="tok-kt">TRParens</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-n">tref</span><span class="tok-p">]</span>
                  <span class="tok-o">&gt;&gt;=</span> <span class="tok-n">suffixWrapper</span> <span class="tok-p">(</span><span class="tok-n">try</span> <span class="tok-o">.</span> <span class="tok-n">alias</span><span class="tok-p">)</span>
    <span class="tok-n">alias</span> <span class="tok-n">tr</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-kt">TRAlias</span> <span class="tok-n">tr</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-p">(</span><span class="tok-n">optional</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;as&quot;</span><span class="tok-p">)</span> <span class="tok-o">*&gt;</span> <span class="tok-n">aliasIdentifier</span><span class="tok-p">))</span>
    <span class="tok-n">aliasIdentifier</span> <span class="tok-ow">=</span> <span class="tok-n">identifierBlacklist</span>
                      <span class="tok-p">[</span><span class="tok-c1">-- join keywords</span>
                       <span class="tok-s">&quot;natural&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;inner&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;outer&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;cross&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;left&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;right&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;full&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;join&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;on&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;using&quot;</span>
                       <span class="tok-c1">-- subsequent clause keywords</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;where&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;group&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;having&quot;</span>
                      <span class="tok-p">,</span><span class="tok-s">&quot;order&quot;</span>
                      <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">joinType</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">JoinType</span>
<span class="tok-nf">joinType</span> <span class="tok-ow">=</span> <span class="tok-n">choice</span>
    <span class="tok-p">[</span><span class="tok-kt">JoinCross</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;cross&quot;</span> <span class="tok-o">&lt;*</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;join&quot;</span>
    <span class="tok-p">,</span><span class="tok-kt">JoinInner</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;inner&quot;</span> <span class="tok-o">&lt;*</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;join&quot;</span>
    <span class="tok-p">,</span><span class="tok-kt">JoinLeft</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;left&quot;</span>
           <span class="tok-o">&lt;*</span> <span class="tok-n">optional</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;outer&quot;</span><span class="tok-p">)</span>
           <span class="tok-o">&lt;*</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;join&quot;</span>
    <span class="tok-p">,</span><span class="tok-kt">JoinRight</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;right&quot;</span>
            <span class="tok-o">&lt;*</span> <span class="tok-n">optional</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;outer&quot;</span><span class="tok-p">)</span>
            <span class="tok-o">&lt;*</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;join&quot;</span>
    <span class="tok-p">,</span><span class="tok-kt">JoinFull</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;full&quot;</span>
           <span class="tok-o">&lt;*</span> <span class="tok-n">optional</span> <span class="tok-p">(</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;outer&quot;</span><span class="tok-p">)</span>
           <span class="tok-o">&lt;*</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;join&quot;</span>
    <span class="tok-p">,</span><span class="tok-kt">JoinInner</span> <span class="tok-o">&lt;$</span> <span class="tok-n">keyword_</span> <span class="tok-s">&quot;join&quot;</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">joinCondition</span> <span class="tok-ow">::</span> <span class="tok-kt">Bool</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">JoinCondition</span>
<span class="tok-nf">joinCondition</span> <span class="tok-n">nat</span> <span class="tok-ow">=</span>
    <span class="tok-n">choice</span> <span class="tok-p">[</span><span class="tok-n">guard</span> <span class="tok-n">nat</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-n">return</span> <span class="tok-kt">JoinNatural</span>
           <span class="tok-p">,</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;on&quot;</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-kt">JoinOn</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">valueExpr</span> <span class="tok-kt">[]</span>
           <span class="tok-p">,</span><span class="tok-n">keyword_</span> <span class="tok-s">&quot;using&quot;</span> <span class="tok-o">&gt;&gt;</span> <span class="tok-kt">JoinUsing</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">parens</span> <span class="tok-p">(</span><span class="tok-n">commaSep1</span> <span class="tok-n">identifier</span><span class="tok-p">)</span>
           <span class="tok-p">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_queryexpr">14.4.2. queryExpr</h4>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">queryExpr</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">QueryExpr</span>
<span class="tok-nf">queryExpr</span> <span class="tok-ow">=</span> <span class="tok-kt">Select</span>
            <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">selectList</span>
            <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">option</span> <span class="tok-kt">[]</span> <span class="tok-n">from</span>
            <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">whereClause</span>
            <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">option</span> <span class="tok-kt">[]</span> <span class="tok-n">groupByClause</span>
            <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">optionMaybe</span> <span class="tok-n">having</span>
            <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">option</span> <span class="tok-kt">[]</span> <span class="tok-n">orderBy</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tokens_2">14.5. tokens</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">whitespace</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span>
<span class="tok-nf">whitespace</span> <span class="tok-ow">=</span>
    <span class="tok-n">choice</span> <span class="tok-p">[</span><span class="tok-n">simpleWhitespace</span> <span class="tok-o">*&gt;</span> <span class="tok-n">whitespace</span>
           <span class="tok-p">,</span><span class="tok-n">lineComment</span> <span class="tok-o">*&gt;</span> <span class="tok-n">whitespace</span>
           <span class="tok-p">,</span><span class="tok-n">blockComment</span> <span class="tok-o">*&gt;</span> <span class="tok-n">whitespace</span>
           <span class="tok-p">,</span><span class="tok-n">return</span> <span class="tok-nb">()</span><span class="tok-p">]</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">lineComment</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-n">string</span> <span class="tok-s">&quot;--&quot;</span><span class="tok-p">)</span>
                  <span class="tok-o">*&gt;</span> <span class="tok-n">manyTill</span> <span class="tok-n">anyChar</span> <span class="tok-p">(</span><span class="tok-n">void</span> <span class="tok-p">(</span><span class="tok-n">char</span> <span class="tok-sc">&#39;</span><span class="tok-se">\n</span><span class="tok-sc">&#39;</span><span class="tok-p">)</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">eof</span><span class="tok-p">)</span>
    <span class="tok-n">blockComment</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-p">(</span><span class="tok-n">string</span> <span class="tok-s">&quot;/*&quot;</span><span class="tok-p">)</span>
                   <span class="tok-o">*&gt;</span> <span class="tok-n">manyTill</span> <span class="tok-n">anyChar</span> <span class="tok-p">(</span><span class="tok-n">try</span> <span class="tok-o">$</span> <span class="tok-n">string</span> <span class="tok-s">&quot;*/&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">simpleWhitespace</span> <span class="tok-ow">=</span> <span class="tok-n">void</span> <span class="tok-o">$</span> <span class="tok-n">many1</span> <span class="tok-p">(</span><span class="tok-n">oneOf</span> <span class="tok-s">&quot; </span><span class="tok-se">\t\n</span><span class="tok-s">&quot;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">lexeme</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span>
<span class="tok-nf">lexeme</span> <span class="tok-n">p</span> <span class="tok-ow">=</span> <span class="tok-n">p</span> <span class="tok-o">&lt;*</span> <span class="tok-n">whitespace</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">integer</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Integer</span>
<span class="tok-nf">integer</span> <span class="tok-ow">=</span> <span class="tok-n">read</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">lexeme</span> <span class="tok-p">(</span><span class="tok-n">many1</span> <span class="tok-n">digit</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">identifier</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">identifier</span> <span class="tok-ow">=</span> <span class="tok-n">lexeme</span> <span class="tok-p">((</span><span class="tok-kt">:</span><span class="tok-p">)</span> <span class="tok-o">&lt;$&gt;</span> <span class="tok-n">firstChar</span> <span class="tok-o">&lt;*&gt;</span> <span class="tok-n">many</span> <span class="tok-n">nonFirstChar</span><span class="tok-p">)</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">firstChar</span> <span class="tok-ow">=</span> <span class="tok-n">letter</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;_&#39;</span>
    <span class="tok-n">nonFirstChar</span> <span class="tok-ow">=</span> <span class="tok-n">digit</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">firstChar</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">symbol</span> <span class="tok-ow">::</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">symbol</span> <span class="tok-n">s</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-o">$</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-kr">do</span>
    <span class="tok-n">u</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">many1</span> <span class="tok-p">(</span><span class="tok-n">oneOf</span> <span class="tok-s">&quot;&lt;&gt;=+-^%/*!|&quot;</span><span class="tok-p">)</span>
    <span class="tok-n">guard</span> <span class="tok-p">(</span><span class="tok-n">s</span> <span class="tok-o">==</span> <span class="tok-n">u</span><span class="tok-p">)</span>
    <span class="tok-n">return</span> <span class="tok-n">s</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">openParen</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Char</span>
<span class="tok-nf">openParen</span> <span class="tok-ow">=</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;(&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">closeParen</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Char</span>
<span class="tok-nf">closeParen</span> <span class="tok-ow">=</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;)&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">stringToken</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">stringToken</span> <span class="tok-ow">=</span> <span class="tok-n">lexeme</span> <span class="tok-p">(</span><span class="tok-n">char</span> <span class="tok-sc">&#39;</span><span class="tok-se">\&#39;</span><span class="tok-sc">&#39;</span> <span class="tok-o">*&gt;</span> <span class="tok-n">manyTill</span> <span class="tok-n">anyChar</span> <span class="tok-p">(</span><span class="tok-n">char</span> <span class="tok-sc">&#39;</span><span class="tok-se">\&#39;</span><span class="tok-sc">&#39;</span><span class="tok-p">))</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">dot</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Char</span>
<span class="tok-nf">dot</span> <span class="tok-ow">=</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;.&#39;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">comma</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-kt">Char</span>
<span class="tok-nf">comma</span> <span class="tok-ow">=</span> <span class="tok-n">lexeme</span> <span class="tok-o">$</span> <span class="tok-n">char</span> <span class="tok-sc">&#39;,&#39;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_helper_functions_2">14.6. helper functions</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">keyword</span> <span class="tok-ow">::</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">keyword</span> <span class="tok-n">k</span> <span class="tok-ow">=</span> <span class="tok-n">try</span> <span class="tok-o">$</span> <span class="tok-kr">do</span>
    <span class="tok-n">i</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">identifier</span>
    <span class="tok-n">guard</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-o">==</span> <span class="tok-n">k</span><span class="tok-p">)</span>
    <span class="tok-n">return</span> <span class="tok-n">k</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parens</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span>
<span class="tok-nf">parens</span> <span class="tok-ow">=</span> <span class="tok-n">between</span> <span class="tok-n">openParen</span> <span class="tok-n">closeParen</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">commaSep</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span>
<span class="tok-nf">commaSep</span> <span class="tok-ow">=</span> <span class="tok-p">(`</span><span class="tok-n">sepBy</span><span class="tok-p">`</span> <span class="tok-n">comma</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">keyword_</span> <span class="tok-ow">::</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span>
<span class="tok-nf">keyword_</span> <span class="tok-ow">=</span> <span class="tok-n">void</span> <span class="tok-o">.</span> <span class="tok-n">keyword</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">symbol_</span> <span class="tok-ow">::</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-nb">()</span>
<span class="tok-nf">symbol_</span> <span class="tok-ow">=</span> <span class="tok-n">void</span> <span class="tok-o">.</span> <span class="tok-n">symbol</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">commaSep1</span> <span class="tok-ow">::</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-p">[</span><span class="tok-n">a</span><span class="tok-p">]</span>
<span class="tok-nf">commaSep1</span> <span class="tok-ow">=</span> <span class="tok-p">(`</span><span class="tok-n">sepBy1</span><span class="tok-p">`</span> <span class="tok-n">comma</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">identifierBlacklist</span> <span class="tok-ow">::</span> <span class="tok-p">[</span><span class="tok-kt">String</span><span class="tok-p">]</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-kt">String</span>
<span class="tok-nf">identifierBlacklist</span> <span class="tok-n">bl</span> <span class="tok-ow">=</span> <span class="tok-kr">do</span>
    <span class="tok-n">i</span> <span class="tok-ow">&lt;-</span> <span class="tok-n">identifier</span>
    <span class="tok-n">guard</span> <span class="tok-p">(</span><span class="tok-n">i</span> <span class="tok-p">`</span><span class="tok-n">notElem</span><span class="tok-p">`</span> <span class="tok-n">bl</span><span class="tok-p">)</span>
    <span class="tok-n">return</span> <span class="tok-n">i</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">suffixWrapper</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span>
<span class="tok-nf">suffixWrapper</span> <span class="tok-n">p</span> <span class="tok-n">a</span> <span class="tok-ow">=</span> <span class="tok-n">p</span> <span class="tok-n">a</span> <span class="tok-o">&lt;|&gt;</span> <span class="tok-n">return</span> <span class="tok-n">a</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_parser_api">14.7. the parser api</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parseQueryExpr</span> <span class="tok-ow">::</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Either</span> <span class="tok-kt">ParseError</span> <span class="tok-kt">QueryExpr</span>
<span class="tok-nf">parseQueryExpr</span> <span class="tok-ow">=</span> <span class="tok-n">parse</span> <span class="tok-p">(</span><span class="tok-n">whitespace</span> <span class="tok-o">*&gt;</span> <span class="tok-n">queryExpr</span> <span class="tok-o">&lt;*</span> <span class="tok-n">eof</span><span class="tok-p">)</span> <span class="tok-s">&quot;&quot;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">parseValueExpr</span> <span class="tok-ow">::</span> <span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Either</span> <span class="tok-kt">ParseError</span> <span class="tok-kt">ValueExpr</span>
<span class="tok-nf">parseValueExpr</span> <span class="tok-ow">=</span> <span class="tok-n">parse</span> <span class="tok-p">(</span><span class="tok-n">whitespace</span> <span class="tok-o">*&gt;</span> <span class="tok-n">valueExpr</span> <span class="tok-kt">[]</span> <span class="tok-o">&lt;*</span> <span class="tok-n">eof</span><span class="tok-p">)</span> <span class="tok-s">&quot;&quot;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tests">14.8. tests</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">data</span> <span class="tok-kt">TestItem</span> <span class="tok-ow">=</span> <span class="tok-kt">Group</span> <span class="tok-kt">String</span> <span class="tok-p">[</span><span class="tok-kt">TestItem</span><span class="tok-p">]</span>
              <span class="tok-o">|</span> <span class="tok-kt">ValueExpressionTest</span> <span class="tok-kt">String</span> <span class="tok-kt">ValueExpr</span>
              <span class="tok-o">|</span> <span class="tok-kt">QueryExpressionTest</span> <span class="tok-kt">String</span> <span class="tok-kt">QueryExpr</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">numLitTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">numLitTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;1&quot;</span><span class="tok-p">,</span> <span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">)</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;54321&quot;</span><span class="tok-p">,</span> <span class="tok-kt">NumLit</span> <span class="tok-mi">54321</span><span class="tok-p">)]</span>

<span class="tok-nf">idenTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">idenTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;test&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;test&quot;</span><span class="tok-p">)</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;_something3&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;_something3&quot;</span><span class="tok-p">)]</span>

<span class="tok-nf">operatorTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">operatorTests</span> <span class="tok-ow">=</span>
   <span class="tok-n">map</span> <span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">o</span> <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-n">o</span> <span class="tok-o">++</span> <span class="tok-s">&quot; a&quot;</span><span class="tok-p">,</span> <span class="tok-kt">PrefOp</span> <span class="tok-n">o</span> <span class="tok-p">(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)))</span> <span class="tok-p">[</span><span class="tok-s">&quot;not&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;+&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;-&quot;</span><span class="tok-p">]</span>
   <span class="tok-o">++</span> <span class="tok-n">map</span> <span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">o</span> <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-s">&quot;a &quot;</span> <span class="tok-o">++</span> <span class="tok-n">o</span> <span class="tok-o">++</span> <span class="tok-s">&quot; b&quot;</span><span class="tok-p">,</span> <span class="tok-kt">BinOp</span> <span class="tok-p">(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-n">o</span> <span class="tok-p">(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">)))</span>
          <span class="tok-p">[</span><span class="tok-s">&quot;=&quot;</span><span class="tok-p">,</span><span class="tok-s">&quot;&gt;&quot;</span><span class="tok-p">,</span><span class="tok-s">&quot;&lt;&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;&gt;=&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;&lt;=&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;!=&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;&lt;&gt;&quot;</span>
          <span class="tok-p">,</span><span class="tok-s">&quot;and&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;or&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;+&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;-&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;*&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;/&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;||&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;like&quot;</span><span class="tok-p">]</span>

<span class="tok-nf">parensTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">parensTests</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-s">&quot;(1)&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Parens</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">))]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">basicTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">basicTests</span> <span class="tok-ow">=</span> <span class="tok-n">numLitTests</span> <span class="tok-o">++</span> <span class="tok-n">idenTests</span> <span class="tok-o">++</span> <span class="tok-n">operatorTests</span> <span class="tok-o">++</span> <span class="tok-n">parensTests</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">stringLiteralTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">stringLiteralTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;&#39;&#39;&quot;</span><span class="tok-p">,</span> <span class="tok-kt">StringLit</span> <span class="tok-s">&quot;&quot;</span><span class="tok-p">)</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;&#39;test&#39;&quot;</span><span class="tok-p">,</span> <span class="tok-kt">StringLit</span> <span class="tok-s">&quot;test&quot;</span><span class="tok-p">)]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">dIdenTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">dIdenTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;t.a&quot;</span><span class="tok-p">,</span> <span class="tok-kt">DIden</span> <span class="tok-s">&quot;t&quot;</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">starTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">starTests</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-s">&quot;*&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Star</span><span class="tok-p">)]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">dStarTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">dStarTests</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-s">&quot;t.*&quot;</span><span class="tok-p">,</span> <span class="tok-kt">DStar</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">appTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">appTests</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-s">&quot;f()&quot;</span><span class="tok-p">,</span> <span class="tok-kt">App</span> <span class="tok-s">&quot;f&quot;</span> <span class="tok-kt">[]</span><span class="tok-p">)</span>
           <span class="tok-p">,(</span><span class="tok-s">&quot;f(1)&quot;</span><span class="tok-p">,</span> <span class="tok-kt">App</span> <span class="tok-s">&quot;f&quot;</span> <span class="tok-p">[</span><span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">])</span>
           <span class="tok-p">,(</span><span class="tok-s">&quot;f(1,a)&quot;</span><span class="tok-p">,</span> <span class="tok-kt">App</span> <span class="tok-s">&quot;f&quot;</span> <span class="tok-p">[</span><span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">])]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">caseTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">caseTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;case a when 1 then 2 end&quot;</span>
     <span class="tok-p">,</span><span class="tok-kt">Case</span> <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-p">[(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-kt">NumLit</span> <span class="tok-mi">2</span><span class="tok-p">)]</span> <span class="tok-kt">Nothing</span><span class="tok-p">)</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;case a when 1 then 2 when 3 then 4 end&quot;</span>
     <span class="tok-p">,</span><span class="tok-kt">Case</span> <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span>
           <span class="tok-p">[(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-kt">NumLit</span> <span class="tok-mi">2</span><span class="tok-p">)</span>
           <span class="tok-p">,(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">3</span><span class="tok-p">,</span> <span class="tok-kt">NumLit</span> <span class="tok-mi">4</span><span class="tok-p">)]</span>
           <span class="tok-kt">Nothing</span><span class="tok-p">)</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;case a when 1 then 2 when 3 then 4 else 5 end&quot;</span>
     <span class="tok-p">,</span><span class="tok-kt">Case</span> <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span>
           <span class="tok-p">[(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">,</span> <span class="tok-kt">NumLit</span> <span class="tok-mi">2</span><span class="tok-p">)</span>
           <span class="tok-p">,(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">3</span><span class="tok-p">,</span> <span class="tok-kt">NumLit</span> <span class="tok-mi">4</span><span class="tok-p">)]</span>
           <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">NumLit</span> <span class="tok-mi">5</span><span class="tok-p">))</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;case when a=1 then 2 when a=3 then 4 else 5 end&quot;</span>
     <span class="tok-p">,</span><span class="tok-kt">Case</span> <span class="tok-kt">Nothing</span>
           <span class="tok-p">[(</span><span class="tok-kt">BinOp</span> <span class="tok-p">(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;=&quot;</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">),</span> <span class="tok-kt">NumLit</span> <span class="tok-mi">2</span><span class="tok-p">)</span>
           <span class="tok-p">,(</span><span class="tok-kt">BinOp</span> <span class="tok-p">(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;=&quot;</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">3</span><span class="tok-p">),</span> <span class="tok-kt">NumLit</span> <span class="tok-mi">4</span><span class="tok-p">)]</span>
           <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">NumLit</span> <span class="tok-mi">5</span><span class="tok-p">))</span>
    <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">allValueExprTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">ValueExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">allValueExprTests</span> <span class="tok-ow">=</span> <span class="tok-n">concat</span> <span class="tok-p">[</span><span class="tok-n">basicTests</span>
                            <span class="tok-p">,</span><span class="tok-n">stringLiteralTests</span>
                            <span class="tok-p">,</span><span class="tok-n">dIdenTests</span>
                            <span class="tok-p">,</span><span class="tok-n">starTests</span>
                            <span class="tok-p">,</span><span class="tok-n">dStarTests</span>
                            <span class="tok-p">,</span><span class="tok-n">appTests</span>
                            <span class="tok-p">,</span><span class="tok-n">caseTests</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">singleSelectItemTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">singleSelectItemTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select 1&quot;</span><span class="tok-p">,</span> <span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]})]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">multipleSelectItemsTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">multipleSelectItemsTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select a&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]})</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;select a,b&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]})</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;select 1+2,3+4&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span>
                     <span class="tok-p">[(</span><span class="tok-kt">BinOp</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">1</span><span class="tok-p">)</span> <span class="tok-s">&quot;+&quot;</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">2</span><span class="tok-p">),</span><span class="tok-kt">Nothing</span><span class="tok-p">)</span>
                     <span class="tok-p">,(</span><span class="tok-kt">BinOp</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">3</span><span class="tok-p">)</span> <span class="tok-s">&quot;+&quot;</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">4</span><span class="tok-p">),</span><span class="tok-kt">Nothing</span><span class="tok-p">)]})</span>
    <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">selectListTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">selectListTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select a as a, b as b&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Just</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Just</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">)]})</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;select a a, b b&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Just</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Just</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">)]})</span>
    <span class="tok-p">]</span> <span class="tok-o">++</span> <span class="tok-n">multipleSelectItemsTests</span>
      <span class="tok-o">++</span> <span class="tok-n">singleSelectItemTests</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">fromTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">fromTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select a from t&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">]})]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">whereTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">whereTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select a from t where a = 5&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeWhere</span> <span class="tok-ow">=</span> <span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">BinOp</span> <span class="tok-p">(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;=&quot;</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">5</span><span class="tok-p">)})</span>
    <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">groupByTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">groupByTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select a,sum(b) from t group by a&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">App</span> <span class="tok-s">&quot;sum&quot;</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">],</span><span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeGroupBy</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">]</span>
                 <span class="tok-p">})</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;select a,b,sum(c) from t group by a,b&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">App</span> <span class="tok-s">&quot;sum&quot;</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;c&quot;</span><span class="tok-p">],</span><span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeGroupBy</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">]</span>
                 <span class="tok-p">})</span>
    <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">havingTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">havingTests</span> <span class="tok-ow">=</span>
  <span class="tok-p">[(</span><span class="tok-s">&quot;select a,sum(b) from t group by a having sum(b) &gt; 5&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)</span>
                                 <span class="tok-p">,(</span><span class="tok-kt">App</span> <span class="tok-s">&quot;sum&quot;</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">],</span><span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeGroupBy</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">]</span>
                 <span class="tok-p">,</span><span class="tok-n">qeHaving</span> <span class="tok-ow">=</span> <span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">BinOp</span> <span class="tok-p">(</span><span class="tok-kt">App</span> <span class="tok-s">&quot;sum&quot;</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">])</span> <span class="tok-s">&quot;&gt;&quot;</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-mi">5</span><span class="tok-p">)</span>
                 <span class="tok-p">})</span>
  <span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">orderByTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">orderByTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select a from t order by a&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">])</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t order by a, b&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">])</span>
    <span class="tok-p">]</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">ms</span> <span class="tok-n">o</span> <span class="tok-ow">=</span> <span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                      <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">]</span>
                      <span class="tok-p">,</span><span class="tok-n">qeOrderBy</span> <span class="tok-ow">=</span> <span class="tok-n">o</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">queryExprJoinTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">queryExprJoinTests</span> <span class="tok-ow">=</span>
    <span class="tok-p">[(</span><span class="tok-s">&quot;select a from t&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">])</span>
    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t,u&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">,</span> <span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t inner join u on expr&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinInner</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">)</span>
          <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">JoinOn</span> <span class="tok-o">$</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;expr&quot;</span><span class="tok-p">)])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t left join u on expr&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinLeft</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">)</span>
          <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">JoinOn</span> <span class="tok-o">$</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;expr&quot;</span><span class="tok-p">)])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t right join u on expr&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinRight</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">)</span>
          <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">JoinOn</span> <span class="tok-o">$</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;expr&quot;</span><span class="tok-p">)])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t full join u on expr&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinFull</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">)</span>
          <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">JoinOn</span> <span class="tok-o">$</span> <span class="tok-kt">Iden</span> <span class="tok-s">&quot;expr&quot;</span><span class="tok-p">)])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t cross join u&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinCross</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">)</span> <span class="tok-kt">Nothing</span><span class="tok-p">])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t natural inner join u&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinInner</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">)</span>
          <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-kt">JoinNatural</span><span class="tok-p">)])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t inner join u using(a,b)&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinInner</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">)</span>
          <span class="tok-p">(</span><span class="tok-kt">Just</span> <span class="tok-o">$</span> <span class="tok-kt">JoinUsing</span> <span class="tok-p">[</span><span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;b&quot;</span><span class="tok-p">])])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from (select a from t)&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRQueryExpr</span> <span class="tok-o">$</span> <span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">]])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t as u&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRAlias</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from t u&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRAlias</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">])</span>

    <span class="tok-p">,(</span><span class="tok-s">&quot;select a from (t cross join u) as u&quot;</span>
     <span class="tok-p">,</span><span class="tok-n">ms</span> <span class="tok-p">[</span><span class="tok-kt">TRAlias</span> <span class="tok-p">(</span><span class="tok-kt">TRParens</span> <span class="tok-o">$</span> <span class="tok-kt">TRJoin</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;t&quot;</span><span class="tok-p">)</span> <span class="tok-kt">JoinCross</span>
                                     <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">)</span> <span class="tok-kt">Nothing</span><span class="tok-p">)</span> <span class="tok-s">&quot;u&quot;</span><span class="tok-p">])</span>
    <span class="tok-p">]</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">ms</span> <span class="tok-n">f</span> <span class="tok-ow">=</span> <span class="tok-n">makeSelect</span> <span class="tok-p">{</span><span class="tok-n">qeSelectList</span> <span class="tok-ow">=</span> <span class="tok-p">[(</span><span class="tok-kt">Iden</span> <span class="tok-s">&quot;a&quot;</span><span class="tok-p">,</span><span class="tok-kt">Nothing</span><span class="tok-p">)]</span>
                      <span class="tok-p">,</span><span class="tok-n">qeFrom</span> <span class="tok-ow">=</span> <span class="tok-n">f</span><span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">allQueryExprTests</span> <span class="tok-ow">::</span> <span class="tok-p">[(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-kt">QueryExpr</span><span class="tok-p">)]</span>
<span class="tok-nf">allQueryExprTests</span> <span class="tok-ow">=</span> <span class="tok-n">concat</span> <span class="tok-p">[</span><span class="tok-n">selectListTests</span> <span class="tok-o">++</span> <span class="tok-n">fromTests</span> <span class="tok-o">++</span> <span class="tok-n">whereTests</span> <span class="tok-o">++</span> <span class="tok-n">groupByTests</span> <span class="tok-o">++</span> <span class="tok-n">havingTests</span> <span class="tok-o">++</span> <span class="tok-n">orderByTests</span> <span class="tok-o">++</span> <span class="tok-n">queryExprJoinTests</span><span class="tok-p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>todo: use external api parsing code</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">makeTest</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-kt">Show</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">=&gt;</span> <span class="tok-kt">Parser</span> <span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">H</span><span class="tok-o">.</span><span class="tok-kt">Test</span>
<span class="tok-nf">makeTest</span> <span class="tok-n">parser</span> <span class="tok-p">(</span><span class="tok-n">src</span><span class="tok-p">,</span><span class="tok-n">expected</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-kt">H</span><span class="tok-o">.</span><span class="tok-kt">TestLabel</span> <span class="tok-n">src</span> <span class="tok-o">$</span> <span class="tok-kt">H</span><span class="tok-o">.</span><span class="tok-kt">TestCase</span> <span class="tok-o">$</span> <span class="tok-kr">do</span>
    <span class="tok-kr">let</span> <span class="tok-n">gote</span> <span class="tok-ow">=</span> <span class="tok-n">parse</span> <span class="tok-p">(</span><span class="tok-n">whitespace</span> <span class="tok-o">*&gt;</span> <span class="tok-n">parser</span> <span class="tok-o">&lt;*</span> <span class="tok-n">eof</span><span class="tok-p">)</span> <span class="tok-s">&quot;&quot;</span> <span class="tok-n">src</span>
    <span class="tok-kr">case</span> <span class="tok-n">gote</span> <span class="tok-kr">of</span>
      <span class="tok-kt">Left</span> <span class="tok-n">e</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">H</span><span class="tok-o">.</span><span class="tok-n">assertFailure</span> <span class="tok-o">$</span> <span class="tok-n">show</span> <span class="tok-n">e</span>
      <span class="tok-kt">Right</span> <span class="tok-n">got</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">H</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span> <span class="tok-n">src</span> <span class="tok-n">expected</span> <span class="tok-n">got</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="pretty-printing">15. Pretty printing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here is a pretty printer for the parser version 0.</p>
</div>
<div class="paragraph">
<p>It uses Text.PrettyPrint module. I haven&#8217;t put much
comments/explanation here.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">module</span> <span class="tok-nn">PrettyPrinting0</span> <span class="tok-kr">where</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-kr">import</span> <span class="tok-nn">SimpleSQLQueryParser0</span> <span class="tok-p">(</span><span class="tok-kt">ValueExpr</span><span class="tok-p">(</span><span class="tok-o">..</span><span class="tok-p">),</span> <span class="tok-kt">QueryExpr</span><span class="tok-p">(</span><span class="tok-o">..</span><span class="tok-p">),</span> <span class="tok-kt">TableRef</span><span class="tok-p">(</span><span class="tok-o">..</span><span class="tok-p">)</span>
                             <span class="tok-p">,</span><span class="tok-kt">JoinType</span><span class="tok-p">(</span><span class="tok-o">..</span><span class="tok-p">),</span> <span class="tok-kt">JoinCondition</span><span class="tok-p">(</span><span class="tok-o">..</span><span class="tok-p">))</span>
<span class="tok-kr">import</span> <span class="tok-k">qualified</span> <span class="tok-nn">SimpleSQLQueryParser0</span> <span class="tok-k">as</span> <span class="tok-n">S</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.PrettyPrint</span> <span class="tok-p">(</span><span class="tok-nf">render</span><span class="tok-p">,</span> <span class="tok-nf">vcat</span><span class="tok-p">,</span> <span class="tok-nf">text</span><span class="tok-p">,</span> <span class="tok-p">(</span><span class="tok-o">&lt;&gt;</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;+&gt;</span><span class="tok-p">),</span> <span class="tok-nf">empty</span><span class="tok-p">,</span> <span class="tok-nf">parens</span><span class="tok-p">,</span>
                         <span class="tok-nf">nest</span><span class="tok-p">,</span> <span class="tok-kt">Doc</span><span class="tok-p">,</span> <span class="tok-nf">punctuate</span><span class="tok-p">,</span> <span class="tok-nf">comma</span><span class="tok-p">,</span> <span class="tok-nf">sep</span><span class="tok-p">,</span> <span class="tok-nf">quotes</span><span class="tok-p">,</span>
                         <span class="tok-nf">doubleQuotes</span><span class="tok-p">,</span> <span class="tok-nf">hsep</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Data.Maybe</span> <span class="tok-p">(</span><span class="tok-nf">maybeToList</span><span class="tok-p">,</span> <span class="tok-nf">catMaybes</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">FunctionsAndTypesForParsing</span>
<span class="tok-c1">--import Text.Parsec.String.Combinator (eof)</span>
<span class="tok-kr">import</span> <span class="tok-k">qualified</span> <span class="tok-nn">Test.HUnit</span> <span class="tok-k">as</span> <span class="tok-n">H</span>
<span class="tok-kr">import</span> <span class="tok-nn">Text.Parsec</span> <span class="tok-p">(</span><span class="tok-nf">parse</span><span class="tok-p">,</span> <span class="tok-kt">ParseError</span><span class="tok-p">)</span>
<span class="tok-kr">import</span> <span class="tok-nn">Control.Applicative</span> <span class="tok-p">((</span><span class="tok-o">&lt;$&gt;</span><span class="tok-p">),(</span><span class="tok-o">&lt;*</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">*&gt;</span><span class="tok-p">),(</span><span class="tok-o">&lt;*&gt;</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;$</span><span class="tok-p">),</span> <span class="tok-p">(</span><span class="tok-o">&lt;|&gt;</span><span class="tok-p">),</span> <span class="tok-nf">many</span><span class="tok-p">)</span>
<span class="tok-c1">--import Text.Parsec.String (Parser)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The basic concept in this pretty printer is we convert the ast into
<code>Doc</code> values, then convert these into a string. We have a bunch of
functions to convert <code>String</code> to `Doc`s, and combine these docs with
different layouts.</p>
</div>
<div class="paragraph">
<p>By using a pretty printer library, we can get human readable source
very easily compared with trying to convert directly to strings
ourselves.</p>
</div>
<div class="sect2">
<h3 id="_api">15.1. api</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">prettyQueryExpr</span> <span class="tok-ow">::</span> <span class="tok-kt">QueryExpr</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">String</span>
<span class="tok-nf">prettyQueryExpr</span> <span class="tok-ow">=</span> <span class="tok-n">render</span> <span class="tok-o">.</span> <span class="tok-n">queryExpr</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_value_expressions_2">15.2. value expressions</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">valueExpr</span> <span class="tok-ow">::</span> <span class="tok-kt">ValueExpr</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Doc</span>
<span class="tok-nf">valueExpr</span> <span class="tok-p">(</span><span class="tok-kt">StringLit</span> <span class="tok-n">s</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-n">quotes</span> <span class="tok-o">$</span> <span class="tok-n">text</span> <span class="tok-n">s</span>
<span class="tok-nf">valueExpr</span> <span class="tok-p">(</span><span class="tok-kt">NumLit</span> <span class="tok-n">i</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-n">text</span> <span class="tok-o">$</span> <span class="tok-n">show</span> <span class="tok-n">i</span>
<span class="tok-nf">valueExpr</span> <span class="tok-p">(</span><span class="tok-kt">Iden</span> <span class="tok-n">s</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-n">text</span> <span class="tok-n">s</span>
<span class="tok-nf">valueExpr</span> <span class="tok-p">(</span><span class="tok-kt">DIden</span> <span class="tok-n">q</span> <span class="tok-n">i</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-n">text</span> <span class="tok-n">q</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-n">text</span> <span class="tok-s">&quot;.&quot;</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-n">text</span> <span class="tok-n">i</span>
<span class="tok-nf">valueExpr</span> <span class="tok-kt">Star</span> <span class="tok-ow">=</span> <span class="tok-n">text</span> <span class="tok-s">&quot;*&quot;</span>
<span class="tok-nf">valueExpr</span> <span class="tok-p">(</span><span class="tok-kt">DStar</span> <span class="tok-n">q</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-n">text</span> <span class="tok-n">q</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-n">text</span> <span class="tok-s">&quot;.&quot;</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-n">text</span> <span class="tok-s">&quot;*&quot;</span>
<span class="tok-nf">valueExpr</span> <span class="tok-p">(</span><span class="tok-kt">App</span> <span class="tok-n">f</span> <span class="tok-n">es</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-n">text</span> <span class="tok-n">f</span> <span class="tok-o">&lt;&gt;</span> <span class="tok-n">parens</span> <span class="tok-p">(</span><span class="tok-n">commaSep</span> <span class="tok-o">$</span> <span class="tok-n">map</span> <span class="tok-n">valueExpr</span> <span class="tok-n">es</span><span class="tok-p">)</span>
<span class="tok-nf">valueExpr</span> <span class="tok-p">(</span><span class="tok-kt">PrefOp</span> <span class="tok-n">op</span> <span class="tok-n">e</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-n">sep</span><span class="tok-p">[</span><span class="tok-n">text</span> <span class="tok-n">op</span><span class="tok-p">,</span> <span class="tok-n">valueExpr</span> <span class="tok-n">e</span><span class="tok-p">]</span>
<span class="tok-nf">valueExpr</span> <span class="tok-p">(</span><span class="tok-kt">BinOp</span> <span class="tok-n">e0</span> <span class="tok-n">op</span> <span class="tok-n">e1</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-n">sep</span> <span class="tok-p">[</span><span class="tok-n">valueExpr</span> <span class="tok-n">e0</span><span class="tok-p">,</span> <span class="tok-n">text</span> <span class="tok-n">op</span><span class="tok-p">,</span> <span class="tok-n">valueExpr</span> <span class="tok-n">e1</span><span class="tok-p">]</span>
<span class="tok-nf">valueExpr</span> <span class="tok-p">(</span><span class="tok-kt">Case</span> <span class="tok-n">test</span> <span class="tok-n">whens</span> <span class="tok-n">els</span><span class="tok-p">)</span> <span class="tok-ow">=</span>
    <span class="tok-n">sep</span> <span class="tok-p">[</span><span class="tok-n">text</span> <span class="tok-s">&quot;case&quot;</span> <span class="tok-o">&lt;+&gt;</span> <span class="tok-n">maybe</span> <span class="tok-n">empty</span> <span class="tok-n">valueExpr</span> <span class="tok-n">test</span>
        <span class="tok-p">,</span><span class="tok-n">nest</span> <span class="tok-mi">5</span> <span class="tok-o">$</span> <span class="tok-n">sep</span> <span class="tok-p">(</span><span class="tok-n">map</span> <span class="tok-n">wh</span> <span class="tok-n">whens</span>
                       <span class="tok-o">++</span> <span class="tok-p">[</span><span class="tok-n">maybe</span> <span class="tok-n">empty</span>
                           <span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">e</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">text</span> <span class="tok-s">&quot;else&quot;</span> <span class="tok-o">&lt;+&gt;</span> <span class="tok-n">valueExpr</span> <span class="tok-n">e</span><span class="tok-p">)</span>
                           <span class="tok-n">els</span><span class="tok-p">])</span>
        <span class="tok-p">,</span><span class="tok-n">text</span> <span class="tok-s">&quot;end&quot;</span><span class="tok-p">]</span>
  <span class="tok-kr">where</span> <span class="tok-n">wh</span> <span class="tok-p">(</span><span class="tok-n">w</span><span class="tok-p">,</span><span class="tok-n">t</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-n">sep</span> <span class="tok-p">[</span><span class="tok-n">text</span> <span class="tok-s">&quot;when&quot;</span> <span class="tok-o">&lt;+&gt;</span> <span class="tok-n">valueExpr</span> <span class="tok-n">w</span>
                       <span class="tok-p">,</span><span class="tok-n">text</span> <span class="tok-s">&quot;then&quot;</span> <span class="tok-o">&lt;+&gt;</span> <span class="tok-n">valueExpr</span> <span class="tok-n">t</span><span class="tok-p">]</span>
<span class="tok-nf">valueExpr</span> <span class="tok-p">(</span><span class="tok-kt">Parens</span> <span class="tok-n">e</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-n">parens</span> <span class="tok-o">$</span> <span class="tok-n">valueExpr</span> <span class="tok-n">e</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_query_expressions_3">15.3. query expressions</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">queryExpr</span> <span class="tok-ow">::</span> <span class="tok-kt">QueryExpr</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Doc</span>
<span class="tok-nf">queryExpr</span> <span class="tok-p">(</span><span class="tok-kt">Select</span> <span class="tok-n">sl</span> <span class="tok-n">fr</span> <span class="tok-n">wh</span> <span class="tok-n">gb</span> <span class="tok-n">hv</span> <span class="tok-n">ob</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-n">sep</span>
    <span class="tok-p">[</span><span class="tok-n">text</span> <span class="tok-s">&quot;select&quot;</span> <span class="tok-o">&lt;+&gt;</span> <span class="tok-n">nest</span> <span class="tok-mi">7</span> <span class="tok-p">(</span><span class="tok-n">commaSep</span> <span class="tok-o">$</span> <span class="tok-n">map</span> <span class="tok-n">selectItem</span> <span class="tok-n">sl</span><span class="tok-p">)</span>
     <span class="tok-c1">-- from</span>
    <span class="tok-p">,</span><span class="tok-n">ml</span> <span class="tok-n">fr</span> <span class="tok-o">$</span> <span class="tok-nf">\</span><span class="tok-n">f</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">text</span> <span class="tok-s">&quot;from&quot;</span> <span class="tok-o">&lt;+&gt;</span> <span class="tok-n">nest</span> <span class="tok-mi">7</span> <span class="tok-p">(</span><span class="tok-n">commaSep</span> <span class="tok-o">$</span> <span class="tok-n">map</span> <span class="tok-n">tref</span> <span class="tok-n">f</span><span class="tok-p">)</span>
     <span class="tok-c1">-- where</span>
    <span class="tok-p">,</span><span class="tok-n">me</span> <span class="tok-n">wh</span> <span class="tok-o">$</span> <span class="tok-nf">\</span><span class="tok-n">w</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">text</span> <span class="tok-s">&quot;where&quot;</span> <span class="tok-o">&lt;+&gt;</span> <span class="tok-n">nest</span> <span class="tok-mi">6</span> <span class="tok-p">(</span><span class="tok-n">valueExpr</span> <span class="tok-n">w</span><span class="tok-p">)</span>
     <span class="tok-c1">-- group by</span>
    <span class="tok-p">,</span><span class="tok-n">ml</span> <span class="tok-n">gb</span> <span class="tok-o">$</span> <span class="tok-nf">\</span><span class="tok-n">g</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">text</span> <span class="tok-s">&quot;group by&quot;</span> <span class="tok-o">&lt;+&gt;</span> <span class="tok-n">nest</span> <span class="tok-mi">9</span> <span class="tok-p">(</span><span class="tok-n">commaSep</span> <span class="tok-o">$</span> <span class="tok-n">map</span> <span class="tok-n">valueExpr</span> <span class="tok-n">g</span><span class="tok-p">)</span>
     <span class="tok-c1">-- having</span>
    <span class="tok-p">,</span><span class="tok-n">me</span> <span class="tok-n">hv</span> <span class="tok-o">$</span> <span class="tok-nf">\</span><span class="tok-n">h</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">text</span> <span class="tok-s">&quot;having&quot;</span> <span class="tok-o">&lt;+&gt;</span> <span class="tok-n">nest</span> <span class="tok-mi">6</span> <span class="tok-p">(</span><span class="tok-n">valueExpr</span> <span class="tok-n">h</span><span class="tok-p">)</span>
     <span class="tok-c1">-- order by</span>
    <span class="tok-p">,</span><span class="tok-n">ml</span> <span class="tok-n">ob</span> <span class="tok-o">$</span> <span class="tok-nf">\</span><span class="tok-n">o</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">text</span> <span class="tok-s">&quot;order by&quot;</span> <span class="tok-o">&lt;+&gt;</span> <span class="tok-n">nest</span> <span class="tok-mi">9</span> <span class="tok-p">(</span><span class="tok-n">commaSep</span> <span class="tok-o">$</span> <span class="tok-n">map</span> <span class="tok-n">valueExpr</span> <span class="tok-n">o</span><span class="tok-p">)</span>
    <span class="tok-p">]</span>
  <span class="tok-kr">where</span>
    <span class="tok-n">selectItem</span> <span class="tok-p">(</span><span class="tok-n">e</span><span class="tok-p">,</span><span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-n">valueExpr</span> <span class="tok-n">e</span> <span class="tok-o">&lt;+&gt;</span> <span class="tok-n">me</span> <span class="tok-n">a</span> <span class="tok-p">(</span><span class="tok-nf">\</span><span class="tok-n">a&#39;</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">text</span> <span class="tok-s">&quot;as&quot;</span> <span class="tok-o">&lt;+&gt;</span> <span class="tok-n">text</span> <span class="tok-n">a&#39;</span><span class="tok-p">)</span>

    <span class="tok-n">tref</span> <span class="tok-p">(</span><span class="tok-kt">TRSimple</span> <span class="tok-n">t</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-n">text</span> <span class="tok-n">t</span>
    <span class="tok-n">tref</span> <span class="tok-p">(</span><span class="tok-kt">TRParens</span> <span class="tok-n">t</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-n">parens</span> <span class="tok-o">$</span> <span class="tok-n">tref</span> <span class="tok-n">t</span>
    <span class="tok-n">tref</span> <span class="tok-p">(</span><span class="tok-kt">TRAlias</span> <span class="tok-n">t</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-n">tref</span> <span class="tok-n">t</span> <span class="tok-o">&lt;+&gt;</span> <span class="tok-n">text</span> <span class="tok-s">&quot;as&quot;</span> <span class="tok-o">&lt;+&gt;</span> <span class="tok-n">text</span> <span class="tok-n">a</span>
    <span class="tok-n">tref</span> <span class="tok-p">(</span><span class="tok-kt">TRQueryExpr</span> <span class="tok-n">q</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-n">parens</span> <span class="tok-o">$</span> <span class="tok-n">queryExpr</span> <span class="tok-n">q</span>
    <span class="tok-n">tref</span> <span class="tok-p">(</span><span class="tok-kt">TRJoin</span> <span class="tok-n">t0</span> <span class="tok-n">jt</span> <span class="tok-n">t1</span> <span class="tok-n">jc</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-n">sep</span>
        <span class="tok-p">[</span><span class="tok-n">tref</span> <span class="tok-n">t0</span>
        <span class="tok-p">,</span><span class="tok-n">joinName</span> <span class="tok-n">jt</span> <span class="tok-n">jc</span> <span class="tok-o">&lt;+&gt;</span> <span class="tok-n">tref</span> <span class="tok-n">t1</span>
        <span class="tok-p">,</span><span class="tok-kr">case</span> <span class="tok-n">jc</span> <span class="tok-kr">of</span>
             <span class="tok-kt">Just</span> <span class="tok-p">(</span><span class="tok-kt">JoinOn</span> <span class="tok-n">e</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">text</span> <span class="tok-s">&quot;on&quot;</span> <span class="tok-o">&lt;+&gt;</span> <span class="tok-n">valueExpr</span> <span class="tok-n">e</span>
             <span class="tok-kt">Just</span> <span class="tok-p">(</span><span class="tok-kt">JoinUsing</span> <span class="tok-n">is</span><span class="tok-p">)</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">text</span> <span class="tok-s">&quot;using&quot;</span> <span class="tok-o">&lt;+&gt;</span> <span class="tok-n">parens</span> <span class="tok-p">(</span><span class="tok-n">commaSep</span> <span class="tok-o">$</span> <span class="tok-n">map</span> <span class="tok-n">text</span> <span class="tok-n">is</span><span class="tok-p">)</span>
             <span class="tok-kt">Just</span> <span class="tok-kt">JoinNatural</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">empty</span>
             <span class="tok-kt">Nothing</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">empty</span><span class="tok-p">]</span>
    <span class="tok-n">joinName</span> <span class="tok-n">jt</span> <span class="tok-n">jc</span> <span class="tok-ow">=</span>
      <span class="tok-n">hsep</span> <span class="tok-p">[</span><span class="tok-kr">case</span> <span class="tok-n">jc</span> <span class="tok-kr">of</span>
               <span class="tok-kt">Just</span> <span class="tok-kt">JoinNatural</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">text</span> <span class="tok-s">&quot;natural&quot;</span>
               <span class="tok-kr">_</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">empty</span>
           <span class="tok-p">,</span><span class="tok-kr">case</span> <span class="tok-n">jt</span> <span class="tok-kr">of</span>
               <span class="tok-kt">JoinInner</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">text</span> <span class="tok-s">&quot;inner join&quot;</span>
               <span class="tok-kt">JoinCross</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">text</span> <span class="tok-s">&quot;cross join&quot;</span>
               <span class="tok-kt">JoinLeft</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">text</span> <span class="tok-s">&quot;left join&quot;</span>
               <span class="tok-kt">JoinRight</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">text</span> <span class="tok-s">&quot;right join&quot;</span>
               <span class="tok-kt">JoinFull</span> <span class="tok-ow">-&gt;</span> <span class="tok-n">text</span> <span class="tok-s">&quot;full join&quot;</span><span class="tok-p">]</span>
    <span class="tok-n">me</span> <span class="tok-n">e</span> <span class="tok-n">r</span> <span class="tok-ow">=</span> <span class="tok-n">maybe</span> <span class="tok-n">empty</span> <span class="tok-n">r</span> <span class="tok-n">e</span>
    <span class="tok-n">ml</span> <span class="tok-kt">[]</span> <span class="tok-kr">_</span> <span class="tok-ow">=</span> <span class="tok-n">empty</span>
    <span class="tok-n">ml</span> <span class="tok-n">l</span> <span class="tok-n">r</span> <span class="tok-ow">=</span> <span class="tok-n">r</span> <span class="tok-n">l</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_helpers">15.4. helpers</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">commaSep</span> <span class="tok-ow">::</span> <span class="tok-p">[</span><span class="tok-kt">Doc</span><span class="tok-p">]</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Doc</span>
<span class="tok-nf">commaSep</span> <span class="tok-ow">=</span> <span class="tok-n">sep</span> <span class="tok-o">.</span> <span class="tok-n">punctuate</span> <span class="tok-n">comma</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Have a look at the haddock for this module and see if you can work out
how the code above works.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*PrettyPrinting0&gt; either (error . show) valueExpr (parseWithEof (S.valueExpr []) "a and b")
a and b

*PrettyPrinting0&gt; either (error . show) queryExpr (parseWithEof S.queryExpr "select a from t inner join u using(a,b)")
select a from t inner join u using (a, b)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tests_2">15.5. tests</h3>
<div class="paragraph">
<p>Now we can do some tests: we take the previous test data, and for each
test add an additional test which pretty prints then parses the
results to see that it is unchanged.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="haskell"><span class="tok-nf">makeTest</span> <span class="tok-ow">::</span> <span class="tok-p">(</span><span class="tok-kt">Eq</span> <span class="tok-n">a</span><span class="tok-p">,</span> <span class="tok-kt">Show</span> <span class="tok-n">a</span><span class="tok-p">)</span> <span class="tok-ow">=&gt;</span>
            <span class="tok-p">(</span><span class="tok-kt">String</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">Either</span> <span class="tok-kt">ParseError</span> <span class="tok-n">a</span><span class="tok-p">)</span>
         <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-n">a</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">String</span><span class="tok-p">)</span>
         <span class="tok-ow">-&gt;</span> <span class="tok-p">(</span><span class="tok-kt">String</span><span class="tok-p">,</span><span class="tok-n">a</span><span class="tok-p">)</span>
         <span class="tok-ow">-&gt;</span> <span class="tok-kt">H</span><span class="tok-o">.</span><span class="tok-kt">Test</span>
<span class="tok-nf">makeTest</span> <span class="tok-n">parser</span> <span class="tok-n">pretty</span> <span class="tok-p">(</span><span class="tok-n">src</span><span class="tok-p">,</span><span class="tok-n">expected</span><span class="tok-p">)</span> <span class="tok-ow">=</span> <span class="tok-kt">H</span><span class="tok-o">.</span><span class="tok-kt">TestLabel</span> <span class="tok-n">src</span> <span class="tok-o">$</span> <span class="tok-kt">H</span><span class="tok-o">.</span><span class="tok-kt">TestCase</span> <span class="tok-o">$</span> <span class="tok-kr">do</span>
    <span class="tok-kr">let</span> <span class="tok-n">gote</span> <span class="tok-ow">=</span> <span class="tok-n">parser</span> <span class="tok-n">src</span>
    <span class="tok-kr">case</span> <span class="tok-n">gote</span> <span class="tok-kr">of</span>
      <span class="tok-kt">Left</span> <span class="tok-n">e</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">H</span><span class="tok-o">.</span><span class="tok-n">assertFailure</span> <span class="tok-o">$</span> <span class="tok-n">show</span> <span class="tok-n">e</span>
      <span class="tok-kt">Right</span> <span class="tok-n">got</span> <span class="tok-ow">-&gt;</span> <span class="tok-kr">do</span>
        <span class="tok-kt">H</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span> <span class="tok-n">src</span> <span class="tok-n">expected</span> <span class="tok-n">got</span>
        <span class="tok-kr">let</span> <span class="tok-n">prsql</span> <span class="tok-ow">=</span> <span class="tok-n">pretty</span> <span class="tok-n">got</span>
            <span class="tok-n">gotpretty</span> <span class="tok-ow">=</span> <span class="tok-n">parser</span> <span class="tok-n">prsql</span>
        <span class="tok-kr">case</span> <span class="tok-n">gotpretty</span> <span class="tok-kr">of</span>
          <span class="tok-kt">Left</span> <span class="tok-n">e</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">H</span><span class="tok-o">.</span><span class="tok-n">assertFailure</span> <span class="tok-o">$</span> <span class="tok-s">&quot;pretty: &quot;</span> <span class="tok-o">++</span> <span class="tok-n">prsql</span> <span class="tok-o">++</span> <span class="tok-s">&quot;</span><span class="tok-se">\n</span><span class="tok-s">&quot;</span> <span class="tok-o">++</span> <span class="tok-n">show</span> <span class="tok-n">e</span>
          <span class="tok-kt">Right</span> <span class="tok-n">gotp</span> <span class="tok-ow">-&gt;</span> <span class="tok-kt">H</span><span class="tok-o">.</span><span class="tok-n">assertEqual</span> <span class="tok-p">(</span><span class="tok-s">&quot;pretty: &quot;</span> <span class="tok-o">++</span> <span class="tok-n">prsql</span><span class="tok-p">)</span> <span class="tok-n">expected</span> <span class="tok-n">gotp</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO: fix parsing issue</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>*PrettyPrinting0&gt; H.runTestTT $ H.TestList $ map (makeTest S.parseQueryExpr (render . queryExpr)) S.allQueryExprTests
Cases: 26  Tried: 26  Errors: 0  Failures: 0
Counts {cases = 26, tried = 26, errors = 0, failures = 0}
*PrettyPrinting0&gt; H.runTestTT $ H.TestList $ map (makeTest S.parseValueExpr (render . valueExpr)) S.allValueExprTests
 ### Failure in: 34:case when a=1 then 2 when a=3 then 4 else 5 end
(line 1, column 11):
unexpected "a"
expecting "--" or "/*"
Cases: 35  Tried: 35  Errors: 0  Failures: 1
Counts {cases = 35, tried = 35, errors = 0, failures = 1}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="error-messages">16. Error messages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this tutorial, we will start looking at the error messages
generated by Parsec and how we can influence to improve them.</p>
</div>
<div class="paragraph">
<p>TODO:</p>
</div>
<div class="paragraph">
<p>review the different methods of generating failure in parsec and what
they look like, including choice.</p>
</div>
<div class="paragraph">
<p>examine how rearranging parsers can change the error messages,
committing to a parsing branch to improve the messages</p>
</div>
<div class="paragraph">
<p>also possibly look at adding additional parsing to detect common
errors to provide a nicer error messages</p>
</div>
<div class="paragraph">
<p>maybe talk about the idea of being permissive in the parsing proper
stage, then doing additional syntax-type checks on the ast after</p>
</div>
<div class="sect2">
<h3 id="_ways_of_generating_errors_in_parsec">16.1. ways of generating errors in parsec</h3>

</div>
<div class="sect2">
<h3 id="_how_parsec_combines_errors_or_drops_them_into_the_void">16.2. how parsec combines errors or drops them into the void</h3>

</div>
<div class="sect2">
<h3 id="_parsing_tpch">16.3. Parsing tpch</h3>
<div class="paragraph">
<p>Let&#8217;s try the parser out on the TPC-H queries.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code></code></pre>
</div>
</div>
<div class="paragraph">
<p>Summary of errors so far:
q1: typed literal: type_name 'literal value'
q2: scalar subquery
q3: typed literal
q4: typed literal
q5: typed literal
q6: typed literal
q7: ??
q8: extract??
q9: extract ??
q10: typed literal
q11: scalar sub query
q12: ??
q13: not like??
q14: decimal literal
q15: cte
q16: count distinct
q17: decimal literal
q18: in subquery
q19: in literal list
q20: in subquery
q21: exists subquery
q22: substring</p>
</div>
<div class="paragraph">
<p>TODO: try to figure out each issue. Not very easy: the error messages
are not very good.</p>
</div>
<div class="paragraph">
<p>Do some ad hoc stuff to try to improve each error message? Keep
simplifying expressions then try to understand specific principles.
Then make some generalizations that can be made across the parser</p>
</div>
</div>
<div class="sect2">
<h3 id="_value_expressions_in_isolation">16.4. value expressions in isolation</h3>
<div class="paragraph">
<p>We can start with the real error code now by considering the
valueexpression parser in isolation.</p>
</div>
<div class="paragraph">
<p>ideas:
error inside function parameter list
bad identifier
unrecognised operator
unrecognised chars
unmatching parens
keyword errors in case
unterminated string lit
3 dot components
binary op with missing second arg
associativity errors with binary ops?
blacklist errors</p>
</div>
</div>
<div class="sect2">
<h3 id="_query_expressions_4">16.5. query expressions</h3>
<div class="paragraph">
<p>mispelling keywords at this level
clauses in wrong order
adding extra tokens or removing them at clause/value expression
boundaries</p>
</div>
</div>
<div class="sect2">
<h3 id="_summarizing">16.6. summarizing?</h3>

</div>
<div class="sect2">
<h3 id="_updated_parsing_code_with_improved_error_message_behaviour">16.7. updated parsing code with improved error message behaviour</h3>

</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-08-15 18:08:54 IDT
</div>
</div>
</body>
</html>
