<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Database/HsSqlPpp/Internals/TypeChecking/Environment.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>


This module represents part of the bound names environment used in the
type checker. It doesn't cover the stuff that is contained in the
catalog (so it is slightly misnamed), but focuses only on identifiers
introduced by things like tablerefs, sub selects, plpgsql parameters
and variables, etc.

<pre><a name="line-1"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>{-# LANGUAGE DeriveDataTypeable,TupleSections,ScopedTypeVariables,OverloadedStrings #-}</span>
<a name="line-2"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>module</span> <span class='hs-conid'>Database</span><span class='hs-varop'>.</span><span class='hs-conid'>HsSqlPpp</span><span class='hs-varop'>.</span><span class='hs-conid'>Internals</span><span class='hs-varop'>.</span><span class='hs-conid'>TypeChecking</span><span class='hs-varop'>.</span><span class='hs-conid'>Environment</span>
<a name="line-3"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>(</span><span class='hs-comment'>-- * abstract environment value</span>
<a name="line-4"></a><span class='hs-varop'>&gt;</span>      <span class='hs-conid'>Environment</span>
<a name="line-5"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-conid'>JoinType</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-varop'>&gt;</span>      <span class='hs-comment'>-- * environment create and update functions</span>
<a name="line-7"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>emptyEnvironment</span>
<a name="line-8"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>isEmptyEnv</span>
<a name="line-9"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>envCreateTrefEnvironment</span>
<a name="line-10"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>createJoinTrefEnvironment</span>
<a name="line-11"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>envSelectListEnvironment</span>
<a name="line-12"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>createCorrelatedSubqueryEnvironment</span>
<a name="line-13"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>createTrefAliasedEnvironment</span>
<a name="line-14"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>brokeEnvironment</span>
<a name="line-15"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>orderByEnvironment</span>
<a name="line-16"></a><span class='hs-varop'>&gt;</span>      <span class='hs-comment'>-- * environment query functions</span>
<a name="line-17"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>envLookupIdentifier</span>
<a name="line-18"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>envExpandStar</span>
<a name="line-19"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
</pre>
<pre><a name="line-20"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span>
<a name="line-21"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Char</span>
<a name="line-22"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import Data.Maybe</span>
<a name="line-23"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-24"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Arrow</span>
<a name="line-25"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-26"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import Debug.Trace</span>
<a name="line-27"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import Text.Show.Pretty</span>
</pre>
<pre><a name="line-28"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Database</span><span class='hs-varop'>.</span><span class='hs-conid'>HsSqlPpp</span><span class='hs-varop'>.</span><span class='hs-conid'>Internals</span><span class='hs-varop'>.</span><span class='hs-conid'>TypesInternal</span>
<a name="line-29"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Database</span><span class='hs-varop'>.</span><span class='hs-conid'>HsSqlPpp</span><span class='hs-varop'>.</span><span class='hs-conid'>Internals</span><span class='hs-varop'>.</span><span class='hs-conid'>TypeChecking</span><span class='hs-varop'>.</span><span class='hs-conid'>TypeConversion</span><span class='hs-varop'>.</span><span class='hs-conid'>TypeConversion</span>
<a name="line-30"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Database</span><span class='hs-varop'>.</span><span class='hs-conid'>HsSqlPpp</span><span class='hs-varop'>.</span><span class='hs-conid'>Internals</span><span class='hs-varop'>.</span><span class='hs-conid'>Catalog</span><span class='hs-varop'>.</span><span class='hs-conid'>CatalogInternal</span>
<a name="line-31"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Database</span><span class='hs-varop'>.</span><span class='hs-conid'>HsSqlPpp</span><span class='hs-varop'>.</span><span class='hs-conid'>Internals</span><span class='hs-varop'>.</span><span class='hs-conid'>Catalog</span><span class='hs-varop'>.</span><span class='hs-conid'>CatalogTypes</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncStr</span><span class='hs-layout'>)</span>
<a name="line-32"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Generics</span><span class='hs-varop'>.</span><span class='hs-conid'>Uniplate</span><span class='hs-varop'>.</span><span class='hs-conid'>Data</span>
<a name="line-33"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span> <span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>)</span>
<a name="line-34"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>T</span>
</pre>
---------------------------------

Alex:
  Not sure that handling of USING joins (and specifically of join keys) is correct, but
    don't know, have to investigate all the connections in the code.
  One problem is that types for the purpose of comparison are different from the output types.
  Moreover, major DBs are imprecise in their definitions of USING joins.
    For instance, what Postgre writes about output columns seems to be related only to the
      star expansion. I still can explicitly reference a key column from the inner table
      in the output expression, with the use of table name or alias. Or can I not?
    Have to look at ANSI.
  More precisely, we have:
    1. Type check join keys to see that they are compatible.
    2. If needed, create additional columns that would exist for the purpose of comparison
        only. The scalar expressions that create them are casts from join keys.
    3. If a join key is used in an output scalar expression, the original' key type is used.
  For a qualified column reference, including qualified star expansion, original' type
    is same as original type, except that it is possibly cast to nullable for an inner table
    of an outer join.
  For star expansion:
    The original' type is defined strictly for LeftOuter and RightOuter.
    It is unclear what to do in case of Inner and FullOuter if the types differ (but, as we
      already know, are compatible).
    There are two choices:
      1. Reject the query.
      2. Resolve the types and return the result type.
  For now, I'll do the 2nd thing, let's see what happens.
    And I don't implement the rest of this plan either, of course:
      - I convert things to nullable for outer joins, but don't separate between
        condition columns and output columns, of course;
      - For Right Outer Joins, I reverse the order of input environments in listBindingsTypes,
        for the purpose of getting the key types.
    And now I see that TypeExtra's in join ids are not actually used.

<pre><a name="line-35"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- | Represent an environment using an abstracted version of the syntax</span>
<a name="line-36"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- which produced the environment. This structure has all the catalog</span>
<a name="line-37"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- queries resolved. No attempt is made to combine environment parts from</span>
<a name="line-38"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- different sources, they are just stacked together, the logic for</span>
<a name="line-39"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- working with combined environments is in the query functions below</span>
<a name="line-40"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>data</span> <span class='hs-conid'>Environment</span> <span class='hs-keyglyph'>=</span>
<a name="line-41"></a><span class='hs-varop'>&gt;</span>                  <span class='hs-comment'>-- | represents an empty environment, makes e.g. joining</span>
<a name="line-42"></a><span class='hs-varop'>&gt;</span>                  <span class='hs-comment'>-- the environments for a list of trefs in a select list</span>
<a name="line-43"></a><span class='hs-varop'>&gt;</span>                  <span class='hs-comment'>-- more straightforward</span>
<a name="line-44"></a><span class='hs-varop'>&gt;</span>                    <span class='hs-conid'>EmptyEnvironment</span>
<a name="line-45"></a><span class='hs-varop'>&gt;</span>                  <span class='hs-comment'>-- | represents the bindings introduced by a tableref:</span>
<a name="line-46"></a><span class='hs-varop'>&gt;</span>                  <span class='hs-comment'>-- the name, the public fields, the private fields</span>
<a name="line-47"></a><span class='hs-varop'>&gt;</span>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SimpleTref</span> <span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span><span class='hs-conid'>Text</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span><span class='hs-conid'>TypeExtra</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span><span class='hs-conid'>TypeExtra</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-48"></a><span class='hs-varop'>&gt;</span>                  <span class='hs-comment'>-- | environment from joining two tables</span>
<a name="line-49"></a><span class='hs-varop'>&gt;</span>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>JoinTref</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span><span class='hs-conid'>TypeExtra</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- join ids</span>
<a name="line-50"></a><span class='hs-varop'>&gt;</span>                             <span class='hs-conid'>JoinType</span>  <span class='hs-comment'>-- added because outer join makes some things nullabie</span>
<a name="line-51"></a><span class='hs-varop'>&gt;</span>                             <span class='hs-conid'>Environment</span> <span class='hs-conid'>Environment</span>
<a name="line-52"></a><span class='hs-varop'>&gt;</span>                  <span class='hs-comment'>-- | environment from a sub select</span>
<a name="line-53"></a><span class='hs-varop'>&gt;</span>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SelectListEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span><span class='hs-conid'>TypeExtra</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-54"></a><span class='hs-varop'>&gt;</span>                    <span class='hs-comment'>-- | correlated subquery environment</span>
<a name="line-55"></a><span class='hs-varop'>&gt;</span>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CSQEnv</span> <span class='hs-conid'>Environment</span> <span class='hs-comment'>-- outerenv</span>
<a name="line-56"></a><span class='hs-varop'>&gt;</span>                           <span class='hs-conid'>Environment</span> <span class='hs-comment'>-- main env</span>
<a name="line-57"></a><span class='hs-varop'>&gt;</span>                    <span class='hs-comment'>-- | an aliased tref</span>
<a name="line-58"></a><span class='hs-varop'>&gt;</span>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TrefAlias</span> <span class='hs-conid'>Text</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Text</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-conid'>Environment</span>
<a name="line-59"></a><span class='hs-varop'>&gt;</span>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BrokeEnvironment</span>
<a name="line-60"></a><span class='hs-varop'>&gt;</span>                    <span class='hs-comment'>-- order by: can use the name of a select list column</span>
<a name="line-61"></a><span class='hs-varop'>&gt;</span>                    <span class='hs-comment'>-- or anything from the same environment which select</span>
<a name="line-62"></a><span class='hs-varop'>&gt;</span>                    <span class='hs-comment'>-- list operates on</span>
<a name="line-63"></a><span class='hs-varop'>&gt;</span>                  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OrderByEnvironment</span> <span class='hs-conid'>Environment</span> <span class='hs-conid'>Environment</span>
<a name="line-64"></a><span class='hs-varop'>&gt;</span>                    <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>,</span><span class='hs-conid'>Show</span><span class='hs-layout'>,</span><span class='hs-conid'>Eq</span><span class='hs-layout'>)</span>
<a name="line-65"></a><span class='hs-varop'>&gt;</span>
<a name="line-66"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>data</span> <span class='hs-conid'>JoinType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Inner</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LeftOuter</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RightOuter</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FullOuter</span>
<a name="line-67"></a><span class='hs-varop'>&gt;</span>                    <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Data</span><span class='hs-layout'>,</span><span class='hs-conid'>Typeable</span><span class='hs-layout'>,</span><span class='hs-conid'>Show</span><span class='hs-layout'>,</span><span class='hs-conid'>Eq</span><span class='hs-layout'>)</span>
</pre>
---------------------------------------------------

Create/ update functions, these are shortcuts to create environment variables,
the main purpose is to encapsulate looking up information in the
catalog and combining environment values with updates

TODO: remove the create prefixes

<pre><a name="line-68"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>emptyEnvironment</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Environment</span>
<a name="line-69"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>emptyEnvironment</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EmptyEnvironment</span>
</pre>
<pre><a name="line-70"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>isEmptyEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Environment</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-71"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>isEmptyEnv</span> <span class='hs-conid'>EmptyEnvironment</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-72"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>isEmptyEnv</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
</pre>
<pre><a name="line-73"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>envCreateTrefEnvironment</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Catalog</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NameComponent</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TypeError</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>Environment</span>
<a name="line-74"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>envCreateTrefEnvironment</span> <span class='hs-varid'>cat</span> <span class='hs-varid'>tbnm</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-75"></a><span class='hs-varop'>&gt;</span>   <span class='hs-layout'>(</span><span class='hs-varid'>nm</span><span class='hs-layout'>,</span><span class='hs-varid'>pub</span><span class='hs-layout'>,</span><span class='hs-varid'>prv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>catLookupTableAndAttrs</span> <span class='hs-varid'>cat</span> <span class='hs-varid'>tbnm</span>
<a name="line-76"></a><span class='hs-varop'>&gt;</span>   <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>SimpleTref</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>pub</span> <span class='hs-layout'>(</span><span class='hs-varid'>second</span> <span class='hs-varid'>mkTypeExtraNN</span> <span class='hs-varop'>`map`</span> <span class='hs-varid'>prv</span><span class='hs-layout'>)</span>
</pre>
<pre><a name="line-77"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>envSelectListEnvironment</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span><span class='hs-conid'>TypeExtra</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TypeError</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>Environment</span>
<a name="line-78"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>envSelectListEnvironment</span> <span class='hs-varid'>cols</span> <span class='hs-keyglyph'>=</span>
<a name="line-79"></a><span class='hs-varop'>&gt;</span>   <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>SelectListEnv</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>first</span> <span class='hs-varop'>$</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>map</span> <span class='hs-varid'>toLower</span><span class='hs-layout'>)</span> <span class='hs-varid'>cols</span>
</pre>

<pre><a name="line-80"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- | create an environment as two envs joined together</span>
<a name="line-81"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>createJoinTrefEnvironment</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Catalog</span>
<a name="line-82"></a><span class='hs-varop'>&gt;</span>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Environment</span>
<a name="line-83"></a><span class='hs-varop'>&gt;</span>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Environment</span>
<a name="line-84"></a><span class='hs-varop'>&gt;</span>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JoinType</span>
<a name="line-85"></a><span class='hs-varop'>&gt;</span>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NameComponent</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- join ids: empty if cross join</span>
<a name="line-86"></a><span class='hs-varop'>&gt;</span>                                                    <span class='hs-comment'>-- nothing for natural join</span>
<a name="line-87"></a><span class='hs-varop'>&gt;</span>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TypeError</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>Environment</span>
<a name="line-88"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>createJoinTrefEnvironment</span> <span class='hs-varid'>cat</span> <span class='hs-varid'>tref0</span> <span class='hs-varid'>tref1</span> <span class='hs-varid'>jt</span> <span class='hs-varid'>jsc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-89"></a><span class='hs-varop'>&gt;</span>   <span class='hs-comment'>-- todo: handle natural join case</span>
<a name="line-90"></a><span class='hs-varop'>&gt;</span>   <span class='hs-layout'>(</span><span class='hs-varid'>jids</span><span class='hs-keyglyph'>::</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Text</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>jsc</span> <span class='hs-keyword'>of</span>
<a name="line-91"></a><span class='hs-varop'>&gt;</span>             <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-92"></a><span class='hs-varop'>&gt;</span>                        <span class='hs-varid'>j0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>snd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>envExpandStar</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>tref0</span>
<a name="line-93"></a><span class='hs-varop'>&gt;</span>                        <span class='hs-varid'>j1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>snd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>envExpandStar</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>tref1</span>
<a name="line-94"></a><span class='hs-varop'>&gt;</span>                        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>j0</span> <span class='hs-varop'>`intersect`</span> <span class='hs-varid'>j1</span>
<a name="line-95"></a><span class='hs-varop'>&gt;</span>             <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>nmcString</span> <span class='hs-varid'>x</span>
</pre>
<pre><a name="line-96"></a><span class='hs-varop'>&gt;</span>  <span class='hs-comment'>--         maybe (error "natural join ids") (map (nnm . (:[]))) jsc</span>
</pre>
<pre><a name="line-97"></a><span class='hs-varop'>&gt;</span>   <span class='hs-varid'>jts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>forM</span> <span class='hs-varid'>jids</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-98"></a><span class='hs-varop'>&gt;</span>            <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>t0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>envLookupIdentifier</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>QNmc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>unpack</span> <span class='hs-varid'>i</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>tref0</span>
<a name="line-99"></a><span class='hs-varop'>&gt;</span>            <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>envLookupIdentifier</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>QNmc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>unpack</span> <span class='hs-varid'>i</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>tref1</span>
<a name="line-100"></a><span class='hs-varop'>&gt;</span>            <span class='hs-keyword'>let</span>  <span class='hs-varid'>adjustTypeExtra</span> <span class='hs-varid'>te</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>jt</span> <span class='hs-keyword'>of</span>
<a name="line-101"></a><span class='hs-varop'>&gt;</span>                     <span class='hs-conid'>Inner</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>te</span>
<a name="line-102"></a><span class='hs-varop'>&gt;</span>                     <span class='hs-conid'>LeftOuter</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>t0</span>
<a name="line-103"></a><span class='hs-varop'>&gt;</span>                     <span class='hs-conid'>RightOuter</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>t1</span>
<a name="line-104"></a><span class='hs-varop'>&gt;</span>                     <span class='hs-conid'>FullOuter</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkNullable</span> <span class='hs-varid'>te</span>
<a name="line-105"></a><span class='hs-varop'>&gt;</span>            <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>adjustTypeExtra</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>resolveResultSetTypeExtra</span> <span class='hs-varid'>cat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t0</span><span class='hs-layout'>,</span><span class='hs-varid'>t1</span><span class='hs-keyglyph'>]</span>
<a name="line-106"></a><span class='hs-varop'>&gt;</span>            <span class='hs-comment'>-- ImplicitCastToDo: remove or restore</span>
<a name="line-107"></a><span class='hs-varop'>&gt;</span>            <span class='hs-comment'>--fmap (i,) $ resolveResultSetTypeExtra cat [t0,t1]</span>
<a name="line-108"></a><span class='hs-varop'>&gt;</span>   <span class='hs-comment'>-- todo: check type compatibility</span>
<a name="line-109"></a><span class='hs-varop'>&gt;</span>   <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>JoinTref</span> <span class='hs-varid'>jts</span> <span class='hs-varid'>jt</span> <span class='hs-varid'>tref0</span> <span class='hs-varid'>tref1</span>
</pre>
<pre><a name="line-110"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>createCorrelatedSubqueryEnvironment</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Environment</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Environment</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Environment</span>
<a name="line-111"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>createCorrelatedSubqueryEnvironment</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CSQEnv</span>
</pre>
<pre><a name="line-112"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>createTrefAliasedEnvironment</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Text</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Text</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Environment</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Environment</span>
<a name="line-113"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>createTrefAliasedEnvironment</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TrefAlias</span>
</pre>
<pre><a name="line-114"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- | represents type check failure upstream, don't produce additional</span>
<a name="line-115"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- type check errors</span>
<a name="line-116"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>brokeEnvironment</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Environment</span>
<a name="line-117"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>brokeEnvironment</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BrokeEnvironment</span>
</pre>
<pre><a name="line-118"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>isBroken</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Environment</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-119"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>isBroken</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>null</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>()</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BrokeEnvironment</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>universeBi</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>]</span>
</pre>
<pre><a name="line-120"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>orderByEnvironment</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Environment</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Environment</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Environment</span>
<a name="line-121"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>orderByEnvironment</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OrderByEnvironment</span>
</pre>
-------------------------------------------------------


The main hard work is done in the query functions: so the idea is that
the update functions create environment values which contain the
context free contributions of each part of the ast to the current
environment, and these query functions do all the work of resolving
implicit correlation names, ambigous identifiers, etc.

for each environment type, provide two functions which do identifier
lookup and star expansion

<pre><a name="line-122"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>listBindingsTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Environment</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Text</span><span class='hs-layout'>,</span><span class='hs-conid'>Text</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span><span class='hs-conid'>Text</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-conid'>TypeExtra</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-123"></a><span class='hs-varop'>&gt;</span>                                     <span class='hs-layout'>,</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Text</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span><span class='hs-conid'>Text</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-conid'>TypeExtra</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- star expand</span>
<a name="line-124"></a><span class='hs-varop'>&gt;</span>                                     <span class='hs-layout'>)</span>
<a name="line-125"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>listBindingsTypes</span> <span class='hs-conid'>EmptyEnvironment</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-varid'>const</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-126"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>listBindingsTypes</span> <span class='hs-conid'>BrokeEnvironment</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-varid'>const</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
</pre>
<pre><a name="line-127"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>listBindingsTypes</span> <span class='hs-layout'>(</span><span class='hs-conid'>TrefAlias</span> <span class='hs-varid'>ta</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-128"></a><span class='hs-varop'>&gt;</span>   <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>q</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>q</span> <span class='hs-varop'>`elem`</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ta</span><span class='hs-keyglyph'>]</span>
<a name="line-129"></a><span class='hs-varop'>&gt;</span>              <span class='hs-keyword'>then</span> <span class='hs-varid'>req</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>listBindingsTypes</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-130"></a><span class='hs-varop'>&gt;</span>              <span class='hs-keyword'>else</span> <span class='hs-conid'>[]</span>
<a name="line-131"></a><span class='hs-varop'>&gt;</span>   <span class='hs-layout'>,</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>q</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>q</span> <span class='hs-varop'>`elem`</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ta</span><span class='hs-keyglyph'>]</span>
<a name="line-132"></a><span class='hs-varop'>&gt;</span>          <span class='hs-keyword'>then</span> <span class='hs-varid'>req</span> <span class='hs-varop'>$</span> <span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>listBindingsTypes</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span>
<a name="line-133"></a><span class='hs-varop'>&gt;</span>          <span class='hs-keyword'>else</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-134"></a><span class='hs-varop'>&gt;</span>   <span class='hs-keyword'>where</span>
<a name="line-135"></a><span class='hs-varop'>&gt;</span>     <span class='hs-varid'>req</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>ta</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>
<pre><a name="line-136"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>listBindingsTypes</span> <span class='hs-layout'>(</span><span class='hs-conid'>TrefAlias</span> <span class='hs-varid'>ta</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-137"></a><span class='hs-varop'>&gt;</span>   <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>q</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-comment'>--trace ("lookup: " ++ show (q,n)) $</span>
<a name="line-138"></a><span class='hs-varop'>&gt;</span>      <span class='hs-keyword'>if</span> <span class='hs-varid'>q</span> <span class='hs-varop'>`elem`</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ta</span><span class='hs-keyglyph'>]</span>
<a name="line-139"></a><span class='hs-varop'>&gt;</span>      <span class='hs-keyword'>then</span>    <span class='hs-comment'>--really hacky, assume the ids come out of the star expansion in same order</span>
<a name="line-140"></a><span class='hs-varop'>&gt;</span>              <span class='hs-comment'>-- almost certainly wrong some of the time</span>
<a name="line-141"></a><span class='hs-varop'>&gt;</span>              <span class='hs-keyword'>case</span> <span class='hs-varid'>elemIndex</span> <span class='hs-varid'>n</span> <span class='hs-varid'>cs</span> <span class='hs-keyword'>of</span>
<a name="line-142"></a><span class='hs-varop'>&gt;</span>                <span class='hs-conid'>Just</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span> <span class='hs-conid'>Text</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TypeExtra</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-143"></a><span class='hs-varop'>&gt;</span>                              <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>listBindingsTypes</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-144"></a><span class='hs-varop'>&gt;</span>                          <span class='hs-keyword'>in</span> <span class='hs-comment'>{-trace ("getit : " ++ show (i,show s))
<a name="line-145"></a>&gt;                                      $ -}</span>
<a name="line-146"></a><span class='hs-varop'>&gt;</span>                             <span class='hs-comment'>-- map to change the qualifier name to match</span>
<a name="line-147"></a><span class='hs-varop'>&gt;</span>                             <span class='hs-comment'>-- this alias not the source tref</span>
<a name="line-148"></a><span class='hs-varop'>&gt;</span>                             <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-sel'>_j</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>ta</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>take</span> <span class='hs-num'>1</span> <span class='hs-varop'>$</span> <span class='hs-varid'>drop</span> <span class='hs-varid'>i</span> <span class='hs-varid'>s</span>
<a name="line-149"></a><span class='hs-varop'>&gt;</span>                <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-150"></a><span class='hs-varop'>&gt;</span>      <span class='hs-keyword'>else</span> <span class='hs-conid'>[]</span>
<a name="line-151"></a><span class='hs-varop'>&gt;</span>   <span class='hs-layout'>,</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>q</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>q</span> <span class='hs-varop'>`elem`</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ta</span><span class='hs-keyglyph'>]</span>
<a name="line-152"></a><span class='hs-varop'>&gt;</span>          <span class='hs-keyword'>then</span> <span class='hs-keyword'>let</span> <span class='hs-comment'>-- if there are too many aliases for the aliased tref</span>
<a name="line-153"></a><span class='hs-varop'>&gt;</span>                   <span class='hs-comment'>-- the extras are ignored (not sure if this is correct)</span>
<a name="line-154"></a><span class='hs-varop'>&gt;</span>                   <span class='hs-comment'>-- if there are not enough, the extras are kept without</span>
<a name="line-155"></a><span class='hs-varop'>&gt;</span>                   <span class='hs-comment'>-- being renamed (think this is correct)</span>
<a name="line-156"></a><span class='hs-varop'>&gt;</span>                   <span class='hs-varid'>repColNames</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>repeat</span> <span class='hs-conid'>Nothing</span>
<a name="line-157"></a><span class='hs-varop'>&gt;</span>                   <span class='hs-varid'>aliasize</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span> <span class='hs-conid'>Text</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TypeExtra</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span> <span class='hs-conid'>Text</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TypeExtra</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-158"></a><span class='hs-varop'>&gt;</span>                   <span class='hs-varid'>aliasize</span> <span class='hs-keyglyph'>=</span>
<a name="line-159"></a><span class='hs-varop'>&gt;</span>                     <span class='hs-varid'>flip</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>repColNames</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-160"></a><span class='hs-varop'>&gt;</span>                              <span class='hs-keyword'>case</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>of</span>
<a name="line-161"></a><span class='hs-varop'>&gt;</span>                                <span class='hs-conid'>Just</span> <span class='hs-varid'>r'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>ta</span><span class='hs-layout'>,</span><span class='hs-varid'>r'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-162"></a><span class='hs-varop'>&gt;</span>                                <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>ta</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-163"></a><span class='hs-varop'>&gt;</span>               <span class='hs-keyword'>in</span> <span class='hs-varid'>aliasize</span> <span class='hs-varop'>$</span> <span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>listBindingsTypes</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span>
<a name="line-164"></a><span class='hs-varop'>&gt;</span>          <span class='hs-keyword'>else</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-165"></a><span class='hs-varop'>&gt;</span>   <span class='hs-keyword'>where</span>
<a name="line-166"></a><span class='hs-varop'>&gt;</span>     <span class='hs-comment'>-- not sure why this is here, code layout is a bit confusing</span>
<a name="line-167"></a><span class='hs-varop'>&gt;</span>     <span class='hs-sel'>_req</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>ta</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>

FIXME!!! (_,nm) ?

<pre><a name="line-168"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>listBindingsTypes</span> <span class='hs-layout'>(</span><span class='hs-conid'>SimpleTref</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>nm</span><span class='hs-layout'>)</span> <span class='hs-varid'>pus</span> <span class='hs-varid'>pvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-169"></a><span class='hs-varop'>&gt;</span>   <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>q</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>n'</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>q</span> <span class='hs-varop'>`elem`</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span><span class='hs-conid'>Just</span> <span class='hs-varid'>nm</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-170"></a><span class='hs-varop'>&gt;</span>                             <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n'</span>
<a name="line-171"></a><span class='hs-varop'>&gt;</span>              <span class='hs-keyword'>in</span> <span class='hs-varid'>addQual</span> <span class='hs-varid'>nm</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>m</span> <span class='hs-varop'>$</span> <span class='hs-varid'>pus</span> <span class='hs-varop'>++</span> <span class='hs-varid'>pvs</span>
<a name="line-172"></a><span class='hs-varop'>&gt;</span>   <span class='hs-layout'>,</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>q</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>()</span> <span class='hs-keyword'>of</span>
<a name="line-173"></a><span class='hs-varop'>&gt;</span>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>q</span> <span class='hs-varop'>`elem`</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>nm</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>addQual</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>pus</span>
<a name="line-174"></a><span class='hs-varop'>&gt;</span>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
</pre>
<pre><a name="line-175"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>listBindingsTypes</span> <span class='hs-layout'>(</span><span class='hs-conid'>JoinTref</span> <span class='hs-varid'>jids</span> <span class='hs-varid'>jt</span> <span class='hs-varid'>env0</span> <span class='hs-varid'>env1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-176"></a><span class='hs-varop'>&gt;</span>   <span class='hs-layout'>(</span><span class='hs-varid'>idens</span><span class='hs-layout'>,</span><span class='hs-varid'>starexp</span><span class='hs-layout'>)</span>
<a name="line-177"></a><span class='hs-varop'>&gt;</span>   <span class='hs-keyword'>where</span>
</pre>
<pre><a name="line-178"></a><span class='hs-varop'>&gt;</span>     <span class='hs-varid'>idens</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>iOuter</span><span class='hs-layout'>,</span><span class='hs-varid'>iInner</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>jt</span><span class='hs-varop'>==</span><span class='hs-conid'>RightOuter</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>reverse</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>is0</span> <span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>is1</span> <span class='hs-varid'>k</span><span class='hs-keyglyph'>]</span>
<a name="line-179"></a><span class='hs-varop'>&gt;</span>               <span class='hs-keyword'>in</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>iOuter</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>k</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>jnames</span>
<a name="line-180"></a><span class='hs-varop'>&gt;</span>                  <span class='hs-keyword'>then</span> <span class='hs-varid'>iOuter</span>
<a name="line-181"></a><span class='hs-varop'>&gt;</span>                  <span class='hs-keyword'>else</span> <span class='hs-varid'>iOuter</span> <span class='hs-varop'>++</span> <span class='hs-varid'>iInner</span>
</pre>
<pre><a name="line-182"></a><span class='hs-varop'>&gt;</span>     <span class='hs-sel'>_useResolvedType</span> <span class='hs-varid'>tr</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>q</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookup</span> <span class='hs-varid'>n</span> <span class='hs-varid'>jids</span> <span class='hs-keyword'>of</span>
<a name="line-183"></a><span class='hs-varop'>&gt;</span>                                    <span class='hs-conid'>Just</span> <span class='hs-varid'>t'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>q</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>t'</span><span class='hs-layout'>)</span>
<a name="line-184"></a><span class='hs-varop'>&gt;</span>                                    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tr</span>
<a name="line-185"></a><span class='hs-varop'>&gt;</span>     <span class='hs-varid'>jnames</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>jids</span>
<a name="line-186"></a><span class='hs-varop'>&gt;</span>     <span class='hs-varid'>isJ</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>jnames</span>
</pre>
todo: use useResolvedType

unqualified star:
reorder the ids so that the join columns are first

<pre><a name="line-187"></a><span class='hs-varop'>&gt;</span>     <span class='hs-varid'>starexp</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>aj</span><span class='hs-layout'>,</span><span class='hs-varid'>anj</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>isJ</span> <span class='hs-layout'>(</span><span class='hs-varid'>st0</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-188"></a><span class='hs-varop'>&gt;</span>                           <span class='hs-varid'>bnj</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isJ</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>st1</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-189"></a><span class='hs-varop'>&gt;</span>                       <span class='hs-keyword'>in</span> <span class='hs-varid'>aj</span> <span class='hs-varop'>++</span> <span class='hs-varid'>anj</span> <span class='hs-varop'>++</span> <span class='hs-varid'>bnj</span>
<a name="line-190"></a><span class='hs-varop'>&gt;</span>     <span class='hs-varid'>starexp</span> <span class='hs-varid'>q</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-191"></a><span class='hs-varop'>&gt;</span>       <span class='hs-keyword'>let</span> <span class='hs-varid'>s0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>st0</span> <span class='hs-varid'>q</span>
<a name="line-192"></a><span class='hs-varop'>&gt;</span>           <span class='hs-varid'>s1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>st1</span> <span class='hs-varid'>q</span>
<a name="line-193"></a><span class='hs-varop'>&gt;</span>       <span class='hs-keyword'>in</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>s0</span><span class='hs-layout'>,</span><span class='hs-varid'>s1</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-194"></a><span class='hs-varop'>&gt;</span>            <span class='hs-comment'>-- if we only get ids from one side, then don't</span>
<a name="line-195"></a><span class='hs-varop'>&gt;</span>            <span class='hs-comment'>-- reorder them (is this right?)</span>
<a name="line-196"></a><span class='hs-varop'>&gt;</span>            <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s0</span>
<a name="line-197"></a><span class='hs-varop'>&gt;</span>            <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s1</span>
<a name="line-198"></a><span class='hs-varop'>&gt;</span>            <span class='hs-comment'>-- have ids coming from both sides</span>
<a name="line-199"></a><span class='hs-varop'>&gt;</span>            <span class='hs-comment'>-- no idea how this is supposed to work</span>
<a name="line-200"></a><span class='hs-varop'>&gt;</span>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>aj</span><span class='hs-layout'>,</span><span class='hs-varid'>anj</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>isJ</span> <span class='hs-varid'>s0</span>
<a name="line-201"></a><span class='hs-varop'>&gt;</span>                     <span class='hs-varid'>bnj</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isJ</span><span class='hs-layout'>)</span> <span class='hs-varid'>s1</span>
<a name="line-202"></a><span class='hs-varop'>&gt;</span>                 <span class='hs-keyword'>in</span> <span class='hs-varid'>aj</span> <span class='hs-varop'>++</span> <span class='hs-varid'>anj</span> <span class='hs-varop'>++</span> <span class='hs-varid'>bnj</span>
<a name="line-203"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>(</span><span class='hs-varid'>is0</span><span class='hs-layout'>,</span><span class='hs-varid'>st0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>jt</span> <span class='hs-varop'>`elem`</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>RightOuter</span><span class='hs-layout'>,</span><span class='hs-conid'>FullOuter</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>addNullability</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-204"></a><span class='hs-varop'>&gt;</span>                 <span class='hs-varop'>$</span> <span class='hs-varid'>listBindingsTypes</span> <span class='hs-varid'>env0</span>
<a name="line-205"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>(</span><span class='hs-varid'>is1</span><span class='hs-layout'>,</span><span class='hs-varid'>st1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>jt</span> <span class='hs-varop'>`elem`</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LeftOuter</span><span class='hs-layout'>,</span><span class='hs-conid'>FullOuter</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>addNullability</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-206"></a><span class='hs-varop'>&gt;</span>                 <span class='hs-varop'>$</span> <span class='hs-varid'>listBindingsTypes</span> <span class='hs-varid'>env1</span>
<a name="line-207"></a><span class='hs-varop'>&gt;</span>     <span class='hs-varid'>addNullability</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>second</span> <span class='hs-varid'>mkNullable</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span><span class='hs-layout'>)</span> <span class='hs-varop'>***</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>second</span> <span class='hs-varid'>mkNullable</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span><span class='hs-layout'>)</span>
</pre>
selectlistenv: not quite right, but should always have an alias so the
empty qualifier never gets very far

<pre><a name="line-208"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>listBindingsTypes</span> <span class='hs-layout'>(</span><span class='hs-conid'>SelectListEnv</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-209"></a><span class='hs-varop'>&gt;</span>   <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>addQual</span> <span class='hs-str'>""</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>==</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-varop'>.</span><span class='hs-varid'>fst</span><span class='hs-layout'>)</span> <span class='hs-varid'>is</span>
<a name="line-210"></a><span class='hs-varop'>&gt;</span>   <span class='hs-layout'>,</span><span class='hs-varid'>const</span> <span class='hs-varop'>$</span> <span class='hs-varid'>addQual</span> <span class='hs-str'>""</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span>
</pre>
not quite right, see queryexprs.ag

<pre><a name="line-211"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>listBindingsTypes</span> <span class='hs-layout'>(</span><span class='hs-conid'>OrderByEnvironment</span> <span class='hs-varid'>sl</span> <span class='hs-varid'>tr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-212"></a><span class='hs-varop'>&gt;</span>   <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-213"></a><span class='hs-varop'>&gt;</span>      <span class='hs-comment'>-- hack: return the tref first so that</span>
<a name="line-214"></a><span class='hs-varop'>&gt;</span>      <span class='hs-comment'>-- a qualifier can be added. This</span>
<a name="line-215"></a><span class='hs-varop'>&gt;</span>      <span class='hs-comment'>-- is probably more wrong than the other</span>
<a name="line-216"></a><span class='hs-varop'>&gt;</span>      <span class='hs-comment'>-- way round</span>
<a name="line-217"></a><span class='hs-varop'>&gt;</span>      <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>listBindingsTypes</span> <span class='hs-varid'>tr</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span>
<a name="line-218"></a><span class='hs-varop'>&gt;</span>           <span class='hs-layout'>,</span><span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>listBindingsTypes</span> <span class='hs-varid'>sl</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-219"></a><span class='hs-varop'>&gt;</span>        <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span><span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span>
<a name="line-220"></a><span class='hs-varop'>&gt;</span>        <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>y</span>
<a name="line-221"></a><span class='hs-varop'>&gt;</span>   <span class='hs-layout'>,</span><span class='hs-varid'>const</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
</pre>

csq just uses standard shadowing for iden lookup
for star expand, the outer env is ignored

<pre><a name="line-222"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>listBindingsTypes</span> <span class='hs-layout'>(</span><span class='hs-conid'>CSQEnv</span> <span class='hs-varid'>outerenv</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-223"></a><span class='hs-varop'>&gt;</span>   <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>k</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>listBindingsTypes</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>k</span>
<a name="line-224"></a><span class='hs-varop'>&gt;</span>               <span class='hs-layout'>,</span><span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>listBindingsTypes</span> <span class='hs-varid'>outerenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-225"></a><span class='hs-varop'>&gt;</span>            <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span>
<a name="line-226"></a><span class='hs-varop'>&gt;</span>            <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span>
<a name="line-227"></a><span class='hs-varop'>&gt;</span>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-228"></a><span class='hs-varop'>&gt;</span>   <span class='hs-layout'>,</span><span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>listBindingsTypes</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
</pre>

<pre><a name="line-229"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>addQual</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Text</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span><span class='hs-conid'>TypeExtra</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span><span class='hs-conid'>Text</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-conid'>TypeExtra</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-230"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>addQual</span> <span class='hs-varid'>q</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>q</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>

-------------------------------------------------------

use listBindingsTypes to implement expandstar and lookupid

<pre><a name="line-231"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>envExpandStar</span><span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>NameComponent</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Environment</span>
<a name="line-232"></a><span class='hs-varop'>&gt;</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TypeError</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span><span class='hs-conid'>Text</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-conid'>TypeExtra</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
</pre>
<pre><a name="line-233"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>envExpandStar</span> <span class='hs-comment'>{-nmc env-}</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-let r =-}</span> <span class='hs-varid'>envExpandStar2</span> <span class='hs-comment'>{-nmc env-}</span>
<a name="line-234"></a><span class='hs-varop'>&gt;</span>                         <span class='hs-comment'>{-in trace ("env expand star: " ++ show nmc ++ " " ++ show r)
<a name="line-235"></a>&gt;                            r-}</span>
</pre>
<pre><a name="line-236"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>envExpandStar2</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>NameComponent</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Environment</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TypeError</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span><span class='hs-conid'>Text</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-conid'>TypeExtra</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-237"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>envExpandStar2</span> <span class='hs-varid'>nmc</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span>
<a name="line-238"></a><span class='hs-varop'>&gt;</span>   <span class='hs-keyword'>if</span> <span class='hs-varid'>isBroken</span> <span class='hs-varid'>env</span>
<a name="line-239"></a><span class='hs-varop'>&gt;</span>   <span class='hs-keyword'>then</span> <span class='hs-conid'>Left</span> <span class='hs-conid'>[]</span>
<a name="line-240"></a><span class='hs-varop'>&gt;</span>   <span class='hs-keyword'>else</span>
<a name="line-241"></a><span class='hs-varop'>&gt;</span>     <span class='hs-keyword'>let</span> <span class='hs-varid'>st</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>listBindingsTypes</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>nmcString</span> <span class='hs-varid'>nmc</span>
<a name="line-242"></a><span class='hs-varop'>&gt;</span>     <span class='hs-keyword'>in</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>st</span>
<a name="line-243"></a><span class='hs-varop'>&gt;</span>        <span class='hs-keyword'>then</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>nmc</span> <span class='hs-keyword'>of</span>
<a name="line-244"></a><span class='hs-varop'>&gt;</span>               <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UnrecognisedCorrelationName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nmcString</span> <span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span>
<a name="line-245"></a><span class='hs-varop'>&gt;</span>               <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>BadStarExpand</span><span class='hs-keyglyph'>]</span>
<a name="line-246"></a><span class='hs-varop'>&gt;</span>        <span class='hs-keyword'>else</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>st</span>
</pre>
<pre><a name="line-247"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>nmcString</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameComponent</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Text</span>
<a name="line-248"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>nmcString</span> <span class='hs-layout'>(</span><span class='hs-conid'>QNmc</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-varid'>n</span>
<a name="line-249"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>nmcString</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nmc</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toLower</span> <span class='hs-varid'>n</span>
<a name="line-250"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- todo: don't use error</span>
<a name="line-251"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>nmcString</span> <span class='hs-layout'>(</span><span class='hs-conid'>AntiNameComponent</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"tried to get ncstr of antinamecomponent"</span>
</pre>
<pre><a name="line-252"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>envLookupIdentifier</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NameComponent</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Environment</span>
<a name="line-253"></a><span class='hs-varop'>&gt;</span>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TypeError</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span><span class='hs-conid'>Text</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TypeExtra</span><span class='hs-layout'>)</span>
<a name="line-254"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>envLookupIdentifier</span> <span class='hs-varid'>nmc</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>--trace ("lookup: " ++ show nmc  ++ "\n" ++ ppShow env) $</span>
<a name="line-255"></a><span class='hs-varop'>&gt;</span>   <span class='hs-keyword'>if</span> <span class='hs-varid'>isBroken</span> <span class='hs-varid'>env</span>
<a name="line-256"></a><span class='hs-varop'>&gt;</span>   <span class='hs-keyword'>then</span> <span class='hs-conid'>Left</span> <span class='hs-conid'>[]</span>
<a name="line-257"></a><span class='hs-varop'>&gt;</span>   <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-258"></a><span class='hs-varop'>&gt;</span>     <span class='hs-varid'>k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>nmc</span> <span class='hs-keyword'>of</span>
<a name="line-259"></a><span class='hs-varop'>&gt;</span>                <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nmcString</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>nmcString</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-260"></a><span class='hs-varop'>&gt;</span>                <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>nmcString</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-261"></a><span class='hs-varop'>&gt;</span>                <span class='hs-keyglyph'>[</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SchemadColumnName</span> <span class='hs-str'>"an identifier cannot be used with an explicit schema name, please use only a correlation name without a schema name (you can use a table reference alias to disambiguate if you need to)."</span><span class='hs-keyglyph'>]</span>
<a name="line-262"></a><span class='hs-varop'>&gt;</span>                <span class='hs-keyglyph'>[</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DbSchemadColumnName</span> <span class='hs-str'>"an identifier cannot be used with an explicit database name and schema name, please use only a correlation name without a schema name (you can use a table reference alias to disambiguate if you need to)."</span><span class='hs-keyglyph'>]</span>
<a name="line-263"></a><span class='hs-varop'>&gt;</span>                <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InternalError</span> <span class='hs-str'>"too many nmc components in envlookupiden"</span><span class='hs-keyglyph'>]</span>
<a name="line-264"></a><span class='hs-varop'>&gt;</span>     <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>listBindingsTypes</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>k</span> <span class='hs-keyword'>of</span>
<a name="line-265"></a><span class='hs-varop'>&gt;</span>       <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UnrecognisedIdentifier</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nmcString</span> <span class='hs-varop'>$</span> <span class='hs-varid'>last</span> <span class='hs-varid'>nmc</span><span class='hs-keyglyph'>]</span>
<a name="line-266"></a><span class='hs-varop'>&gt;</span>       <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-varop'>$</span> <span class='hs-varid'>keepCasehack</span> <span class='hs-varid'>x</span>
<a name="line-267"></a><span class='hs-varop'>&gt;</span>       <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>AmbiguousIdentifier</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nmcString</span> <span class='hs-varop'>$</span> <span class='hs-varid'>last</span> <span class='hs-varid'>nmc</span><span class='hs-keyglyph'>]</span>
<a name="line-268"></a><span class='hs-varop'>&gt;</span>   <span class='hs-keyword'>where</span>
<a name="line-269"></a><span class='hs-varop'>&gt;</span>     <span class='hs-varid'>keepCasehack</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>na</span><span class='hs-layout'>,</span><span class='hs-varid'>nb</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-270"></a><span class='hs-varop'>&gt;</span>       <span class='hs-keyword'>case</span> <span class='hs-varid'>nmc</span> <span class='hs-keyword'>of</span>
<a name="line-271"></a><span class='hs-varop'>&gt;</span>         <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>keepcase</span> <span class='hs-varid'>a</span> <span class='hs-varid'>na</span><span class='hs-layout'>,</span><span class='hs-varid'>keepcase</span> <span class='hs-varid'>b</span> <span class='hs-varid'>nb</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-272"></a><span class='hs-varop'>&gt;</span>                  <span class='hs-keyword'>in</span> <span class='hs-comment'>{-(if True -- map toLower nb == "ou_id"
<a name="line-273"></a>&gt;                      then trace ("\n\n*********************\n\nlookup: " ++ show x ++ "\n\n********************************\n\n" ++ ppShow env ++ "\n\n********************************\n\n")
<a name="line-274"></a>&gt;                      else id)-}</span> <span class='hs-varid'>x</span>
<a name="line-275"></a><span class='hs-varop'>&gt;</span>         <span class='hs-keyglyph'>[</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>na</span><span class='hs-layout'>,</span><span class='hs-varid'>keepcase</span> <span class='hs-varid'>b</span> <span class='hs-varid'>nb</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-276"></a><span class='hs-varop'>&gt;</span>         <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>error</span> <span class='hs-str'>"too many nmc components in envlookupiden(2)"</span>
<a name="line-277"></a><span class='hs-varop'>&gt;</span>     <span class='hs-varid'>keepcase</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>new</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- sanity check: make sure the nmcs are equal</span>
<a name="line-278"></a><span class='hs-varop'>&gt;</span>                         <span class='hs-keyword'>if</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>map</span> <span class='hs-varid'>toLower</span> <span class='hs-varid'>new</span> <span class='hs-varop'>==</span> <span class='hs-varid'>nmcString</span> <span class='hs-varid'>orig</span>
<a name="line-279"></a><span class='hs-varop'>&gt;</span>                         <span class='hs-keyword'>then</span> <span class='hs-varid'>noLower</span> <span class='hs-varid'>orig</span>
<a name="line-280"></a><span class='hs-varop'>&gt;</span>                         <span class='hs-keyword'>else</span> <span class='hs-varid'>new</span>
<a name="line-281"></a><span class='hs-varop'>&gt;</span>     <span class='hs-varid'>noLower</span> <span class='hs-layout'>(</span><span class='hs-conid'>QNmc</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-varid'>n</span>
<a name="line-282"></a><span class='hs-varop'>&gt;</span>     <span class='hs-varid'>noLower</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nmc</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-varid'>n</span>
<a name="line-283"></a><span class='hs-varop'>&gt;</span>     <span class='hs-varid'>noLower</span> <span class='hs-layout'>(</span><span class='hs-conid'>AntiNameComponent</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"bad antinamecomponent in Environment.envLookupIdentifier.noLower "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>n</span>
</pre>
--------------------------
adding for plpgsql notes:

additional envs
* parameter in function
* declaration in function block
* implicit integer loop var in for loop
* set explicit record type in for loop/ assignment to record type
* for constraints in create table, create domain

Write tests to quickly check each bit of code which uses these using
the full typechecking:
update: sets, where, returning
select: tref -> select list, where, group by, order by
join: out to tref, into on expression
implicit variable in for loop
record type in for loop
record type in assignment
record type in select into
delete where and returning
block declarations
constraints in create table, create domain
parameters in function body
statementlist: pass on record updates?
insert: columns?, returning
</body>
</html>
