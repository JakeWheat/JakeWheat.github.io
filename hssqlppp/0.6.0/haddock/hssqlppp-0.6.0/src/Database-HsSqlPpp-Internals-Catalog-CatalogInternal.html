<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Database/HsSqlPpp/Internals/Catalog/CatalogInternal.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>

This module contains the implementation of the Catalog data types
and functions, and provides the api for the other type checking
modules.

NEW CATALOG!

create new types from scratch
1st version only supports checking type names
fix the read catalog code
continue to ignore schemas
start handling case sensitivity properly
ignore modifiers

= Catalog overview

The main purpose of the catalog is to support typechecking. A
secondary purpose is to be able to support documentation generation.

== What information does the catalog contain?

types:

base types
names of all types
domains
casts
type categories (what is this?)

tables, views, composite types

operators:
  prefix ops
  postfix ops
  binary ops
  regular fns
  aggregate fns
  window fns


triggers

indexes

sequences


<pre><a name="line-1"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>{-# LANGUAGE DeriveDataTypeable,OverloadedStrings #-}</span>
<a name="line-2"></a><span class='hs-varop'>&gt;</span>
<a name="line-3"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>module</span> <span class='hs-conid'>Database</span><span class='hs-varop'>.</span><span class='hs-conid'>HsSqlPpp</span><span class='hs-varop'>.</span><span class='hs-conid'>Internals</span><span class='hs-varop'>.</span><span class='hs-conid'>Catalog</span><span class='hs-varop'>.</span><span class='hs-conid'>CatalogInternal</span>
<a name="line-4"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>(</span><span class='hs-varid'>catLookupType</span>
<a name="line-5"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>catLookupTableAndAttrs</span>
<a name="line-6"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>catGetOpsMatchingName</span>
<a name="line-7"></a><span class='hs-varop'>&gt;</span>      <span class='hs-comment'>-- temp stuff for old typeconversion</span>
<a name="line-8"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>catLookupFns</span>
<a name="line-9"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>catPreferredType</span>
<a name="line-10"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>isOperatorName</span>
<a name="line-11"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>catTypeCategory</span>
<a name="line-12"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>catCast</span>
<a name="line-13"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>catCompositePublicAttrs</span>
<a name="line-14"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>catDomainBaseType</span>
<a name="line-15"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-varid'>typeToCatName</span>
<a name="line-16"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
</pre>
<pre><a name="line-17"></a><span class='hs-varop'>&gt;</span>
<a name="line-18"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import Control.Monad</span>
<a name="line-19"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import Data.List</span>
<a name="line-20"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import Data.Data</span>
<a name="line-21"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import Data.Char</span>
<a name="line-22"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
</pre>
<pre><a name="line-23"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>M</span>
<a name="line-24"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>S</span>
<a name="line-25"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Database</span><span class='hs-varop'>.</span><span class='hs-conid'>HsSqlPpp</span><span class='hs-varop'>.</span><span class='hs-conid'>Internals</span><span class='hs-varop'>.</span><span class='hs-conid'>TypesInternal</span>
<a name="line-26"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import Database.HsSqlPpp.Utils.Utils</span>
<a name="line-27"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span> <span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>)</span>
<a name="line-28"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>T</span>
<a name="line-29"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import qualified Data.Text.Lazy as LT</span>
</pre>
<pre><a name="line-30"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Database</span><span class='hs-varop'>.</span><span class='hs-conid'>HsSqlPpp</span><span class='hs-varop'>.</span><span class='hs-conid'>Internals</span><span class='hs-varop'>.</span><span class='hs-conid'>Catalog</span><span class='hs-varop'>.</span><span class='hs-conid'>CatalogTypes</span>
<a name="line-31"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import Database.HsSqlPpp.Internals.Catalog.BaseCatalog</span>
<a name="line-32"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Database</span><span class='hs-varop'>.</span><span class='hs-conid'>HsSqlPpp</span><span class='hs-varop'>.</span><span class='hs-conid'>Internals</span><span class='hs-varop'>.</span><span class='hs-conid'>Catalog</span><span class='hs-varop'>.</span><span class='hs-conid'>CatalogUtils</span>
</pre>
-----------------------------------

types:

What information does the catalog store and use on types?

The basic set of types recorded here are:

scalar types - the base types implemented outside of plpgsql

domain types - this is a base type with a constraint (can composite
types be used in a domain?)

enum types - the usual. The values are strings and are case
sensitive. I think you can overload the values so they can be members
of more than one enum type

named composite types - these are structs, created using 'create type
x as', and also a composite type is implicitly created for each table
and view definition with the same name as the table or view

array types - not sure exactly how to handle this, generally, postgres
automatically creates an array type for each scalar, domain, composite
and enum type (any others?), and you can't use arrays of something if
the type of the array isn't in the catalog. So lots of other types
can't be made into arrays (what about arrays of arrays? don't
know). Hssqlppp simply assumes that the array type of any type is
available


None of the types apart from these exist in the same way in postgres -
so unnamed compositetypes, anonymous record type, unknown and pseudo
type are used in less contexts. Maybe one way of looking at them is to
consider them more like type generators which exist simply when they
are used, and don't have to be declared up front. Only the above
privileged types can be used for the types of columns in tables and
views (I think?).

for scalar types, no information is used apart from the fact that a
type with the given name exists and can be referred to.

for domain types, there is also the base type name, and the check
constraint

for enum types, name and the list of labels

for named composite types, you need the name of the type, and the
names and types of the fields

for array types, you only need the base type name, array types don't
have their own separate name

todo: where should this utility live? Probably should be connected 
to the dialects

<pre><a name="line-33"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>typeToCatName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeExtra</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TypeError</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>CatNameExtra</span>
<a name="line-34"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>typeToCatName</span> <span class='hs-varid'>te</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>teType</span> <span class='hs-varid'>te</span> <span class='hs-keyword'>of</span>
<a name="line-35"></a><span class='hs-varop'>&gt;</span>   <span class='hs-conid'>ScalarType</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span>
<a name="line-36"></a><span class='hs-varop'>&gt;</span>       <span class='hs-varop'>$</span> <span class='hs-conid'>CatNameExtra</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-varid'>tePrecision</span> <span class='hs-varid'>te</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>teScale</span> <span class='hs-varid'>te</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>teNullable</span> <span class='hs-varid'>te</span><span class='hs-layout'>)</span>
<a name="line-37"></a><span class='hs-varop'>&gt;</span>   <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InternalError</span> <span class='hs-str'>"typeToCatName on a non scalar type"</span><span class='hs-keyglyph'>]</span>
</pre>
-----------------------------------------------------------

queries


gets a schema qualified catname, puts in the default 'public' if there
is only one name component. This will be altered when schema search
paths are implemented.

<pre><a name="line-38"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>getCatName2</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NameComponent</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CatName</span><span class='hs-layout'>,</span><span class='hs-conid'>CatName</span><span class='hs-layout'>)</span>
<a name="line-39"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>getCatName2</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"empty name component in catalog code"</span>
<a name="line-40"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>getCatName2</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-str'>"public"</span><span class='hs-layout'>,</span><span class='hs-varid'>ncStrT</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-41"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>getCatName2</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncStrT</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>ncStrT</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-42"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>getCatName2</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getCatName2</span> <span class='hs-varid'>xs</span>
</pre>

TODO: add inverse of this operation, give a type, returns a typename


<pre><a name="line-43"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- | takes a table name, and returns the exact table name (to deal</span>
<a name="line-44"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- with quoting), and the public and private attr names</span>
<a name="line-45"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catLookupTableAndAttrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Catalog</span>
<a name="line-46"></a><span class='hs-varop'>&gt;</span>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NameComponent</span><span class='hs-keyglyph'>]</span>
<a name="line-47"></a><span class='hs-varop'>&gt;</span>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TypeError</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span><span class='hs-conid'>Text</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span><span class='hs-conid'>TypeExtra</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span><span class='hs-conid'>Type</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-48"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catLookupTableAndAttrs</span> <span class='hs-varid'>cat</span> <span class='hs-varid'>nmcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-49"></a><span class='hs-varop'>&gt;</span>   <span class='hs-keyword'>let</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getCatName2</span> <span class='hs-varid'>nmcs</span>
<a name="line-50"></a><span class='hs-varop'>&gt;</span>   <span class='hs-layout'>(</span><span class='hs-varid'>pu</span><span class='hs-layout'>,</span><span class='hs-varid'>pv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UnrecognisedRelation</span> <span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-conid'>Right</span>
<a name="line-51"></a><span class='hs-varop'>&gt;</span>              <span class='hs-varop'>$</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>catTables</span> <span class='hs-varid'>cat</span><span class='hs-layout'>)</span>
<a name="line-52"></a><span class='hs-varop'>&gt;</span>   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>pu</span><span class='hs-layout'>,</span><span class='hs-varid'>pv</span><span class='hs-layout'>)</span>
</pre>


<pre><a name="line-53"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catGetOpsMatchingName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Catalog</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NameComponent</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>OperatorPrototype</span><span class='hs-keyglyph'>]</span>
<a name="line-54"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catGetOpsMatchingName</span> <span class='hs-varid'>cat</span> <span class='hs-varid'>nmcs</span> <span class='hs-keyglyph'>=</span>
<a name="line-55"></a><span class='hs-varop'>&gt;</span>   <span class='hs-keyword'>let</span> <span class='hs-varid'>nm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getCatName</span> <span class='hs-varid'>nmcs</span>
<a name="line-56"></a><span class='hs-varop'>&gt;</span>   <span class='hs-keyword'>in</span> <span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>f</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fromMaybe</span> <span class='hs-conid'>[]</span> <span class='hs-varop'>$</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>nm</span> <span class='hs-varop'>$</span> <span class='hs-varid'>f</span> <span class='hs-varid'>cat</span><span class='hs-layout'>)</span>
<a name="line-57"></a><span class='hs-varop'>&gt;</span>        <span class='hs-keyglyph'>[</span><span class='hs-varid'>catPrefixOps</span>
<a name="line-58"></a><span class='hs-varop'>&gt;</span>        <span class='hs-layout'>,</span><span class='hs-varid'>catPostfixOps</span>
<a name="line-59"></a><span class='hs-varop'>&gt;</span>        <span class='hs-layout'>,</span><span class='hs-varid'>catBinaryOps</span>
<a name="line-60"></a><span class='hs-varop'>&gt;</span>        <span class='hs-layout'>,</span><span class='hs-varid'>catFunctions</span>
<a name="line-61"></a><span class='hs-varop'>&gt;</span>        <span class='hs-layout'>,</span><span class='hs-varid'>catAggregateFunctions</span>
<a name="line-62"></a><span class='hs-varop'>&gt;</span>        <span class='hs-layout'>,</span><span class='hs-varid'>catWindowFunctions</span><span class='hs-keyglyph'>]</span>
</pre>
the TypeConversion module handles checking assignment compatibility,
'resolving result set types', and finding function call matches since
this relies on some heavy algorithms to match postgress really complex
overloading and implicit cast system.


--------------------------------------------------------

old stuff chucked in to support the old typeconversion, to be promoted
to new code or deleted as typeconversion is rewritten



<pre><a name="line-63"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catCompositePublicAttrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Catalog</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CompositeFlavour</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Text</span>
<a name="line-64"></a><span class='hs-varop'>&gt;</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TypeError</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span><span class='hs-conid'>TypeExtra</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-65"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catCompositePublicAttrs</span> <span class='hs-varid'>cat</span> <span class='hs-sel'>_flvs</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-66"></a><span class='hs-varop'>&gt;</span>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>catLookupTableAndAttrs</span> <span class='hs-varid'>cat</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Nmc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>unpack</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
<a name="line-67"></a><span class='hs-varop'>&gt;</span>    <span class='hs-varid'>return</span> <span class='hs-varid'>a</span>
</pre>
<pre><a name="line-68"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catPreferredType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Catalog</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TypeError</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>Bool</span>
<a name="line-69"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catPreferredType</span> <span class='hs-varid'>cat</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-70"></a><span class='hs-varop'>&gt;</span>   <span class='hs-varid'>fmap</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>catGetCategoryInfo</span> <span class='hs-varid'>cat</span> <span class='hs-varid'>ty</span>
<a name="line-71"></a><span class='hs-varop'>&gt;</span>
<a name="line-72"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catCast</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Catalog</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CastContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TypeError</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>Bool</span>
<a name="line-73"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catCast</span> <span class='hs-varid'>cat</span> <span class='hs-varid'>ctx</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span> <span class='hs-keyglyph'>=</span>
<a name="line-74"></a><span class='hs-varop'>&gt;</span>     <span class='hs-keyword'>case</span> <span class='hs-varid'>from</span> <span class='hs-keyword'>of</span>
<a name="line-75"></a><span class='hs-varop'>&gt;</span>       <span class='hs-varid'>t</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DomainType</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-76"></a><span class='hs-varop'>&gt;</span>                 <span class='hs-varid'>baseType</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>catDomainBaseType</span> <span class='hs-varid'>cat</span> <span class='hs-varid'>t</span>
<a name="line-77"></a><span class='hs-varop'>&gt;</span>                 <span class='hs-varid'>cc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>catCast</span> <span class='hs-varid'>cat</span> <span class='hs-varid'>ctx</span> <span class='hs-varid'>baseType</span> <span class='hs-varid'>to</span>
<a name="line-78"></a><span class='hs-varop'>&gt;</span>                 <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>baseType</span> <span class='hs-varop'>==</span> <span class='hs-varid'>to</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span>
<a name="line-79"></a><span class='hs-varop'>&gt;</span>                                <span class='hs-layout'>(</span><span class='hs-varid'>cc</span> <span class='hs-varop'>||</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>member</span> <span class='hs-layout'>(</span><span class='hs-varid'>from</span><span class='hs-layout'>,</span> <span class='hs-varid'>to</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctx</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>catCasts</span> <span class='hs-varid'>cat</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-80"></a><span class='hs-varop'>&gt;</span>       <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-varop'>$</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>member</span> <span class='hs-layout'>(</span><span class='hs-varid'>from</span><span class='hs-layout'>,</span> <span class='hs-varid'>to</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctx</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>catCasts</span> <span class='hs-varid'>cat</span><span class='hs-layout'>)</span>
<a name="line-81"></a><span class='hs-varop'>&gt;</span>
<a name="line-82"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catDomainBaseType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Catalog</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TypeError</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>Type</span>
<a name="line-83"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catDomainBaseType</span> <span class='hs-varid'>cat</span> <span class='hs-layout'>(</span><span class='hs-conid'>ScalarType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-84"></a><span class='hs-varop'>&gt;</span>   <span class='hs-keyword'>case</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$</span> <span class='hs-varid'>catDomainTypes</span> <span class='hs-varid'>cat</span> <span class='hs-keyword'>of</span>
<a name="line-85"></a><span class='hs-varop'>&gt;</span>     <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ScalarType</span> <span class='hs-varid'>n</span>
<a name="line-86"></a><span class='hs-varop'>&gt;</span>     <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DomainDefNotFound</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ScalarType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
<a name="line-87"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catDomainBaseType</span> <span class='hs-sel'>_cat</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DomainDefNotFound</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
<a name="line-88"></a><span class='hs-varop'>&gt;</span>
<a name="line-89"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catLookupFns</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Catalog</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Text</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>OperatorPrototype</span><span class='hs-keyglyph'>]</span>
<a name="line-90"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catLookupFns</span> <span class='hs-varid'>cat</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span>
<a name="line-91"></a><span class='hs-varop'>&gt;</span>    <span class='hs-varid'>catGetOpsMatchingName</span> <span class='hs-varid'>cat</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Nmc</span> <span class='hs-varop'>$</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>unpack</span> <span class='hs-varid'>name</span><span class='hs-keyglyph'>]</span>
</pre>
<pre><a name="line-92"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catTypeCategory</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Catalog</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TypeError</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>Text</span>
<a name="line-93"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catTypeCategory</span> <span class='hs-varid'>cat</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-94"></a><span class='hs-varop'>&gt;</span>   <span class='hs-varid'>fmap</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>catGetCategoryInfo</span> <span class='hs-varid'>cat</span> <span class='hs-varid'>ty</span>
</pre>
<pre><a name="line-95"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>isOperatorName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Text</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-96"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>isOperatorName</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elem`</span> <span class='hs-layout'>(</span><span class='hs-str'>"+-*/&lt;&gt;=~!@#%^&amp;|`?."</span><span class='hs-keyglyph'>::</span><span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre>
<pre><a name="line-97"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catGetCategoryInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Catalog</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TypeError</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>
<a name="line-98"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catGetCategoryInfo</span> <span class='hs-varid'>cat</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-99"></a><span class='hs-varop'>&gt;</span>   <span class='hs-keyword'>case</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-100"></a><span class='hs-varop'>&gt;</span>     <span class='hs-conid'>Pseudo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SetOfType</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-str'>""</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-101"></a><span class='hs-varop'>&gt;</span>     <span class='hs-conid'>AnonymousCompositeType</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-str'>""</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-102"></a><span class='hs-varop'>&gt;</span>     <span class='hs-conid'>ArrayType</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pseudo</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-str'>"A"</span><span class='hs-layout'>,</span><span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-103"></a><span class='hs-varop'>&gt;</span>     <span class='hs-conid'>Pseudo</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-str'>"P"</span><span class='hs-layout'>,</span><span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-104"></a><span class='hs-varop'>&gt;</span>     <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$</span> <span class='hs-varid'>catTypeCategories</span> <span class='hs-varid'>cat</span> <span class='hs-keyword'>of</span>
<a name="line-105"></a><span class='hs-varop'>&gt;</span>            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InternalError</span> <span class='hs-varop'>$</span> <span class='hs-str'>"no type category for "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span>
<a name="line-106"></a><span class='hs-varop'>&gt;</span>            <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>x</span>
</pre></body>
</html>
