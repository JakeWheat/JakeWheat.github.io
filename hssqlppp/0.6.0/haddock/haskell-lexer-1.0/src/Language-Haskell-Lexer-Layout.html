<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Language/Haskell/Lexer/Layout.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>Lexer</span><span class='hs-varop'>.</span><span class='hs-conid'>Layout</span> <span class='hs-layout'>(</span><span class='hs-varid'>layoutPre</span><span class='hs-layout'>,</span><span class='hs-conid'>PosToken</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>Lexer</span><span class='hs-varop'>.</span><span class='hs-conid'>Tokens</span>
<a name="line-4"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>Lexer</span><span class='hs-varop'>.</span><span class='hs-conid'>Position</span>
<a name="line-5"></a>
<a name="line-6"></a><a name="PosToken"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>PosToken</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Token</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-conid'>Pos</span><span class='hs-layout'>,</span><span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-7"></a>
<a name="line-8"></a><a name="layoutPre"></a><span class='hs-comment'>-- | This is an implementation of Haskell layout, as specified in</span>
<a name="line-9"></a><span class='hs-comment'>-- section 9.3 of the revised Haskell 98 report.</span>
<a name="line-10"></a><span class='hs-comment'>-- This preprocessor inserts the extra \&lt;n\&gt; and {n} tokens.</span>
<a name="line-11"></a><span class='hs-definition'>layoutPre</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PosToken</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PosToken</span><span class='hs-keyglyph'>]</span>
<a name="line-12"></a><span class='hs-definition'>layoutPre</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>indent</span> <span class='hs-varop'>.</span> <span class='hs-varid'>open</span>
<a name="line-13"></a>
<a name="line-14"></a><a name="open"></a><span class='hs-definition'>open</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PosToken</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PosToken</span><span class='hs-keyglyph'>]</span>
<a name="line-15"></a><span class='hs-definition'>open</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>open1</span>
<a name="line-16"></a>
<a name="line-17"></a><a name="open1"></a><span class='hs-comment'>{-+
<a name="line-18"></a>If the first lexeme of a module is not { or module, then it is preceded
<a name="line-19"></a>by {n} where n is the indentation of the lexeme.
<a name="line-20"></a>-}</span>
<a name="line-21"></a><span class='hs-definition'>open1</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PosToken</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PosToken</span><span class='hs-keyglyph'>]</span>
<a name="line-22"></a><span class='hs-definition'>open1</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Reservedid</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-str'>"module"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t1</span><span class='hs-conop'>:</span><span class='hs-varid'>open2</span> <span class='hs-varid'>ts</span>
<a name="line-23"></a><span class='hs-definition'>open1</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Special</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-str'>"{"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>ts</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t1</span><span class='hs-conop'>:</span><span class='hs-varid'>open2</span> <span class='hs-varid'>ts</span>
<a name="line-24"></a><span class='hs-definition'>open1</span> <span class='hs-varid'>ts</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>	                <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Open</span> <span class='hs-layout'>(</span><span class='hs-varid'>column</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-str'>""</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>open2</span> <span class='hs-varid'>ts</span>
<a name="line-25"></a><span class='hs-definition'>open1</span> <span class='hs-conid'>[]</span>                                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-26"></a>
<a name="line-27"></a><a name="open2"></a><span class='hs-comment'>{-+
<a name="line-28"></a>If a let, where, do, or of keyword is not followed by the lexeme {,
<a name="line-29"></a>the token {n} is inserted after the keyword, where n is the indentation of
<a name="line-30"></a>the next lexeme if there is one, or 0 if the end of file has been reached.
<a name="line-31"></a>-}</span>
<a name="line-32"></a><span class='hs-definition'>open2</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PosToken</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PosToken</span><span class='hs-keyglyph'>]</span>
<a name="line-33"></a><span class='hs-definition'>open2</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1</span><span class='hs-conop'>:</span><span class='hs-varid'>ts1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLtoken</span> <span class='hs-varid'>t1</span> <span class='hs-keyglyph'>=</span>
<a name="line-34"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>ts1</span> <span class='hs-keyword'>of</span>
<a name="line-35"></a>      <span class='hs-varid'>t2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>ts2</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-36"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>notLBrace</span> <span class='hs-varid'>t2</span>
<a name="line-37"></a>        <span class='hs-keyword'>then</span> <span class='hs-varid'>t1</span><span class='hs-conop'>:</span><span class='hs-layout'>(</span><span class='hs-conid'>Open</span> <span class='hs-layout'>(</span><span class='hs-varid'>column</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-str'>""</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>open2</span> <span class='hs-varid'>ts1</span>
<a name="line-38"></a>        <span class='hs-keyword'>else</span> <span class='hs-varid'>t1</span><span class='hs-conop'>:</span><span class='hs-varid'>t2</span><span class='hs-conop'>:</span><span class='hs-varid'>open2</span> <span class='hs-varid'>ts2</span>
<a name="line-39"></a>      <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>t1</span><span class='hs-conop'>:</span><span class='hs-layout'>(</span><span class='hs-conid'>Open</span> <span class='hs-num'>0</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>snd</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-str'>""</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-conid'>[]</span>
<a name="line-40"></a>  <span class='hs-keyword'>where</span>
<a name="line-41"></a>    <span class='hs-varid'>isLtoken</span> <span class='hs-layout'>(</span><span class='hs-conid'>Reservedid</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span> <span class='hs-varop'>`elem`</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"let"</span><span class='hs-layout'>,</span><span class='hs-str'>"where"</span><span class='hs-layout'>,</span><span class='hs-str'>"do"</span><span class='hs-layout'>,</span><span class='hs-str'>"of"</span><span class='hs-keyglyph'>]</span>
<a name="line-42"></a>    <span class='hs-varid'>isLtoken</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-43"></a>
<a name="line-44"></a>    <span class='hs-varid'>notLBrace</span> <span class='hs-layout'>(</span><span class='hs-conid'>Special</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-str'>"{"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-45"></a>    <span class='hs-varid'>notLBrace</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-46"></a><span class='hs-definition'>open2</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-conop'>:</span><span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span><span class='hs-conop'>:</span><span class='hs-varid'>open2</span> <span class='hs-varid'>ts</span>
<a name="line-47"></a><span class='hs-definition'>open2</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-48"></a>
<a name="line-49"></a><a name="indent"></a><span class='hs-comment'>{-+
<a name="line-50"></a>(This is from the original Haskell 98 report.)
<a name="line-51"></a>The first token on each line (not including tokens already annotated) is
<a name="line-52"></a>preceeded by &amp;lt;n&amp;gt;, where n is the indentation of the token.
<a name="line-53"></a>-}</span>
<a name="line-54"></a><span class='hs-definition'>indent</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PosToken</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PosToken</span><span class='hs-keyglyph'>]</span>
<a name="line-55"></a><span class='hs-definition'>indent</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Open</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t1</span><span class='hs-conop'>:</span><span class='hs-varid'>indent2</span> <span class='hs-layout'>(</span><span class='hs-varid'>line</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-varid'>ts</span>
<a name="line-56"></a><span class='hs-definition'>indent</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>ts</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Indent</span> <span class='hs-layout'>(</span><span class='hs-varid'>column</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-str'>""</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>t1</span><span class='hs-conop'>:</span><span class='hs-varid'>indent2</span> <span class='hs-layout'>(</span><span class='hs-varid'>line</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-varid'>ts</span>
<a name="line-57"></a><span class='hs-definition'>indent</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="indent2"></a><span class='hs-definition'>indent2</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PosToken</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PosToken</span><span class='hs-keyglyph'>]</span>
<a name="line-60"></a><span class='hs-definition'>indent2</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>t1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>line</span> <span class='hs-varid'>p</span><span class='hs-varop'>==</span><span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t1</span><span class='hs-conop'>:</span><span class='hs-varid'>indent2</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ts</span>
<a name="line-61"></a><span class='hs-definition'>indent2</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>indent</span> <span class='hs-varid'>ts</span>
</pre></body>
</html>
