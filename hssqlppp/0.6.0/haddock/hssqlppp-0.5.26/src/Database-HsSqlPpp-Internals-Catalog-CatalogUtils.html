<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Database/HsSqlPpp/Internals/Catalog/CatalogUtils.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>

some utilities which are used by catalog builder and by catalog
internals

<pre><a name="line-1"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>{-# LANGUAGE OverloadedStrings #-}</span>
<a name="line-2"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>module</span> <span class='hs-conid'>Database</span><span class='hs-varop'>.</span><span class='hs-conid'>HsSqlPpp</span><span class='hs-varop'>.</span><span class='hs-conid'>Internals</span><span class='hs-varop'>.</span><span class='hs-conid'>Catalog</span><span class='hs-varop'>.</span><span class='hs-conid'>CatalogUtils</span>
<a name="line-3"></a><span class='hs-varop'>&gt;</span>        <span class='hs-layout'>(</span><span class='hs-varid'>catLookupType</span><span class='hs-layout'>,</span> <span class='hs-varid'>getCatName</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
</pre>
<pre><a name="line-4"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Database</span><span class='hs-varop'>.</span><span class='hs-conid'>HsSqlPpp</span><span class='hs-varop'>.</span><span class='hs-conid'>Internals</span><span class='hs-varop'>.</span><span class='hs-conid'>Catalog</span><span class='hs-varop'>.</span><span class='hs-conid'>CatalogTypes</span>
<a name="line-5"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import Control.Monad</span>
<a name="line-6"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import Data.List</span>
<a name="line-7"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import Data.Data</span>
<a name="line-8"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import Data.Char</span>
<a name="line-9"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import Data.Maybe</span>
</pre>
<pre><a name="line-10"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>M</span>
<a name="line-11"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Set</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>S</span>
<a name="line-12"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Database</span><span class='hs-varop'>.</span><span class='hs-conid'>HsSqlPpp</span><span class='hs-varop'>.</span><span class='hs-conid'>Internals</span><span class='hs-varop'>.</span><span class='hs-conid'>TypesInternal</span>
<a name="line-13"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import Database.HsSqlPpp.Utils.Utils</span>
<a name="line-14"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import Data.Text (Text)</span>
<a name="line-15"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import qualified Data.Text as T</span>
<a name="line-16"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import qualified Data.Text.Lazy as LT</span>
<a name="line-17"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import Database.HsSqlPpp.Internals.Catalog.CatalogTypes</span>
<a name="line-18"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import Database.HsSqlPpp.Dialects.BaseCatalog</span>
</pre>
names to refer to the pseudo types. This is very postgresql
specific. Some of these should be deleted since hssqlppp has nothing
to do with them. Some of them will become postgresql dialect specific
and not appear here, and some we will repurpose to implement features
for non-postgresql dialects as well.

<pre><a name="line-19"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>pseudoTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-conid'>CatName</span> <span class='hs-conid'>Type</span>
<a name="line-20"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>pseudoTypes</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span>
<a name="line-21"></a><span class='hs-varop'>&gt;</span>     <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-str'>"any"</span><span class='hs-layout'>,</span><span class='hs-conid'>Pseudo</span> <span class='hs-conid'>Any</span><span class='hs-layout'>)</span>
<a name="line-22"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-str'>"anyarray"</span><span class='hs-layout'>,</span><span class='hs-conid'>Pseudo</span> <span class='hs-conid'>AnyArray</span><span class='hs-layout'>)</span>
<a name="line-23"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-str'>"anyelement"</span><span class='hs-layout'>,</span><span class='hs-conid'>Pseudo</span> <span class='hs-conid'>AnyElement</span><span class='hs-layout'>)</span>
<a name="line-24"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-str'>"anyenum"</span><span class='hs-layout'>,</span><span class='hs-conid'>Pseudo</span> <span class='hs-conid'>AnyEnum</span><span class='hs-layout'>)</span>
<a name="line-25"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-str'>"anyrange"</span><span class='hs-layout'>,</span><span class='hs-conid'>Pseudo</span> <span class='hs-conid'>AnyRange</span><span class='hs-layout'>)</span>
<a name="line-26"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-str'>"anynonarray"</span><span class='hs-layout'>,</span><span class='hs-conid'>Pseudo</span> <span class='hs-conid'>AnyNonArray</span><span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-varop'>&gt;</span>     <span class='hs-comment'>--,("cstring",Pseudo Cstring)</span>
<a name="line-28"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-str'>"record"</span><span class='hs-layout'>,</span><span class='hs-conid'>Pseudo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Record</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-29"></a><span class='hs-varop'>&gt;</span>     <span class='hs-comment'>--,("trigger",Pseudo Trigger)</span>
<a name="line-30"></a><span class='hs-varop'>&gt;</span>      <span class='hs-comment'>-- todo: fix this?</span>
<a name="line-31"></a><span class='hs-varop'>&gt;</span>     <span class='hs-comment'>--,("event_trigger",Pseudo Trigger)</span>
<a name="line-32"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-str'>"void"</span><span class='hs-layout'>,</span><span class='hs-conid'>Pseudo</span> <span class='hs-conid'>Void</span><span class='hs-layout'>)</span>
<a name="line-33"></a><span class='hs-varop'>&gt;</span>     <span class='hs-comment'>--("_cstring",ArrayType $ Pseudo Cstring)</span>
<a name="line-34"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>,</span><span class='hs-layout'>(</span><span class='hs-str'>"_record"</span><span class='hs-layout'>,</span><span class='hs-conid'>ArrayType</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Pseudo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Record</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-35"></a><span class='hs-varop'>&gt;</span>     <span class='hs-comment'>--,("internal",Pseudo Internal)</span>
<a name="line-36"></a><span class='hs-varop'>&gt;</span>     <span class='hs-comment'>--,("language_handler", Pseudo LanguageHandler)</span>
<a name="line-37"></a><span class='hs-varop'>&gt;</span>     <span class='hs-comment'>--,("opaque", Pseudo Opaque)</span>
<a name="line-38"></a><span class='hs-varop'>&gt;</span>     <span class='hs-comment'>--,("fdw_handler", Pseudo FdwHandler)</span>
<a name="line-39"></a><span class='hs-varop'>&gt;</span>     <span class='hs-keyglyph'>]</span>
</pre>
<pre><a name="line-40"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- | takes a [NameComponent] and returns the type for that name</span>
<a name="line-41"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- will return a type not recognised if the type isn't in the catalog</span>
<a name="line-42"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catLookupType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Catalog</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NameComponent</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TypeError</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>Type</span>
<a name="line-43"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>catLookupType</span> <span class='hs-varid'>cat</span> <span class='hs-varid'>ncs</span> <span class='hs-keyglyph'>=</span>
<a name="line-44"></a><span class='hs-varop'>&gt;</span>   <span class='hs-keyword'>case</span> <span class='hs-varid'>getCatName</span> <span class='hs-varid'>ncs</span> <span class='hs-keyword'>of</span>
<a name="line-45"></a><span class='hs-varop'>&gt;</span>     <span class='hs-comment'>-- check if is a pseudo type</span>
<a name="line-46"></a><span class='hs-varop'>&gt;</span>     <span class='hs-varid'>cn</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>cn</span> <span class='hs-varid'>pseudoTypes</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>p</span>
<a name="line-47"></a><span class='hs-varop'>&gt;</span>     <span class='hs-comment'>-- check for base, domain, enum or composite, and array</span>
<a name="line-48"></a><span class='hs-varop'>&gt;</span>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>member</span> <span class='hs-varid'>cn</span> <span class='hs-layout'>(</span><span class='hs-varid'>catScalarTypeNames</span> <span class='hs-varid'>cat</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ScalarType</span> <span class='hs-varid'>cn</span>
<a name="line-49"></a><span class='hs-varop'>&gt;</span>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>member</span> <span class='hs-varid'>cn</span> <span class='hs-layout'>(</span><span class='hs-varid'>catDomainTypes</span> <span class='hs-varid'>cat</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DomainType</span> <span class='hs-varid'>cn</span>
<a name="line-50"></a><span class='hs-varop'>&gt;</span>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>member</span> <span class='hs-varid'>cn</span> <span class='hs-layout'>(</span><span class='hs-varid'>catCompositeTypes</span> <span class='hs-varid'>cat</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-varop'>$</span> <span class='hs-conid'>NamedCompositeType</span> <span class='hs-varid'>cn</span>
<a name="line-51"></a><span class='hs-varop'>&gt;</span>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>cn</span> <span class='hs-layout'>(</span><span class='hs-varid'>catArrayTypes</span> <span class='hs-varid'>cat</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ArrayType</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ScalarType</span> <span class='hs-varid'>t</span>
<a name="line-52"></a><span class='hs-varop'>&gt;</span>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UnknownTypeName</span> <span class='hs-varid'>cn</span><span class='hs-keyglyph'>]</span>
</pre>
<pre><a name="line-53"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>getCatName</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>NameComponent</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CatName</span>
<a name="line-54"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>getCatName</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"empty name component in catalog code"</span>
<a name="line-55"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>getCatName</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ncStrT</span> <span class='hs-varid'>x</span>
<a name="line-56"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>getCatName</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getCatName</span> <span class='hs-varid'>xs</span>
</pre></body>
</html>
