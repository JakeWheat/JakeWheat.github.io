<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Database/HsSqlPpp/Quote.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>{- | A quasiquoter for SQL. Antiquoting is a bit inconsistent.
<a name="line-2"></a>&gt;
<a name="line-3"></a>&gt; Example:
<a name="line-4"></a>&gt;
<a name="line-5"></a>&gt; &gt;
<a name="line-6"></a>&gt; &gt; {-# LANGUAGE QuasiQuotes #-}
<a name="line-7"></a>&gt; &gt; import Database.HsSqlPpp.Ast
<a name="line-8"></a>&gt; &gt; import Database.HsSqlPpp.Quote
<a name="line-9"></a>&gt; &gt; import Database.HsSqlPpp.Annotation
<a name="line-10"></a>&gt; &gt;
<a name="line-11"></a>&gt; &gt; test :: Statement
<a name="line-12"></a>&gt; &gt; test = [$sqlStmt|
<a name="line-13"></a>&gt; &gt;
<a name="line-14"></a>&gt; &gt;   create table $n(tablename) (
<a name="line-15"></a>&gt; &gt;    $m(varname) $n(typename)
<a name="line-16"></a>&gt; &gt;   );
<a name="line-17"></a>&gt; &gt;
<a name="line-18"></a>&gt; &gt;         |]
<a name="line-19"></a>&gt; &gt;   where
<a name="line-20"></a>&gt; &gt;     tablename = [sqlName| my_table |]
<a name="line-21"></a>&gt; &gt;     varname = [sqlNameComponent| my_field |]
<a name="line-22"></a>&gt; &gt;     typename = [sqlName| text |]
<a name="line-23"></a>&gt; &gt;
<a name="line-24"></a>&gt;
<a name="line-25"></a>&gt; See &lt;<a href="http://jakewheat.github.com/hssqlppp/QuasiQuoteTests.html">http://jakewheat.github.com/hssqlppp/QuasiQuoteTests.html</a>&gt;
<a name="line-26"></a>&gt; for more simple examples
<a name="line-27"></a>&gt;
<a name="line-28"></a>&gt; The splices are:
<a name="line-29"></a>&gt;
<a name="line-30"></a>&gt; * $e(scalarexpression)
<a name="line-31"></a>&gt;
<a name="line-32"></a>&gt; * $s(string)
<a name="line-33"></a>&gt;
<a name="line-34"></a>&gt; * $t(triggerevent)
<a name="line-35"></a>&gt;
<a name="line-36"></a>&gt; * $s(statement)
<a name="line-37"></a>&gt;
<a name="line-38"></a>&gt; * $n(name)
<a name="line-39"></a>&gt;
<a name="line-40"></a>&gt; * $m(namecomponent)
<a name="line-41"></a>&gt;
<a name="line-42"></a>&gt; You can use $m() in a name context, and $n() or $m() in a scalar
<a name="line-43"></a>&gt; expression context. You can only use a single variable name in a
<a name="line-44"></a>&gt; splice atm.
<a name="line-45"></a>&gt;      -}</span>
</pre>
, and
<http://jakewheat.github.com/hssqlppp/source/examples/Database/HsSqlPpp/Examples/Extensions/>
for some example files which use quasiquotation to do ast
transformations which implement syntax extensions to sql
these files need fixing up before ready for public consumption


improvements to qq:
quasi quotes and antiquotes for?:
tablerefs
select lists
multiple statements

use haskell syntax inside antiquotes

<pre><a name="line-46"></a><span class='hs-varop'>&gt;</span>
<a name="line-47"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables #-}</span>
<a name="line-48"></a><span class='hs-varop'>&gt;</span>
<a name="line-49"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>module</span> <span class='hs-conid'>Database</span><span class='hs-varop'>.</span><span class='hs-conid'>HsSqlPpp</span><span class='hs-varop'>.</span><span class='hs-conid'>Quote</span>
<a name="line-50"></a><span class='hs-varop'>&gt;</span>     <span class='hs-layout'>(</span><span class='hs-varid'>sqlStmts</span><span class='hs-layout'>,</span><span class='hs-varid'>sqlStmt</span><span class='hs-layout'>,</span><span class='hs-varid'>pgsqlStmts</span><span class='hs-layout'>,</span><span class='hs-varid'>pgsqlStmt</span><span class='hs-layout'>,</span><span class='hs-varid'>sqlExpr</span><span class='hs-layout'>,</span><span class='hs-varid'>sqlName</span><span class='hs-layout'>,</span><span class='hs-varid'>sqlNameComponent</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
</pre>
<pre><a name="line-51"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>TH</span><span class='hs-varop'>.</span><span class='hs-conid'>Quote</span>
<a name="line-52"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Language</span><span class='hs-varop'>.</span><span class='hs-conid'>Haskell</span><span class='hs-varop'>.</span><span class='hs-conid'>TH</span>
<a name="line-53"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Generics</span>
<a name="line-54"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-55"></a><span class='hs-varop'>&gt;</span>
<a name="line-56"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Database</span><span class='hs-varop'>.</span><span class='hs-conid'>HsSqlPpp</span><span class='hs-varop'>.</span><span class='hs-conid'>Parse</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>P</span>
<a name="line-57"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Database</span><span class='hs-varop'>.</span><span class='hs-conid'>HsSqlPpp</span><span class='hs-varop'>.</span><span class='hs-conid'>Annotation</span>
<a name="line-58"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Database</span><span class='hs-varop'>.</span><span class='hs-conid'>HsSqlPpp</span><span class='hs-varop'>.</span><span class='hs-conid'>Syntax</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>)</span>
<a name="line-59"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span>  <span class='hs-conid'>Database</span><span class='hs-varop'>.</span><span class='hs-conid'>HsSqlPpp</span><span class='hs-varop'>.</span><span class='hs-conid'>Syntax</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>A</span>
<a name="line-60"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import qualified Data.Text as T</span>
<a name="line-61"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span><span class='hs-varop'>.</span><span class='hs-conid'>Lazy</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>L</span>
<a name="line-62"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import Data.Data</span>
</pre>
<pre><a name="line-63"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span> <span class='hs-conid'>()</span>
</pre>
<pre><a name="line-64"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- Control.Monad.Identity</span>
<a name="line-65"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--import Text.Parsec</span>
</pre>
public api: the quasiquote functions

<pre><a name="line-66"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- | quotes Statements</span>
<a name="line-67"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>sqlStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>QuasiQuoter</span>
<a name="line-68"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>sqlStmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>makeQQ</span> <span class='hs-varop'>$</span> <span class='hs-varid'>parseStatements</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-varid'>defaultParseFlags</span>
<a name="line-69"></a><span class='hs-varop'>&gt;</span>
<a name="line-70"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- | quotes a single Statement</span>
<a name="line-71"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>sqlStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>QuasiQuoter</span>
<a name="line-72"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>sqlStmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>makeQQ</span> <span class='hs-varid'>parseOneStatement</span>
<a name="line-73"></a><span class='hs-varop'>&gt;</span>
<a name="line-74"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- | quotes plpgsql Statements</span>
<a name="line-75"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>pgsqlStmts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>QuasiQuoter</span>
<a name="line-76"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>pgsqlStmts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>makeQQ</span> <span class='hs-varop'>$</span> <span class='hs-varid'>parsePlpgsql</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-varid'>defaultParseFlags</span>
<a name="line-77"></a><span class='hs-varop'>&gt;</span>
<a name="line-78"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- | quotes a plpgsql Statement</span>
<a name="line-79"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>pgsqlStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>QuasiQuoter</span>
<a name="line-80"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>pgsqlStmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>makeQQ</span> <span class='hs-varid'>parseOnePlpgsql</span>
</pre>
<pre><a name="line-81"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- | quotes a ScalarExpr</span>
<a name="line-82"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>sqlExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>QuasiQuoter</span>
<a name="line-83"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>sqlExpr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>makeQQ</span> <span class='hs-varop'>$</span> <span class='hs-varid'>parseScalarExpr</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-varid'>defaultParseFlags</span>
<a name="line-84"></a><span class='hs-varop'>&gt;</span>      <span class='hs-comment'>{-QuasiQuoter {quoteExp = prs}
<a name="line-85"></a>&gt;   where
<a name="line-86"></a>&gt;     prs :: String -&gt; Q Exp
<a name="line-87"></a>&gt;     prs s = either (fail . show) return (pse s)
<a name="line-88"></a>&gt;             &gt;&gt;= dataToExpQ (const Nothing)-}</span>
</pre>
<pre><a name="line-89"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--pse :: String -&gt; Either P.ParseErrorExtra ScalarExpr</span>
<a name="line-90"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>--pse = parseScalarExpr P.defaultParseFlags "" Nothing</span>
</pre>
ghc -Wall -threaded -rtsopts  -isrc:src-extra/catalogReader:src-extra/chaos:src-extra/devel-util:src-extra/docutil:src-extra/examples:src-extra/extensions:src-extra/h7c:src-extra/tests:src-extra/chaos/extensions:src-extra/utils temp.lhs

<pre><a name="line-91"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- | quotes a Name</span>
<a name="line-92"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>sqlName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>QuasiQuoter</span>
<a name="line-93"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>sqlName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>makeQQ</span> <span class='hs-varop'>$</span> <span class='hs-varid'>parseName</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-varid'>defaultParseFlags</span>
</pre>
<pre><a name="line-94"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>-- | quotes a Name</span>
<a name="line-95"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>sqlNameComponent</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>QuasiQuoter</span>
<a name="line-96"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>sqlNameComponent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>makeQQ</span> <span class='hs-varop'>$</span> <span class='hs-varid'>parseNameComponent</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-varid'>defaultParseFlags</span>
</pre>

boilerplate utils to hook everything together

<pre><a name="line-97"></a><span class='hs-varop'>&gt;</span> <span class='hs-keyword'>type</span> <span class='hs-conid'>Parser</span> <span class='hs-varid'>e</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span>
<a name="line-98"></a><span class='hs-varop'>&gt;</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-99"></a><span class='hs-varop'>&gt;</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-100"></a><span class='hs-varop'>&gt;</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-varid'>e</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-101"></a><span class='hs-varop'>&gt;</span>
<a name="line-102"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>makeQQ</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span> <span class='hs-varid'>e</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-103"></a><span class='hs-varop'>&gt;</span>           <span class='hs-conid'>Parser</span> <span class='hs-varid'>e</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QuasiQuoter</span>
<a name="line-104"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>makeQQ</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>QuasiQuoter</span> <span class='hs-layout'>{</span><span class='hs-varid'>quoteExp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parseExprExp</span> <span class='hs-varid'>p</span>
<a name="line-105"></a><span class='hs-varop'>&gt;</span>                        <span class='hs-layout'>,</span><span class='hs-varid'>quotePat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parseExprPat</span> <span class='hs-varid'>p</span>
<a name="line-106"></a><span class='hs-varop'>&gt;</span>                        <span class='hs-layout'>,</span><span class='hs-varid'>quoteType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"quasi-quoter doesn't work for types"</span>
<a name="line-107"></a><span class='hs-varop'>&gt;</span>                        <span class='hs-layout'>,</span><span class='hs-varid'>quoteDec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"quasi-quoter doesn't work for declarations"</span><span class='hs-layout'>}</span>
</pre>
hack for the text issue:

create parallel ast with text replaced with strings automatically
create conversion function to convert tree with text to tree with
strings automatically
pass this tree into dataToExpQ
then get the result, and convert the Exp type back to using text
not sure what needs to be done about which package the Exp refers to
maybe it will work?

<pre><a name="line-108"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>parseExprExp</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span> <span class='hs-varid'>e</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-109"></a><span class='hs-varop'>&gt;</span>                 <span class='hs-conid'>Parser</span> <span class='hs-varid'>e</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Q</span> <span class='hs-conid'>Exp</span>
<a name="line-110"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>parseExprExp</span> <span class='hs-varid'>p</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parseSql'</span> <span class='hs-varid'>p</span> <span class='hs-varid'>s</span>
<a name="line-111"></a><span class='hs-varop'>&gt;</span>                    <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>dataToExpQ</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>Nothing</span>
<a name="line-112"></a><span class='hs-varop'>&gt;</span>                                     <span class='hs-varop'>`extQ`</span> <span class='hs-varid'>antiExpE</span>
<a name="line-113"></a><span class='hs-varop'>&gt;</span>                                     <span class='hs-varop'>`extQ`</span> <span class='hs-varid'>antiStrE</span>
<a name="line-114"></a><span class='hs-varop'>&gt;</span>                                     <span class='hs-varop'>`extQ`</span> <span class='hs-varid'>antiTriggerEventE</span>
<a name="line-115"></a><span class='hs-varop'>&gt;</span>                                     <span class='hs-varop'>`extQ`</span> <span class='hs-varid'>antiStatementE</span>
<a name="line-116"></a><span class='hs-varop'>&gt;</span>                                     <span class='hs-varop'>`extQ`</span> <span class='hs-varid'>antiNameE</span>
<a name="line-117"></a><span class='hs-varop'>&gt;</span>                                     <span class='hs-varop'>`extQ`</span> <span class='hs-varid'>antiNameComponentE</span><span class='hs-layout'>)</span>
</pre>
<pre><a name="line-118"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>parseExprPat</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span> <span class='hs-varid'>e</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-119"></a><span class='hs-varop'>&gt;</span>                 <span class='hs-conid'>Parser</span> <span class='hs-varid'>e</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Q</span> <span class='hs-conid'>Pat</span>
<a name="line-120"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>parseExprPat</span> <span class='hs-varid'>p</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parseSql'</span> <span class='hs-varid'>p</span> <span class='hs-varid'>s</span>
<a name="line-121"></a><span class='hs-varop'>&gt;</span>                    <span class='hs-varop'>&gt;&gt;=</span>  <span class='hs-varid'>dataToPatQ</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>Nothing</span>
<a name="line-122"></a><span class='hs-varop'>&gt;</span>                                     <span class='hs-varop'>`extQ`</span> <span class='hs-varid'>antiExpP</span>
<a name="line-123"></a><span class='hs-varop'>&gt;</span>                                     <span class='hs-varop'>`extQ`</span> <span class='hs-varid'>antiStrP</span>
<a name="line-124"></a><span class='hs-varop'>&gt;</span>                                     <span class='hs-varop'>`extQ`</span> <span class='hs-varid'>antiTriggerEventP</span>
<a name="line-125"></a><span class='hs-varop'>&gt;</span>                                     <span class='hs-varop'>`extQ`</span> <span class='hs-varid'>antiStatementP</span>
<a name="line-126"></a><span class='hs-varop'>&gt;</span>                                     <span class='hs-varop'>`extQ`</span> <span class='hs-varid'>antiNameP</span>
<a name="line-127"></a><span class='hs-varop'>&gt;</span>                                     <span class='hs-varop'>`extQ`</span> <span class='hs-varid'>antiNameComponentP</span>
<a name="line-128"></a><span class='hs-varop'>&gt;</span>                                     <span class='hs-varop'>`extQ`</span> <span class='hs-varid'>annotToWildCard</span><span class='hs-layout'>)</span>
<a name="line-129"></a><span class='hs-varop'>&gt;</span>
</pre>
wrapper for all the different parsers which sets the source location
and converts left to fail

todo: error messages not coming out nicely from ghc when doing
fail.show.

<pre><a name="line-130"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>parseSql'</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Data</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Parser</span> <span class='hs-varid'>e</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Q</span> <span class='hs-varid'>a</span>
<a name="line-131"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>parseSql'</span> <span class='hs-varid'>p</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-132"></a><span class='hs-varop'>&gt;</span>     <span class='hs-conid'>Loc</span> <span class='hs-varid'>fn</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>location</span>
<a name="line-133"></a><span class='hs-varop'>&gt;</span>     <span class='hs-varid'>either</span> <span class='hs-layout'>(</span><span class='hs-varid'>fail</span> <span class='hs-varop'>.</span> <span class='hs-varid'>show</span><span class='hs-layout'>)</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>p</span> <span class='hs-varid'>fn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
</pre>
wrappers - the Parser module doesn't expose methods which parse
exactly one statement

<pre><a name="line-134"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>parseOnePlpgsql</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Parser</span> <span class='hs-conid'>String</span> <span class='hs-conid'>Statement</span>
<a name="line-135"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>parseOnePlpgsql</span> <span class='hs-varid'>f</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span>
<a name="line-136"></a><span class='hs-varop'>&gt;</span>     <span class='hs-keyword'>case</span> <span class='hs-varid'>parsePlpgsql</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-varid'>defaultParseFlags</span> <span class='hs-varid'>f</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>of</span>
<a name="line-137"></a><span class='hs-varop'>&gt;</span>       <span class='hs-conid'>Right</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>st</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>st</span>
<a name="line-138"></a><span class='hs-varop'>&gt;</span>       <span class='hs-conid'>Right</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-str'>"got multiple statements"</span>
<a name="line-139"></a><span class='hs-varop'>&gt;</span>       <span class='hs-conid'>Left</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-varop'>$</span> <span class='hs-varid'>show</span> <span class='hs-varid'>e</span>
<a name="line-140"></a><span class='hs-varop'>&gt;</span>
<a name="line-141"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>parseOneStatement</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Parser</span> <span class='hs-conid'>String</span> <span class='hs-conid'>Statement</span>
<a name="line-142"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>parseOneStatement</span> <span class='hs-varid'>f</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span>
<a name="line-143"></a><span class='hs-varop'>&gt;</span>     <span class='hs-keyword'>case</span> <span class='hs-varid'>parseStatements</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-varid'>defaultParseFlags</span> <span class='hs-varid'>f</span> <span class='hs-varid'>sp</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>of</span>
<a name="line-144"></a><span class='hs-varop'>&gt;</span>       <span class='hs-conid'>Right</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>st</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>st</span>
<a name="line-145"></a><span class='hs-varop'>&gt;</span>       <span class='hs-conid'>Right</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-str'>"got multiple statements"</span>
<a name="line-146"></a><span class='hs-varop'>&gt;</span>       <span class='hs-conid'>Left</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Left</span> <span class='hs-varop'>$</span> <span class='hs-varid'>show</span> <span class='hs-varid'>e</span>
</pre>
hack: replace the annotations in asts produced by parsing with
wildcards, if you don't do this then pattern matches generally don't
work since the source position annotations from the parser don't match
up. The source position annotations are still available so that e.g. a
function can pattern match against a statement then get the source
position from the matched statements.

<pre><a name="line-147"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>annotToWildCard</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Annotation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>PatQ</span>
<a name="line-148"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>annotToWildCard</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>return</span> <span class='hs-conid'>WildP</span>
</pre>
= individual antinode lookup functions

<pre><a name="line-149"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiExpE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ScalarExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ExpQ</span>
<a name="line-150"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiExpE</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>varE</span> <span class='hs-layout'>(</span><span class='hs-varid'>antiExp</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-151"></a><span class='hs-varop'>&gt;</span>
<a name="line-152"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiExpP</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ScalarExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>PatQ</span>
<a name="line-153"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiExpP</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>varP</span> <span class='hs-varop'>$</span> <span class='hs-varid'>antiExp</span> <span class='hs-varid'>v</span>
<a name="line-154"></a><span class='hs-varop'>&gt;</span>
<a name="line-155"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiExp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ScalarExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span>
<a name="line-156"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiExp</span> <span class='hs-layout'>(</span><span class='hs-conid'>AntiScalarExpr</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkName</span> <span class='hs-varid'>v</span>
<a name="line-157"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiExp</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>

<pre><a name="line-158"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiNameE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>A</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ExpQ</span>
<a name="line-159"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiNameE</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>varE</span> <span class='hs-layout'>(</span><span class='hs-varid'>antiName</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-160"></a><span class='hs-varop'>&gt;</span>
<a name="line-161"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiNameP</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>A</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>PatQ</span>
<a name="line-162"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiNameP</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>varP</span> <span class='hs-varop'>$</span> <span class='hs-varid'>antiName</span> <span class='hs-varid'>v</span>
<a name="line-163"></a><span class='hs-varop'>&gt;</span>
<a name="line-164"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>A</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span>
<a name="line-165"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiName</span> <span class='hs-layout'>(</span><span class='hs-conid'>AntiName</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkName</span> <span class='hs-varid'>v</span>
<a name="line-166"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiName</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>
<pre><a name="line-167"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiNameComponentE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameComponent</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ExpQ</span>
<a name="line-168"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiNameComponentE</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>varE</span> <span class='hs-layout'>(</span><span class='hs-varid'>antiNameComponent</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-169"></a><span class='hs-varop'>&gt;</span>
<a name="line-170"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiNameComponentP</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameComponent</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>PatQ</span>
<a name="line-171"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiNameComponentP</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>varP</span> <span class='hs-varop'>$</span> <span class='hs-varid'>antiNameComponent</span> <span class='hs-varid'>v</span>
<a name="line-172"></a><span class='hs-varop'>&gt;</span>
<a name="line-173"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiNameComponent</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NameComponent</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span>
<a name="line-174"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiNameComponent</span> <span class='hs-layout'>(</span><span class='hs-conid'>AntiNameComponent</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkName</span> <span class='hs-varid'>v</span>
<a name="line-175"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiNameComponent</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>


<pre><a name="line-176"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiStatementE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Statement</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ExpQ</span>
<a name="line-177"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiStatementE</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>varE</span> <span class='hs-layout'>(</span><span class='hs-varid'>antiStatement</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-178"></a><span class='hs-varop'>&gt;</span>
<a name="line-179"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiStatementP</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Statement</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>PatQ</span>
<a name="line-180"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiStatementP</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>varP</span> <span class='hs-varop'>$</span> <span class='hs-varid'>antiStatement</span> <span class='hs-varid'>v</span>
<a name="line-181"></a><span class='hs-varop'>&gt;</span>
<a name="line-182"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiStatement</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Statement</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span>
<a name="line-183"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiStatement</span> <span class='hs-layout'>(</span><span class='hs-conid'>AntiStatement</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkName</span> <span class='hs-varid'>v</span>
<a name="line-184"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiStatement</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>


antistatements not working ...
trying to replace a single antistatement node with multiple statement
nodes and my generics skills aren't up to the task.


<pre><a name="line-185"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>{-antiStatementE :: [Statement] -&gt; Maybe ExpQ
<a name="line-186"></a>&gt; antiStatementE (AntiStatement v : tl) =
<a name="line-187"></a>&gt;    Just (listE (vref : conArgs))
<a name="line-188"></a>&gt;    where
<a name="line-189"></a>&gt;      conArgs = gmapQ (dataToExpQ (const Nothing
<a name="line-190"></a>&gt;                                     `extQ` antiExpE
<a name="line-191"></a>&gt;                                     -- `extQ` antiStrE
<a name="line-192"></a>&gt;                                     `extQ` antiTriggerEventE
<a name="line-193"></a>&gt;                                     `extQ` antiStatementE
<a name="line-194"></a>&gt;                                     `extQ` antiNameE
<a name="line-195"></a>&gt;                                     `extQ` antiNameComponentE)) tl
<a name="line-196"></a>&gt;      vref :: ExpQ
<a name="line-197"></a>&gt;      vref = varE $ mkName v
<a name="line-198"></a>&gt; antiStatementE _ = Nothing-}</span>
</pre>

<pre><a name="line-199"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiStrE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ExpQ</span>
<a name="line-200"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiStrE</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>varE</span> <span class='hs-varop'>$</span> <span class='hs-varid'>antiStr</span> <span class='hs-varid'>v</span>
</pre>
<pre><a name="line-201"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiStrP</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>PatQ</span>
<a name="line-202"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiStrP</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>varP</span> <span class='hs-varop'>$</span> <span class='hs-varid'>antiStr</span> <span class='hs-varid'>v</span>
</pre>
<pre><a name="line-203"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiStr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Name</span>
<a name="line-204"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiStr</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span>
<a name="line-205"></a><span class='hs-varop'>&gt;</span>   <span class='hs-varid'>fmap</span> <span class='hs-varid'>mkName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getSpliceName</span> <span class='hs-varid'>v</span>
<a name="line-206"></a><span class='hs-varop'>&gt;</span>   <span class='hs-keyword'>where</span>
<a name="line-207"></a><span class='hs-varop'>&gt;</span>     <span class='hs-varid'>getSpliceName</span> <span class='hs-varid'>s</span>
<a name="line-208"></a><span class='hs-varop'>&gt;</span>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPrefixOf</span> <span class='hs-str'>"$s("</span> <span class='hs-varid'>s</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>last</span> <span class='hs-varid'>s</span> <span class='hs-varop'>==</span> <span class='hs-chr'>')'</span> <span class='hs-keyglyph'>=</span>
<a name="line-209"></a><span class='hs-varop'>&gt;</span>           <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>drop</span> <span class='hs-num'>3</span> <span class='hs-varop'>$</span> <span class='hs-varid'>init</span> <span class='hs-varid'>s</span>
<a name="line-210"></a><span class='hs-varop'>&gt;</span>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>
<pre><a name="line-211"></a><span class='hs-varop'>&gt;</span>
<a name="line-212"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiTriggerEventE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TriggerEvent</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ExpQ</span>
<a name="line-213"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiTriggerEventE</span> <span class='hs-layout'>(</span><span class='hs-conid'>AntiTriggerEvent</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>varE</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkName</span> <span class='hs-varid'>v</span>
<a name="line-214"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiTriggerEventE</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>
<pre><a name="line-215"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiTriggerEventP</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TriggerEvent</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>PatQ</span>
<a name="line-216"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiTriggerEventP</span> <span class='hs-layout'>(</span><span class='hs-conid'>AntiTriggerEvent</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>varP</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkName</span> <span class='hs-varid'>v</span>
<a name="line-217"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>antiTriggerEventP</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
</pre>

what needs to be done to support _ in pattern quasiquotes? -> I think
it's just adding a wildcard ctor to the appropriate ast types using
makeantinodes, and adding in lexing and parsing support - actually
using wildcards is now working with the annotation approach above

also, how to use haskell syntax in splices

----------------------------------

<pre><a name="line-218"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>parseStatements</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-conid'>ParseFlags</span> <span class='hs-comment'>-- ^ parse options</span>
<a name="line-219"></a><span class='hs-varop'>&gt;</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-comment'>-- ^ filename to use in errors</span>
<a name="line-220"></a><span class='hs-varop'>&gt;</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ set the line number and column number</span>
<a name="line-221"></a><span class='hs-varop'>&gt;</span>                                    <span class='hs-comment'>-- of the first char in the source (used in annotation)</span>
<a name="line-222"></a><span class='hs-varop'>&gt;</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-comment'>-- ^ a string containing the sql to parse</span>
<a name="line-223"></a><span class='hs-varop'>&gt;</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-conid'>ParseErrorExtra</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Statement</span><span class='hs-keyglyph'>]</span>
<a name="line-224"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>parseStatements</span> <span class='hs-varid'>p</span> <span class='hs-varid'>f</span> <span class='hs-varid'>s</span> <span class='hs-varid'>src</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-varid'>parseStatements</span> <span class='hs-varid'>p</span> <span class='hs-varid'>f</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span>
</pre>
<pre><a name="line-225"></a><span class='hs-varop'>&gt;</span> <span class='hs-comment'>{-parseQueryExpr :: P.ParseFlags -- ^ parse options
<a name="line-226"></a>&gt;                -&gt; FilePath -- ^ filename to use in errors
<a name="line-227"></a>&gt;                -&gt; Maybe (Int,Int) -- ^ set the line number and column number
<a name="line-228"></a>&gt;                -&gt; String -- ^ a string containing the sql to parse
<a name="line-229"></a>&gt;                -&gt; Either P.ParseErrorExtra QueryExpr
<a name="line-230"></a>&gt; parseQueryExpr p f s src = P.parseQueryExpr p f s (L.pack src)-}</span>
</pre>
<pre><a name="line-231"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>parseScalarExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-conid'>ParseFlags</span> <span class='hs-comment'>-- ^ parse options</span>
<a name="line-232"></a><span class='hs-varop'>&gt;</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-comment'>-- ^ filename to use in errors</span>
<a name="line-233"></a><span class='hs-varop'>&gt;</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ set the line number and column number</span>
<a name="line-234"></a><span class='hs-varop'>&gt;</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-comment'>-- ^ a string containing the sql to parse</span>
<a name="line-235"></a><span class='hs-varop'>&gt;</span>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-conid'>ParseErrorExtra</span> <span class='hs-conid'>ScalarExpr</span>
<a name="line-236"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>parseScalarExpr</span> <span class='hs-varid'>p</span> <span class='hs-varid'>f</span> <span class='hs-varid'>s</span> <span class='hs-varid'>src</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-varid'>parseScalarExpr</span> <span class='hs-varid'>p</span> <span class='hs-varid'>f</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span>
</pre>
<pre><a name="line-237"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>parseName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-conid'>ParseFlags</span>
<a name="line-238"></a><span class='hs-varop'>&gt;</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-239"></a><span class='hs-varop'>&gt;</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-240"></a><span class='hs-varop'>&gt;</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-241"></a><span class='hs-varop'>&gt;</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-conid'>ParseErrorExtra</span> <span class='hs-conid'>A</span><span class='hs-varop'>.</span><span class='hs-conid'>Name</span>
<a name="line-242"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>parseName</span> <span class='hs-varid'>p</span> <span class='hs-varid'>f</span> <span class='hs-varid'>s</span> <span class='hs-varid'>src</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-varid'>parseName</span> <span class='hs-varid'>p</span> <span class='hs-varid'>f</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span>
</pre>
<pre><a name="line-243"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>parseNameComponent</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-conid'>ParseFlags</span>
<a name="line-244"></a><span class='hs-varop'>&gt;</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-245"></a><span class='hs-varop'>&gt;</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-246"></a><span class='hs-varop'>&gt;</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-247"></a><span class='hs-varop'>&gt;</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-conid'>ParseErrorExtra</span> <span class='hs-conid'>NameComponent</span>
<a name="line-248"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>parseNameComponent</span> <span class='hs-varid'>p</span> <span class='hs-varid'>f</span> <span class='hs-varid'>s</span> <span class='hs-varid'>src</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-varid'>parseNameComponent</span> <span class='hs-varid'>p</span> <span class='hs-varid'>f</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span>
</pre>
<pre><a name="line-249"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>parsePlpgsql</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-conid'>ParseFlags</span> <span class='hs-comment'>-- ^ parse options</span>
<a name="line-250"></a><span class='hs-varop'>&gt;</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-comment'>-- ^ filename to use in errors</span>
<a name="line-251"></a><span class='hs-varop'>&gt;</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ set the line number and column number</span>
<a name="line-252"></a><span class='hs-varop'>&gt;</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-253"></a><span class='hs-varop'>&gt;</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-conid'>ParseErrorExtra</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Statement</span><span class='hs-keyglyph'>]</span>
<a name="line-254"></a><span class='hs-varop'>&gt;</span> <span class='hs-definition'>parsePlpgsql</span> <span class='hs-varid'>p</span> <span class='hs-varid'>f</span> <span class='hs-varid'>s</span> <span class='hs-varid'>src</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>P</span><span class='hs-varop'>.</span><span class='hs-varid'>parseProcSQL</span> <span class='hs-varid'>p</span> <span class='hs-varid'>f</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-varid'>src</span><span class='hs-layout'>)</span>
</pre></body>
</html>
